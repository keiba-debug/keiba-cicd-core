# オッズボード 改善アイデア集

**作成日**: 2026-01-31  
**目的**: オッズボードのデザイン性・フィルタ・分析機能の拡張案を整理

---

## 1. デザイン・視認性

### 1.1 枠に色を付ける
- **概要**: 馬番の左に枠番を表示し、JRA 枠色で着色
- **データ**: shutsuba/integrated の `枠番`（馬番と 1:1 対応）
- **既存実装**: `getWakuColor()`（race-data.ts）、HorseEntryTable で使用中
- **効果**: 枠連・枠順の把握が容易、株ボード風の見やすさ向上

### 1.2 人気別の行ハイライト
- **概要**: 1〜3 人気の行を薄い背景色で強調（既に HorseEntryTable で実施済み）
- **適用**: オッズボードでも人気順に応じた行色を導入

### 1.3 AI指数ランクの色分け
- **概要**: A/B/C ランクを色で表現（A=黄、B=青、C=緑など）
- **データ**: shutsuba の `AI指数ランク`（Ａ/Ｂ/Ｃ）
- **既存**: HorseEntryTable の `getAiIndexColor` を参考

### 1.4 株ボード風レイアウト強化
- **現状**: カード縦積み
- **案**: 競馬場タブ＋レース番号タブで切り替え、1 レースにフォーカスした広い表示
- **案**: ダークモード対応、フォント（等幅・数字の太字）の統一

---

## 2. フィルタ・表示切り替え

### 2.1 競馬場フィルタ
- **概要**: 東京のみ、京都のみなどでレースを絞り込み
- **UI**: チェックボックス or タブで競馬場を選択

### 2.2 レース番号フィルタ
- **概要**: 1R〜6R / 7R〜12R など時間帯で絞り込み
- **用途**: 発走前のレースだけ表示、注目レースのみ表示

### 2.3 オッズ種別の切り替え
- **概要**: 単複 / 馬連 / 馬単 / ワイド をタブで切り替え
- **前提**: RT_DATA に O2/O4 等が含まれる、または JI_ 時系列データの対応

### 2.4 表示列のカスタマイズ
- **概要**: 馬番・馬名・単勝・複勝・人気・枠・AI指数・レイティング・期待値 の ON/OFF
- **UI**: 歯車アイコンから列の表示/非表示を選択

---

## 3. 期待値・分析機能

### 3.1 AI指数・レイティングによる期待値計算
- **概要**: 
  - **簡易版**: レイティング or AI指数を「勝率の代理指標」として扱い、`期待値率 = 勝率代理 × オッズ`
  - **例**: レイティング 55 の馬が単勝 4.0 倍 → 仮に勝率 25% とすると期待値 100%
- **データ**: shutsuba の `レイティング`、`AI指数`、`人気指数`
- **既存**: TARGET `evaluator.py` が本格的な期待値計算を実装済み

### 3.2 簡易期待値の表示
- **案 A**: レイティングをレース内で正規化し、相対勝率として期待値率を算出
  - `期待値率 = (正規化勝率) × オッズ`
  - 100% 超を緑、100% 未満をグレーで表示
- **案 B**: AI指数をベースに、レース内順位から確率を逆算
- **案 C**: TARGET evaluator を API 化し、WebViewer から呼び出し

### 3.3 オッズゆがみ検出
- **概要**: 人気と実力（AI指数・レイティング）の乖離をハイライト
- **例**: AI指数 1 位なのに人気 5 番 → 「割り」候補として強調
- **AI チーム連携**: 将来的に ML モデルでゆがみスコアを算出

---

## 4. 時系列オッズ（JI_2026 活用）— 拡張アイデア集

**データソース**: `C:\TFJV\RT_DATA\JI_2026\{MMDD}\` の JT（馬単）・JU（馬連）ファイル  
**前提**: 時刻別スナップショットが複数ある、または朝オッズ vs 締切前の比較が可能

---

### 4.1 上げ下げ・急変の可視化（基本）

| アイデア | 説明 | UI 例 |
|----------|------|-------|
| **矢印＋色** | 朝 vs 現在の差分を ↑↓= で表示 | 4.2 → 3.8 = ↓ 緑（人気上昇） |
| **変動幅の強弱** | 微増減 vs 急変を色の濃さで表現 | 微: 薄青/薄赤、急: 濃い赤/濃い青 |
| **倍率変化** | 何倍に動いたか（例: 1.2倍下落） | 「-20%」と表示 |

---

### 4.2 急上昇・急落の検出

| アイデア | 定義 | 表示 |
|----------|------|------|
| **急上昇馬** | 単勝オッズが一定割合以上下落（人気急上昇） | 🚀 バッジ、行をハイライト |
| **急落馬** | 単勝オッズが一定割合以上上昇（人気急落） | ⚠️ バッジ、薄いオレンジ |
| **閾値** | 例: 10%以上変動で「変動あり」、20%以上で「急変」 | 設定で変更可能 |
| **時間軸** | 朝〜現在 / 1時間前〜現在 / 30分前〜現在 | ドロップダウンで選択 |

---

### 4.3 ミニチャート・グラフ

| アイデア | 説明 | 用途 |
|----------|------|------|
| **スパークライン** | 単勝オッズの推移を 1 行のミニ折れ線 | 傾向の一目把握 |
| **マウスオーバーで拡大** | ホバーで大きなチャートをポップアップ | 詳細確認 |
| **比較モード** | 2〜3 頭を重ねて表示 | 人気の抜き差しを比較 |
| **馬連・馬単チャート** | 特定の組み合わせのオッズ推移 | 本命・対抗の入れ替わり |

---

### 4.4 変動ランキング・ソート

| アイデア | 説明 |
|----------|------|
| **急上昇ランキング** | レース内で「人気急上昇 TOP3」を表示 |
| **急落ランキング** | 人気急落した馬をリストアップ |
| **変動幅でソート** | 表を「変動幅」列でソート可能に |
| **レース間比較** | 全日程で「今日いちばん動いた馬」を表示 |

---

### 4.5 朝オッズとの比較

| アイデア | 説明 | 活用 |
|----------|------|------|
| **朝オッズ列** | 朝の単勝・複勝を並列表示 | 締切前との比較 |
| **乖離度** | 朝オッズから何% 動いたか | 大きく動いた馬を抽出 |
| **逆転検出** | 朝 1 番人気が 3 番に落ちた等 | 本命崩れの早期把握 |
| **初出し検出** | 朝はオッズなしで、途中から出てきた馬 | 穴馬の候補 |

---

### 4.6 人気の流れ・トレンド

| アイデア | 説明 |
|----------|------|
| **人気推移** | 各時点での 1〜3 人気の馬番を時系列で表示 |
| **追い上げ・落ち込み** | 開始時 5 番人気 → 現在 2 番人気 など |
| **安定度** | オッズがほとんど動かない馬を「安定」と表示 |
| **荒れ度** | レース全体のオッズ変動の激しさを指標化 |

---

### 4.7 馬連・馬単の時系列

| アイデア | 説明 |
|----------|------|
| **本命×対抗の推移** | 1-2 番人気の馬連オッズの変動 |
| **穴馬連の急騰** | 低人気だった組み合わせが急に人気化 |
| **軸馬の入れ替わり** | 軸候補が A → B に変わったタイミングを表示 |
| **3連複・3連単** | データがあれば同様の変動表示 |

---

### 4.8 アラート・ハイライト

| アイデア | 説明 |
|----------|------|
| **変動アラート** | 一定以上の変動があった馬に 🔔 表示 |
| **「要チェック」** | 急上昇＋AI指数上位など条件で自動タグ |
| **色付き枠** | 行の左端を変動の方向（赤/青）で着色 |
| **バッジ** | 「急騰」「急落」「安定」などをバッジで表示 |

---

### 4.9 フィルタ・絞り込み（時系列）

| アイデア | 説明 |
|----------|------|
| **急変馬のみ表示** | 変動が一定以上の馬だけ表示 |
| **上昇馬 / 下落馬** | 方向でフィルタ |
| **変動なし** | 安定馬のみ表示（穴狙いの逆張り用） |
| **時間帯フィルタ** | 直近 30 分で動いた馬のみ など |

---

### 4.10 集計・サマリー

| アイデア | 説明 |
|----------|------|
| **レース別変動サマリー** | 「このレースは荒れている / 落ち着いている」 |
| **競馬場別傾向** | 東京は動きやすい、京都は安定 などの傾向 |
| **時間帯別** | 発走何分前にいちばん動くか など |

---

### 4.11 特定時間への巻き戻し（タイムスライダー）

| アイデア | 説明 | UI |
|----------|------|-----|
| **タイムスライダー** | スライダーや時刻選択で「〇時〇分のオッズ」を表示 | 時計アイコン＋スライダー |
| **DVR 風再生** | 過去のスナップショットを連続で表示、一時停止・早送り | 再生ボタン ＋ ◀ ▶ |
| **時刻ドロップダウン** | 取得済みのタイムスタンプ一覧から選択 | 09:00, 10:30, 11:45... |
| **比較モード** | 「現在」と「選択時刻」を左右に並べて表示 | 2 カラム比較 |
| **差分ハイライト** | 選択時刻→現在で変わった部分だけ色付け | 緑/赤で変化箇所を強調 |

**ユースケース**
- 「発走 30 分前のオッズはどうだった？」の確認
- 「本命が崩れたタイミング」の特定
- 自分が購入した時刻のオッズを後から確認
- レース後の振り返り（どのタイミングで人気が動いたか）

**データ前提**: 複数タイムスタンプのスナップショットが保存されていること（JI_ / ODDS 蓄積 / DB）

---

### 4.12 将来のデータ蓄積（Phase 2）

- **ODDS フォルダ**: JV-Link で定期的に O1/O2 を保存 → 自作時系列を構築
- **DB 化**: スナップショットを DB に格納 → 任意の時間範囲で分析
- **ポーリング**: オッズボード表示中に一定間隔で取得 → 擬似リアルタイム

---

## 5. 実装優先度案

| 優先度 | 機能 | 工数 | データ前提 |
|--------|------|------|------------|
| 高 | 枠に色を付ける | 小 | 枠番（shutsuba 連携済み） |
| 高 | 競馬場フィルタ | 小 | 既存 |
| 中 | 期待値簡易表示（レイティングベース） | 中 | レイティング追加取得 |
| 中 | AI指数・ランク表示 | 小 | AI指数追加取得 |
| 中 | 表示列カスタマイズ | 中 | 既存 |
| 中 | **上げ下げ表示**（矢印・色） | 中 | 時系列 or 朝オッズ |
| 中 | **急上昇・急落バッジ** | 小 | 時系列 2 時点以上 |
| 低 | オッズ種別切り替え | 大 | O2/O4 パース対応 |
| 低 | **スパークライン** | 中 | 時系列 複数スナップ |
| 低 | **変動ランキング・ソート** | 小 | 上げ下げ実装後 |
| 低 | **タイムスライダー（過去時刻のオッズ表示）** | 大 | 複数スナップ蓄積 |
| 低 | オッズゆがみ検出 | 大 | AI モデル連携 |

---

## 6. データ拡張の要件

オッズ API のレスポンスに以下を追加すると、上記機能の多くが実装可能：

```typescript
// HorseOdds の拡張案
interface HorseOdds {
  umaban: string;
  waku?: string;           // 枠番
  horseName?: string;
  winOdds: number | null;
  placeOddsMin: number | null;
  placeOddsMax: number | null;
  ninki: number | null;
  // 追加
  rating?: number;         // レイティング
  aiIndex?: number;        // AI指数
  aiIndexRank?: string;    // A/B/C
  oddsRank?: number;       // オッズ人気順（shutsuba）
}
```

shutsuba/integrated から `枠番`・`レイティング`・`AI指数`・`AI指数ランク` を馬番でマージして返す形が想定される。

---

## 7. 時系列データの構造（2026-01 調査結果）

### JI_2026 の実態 ✅ 確認済み

**1 ファイル内に複数行 = タイムスタンプごとのスナップショット**

- `JT2026013105010101.DAT`（東京1R 馬単）を調査
- **1 行 = 1 時点のオッズ**。行数 = スナップショット数（約 180 行以上）
- 各行の先頭付近に時刻らしき値（例: `01301831`, `01301836`, `01301841`…）があり、数分間隔で更新されていると推定
- JV O2/O4 の `HappyoTime`（発表月日時分、bytes 28-35）に相当するフィールドのパースが必要

### ファイル構造まとめ

| 項目 | 内容 |
|------|------|
| 場所 | `C:\TFJV\RT_DATA\JI_2026\{MMDD}\` |
| ファイル | `JT{raceId}.DAT`（馬単）, `JU{raceId}.DAT`（馬連） |
| 1 ファイル | 1 レース分の時系列データ |
| 1 行 | 1 時点のオッズスナップショット |
| 行数 | 発売開始〜締切までの取得回数（約 180 件以上） |

### タイムスライダー実装への含意

- **同一ファイル内の行を時刻順に並べれば、任意の時刻のオッズを再現可能**
- HappyoTime をパースしてタイムスタンプを取得し、行と時刻の対応を取る
- 「〇時〇分のオッズを表示」は、該当時刻に最も近い行を選べば実装可能

### フォールバック案
- JI パーサー完成前: **朝オッズ** を shutsuba の単勝列など別ソースで持つ
- 朝オッズ vs RT 現在 の 2 時点比較でも「上げ下げ」は実装可能

---

## 8. 参考

- [ODDS_DISPLAY_DESIGN.md](./ODDS_DISPLAY_DESIGN.md) - オッズデータソース・設計
- [BETTING_STRATEGY_FRAMEWORK.md](../KeibaCICD.TARGET/ml/docs/BETTING_STRATEGY_FRAMEWORK.md) - 期待値計算の理論
- `evaluator.py` - 期待値計算エンジン
- `getWakuColor()` (race-data.ts) - 枠色定義
