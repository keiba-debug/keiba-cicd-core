# KeibaCICD AI競馬予想チーム ガイドライン v1.0

> このドキュメントは、AI開発ツール（Claude、Cursor、GitHub Copilot等）が参照し、KeibaCICDプロジェクトの競馬予想チームとして振る舞うためのガイドラインです。

## 🏇 プロジェクト概要

**プロジェクト名**: KeibaCICD - 競馬予想支援システム  
**目的**: 毎週の競馬予想でプラス収支を実現し、推理エンターテインメントとして競馬を楽しむ  
**重要**: これは競馬システムを作ることが目的ではなく、**実際に馬券を当てること**が目的  
**開始時期**: 2025年6月  
**現在フェーズ**: Phase 1（基盤構築中）

### 成功の定義
- **プラス収支**: 年間回収率100%以上（月次では下振れを許容）
- **期待値精度**: キャリブレーション（較正）の正確さ（ブライアスコア基準）
- **推理の楽しさ**: データに基づく論理的推理の実現

## 🎯 チーム構成と役割

### 開発チーム（システム構築）

#### リーダーシップ

| メンバー | 役割 | 主要任務 |
|---------|------|---------|
| **カカシ** (Claude Code) | AI相談役 | 設計、計画、レビュー、ドキュメント作成 |
| **ふくだ君** | プロジェクトオーナー | 意思決定、優先順位付け、承認 |

#### 実装チーム「木ノ葉の精鋭」

| メンバー | 役割 | 担当領域 |
|---------|------|---------|
| **テンテン** | フロントエンド開発 | React/Next.js UI実装 |
| **ネジ** | ドメイン層ロジック | Python ビジネスロジック |
| **リー** | インフラ・バッチ | データパイプライン、自動化 |

**協調開発プロトコル**: [COLLABORATION_PROTOCOL.md](./COLLABORATION_PROTOCOL.md)
→ conversations/ フォルダを使った非同期協調開発の詳細ルール

---

### AIエージェントチーム（競馬予想）

#### 分析統括
| エージェント | 役割 | 主要任務 | 重要指標 |
|------------|------|----------|---------|
| **COMMANDER** | 全体統括 | チーム調整、最終判断 | 全体収支 |
| **ANALYST** | 分析統括 | データ統合、品質管理 | 分析精度 |
| **INVESTOR** | 投資判断 | 資金配分、リスク管理 | ROI |

#### 専門分析
| エージェント | 役割 | 主要任務 | 着目点 |
|------------|------|----------|--------|
| **STRATEGIST** | 展開予想 | レース展開、ペース分析 | 展開利不利 |
| **EVALUATOR** | 馬質評価 | 能力評価、適性判断 | 馬の実力 |
| **HANDICAPPER** | ハンデ分析 | 斤量影響、条件分析 | 条件適性 |
| **JOCKEY_SCOUT** | 騎手分析 | 騎手相性、技術評価 | 人馬一体度 |

#### 実行支援
| エージェント | 役割 | 主要任務 | 担当領域 |
|------------|------|----------|----------|
| **SCRAPER** | データ収集 | 競馬ブック、JRA-VAN連携 | データ取得 |
| **TRACKER** | リアルタイム追跡 | オッズ変動、情報更新 | 最新情報 |
| **EXECUTOR** | 実行管理 | システム運用、バッチ処理 | 安定稼働 |
| **GUARDIAN** | リスク管理 | 異常検知、損失防止 | リスク回避 |
| **LEARNER** | 継続学習 | モデル改善、知識蓄積 | 精度向上 |

## 📋 基本行動原則

### 競馬AI戦略の核心原則（松風ブログ知見）

> 詳細: `docs/knowledge/insights/matsukaze_core_insights.md`

#### 思想・戦略

1. **収支最大化 ≠ 回収率最大化**: 回収率を下げてでも購入金額を増やす方が利益は大きく安定する。EV > 1.0の馬券を全て購入する
2. **確率論的競馬観**: 「この馬が勝つ」ではなく「この馬の勝率は23%」と予測。評価は的中率ではなくキャリブレーション（較正精度）で行う
3. **オッズの歪みが利益の源泉**: 利益はAI予測確率と市場オッズの乖離（= 市場の非効率性）から生まれる
4. **税務設計はAI設計の一部**: 雑所得要件（自動購入、ほぼ全レース購入、購入記録の保存）を設計段階から織り込む

#### モデル設計

5. **アルゴリズムより特徴量**: scikit-learn 3行で十分。差別化は特徴量の質と予測対象の設計から生まれる
6. **過学習の徹底回避**: 小サンプル×多条件分け = ノイズへのフィット。血統×距離×コースの細分化分析は疑似科学
7. **スマートマネー効果**: 締切直前の馬券購入は的中率が高い。EV計算にバッファを織り込む

#### 購入戦略

8. **Themis原則（関心の分離）**: 購入決定モジュールの入力は「確率・オッズ・バンクロール残高」の3つだけ。馬名も騎手名も渡さない
9. **馬券ポートフォリオ**: 相関の低い馬券種を組み合わせてリスク分散（ワイド+枠連が推奨）
10. **バンクロール管理**: 複利は味方にも敵にもなる。追い下げ（バンク連動の購入金額調整）が破産防止の最終防衛ライン

#### 運用

11. **運用ミスが最大のリスク**: モデル精度より自動購入の信頼性・バンクロール同期の一貫性が収益に直結
12. **耐える期間にバンクを毀損しない**: 年間収支は少数の「当たり期間」が支配する。短期の負けで戦略を変えない

### 競馬予想における鉄則

1. **期待値重視**: 人気だけでなく、期待値（オッズ×勝率）で判断。EV > 1.0を全て購入対象とする
2. **データ根拠**: 感覚ではなく、データに基づく論理的判断
3. **リスク分散**: 馬券種ポートフォリオ（相関の低い組合せ）で適切に分散
4. **継続記録**: 予想と結果を必ず記録し、改善に活用。改ざん防止のタイムスタンプ付きログ
5. **楽しむ姿勢**: 推理の過程を楽しみ、負けても学びとする
6. **結果で判断しない**: 意思決定のクオリティ（期待値）で評価し、短期の的中/不的中で戦略を変えない

### 週末予想ワークフロー

```
金曜日:
1. 土日のレース日程取得
2. 注目レース選定（重賞・メインレース）
3. 出馬表・調教データ取得

土曜日朝:
1. 最新オッズ確認
2. 厩舎コメント分析
3. 予想確定・馬券購入計画

レース後:
1. 結果記録
2. 予想の振り返り
3. 改善点の抽出
```

## 💬 チーム連携システム

### ファイル配置
```
ai-team/
├── knowledge/
│   └── CLAUDE.md         # このファイル
├── experts/               # 各エージェント定義
│   ├── ANALYST.md
│   ├── COMMANDER.md
│   └── ...
├── to_ANALYST.md        # ANALYSTへの指示
├── from_ANALYST.md      # ANALYSTからの報告
└── project.md           # プロジェクト概要
```

### 報告フォーマット
```markdown
## [日付] [レース名] 分析レポート - [エージェント名]

### 推奨馬
- ◎ [馬番] [馬名] - 期待値: [数値]
- ○ [馬番] [馬名] - 期待値: [数値]

### 分析根拠
- [根拠1]
- [根拠2]

### リスク要因
- [懸念事項]

### 推奨買い目
- [券種]: [買い目] × [金額]
```

## 🛠️ 技術スタック

### データ収集層（SCRAPER担当）
- **スクレイピング**: Python + Requests/BeautifulSoup4
- **高速版**: RequestsScraper（8.6秒/12レース）
- **データ形式**: JSON（UTF-8）
- **並列処理**: 最大22並列

### 分析層（ANALYST統括）
- **言語**: Python 3.11+
- **分析**: pandas, numpy, scikit-learn
- **統計**: scipy, statsmodels
- **可視化**: matplotlib, plotly

### データ管理層（計画中）
- **メインDB**: PostgreSQL
- **ドキュメントDB**: MongoDB
- **検索**: Elasticsearch（日本語対応）
- **キャッシュ**: Redis

### 予測モデル（LEARNER担当）

> 詳細: `docs/knowledge/insights/ml_learning_roadmap.md`

- **目的変数**: 各馬の勝率/複勝率（確率推定）← 着順ではなく確率を予測
- **メインモデル**: LightGBM（表形式データで最強クラス、確率出力可能）
- **キャリブレーション**: Plattスケーリング / Isotonic Regression で較正必須
- **評価指標**: ブライアスコア、対数損失、キャリブレーションプロット（的中率ではなく較正精度）
- **交差検証**: Walk-Forward Validation（時系列分割。ランダム分割は未来の情報リーク）
- **深層学習**: レース映像解析・テキスト解析に拡張する際に導入（表形式だけならLightGBMで十分）

#### Themisモジュール（購入決定エンジン）
```
入力: P[i]=的中確率, O[i]=オッズ, B=バンクロール残高
計算: EV[i] = P[i] × O[i], bet[i] = B × Kelly(P[i], O[i]) × safety_factor
出力: {(馬券i, bet[i]) | EV[i] > threshold}
```

## 📁 プロジェクト構造

```
_keiba/
├── keiba-cicd-core/
│   ├── KeibaCICD.keibabook/     # データ取得システム
│   │   ├── src/
│   │   │   ├── batch_cli.py     # バッチ処理CLI
│   │   │   ├── fast_batch_cli.py # 高速版CLI
│   │   │   ├── scrapers/        # スクレイパー
│   │   │   └── parsers/         # パーサー
│   │   └── docs/                # ドキュメント
│   └── docs/                     # プロジェクト文書
├── ai-team/                      # AIチーム設定
└── 競馬場コースデータ/            # コース情報
```

## 🔄 開発ワークフロー

### データ取得コマンド
```bash
# 高速版（推奨）
cd keiba-cicd-core/KeibaCICD.keibabook
python -m src.fast_batch_cli full --start-date YYYY/MM/DD --delay 0.5

# 従来版（安定）
python -m src.batch_cli full --start-date YYYY/MM/DD --delay 3
```

### 予想フロー
1. **データ取得**: 金曜夜に週末データ取得
2. **分析実行**: 各エージェントが専門分析
3. **統合判定**: ANALYSTが総合評価
4. **投資判断**: INVESTORが買い目決定
5. **結果記録**: 的中・回収率を記録

## 📊 品質基準

### データ品質
- **取得成功率**: 95%以上
- **データ鮮度**: レース1時間前まで更新
- **欠損値**: 5%以下

### 予想品質
- **キャリブレーション**: 予測確率と実際の結果が一致（ブライアスコア基準）
- **回収率**: 年間100%以上（月次では下振れを許容。収束に数千レース必要）
- **EV精度**: 購入馬券の平均EV > 1.0

### システム品質
- **処理速度**: 12レース/10秒以内
- **エラー率**: 1%以下
- **可用性**: 週末100%稼働

## 🎯 重要KPI

### 週次指標
- **購入レース数/全レース数**: 80%以上を目標（税務要件「ほぼ全て」の充足）
- **購入馬券の平均EV**: 1.0超を維持
- **バンクロール変動率**: 追い下げが正常に機能しているか

### 月次指標
- **キャリブレーション精度**: ブライアスコア、予測確率と実際結果の一致度
- **的中率 vs 回収率の分離監視**: 的中率維持+回収率低下→チューニング見直し
- **最大ドローダウン**: 監視（複利では回収率100%を少し下回るだけで急速に溶ける）

### 年次指標
- **総合回収率**: 100%以上（統計的有意性を信頼区間で確認）
- **購入点数**: 年間2万点以上（税務要件「多数」の充足）
- **購入記録の完全性**: タイムスタンプ付きログの欠損率0%

## 🚀 当面の優先タスク

### Phase 1: 基盤構築（まず動くものを作る）
1. **確率推定モデルの構築**
   - LightGBMで各馬の勝率/複勝率を確率出力
   - 基本特徴量（馬基本情報、過去成績、枠順、騎手、馬場）の設計
   - Walk-Forward Validation（時系列交差検証）でのバックテスト
   - キャリブレーション（較正）の実装と評価

2. **EV計算の実装**
   - EV = AI予測確率 × オッズ の算出
   - EV > 1.0の馬券を全て抽出するロジック
   - 信頼区間付きバックテスト結果の表示

3. **購入ログの自動記録**
   - タイムスタンプ付き購入記録（予測値・EV計算根拠含む）
   - 改ざん防止を意識した保存設計（税務要件の充足）

### Phase 2: 購入エンジン（モデルが動いた後）
1. **Themis相当モジュール（購入決定エンジン）**
   - 入力: 確率、オッズ、バンクロール残高のみ
   - ケリー基準ベースの購入金額決定
   - 追い下げ（バンク連動の購入金額調整）

2. **馬券ポートフォリオ設計**
   - ワイドEV計算（全3着候補の条件付き期待値合算）
   - 馬券種間の的中相関行列の計算
   - ワイド+枠連の低相関ポートフォリオ構成

3. **特徴量エンジニアリング強化**
   - オッズ乖離度（AI予測 vs 市場オッズ）
   - スマートマネー補正（最終→確定オッズの変動予測）
   - 馬主クラブフラグ（応援馬券によるオッズ歪み指標）

### Phase 3: 運用・差別化
1. **監視・分析基盤**
   - 的中率/回収率の分離監視ダッシュボード
   - 試行間独立性の検定（ラン検定・自己相関）
   - モンテカルロシミュレーション（破産確率・ドローダウン分布）

2. **独自データの構築**
   - レース映像解析（位置取り、不利、コース取りの数値化）
   - ディープラーニング（CNN）の導入（映像→特徴量）
   - 独自データによる差別化（公開データだけでは競合と同質化）

3. **完全自動化**
   - 自動購入システム（リトライ・耐障害設計）
   - バンクロール同期の一貫性保証
   - 税務要件の自動チェック（購入レース比率、購入点数）

## ⚠️ リスク管理

### やってはいけないこと（松風ブログ教訓）
- **少数レースで戦略を判断しない**: 収束に数千レース必要。短期の結果でモデルを変えない
- **馬券種別の事後選択をしない**: 「ワイドが負けてるから止める」= サイコロの偏った目を選ぶのと同じ
- **小サンプル×多条件分けの分析をしない**: 種牡馬×距離×コース = 過学習（平均回帰で消える）
- **「流れ」で賭け金を変えない**: ホットハンド誤謬。固定ロジックで機械的に購入
- **チューニングを攻めすぎない**: EV閾値を下げすぎる（攻めすぎ）とドローダウンが指数的に拡大

### 資金管理
- **追い下げ方式**: 購入金額はバンクロール残高に連動。負けたら自動的に減額
- **複利の両刃性を認識**: バンクロールが増えても破産確率は下がらない（相対リスク一定）
- **ドローダウン監視**: 的中率維持+回収率低下→チューニング見直しのアラート

### システムリスク
- **運用ミスが最大のリスク**: 自動購入障害、入金漏れ、バンクロール同期バグ → モデル精度以上に収益を毀損
- **データ取得失敗**: リトライ処理とフォールバック
- **予測モデル劣化**: 定期的な再学習 + 的中率/回収率の分離監視
- **過学習**: 時系列交差検証（Walk-Forward）+ 正則化 + 信頼区間の表示

## 📚 参考情報

### 競馬データソース
- 競馬ブック: https://p.keibabook.co.jp/
- JRA公式: https://www.jra.go.jp/
- netkeiba: https://www.netkeiba.com/

### 分析手法（ML学習ロードマップ）

> 詳細: `docs/knowledge/insights/ml_learning_roadmap.md`

| 優先度 | 領域 | 内容 |
|--------|------|------|
| **最優先** | 確率・統計基礎 | 条件付き確率、期待値、大数の法則、仮説検定、信頼区間 |
| **高** | 教師あり学習 | 確率推定（predict_proba）、キャリブレーション、交差検証 |
| **高** | 勾配ブースティング | LightGBM（メイン）、特徴量重要度、パラメータチューニング |
| **高** | 特徴量エンジニアリング | 数値/カテゴリ/時系列特徴量、エンコーディング、特徴量選択 |
| 中 | 購入戦略の数理 | ケリー基準、ポートフォリオ理論、モンテカルロシミュレーション |
| 低〜中 | 教師なし学習 | クラスタリング（レースタイプ分類）、次元削減（PCA） |
| 拡張時 | ディープラーニング | CNN（映像解析）、NLP（テキスト解析）、TabNet |

### ナレッジベース

| ドキュメント | 内容 |
|---|---|
| `docs/knowledge/README.md` | ナレッジベース全体の索引 |
| `docs/knowledge/insights/matsukaze_core_insights.md` | 松風ブログ核心知見（17項目） |
| `docs/knowledge/insights/ml_learning_roadmap.md` | ML学習ロードマップ（Level 0〜5） |
| `docs/knowledge/features.md` | AI特徴量候補リスト |
| `docs/knowledge/blog-analyses/` | 個別ブログ分析ドキュメント（001-012） |

## 🔄 更新履歴

- 2025-02-11: v1.1 松風ブログ核心知見の反映（戦略原則、モデル設計、KPI、Phase計画を全面改訂）
- 2025-08-15: v1.0 初版作成（KeibaCICD用カスタマイズ）

---

*毎週の競馬を楽しみながら、データと論理でプラス収支を目指す。それが我々の使命です。*