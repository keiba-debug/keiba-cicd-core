# ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°é–‹ç™ºè¨ˆç”»

## 1. ç›®æ¨™

ç«¶é¦¬ãƒ–ãƒƒã‚¯ã®ãƒ‡ãƒ¼ã‚¿ã¨ãƒ¬ãƒ¼ã‚¹ãƒ©ãƒƒãƒ—ã‚’æ´»ç”¨ã—ã¦ã€å„é¦¬ã®ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°ï¼ˆèƒ½åŠ›æŒ‡æ•°ï¼‰ã‚’è¨ˆç®—ã—ã€TARGETã®å¤–éƒ¨æŒ‡æ•°ã¨ã—ã¦å–ã‚Šè¾¼ã‚€ã€‚

### æœ€çµ‚ç›®æ¨™

- **ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ—é‡è¦–**ã®æŒ‡æ•°ç®—å‡º
- é¦¬å ´è£œæ­£ãƒ»è·é›¢è£œæ­£ã‚’é©ç”¨
- TARGETã§å‡ºé¦¬è¡¨åˆ†æãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«æ´»ç”¨

---

## 2. ç¾çŠ¶åˆ†æ

### 2.1 æˆç¸¾JSONã®å–å¾—çŠ¶æ³

| ãƒ‡ãƒ¼ã‚¿é …ç›® | ç¾åœ¨ã®å–å¾—çŠ¶æ³ | ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°ã¸ã®é‡è¦åº¦ |
|:---|:---:|:---:|
| ç€é † | âœ… å–å¾—æ¸ˆã¿ | â—‹ |
| ã‚¿ã‚¤ãƒ ï¼ˆèµ°ç ´æ™‚è¨ˆï¼‰ | âœ… å–å¾—æ¸ˆã¿ | ğŸ”´å¿…é ˆ |
| ç€å·® | âœ… å–å¾—æ¸ˆã¿ | â—‹ |
| å‰åŠ3F | âœ… å–å¾—æ¸ˆã¿ | â—‹ |
| ä¸Šã‚Š3F | âœ… å–å¾—æ¸ˆã¿ | ğŸ”´å¿…é ˆ |
| é€šéé †ä½ | âœ… å–å¾—æ¸ˆã¿ | â—‹ |
| é¦¬ä½“é‡ | âœ… å–å¾—æ¸ˆã¿ | â–³ |
| **è·é›¢** | âŒ æœªå–å¾— | ğŸ”´å¿…é ˆ |
| **ã‚³ãƒ¼ã‚¹ç¨®åˆ¥ï¼ˆèŠ/ãƒ€ãƒ¼ãƒˆï¼‰** | âŒ æœªå–å¾— | ğŸ”´å¿…é ˆ |
| **é¦¬å ´çŠ¶æ…‹** | âŒ æœªå–å¾— | ğŸ”´å¿…é ˆ |
| **ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ** | âŒ æœªå–å¾—ï¼ˆå®Ÿè£…æ¸ˆã ãŒä¿å­˜ã•ã‚Œãšï¼‰ | ğŸ”´å¿…é ˆ |
| **é€šéã‚¿ã‚¤ãƒ ** | âŒ æœªå–å¾— | ğŸŸ¡é‡è¦ |
| **å¹³å‡ãƒãƒ­ãƒ³** | âŒ æœªå–å¾— | ğŸŸ¡é‡è¦ |
| **ãƒšãƒ¼ã‚¹ï¼ˆS/M/Hï¼‰** | âŒ æœªå–å¾—ï¼ˆå®Ÿè£…æ¸ˆã ãŒä¿å­˜ã•ã‚Œãšï¼‰ | ğŸŸ¡é‡è¦ |
| **é…å½“æƒ…å ±** | âŒ æœªå–å¾—ï¼ˆå®Ÿè£…æ¸ˆã ãŒä¿å­˜ã•ã‚Œãšï¼‰ | â–³ |

### 2.2 ç™ºè¦‹ã—ãŸå•é¡Œ

**`optimized_data_fetcher.py` ã§ã® seiseki ãƒ‘ãƒ¼ã‚¹å‡¦ç†**

```python
# ç¾çŠ¶ã®ã‚³ãƒ¼ãƒ‰ï¼ˆ258-266è¡Œç›®ï¼‰
if data_type == 'seiseki':
    race_info = self.seiseki_parser._extract_race_info(soup)
    results = self.seiseki_parser._extract_results(soup)
    interviews_and_memos = self.seiseki_parser._extract_interviews_and_memos(soup)
    results = self.seiseki_parser._merge_interview_memo_data(results, interviews_and_memos)
    race_info['race_id'] = race_id
    return {"race_info": race_info, "results": results}  # â† ä¸å®Œå…¨ï¼
```

**å•é¡Œç‚¹ï¼š**
- `_extract_payout_info()` ãŒå‘¼ã°ã‚Œã¦ã„ãªã„
- `_extract_race_details()` ãŒå‘¼ã°ã‚Œã¦ã„ãªã„ï¼ˆè·é›¢/é¦¬å ´/å¤©å€™ï¼‰
- `_extract_laps()` ãŒå‘¼ã°ã‚Œã¦ã„ãªã„ï¼ˆãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ï¼‰

---

## 3. æ”¹å–„ã‚¿ã‚¹ã‚¯

### Phase 1: ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ä¿®æ­£ãƒ»å¼·åŒ–

#### ã‚¿ã‚¹ã‚¯ 1-1: OptimizedDataFetcher ã®ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«:** `KeibaCICD.keibabook/src/batch/optimized_data_fetcher.py`

```python
# ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰
if data_type == 'seiseki':
    race_info = self.seiseki_parser._extract_race_info(soup)
    results = self.seiseki_parser._extract_results(soup)
    interviews_and_memos = self.seiseki_parser._extract_interviews_and_memos(soup)
    results = self.seiseki_parser._merge_interview_memo_data(results, interviews_and_memos)
    
    # è¿½åŠ : é…å½“ãƒ»ãƒ¬ãƒ¼ã‚¹è©³ç´°ãƒ»ãƒ©ãƒƒãƒ—
    payouts = self.seiseki_parser._extract_payout_info(soup)
    race_details = self.seiseki_parser._extract_race_details(soup)
    laps = self.seiseki_parser._extract_laps(soup)
    
    race_info['race_id'] = race_id
    return {
        "race_info": race_info,
        "results": results,
        "payouts": payouts,
        "race_details": race_details,
        "laps": laps
    }
```

#### ã‚¿ã‚¹ã‚¯ 1-2: SeisekiParser ã® _extract_race_details å¼·åŒ–

**ç¾çŠ¶ã®å•é¡Œï¼š**
- è·é›¢/ã‚³ãƒ¼ã‚¹ç¨®åˆ¥ã®æŠ½å‡ºãŒä¸å®‰å®š
- é¦¬å ´çŠ¶æ…‹ã®æŠ½å‡ºç²¾åº¦ãŒä½ã„
- ç«¶é¦¬ãƒ–ãƒƒã‚¯ã®HTMLæ§‹é€ ã«ç‰¹åŒ–ã—ãŸæŠ½å‡ºãŒå¿…è¦

**æ”¹å–„å†…å®¹ï¼š**
- ç”»åƒä¸Šéƒ¨ã®ã€Œ1å›ä¸­å±±5æ—¥ç›®ã€ã€Œ1200mï¼ˆãƒ€ãƒ¼ãƒˆãƒ»å³ï¼‰ã€ã€Œæ›‡ãƒ»è‰¯ã€ãªã©ã‚’ç¢ºå®Ÿã«å–å¾—
- æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã®èª¿æ•´

#### ã‚¿ã‚¹ã‚¯ 1-3: SeisekiParser ã® _extract_laps å¼·åŒ–

**ç¾çŠ¶ã®å•é¡Œï¼š**
- ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ æŠ½å‡ºãŒä¸æ­£ç¢ºï¼ˆå…¨ã¦ã®XX.Xãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å–å¾—ï¼‰
- ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ãŒæœªå–å¾—
- é€šéã‚¿ã‚¤ãƒ ãŒæœªå–å¾—

**æ”¹å–„å†…å®¹ï¼š**
- ã€Œãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç‰¹å®šã—ã¦æŠ½å‡º
- ã€Œé€šéã‚¿ã‚¤ãƒ ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç‰¹å®šã—ã¦æŠ½å‡º
- ã€Œã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ã€ã‚’æŠ½å‡º

#### ã‚¿ã‚¹ã‚¯ 1-4: æ–°è¦ãƒ‡ãƒ¼ã‚¿é …ç›®ã®è¿½åŠ 

**è¿½åŠ é …ç›®ï¼š**

| é …ç›® | èª¬æ˜ | æŠ½å‡ºå…ƒ |
|:---|:---|:---|
| corner_positions | ã‚³ãƒ¼ãƒŠãƒ¼é€šéé † | ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ã‚»ã‚¯ã‚·ãƒ§ãƒ³ |
| passage_times | é€šéã‚¿ã‚¤ãƒ ï¼ˆ600m, 800m...ï¼‰ | é€šéã‚¿ã‚¤ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ |
| avg_furlong | å¹³å‡ãƒãƒ­ãƒ³ | å¹³å‡ãƒãƒ­ãƒ³ãªã©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ |
| last_3f_time | ä¸Šã‚Š3Fã‚¿ã‚¤ãƒ ï¼ˆãƒ¬ãƒ¼ã‚¹å…¨ä½“ï¼‰ | å¹³å‡ãƒãƒ­ãƒ³ãªã©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ |
| decision | æ±ºã‚æ‰‹ | å¹³å‡ãƒãƒ­ãƒ³ãªã©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ |
| equipment | é¦¬è£…å…· | é¦¬è£…å…·ã‚»ã‚¯ã‚·ãƒ§ãƒ³ |
| start_notes | ç™ºèµ°çŠ¶æ³ä»– | ç™ºèµ°çŠ¶æ³ä»–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ |

---

### Phase 2: ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®è¨­è¨ˆ

#### 2-1: åŸºæœ¬å¼

```
ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•° = åŸºæº–ã‚¿ã‚¤ãƒ  - èµ°ç ´ã‚¿ã‚¤ãƒ  + é¦¬å ´è£œæ­£ + æ–¤é‡è£œæ­£ + ãƒšãƒ¼ã‚¹è£œæ­£
```

#### 2-2: åŸºæº–ã‚¿ã‚¤ãƒ ã®è¨­å®š

| è·é›¢ | èŠï¼ˆè‰¯ï¼‰ | ãƒ€ãƒ¼ãƒˆï¼ˆè‰¯ï¼‰ |
|:---:|:---:|:---:|
| 1000m | 57.0 | 59.0 |
| 1200m | 69.0 | 72.0 |
| 1400m | 81.0 | 85.0 |
| 1600m | 93.0 | 98.0 |
| 1800m | 105.0 | 111.0 |
| 2000m | 117.0 | 124.0 |
| ... | ... | ... |

#### 2-3: è£œæ­£é …ç›®

| è£œæ­£ | ç®—å‡ºæ–¹æ³• |
|:---|:---|
| é¦¬å ´è£œæ­£ | è‰¯=0, ç¨é‡=-1, é‡=-2, ä¸è‰¯=-3 |
| æ–¤é‡è£œæ­£ | (æ¨™æº–æ–¤é‡ - å®Ÿæ–¤é‡) Ã— 0.1 |
| ãƒšãƒ¼ã‚¹è£œæ­£ | H=+1, M=0, S=-1 |

#### 2-4: ãƒ©ãƒƒãƒ—åˆ†æï¼ˆå°†æ¥æ‹¡å¼µï¼‰

ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ—åˆ†é¡ï¼š
- **å‰å‚¾ãƒ©ãƒƒãƒ—**: å‰åŠ < å¾ŒåŠï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¹ï¼‰
- **å¾Œå‚¾ãƒ©ãƒƒãƒ—**: å‰åŠ > å¾ŒåŠï¼ˆã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹ï¼‰
- **å¹³å‡ãƒ©ãƒƒãƒ—**: å‰åŠ â‰ˆ å¾ŒåŠ

---

### Phase 3: å¤–éƒ¨æŒ‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ

#### 3-1: ç”Ÿæˆãƒ•ãƒ­ãƒ¼

```
1. seiseki_*.json ã‚’èª­ã¿è¾¼ã¿
2. race_details ã‹ã‚‰è·é›¢ãƒ»é¦¬å ´ã‚’å–å¾—
3. å„é¦¬ã®èµ°ç ´ã‚¿ã‚¤ãƒ ã‚’ç§’ã«å¤‰æ›
4. ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°ã‚’è¨ˆç®—
5. TARGETç”¨CSVå½¢å¼ã§å‡ºåŠ›
```

#### 3-2: å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

```csv
202601120601050101,85
202601120601050102,92
...
```

---

## 4. å®Ÿè£…å„ªå…ˆé †ä½

| å„ªå…ˆåº¦ | ã‚¿ã‚¹ã‚¯ | è¦‹ç©ã‚‚ã‚Š |
|:---:|:---|:---:|
| 1 | OptimizedDataFetcher ã®ä¿®æ­£ | 30åˆ† |
| 2 | SeisekiParser ã® _extract_race_details å¼·åŒ– | 1æ™‚é–“ |
| 3 | SeisekiParser ã® _extract_laps å¼·åŒ– | 1æ™‚é–“ |
| 4 | æ–°è¦ãƒ‡ãƒ¼ã‚¿é …ç›®ã®è¿½åŠ  | 1æ™‚é–“ |
| 5 | ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£… | 2æ™‚é–“ |
| 6 | å¤–éƒ¨æŒ‡æ•°CSVç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ | 1æ™‚é–“ |

---

## 5. æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿

### æ¤œè¨¼å¯¾è±¡ãƒ¬ãƒ¼ã‚¹

- **2026å¹´1æœˆ12æ—¥ ä¸­å±±12R**
  - race_id: `202601050512`
  - è·é›¢: 2000mï¼ˆèŠãƒ»å³ï¼‰
  - é¦¬å ´: è‰¯
  - ãƒ©ãƒƒãƒ—: 12.2-11.0-11.9-12.6-12.6-12.5...

### æœŸå¾…ã™ã‚‹å‡ºåŠ›ï¼ˆseiseki_*.jsonï¼‰

```json
{
  "race_info": {
    "race_name": "2026å¹´1æœˆ12æ—¥ä¸­å±±12R",
    "race_id": "202601050512"
  },
  "results": [...],
  "payouts": {
    "win": 4100,
    "place": [180, 1250, 190],
    ...
  },
  "race_details": {
    "distance": 2000,
    "track_type": "èŠ",
    "track_condition": "è‰¯",
    "weather": "æ›‡",
    "start_time": "16:25",
    "grade": null,
    "prize_money": []
  },
  "laps": {
    "lap_times": ["12.2", "11.0", "11.9", "12.6", "12.6", "12.5"],
    "passage_times": {
      "600m": "35.1",
      "800m": "47.7",
      "1000m": "1.00.3"
    },
    "avg_furlong": "12.13",
    "last_3f": "49.6-37.7",
    "pace": "M",
    "decision": "1ç€é¦¬å…ˆè¡ŒæŠœ 2ç€é¦¬å¥½ä½ä¼¸",
    "corner_positions": {
      "å‘æ­£é¢": "â‘¥5.7)3(3.8)(4.15)(11.12)(1.10.14)9.16)-2",
      "3è§’": "...",
      "4è§’": "..."
    }
  }
}
```

---

## 6. å‚è€ƒãƒªãƒ³ã‚¯

- [å¤–éƒ¨æŒ‡æ•°ä»•æ§˜.md](å¤–éƒ¨æŒ‡æ•°ä»•æ§˜.md)
- [seiseki_parser.py](../../KeibaCICD.keibabook/src/parsers/seiseki_parser.py)
- [optimized_data_fetcher.py](../../KeibaCICD.keibabook/src/batch/optimized_data_fetcher.py)
