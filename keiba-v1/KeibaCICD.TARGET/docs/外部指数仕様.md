# TARGET 外部指数 仕様書

## 1. 概要

### 外部指数とは

TARGET（TARGET frontier JV）に外部で作成した指数ファイルを取り込み、出馬表分析・戦歴・レース検索・馬券シミュレーションなどで表示・集計・分析に利用できる機能。

### 指数の種類

| 種類 | 説明 | TARGET対応 |
|:---|:---|:---:|
| **予想指数** | レース予想用。各馬に1つの数値（能力・順位など） | ✅ 対応済み |
| **結果指数** | 過去レース結果の指数化。馬ごとに複数値 | ⚠️ 将来対応予定 |

---

## 2. ファイル形式

### 2.1 単位

| 形式 | 1行の内容 | レースID桁数 | 推奨 |
|:---|:---|:---|:---:|
| **レース単位** | 1レース分（馬番順に指数を並べる） | 8/16/12桁 | |
| **馬単位** | 1頭分 | 10/18/14桁（馬番付き） | ⭐ |

### 2.2 フォーマット

| 形式 | 説明 | 速度 |
|:---|:---|:---:|
| **CSV形式** | カンマ区切り | 最速 ⭐ |
| **固定長形式** | 指数6桁、順位2桁など固定幅 | 普通 |

### 2.3 推奨構成

**馬単位・CSV形式**を採用

```csv
レースID(18桁),指数
202601120601050101,85
202601120601050102,92
202601120601050103,78
```

---

## 3. レースID（競走識別コード）仕様

### 3.1 TARGET対応の3仕様

| 仕様 | 馬番なし | 馬番あり | 構成 |
|:---|:---:|:---:|:---|
| **旧仕様** | 8桁 | 10桁 | `pp` + `yy` + `k` + `n` + `rr` [+ `uu`] |
| **新仕様（Data Lab）** | 16桁 | 18桁 | `yyyy` + `mm` + `dd` + `pp` + `kk` + `nn` + `rr` [+ `uu`] |
| **第3仕様（簡易）** | 12桁 | 14桁 | `yyyymmdd` + `pp` + `rr` [+ `uu`] |

### 3.2 推奨：新仕様（18桁・馬番付き）

```
yyyymmddppkknnrruu
```

| 位置 | 記号 | 意味 | 桁数 | 例 |
|:---:|:---|:---|:---:|:---|
| 1-4 | yyyy | 西暦年 | 4 | 2026 |
| 5-6 | mm | 月 | 2 | 01 |
| 7-8 | dd | 日 | 2 | 12 |
| 9-10 | pp | 場所コード | 2 | 06（中山） |
| 11-12 | kk | 回次 | 2 | 01 |
| 13-14 | nn | 日次 | 2 | 05 |
| 15-16 | rr | レース番号 | 2 | 01 |
| 17-18 | uu | 馬番 | 2 | 03 |

### 3.3 場所コード（JRA競馬場）

| コード | 競馬場 | コード | 競馬場 |
|:---:|:---|:---:|:---|
| 01 | 札幌 | 06 | 中山 |
| 02 | 函館 | 07 | 中京 |
| 03 | 福島 | 08 | 京都 |
| 04 | 新潟 | 09 | 阪神 |
| 05 | 東京 | 10 | 小倉 |

### 3.4 回次・日次の16進数（旧仕様のみ）

旧仕様では回次・日次が1桁で、10以上は16進数を使用：

| 値 | 1 | 2 | ... | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 |
|:---|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| 16進 | 1 | 2 | ... | 9 | A | B | C | D | E | F | 10 |

### 3.5 RXプレフィックス

先頭に `RX` を付けてもTARGETは認識可能（Excel対策用）：

```
RX202601120601050103
```

---

## 4. 競馬ブックデータからの変換

### 4.1 競馬ブック race_info.json の構造

```json
{
  "date": "20260112",
  "kaisai_data": {
    "1回中山5日目": [
      {
        "race_no": "1R",
        "race_id": "202601050501",
        "race_name": "3歳未勝利",
        "course": "ダ・1200m",
        "start_time": "09:50"
      }
    ],
    "1回京都5日目": [...]
  }
}
```

### 4.2 開催キーからの情報抽出

開催キー形式：`{回次}回{場所}{日次}日目`

| 開催キー | 回次 | 場所 | 日次 |
|:---|:---:|:---:|:---:|
| `1回中山5日目` | 1 | 中山 | 5 |
| `1回京都5日目` | 1 | 京都 | 5 |
| `2回東京3日目` | 2 | 東京 | 3 |

### 4.3 競馬ブック race_id の構造（12桁）

```
yyyykkppnnrr
```

| 位置 | 意味 | 例（202601050501） |
|:---|:---|:---|
| 1-4 | 年 | 2026 |
| 5-6 | 回次 | 01 |
| 7-8 | 場所コード（競馬ブック独自） | 05（中山） |
| 9-10 | 日次 | 05 |
| 11-12 | レース番号 | 01 |

### 4.4 場所コード変換テーブル

| 場所名 | 競馬ブック | TARGET |
|:---|:---:|:---:|
| 札幌 | 01 | 01 |
| 函館 | 02 | 02 |
| 福島 | 03 | 03 |
| 新潟 | 04 | 04 |
| 東京 | 04? | 05 |
| 中山 | 05 | 06 |
| 中京 | 06? | 07 |
| 京都 | 00 | 08 |
| 阪神 | 08? | 09 |
| 小倉 | 09? | 10 |

> ⚠️ 競馬ブックの場所コードは要検証。開催キーの場所名から変換する方が確実。

### 4.5 TARGET用レースID生成ロジック

```
入力:
  - date: "20260112"
  - kaisai_key: "1回中山5日目"
  - race_no: "1R"
  - umaban: 3

処理:
  1. kaisai_keyをパース → 回次=1, 場所=中山, 日次=5
  2. 場所名をTARGETコードに変換 → 06
  3. dateから年月日を取得 → 2026, 01, 12
  4. レース番号を抽出 → 01
  5. 馬番をゼロパディング → 03

出力:
  2026 + 01 + 12 + 06 + 01 + 05 + 01 + 03
  = 202601120601050103 (18桁)
```

---

## 5. 外部指数ファイル仕様

### 5.1 ファイル形式

- **形式**: 馬単位・CSV
- **文字コード**: Shift-JIS（CP932）
- **改行コード**: CRLF
- **ヘッダー**: なし

### 5.2 レコード形式

```
レースID(18桁),指数
```

### 5.3 指数の仕様

| 項目 | 仕様 |
|:---|:---|
| 型 | 整数または実数 |
| 範囲（整数） | -99999 〜 999999 |
| 範囲（実数） | 0.0 〜 9999.99 |
| 順位 | 指数から自動計算可能（TARGET側で付与） |

### 5.4 ファイル例

```csv
202601120601050101,85
202601120601050102,92
202601120601050103,78
202601120601050104,65
202601120601050105,88
202601120601050106,90
202601120601050107,72
202601120601050108,81
202601120601050109,95
202601120601050110,77
202601120601050111,83
202601120601050112,69
```

### 5.5 ファイル命名規則（推奨）

```
外部指数_{YYYYMMDD}.csv
外部指数_{YYYYMMDD}_{場所}.csv
外部指数_{YYYY}{MM}.csv
```

ファイルを分割すると読み込み速度が向上。

---

## 6. TARGET設定

### 6.1 環境設定

1. **環境設定 → 外部指数の設定** を開く
2. ファイル形式を選択：
   - 馬単位 / レース単位
   - CSV / 固定長
3. ファイルパスを指定
4. 表示する指数番号（No.1〜4）を設定

### 6.2 表示可能な画面

- 出馬表分析
- 戦歴・レース検索
- 馬券シミュレーション
- 馬データ画面

### 6.3 順位の扱い

- 順位情報がファイルにない場合、TARGETが自動付与
- 同値の場合は同順位
- 順位の優位方向（大きい方が上位/小さい方が上位）を設定可能

---

## 7. 実装計画

### 7.1 必要なスクリプト

| スクリプト | 機能 |
|:---|:---|
| `generate_external_index.py` | 外部指数ファイル生成 |
| `race_id_converter.py` | レースID変換ユーティリティ |

### 7.2 必要なデータ

| データ | 取得元 | 用途 |
|:---|:---|:---|
| 年月日 | race_info.json | レースID生成 |
| 回次・日次・場所 | kaisai_dataキー | レースID生成 |
| レース番号 | race_no | レースID生成 |
| 馬番 | shutsuba_*.json | レースID生成 |
| 指数計算用データ | 各種JSON | 指数算出 |

### 7.3 今後の確認事項

- [ ] 競馬ブック場所コードの完全な対応表を確認
- [ ] shutsuba_*.jsonの構造確認（馬番の取得）
- [ ] 指数計算ロジックの設計
- [ ] ファイル配置場所・命名規則の決定

---

## 参考リンク

- [TARGET FAQ - 外部指数](https://targetfaq.jra-van.jp/faq/detail?site=SVKNEGBV&id=642)
- [TARGET FAQ - 競走識別コード（レースID）](https://targetfaq.jra-van.jp/faq/detail?site=SVKNEGBV&category=47&id=658)
