# 馬過去レースマルチビュー機能 開発計画

## 概要

1頭の馬の過去レースを複数選択し、パドック・レース映像をマルチビューで並べて確認できる機能。

**ステータス: 実装完了 (2026-01-24)**

---

## 🎯 実現した機能

1. **馬プロファイルページ（WebViewer）**
   - 過去成績一覧にチェックボックスと「マルチビューに追加」ボタンを配置
   - 選択したレース情報をクエリパラメータとしてマルチビュー画面に渡す
   - `window.postMessage` を利用して、既存のマルチビューウィンドウへ追加可能

2. **マルチビュー画面**
   - 選択したレースのパドック/レース/パトロール映像を並べて表示
   - スロット数制限なし（スクロール対応）
   - 「すべて閉じる」ボタンで一括クリア
   - 馬ごとに別ウィンドウで開くことも可能（実装上は対応済み）

---

## 📊 実装詳細

### JRAビュアーURL生成の仕組み

1. **基本情報**: WebViewer上のレース情報（日付、競馬場、レース番号）を利用
2. **回次・日次補完**: 
   - `race_info.json` が存在する場合はそこから補完
   - 不足している場合は、日付と競馬場コードから推測またはデフォルト値を使用（一部制限あり）
3. **小倉競馬場の対応**:
   - 小倉のトラックコード（`10`）を正しく16進数変換してURL生成に使用するよう修正済み

### ファイル構成

- `src/components/horse-race-selector.tsx`: 馬プロファイルページ用のレース選択コンポーネント
- `src/app/multi-view/page.tsx`: マルチビュー画面本体
- `src/lib/jra-viewer-url.ts`: URL生成ロジック

---

## 📋 実装履歴

### Phase 1: 基盤整備
- [x] **1.1** 馬プロファイルMDから過去レース情報の抽出ロジック強化 (`horse-reader.ts`)
- [x] **1.2** race_info.json 検索APIの実装 (`/api/race-lookup`)
  - レース名だけでなく、距離などの条件も考慮してマッチング精度を向上
- [x] **1.3** 馬プロファイルページにレース選択UIを追加 (`horse-race-selector.tsx`)

### Phase 2: マルチビュー連携
- [x] **2.1** 馬ページ → マルチビュー連携
  - `window.open` と `postMessage` による連携
- [x] **2.2** JRAビュアーURL生成の拡張
  - 小倉競馬場対応、動画種別（パドック/レース/パトロール）の切替対応

### Phase 3: データ・スクレイピング拡張
- [ ] **3.1** 馬成績ページからレース番号を取得 (未実装)
  - 現状は `race_info.json` とのマッチングで対応中
- [ ] **3.2** 馬プロファイル再生成 (未実装)

### Phase 4: UI改善
- [x] **4.1** 馬ページのレース選択UI改善
  - 選択解除ボタン、追加ボタンの視認性向上
- [x] **4.2** マルチビューの機能改善
  - 動画種別切替ボタンの実装
  - スロット数制限の撤廃

---

## 🚀 今後の課題

1. **過去データの精度向上**
   - 古いレース（race_info.jsonがない期間）のレース番号特定
   - 競馬ブックのスクレイピングロジック拡張によるデータ補完

2. **映像同期再生**
   - 複数のレース映像のスタートタイミングを合わせて再生する機能（技術的に難易度高）

---
*最終更新日: 2026-01-24*
