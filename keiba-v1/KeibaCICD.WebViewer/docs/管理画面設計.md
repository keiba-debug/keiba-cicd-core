# 管理画面設計書

## 概要

競馬ブックデータの取得・統合・生成を GUI から実行できる管理画面。

## 利用シーン

- **前日準備**: 基本データ（出馬表、調教、談話）の取得
- **レース当日**: パドック情報・成績の取得、リアルタイム更新

## 要件

| 項目 | 内容 |
|------|------|
| 同時実行 | 不要（順次実行） |
| エラー通知 | 画面表示のみ |
| 実行権限 | 確認ダイアログなし |
| 認証 | なし（ローカル利用） |

---

## 画面設計

### URL構成

| URL | 内容 |
|-----|------|
| `/admin` | 管理画面トップ |
| `/admin/fetch` | データ取得 |
| `/admin/logs` | 実行ログ一覧（将来） |

### メイン画面 (`/admin`)

画面レイアウトは利便性を考慮し、一括実行アクションを最上部に配置。各セクションは折りたたみ可能（Collapsible）としています。

```
┌─────────────────────────────────────────────────────────┐
│  🏇 KEIBA Data Viewer                     📊 管理画面   │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  📅 対象日付                                             │
│  ┌──────────────────────────────────────────────────┐   │
│  │  [2026] 年 [01] 月 [24] 日   [今日に設定]        │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  ═══════════════════════════════════════════════════    │
│                                                          │
│  🚀 一括実行 (Collapsible)                              │
│  ┌──────────────────────────────────────────────────┐   │
│  │                                                    │   │
│  │  [🌅 前日準備]                                    │   │
│  │  スケジュール → 基本データ → 統合 → MD生成 → 馬PF │   │
│  │                                                    │   │
│  │  [🔄 レース後更新]                                │   │
│  │  パドック → 成績 → 統合 → MD生成                  │   │
│  │                                                    │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  📝 実行設定・オプション (Collapsible)                  │
│  ┌──────────────────────────────────────────────────┐   │
│  │  □ 取得対象レース: [1R] ～ [12R]                 │   │
│  │  □ 取得対象競馬場: [中山] [京都] [小倉]          │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  📥 データ取得 (Collapsible)                            │
│  ┌──────────────────────────────────────────────────┐   │
│  │  [📅 スケジュール取得] [📋 基本データ取得]       │   │
│  │  [🐎 パドック取得]     [🏆 成績取得]             │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  📝 データ統合・生成 (Collapsible)                      │
│  ┌──────────────────────────────────────────────────┐   │
│  │  [🔗 データ統合]       [📄 MD生成]               │   │
│  │  [🐴 馬プロフィール生成]                         │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  📋 実行ログ                                             │
│  ┌──────────────────────────────────────────────────┐   │
│  │  [10:30:15] 🟢 パドック取得開始...                │   │
│  │  [10:30:45] 🟢 中山 12レース 完了                 │   │
│  │  [10:31:15] ✅ パドック取得完了                   │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 機能一覧

### 一括実行

| ボタン | 実行順序 | 備考 |
|--------|----------|------|
| 前日準備 | スケジュール → 基本データ → 統合 → MD生成 → 馬PF | 馬プロファイル生成まで一気通貫 |
| レース後更新 | パドック → 成績 → 統合 → MD生成 | リアルタイム更新用 |

### データ取得

| ボタン | 実行コマンド | 説明 |
|--------|-------------|------|
| スケジュール取得 | `python -m src.fast_batch_cli schedule` | 開催日程 |
| 基本データ取得 | `python -m src.fast_batch_cli full --data-types shutsuba,cyokyo,danwa,syoin` | 出馬表等 |
| パドック取得 | `python -m src.fast_batch_cli full --data-types paddok` | パドック |
| 成績取得 | `python -m src.fast_batch_cli full --data-types seiseki` | レース結果 |

※ 各コマンドには `--start {date} --end {date}` が付与されます。
※ オプション設定により `--from-race`, `--to-race`, `--track` などのフィルタが適用可能です。

### データ統合・生成

| ボタン | 実行コマンド | 説明 |
|--------|-------------|------|
| データ統合 | `python -m src.integrator_cli batch --date {date}` | JSON統合 |
| MD生成 | `python -m src.markdown_cli batch --date {date} --organized` | MD生成 |
| 馬プロフィール生成 | `python -m src.horse_profile_cli --date {date} --all --with-history` | 馬詳細 |

---

## 状態管理

### 実行状態

```typescript
type ExecutionStatus = 
  | 'idle'       // 待機中
  | 'running'    // 実行中
  | 'success'    // 成功
  | 'error';     // エラー
```

---

## 実装状況

### Phase 1: 基本機能 (MVP)
- [x] 管理画面ページ作成 (`/admin`)
- [x] 日付選択コンポーネント
- [x] 単発実行ボタン
- [x] API Route でコマンド実行
- [x] ログ表示（リアルタイムSSE）

### Phase 2: UI/UX改善 & 機能拡張
- [x] 一括実行ボタン（前日準備、レース後更新）
- [x] セクションの折りたたみ (Collapsible)
- [x] レース番号範囲指定フィルタ
- [x] 競馬場指定フィルタ

---

## 注意事項

1. **ローカル専用**: このAPIはローカル環境でのみ動作する想定
2. **排他制御**: 同時に複数のコマンドは実行しない
3. **タイムアウト**: 長時間処理のため、タイムアウトは長めに設定（5分）

---
*最終更新日: 2026-01-24*
