# 競馬ブック データ取得システム - 環境構築ガイド

## 🚀 概要

競馬ブック データ取得システムの環境構築手順を詳しく説明します。初回セットアップから本格運用まで、段階的に進められます。

**最終更新**: 2025年8月9日  
**対象システム**: v2.3+（最適化版含む）  
**推奨環境**: Python 3.8+, 4GB RAM, 2GB ディスク

---

## 📋 システム要件

### 必須環境
- **OS**: Windows 10/11, macOS 10.15+, Linux (Ubuntu 20.04+ 推奨)
- **Python**: 3.8以上（3.9+ 推奨）
- **メモリ**: 4GB以上（8GB推奨）
- **ディスク**: 2GB以上の空き容量
- **ネットワーク**: 安定したインターネット接続

### 推奨環境
- **OS**: Windows 11, macOS 12+, Ubuntu 22.04 LTS
- **Python**: 3.10以上
- **メモリ**: 8GB以上
- **CPU**: 4コア以上（並列処理最適化のため）
- **ディスク**: SSD 5GB以上

### 対応ブラウザ（Cookie取得用）
- **Chrome**: 最新版（推奨）
- **Firefox**: 最新版
- **Edge**: 最新版

---

## 🔧 事前準備

### 1. Python環境確認
```bash
# Pythonバージョン確認
python --version
# または  
python3 --version

# pipバージョン確認
pip --version
# または
pip3 --version
```

**期待される出力例**:
```
Python 3.10.0
pip 23.0.1 from /usr/local/lib/python3.10/site-packages/pip (python 3.10)
```

### 2. Git確認（開発者向け）
```bash
git --version
```

### 3. ディスク容量確認
```bash
# Windows
dir C:\ 

# Linux/macOS  
df -h .
```

---

## 📦 システムインストール

### Phase 1: 基本セットアップ

#### 1. プロジェクトディレクトリ準備
```bash
# プロジェクトディレクトリに移動
cd /path/to/keiba-cicd-core/KeibaCICD.keibabook

# ディレクトリ構造確認
ls -la
```

**期待される構造**:
```
KeibaCICD.keibabook/
├── src/
├── scripts/
├── docs/
├── requirements.txt
└── .env（作成予定）
```

#### 2. Python仮想環境作成（推奨）
```bash
# 仮想環境作成
python -m venv keiba_env

# 仮想環境有効化
# Windows:
keiba_env\Scripts\activate
# Linux/macOS:
source keiba_env/bin/activate

# 有効化確認
which python  # 仮想環境のPythonが表示されるはず
```

#### 3. 依存関係インストール
```bash
# 最新pipにアップグレード
pip install --upgrade pip

# メイン依存関係インストール
pip install -r src/requirements.txt

# インストール確認
pip list | grep -E "(requests|beautifulsoup4|python-dotenv)"
```

**重要な依存関係**:
- `requests`: HTTP通信ライブラリ
- `beautifulsoup4`: HTMLパース
- `python-dotenv`: 環境変数管理
- `psutil`: システム監視
- `concurrent.futures`: 並列処理

### Phase 2: ディレクトリ構造設定

#### 1. 基本ディレクトリ作成
```bash
# データ保存ディレクトリ作成
mkdir -p data
mkdir -p data/race_ids
mkdir -p logs

# Windows PowerShell の場合
New-Item -ItemType Directory -Path "data" -Force
New-Item -ItemType Directory -Path "data\race_ids" -Force  
New-Item -ItemType Directory -Path "logs" -Force
```

#### 2. 権限設定（Linux/macOS）
```bash
# ディレクトリ権限設定
chmod 755 data/
chmod 755 data/race_ids/
chmod 755 logs/

# 書き込み権限確認
touch data/test_write && rm data/test_write && echo "✅ 書き込みOK"
```

#### 3. ディレクトリ構造確認
```bash
# 完成した構造を確認
tree -L 2
# または
find . -type d -maxdepth 2 | sort
```

**期待される構造**:
```
.
├── data/
│   └── race_ids/
├── logs/
├── src/
└── scripts/
```

---

## ⚙️ システム設定

### Phase 3: 環境変数設定

#### 1. .envファイル作成
```bash
# .envファイルのテンプレート作成
cat > .env << 'EOF'
# データ保存設定
KEIBA_DATA_ROOT_DIR=./data

# ログ設定  
LOG_LEVEL=INFO

# 認証設定（後で設定）
KEIBABOOK_SESSION=
KEIBABOOK_TK=
KEIBABOOK_XSRF_TOKEN=

# オプション設定
DEBUG=false
DEFAULT_TIMEOUT=30
DEFAULT_SLEEP_TIME=1.0
MAX_RETRY_COUNT=3
EOF
```

#### 2. 環境変数設定の確認
```bash
# 設定ファイル表示
cat .env

# 環境変数読み込みテスト
python -c "
from dotenv import load_dotenv
import os
load_dotenv()
print(f'データディレクトリ: {os.getenv(\"KEIBA_DATA_ROOT_DIR\", \"未設定\")}')
print(f'ログレベル: {os.getenv(\"LOG_LEVEL\", \"未設定\")}')
"
```

### Phase 4: 基本動作確認

#### 1. Pythonモジュール確認
```bash
# システムモジュールのインポート確認
python -c "
import sys
print(f'Python: {sys.version}')
import requests
print(f'requests: {requests.__version__}')  
import bs4
print(f'beautifulsoup4: {bs4.__version__}')
import psutil
print(f'psutil: {psutil.__version__}')
print('✅ 全モジュール正常')
"
```

#### 2. システム内部構造確認
```bash
# プロジェクト内部確認
python -c "
import os
import sys
sys.path.insert(0, 'src')

try:
    from keibabook.utils.config import Config
    print('✅ Config モジュール: OK')
except ImportError as e:
    print(f'❌ Config モジュール: {e}')

try:
    from keibabook.batch.core.common import parse_date
    print('✅ Common モジュール: OK') 
except ImportError as e:
    print(f'❌ Common モジュール: {e}')
"
```

#### 3. CLIシステム確認
```bash
# 従来版CLI
python -m src.batch_cli --help
echo "従来版CLI確認: $?"

# 高速版CLI（現在修正中の可能性有り）
python -m src.fast_batch_cli --help 2>/dev/null && echo "✅ 高速版CLI: OK" || echo "⚠️ 高速版CLI: 修正中"
```

---

## 🔐 認証設定

### Phase 5: Cookie認証設定

#### 1. 競馬ブックサイトでのCookie取得

**手順**:
1. ブラウザで https://p.keibabook.co.jp/ にアクセス
2. アカウントでログイン
3. **F12キー**を押して開発者ツールを開く
4. **Application（アプリケーション）**タブをクリック
5. **Storage（ストレージ）** → **Cookies** → **https://p.keibabook.co.jp** を選択

**取得が必要なCookie**:
- `keibabook_session`
- `tk`  
- `XSRF-TOKEN`

#### 2. .envファイルにCookie設定
```bash
# .envファイルを編集（実際の値に置き換える）
nano .env
```

**設定例**:
```bash
# 認証設定（実際の値に置き換え）
KEIBABOOK_SESSION=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
KEIBABOOK_TK=abcd1234efgh5678ijkl...
KEIBABOOK_XSRF_TOKEN=1234567890abcdef...
```

#### 3. Cookie設定確認
```bash
# Cookie設定テスト
python -c "
import os
from dotenv import load_dotenv
load_dotenv()

cookies = {
    'KEIBABOOK_SESSION': os.getenv('KEIBABOOK_SESSION', ''),
    'KEIBABOOK_TK': os.getenv('KEIBABOOK_TK', ''),
    'KEIBABOOK_XSRF_TOKEN': os.getenv('KEIBABOOK_XSRF_TOKEN', '')
}

for name, value in cookies.items():
    status = '✅ 設定済み' if value else '❌ 未設定'
    print(f'{name}: {status}')
"
```

---

## 🧪 初回動作テスト

### Phase 6: システム動作確認

#### 1. 設定確認テスト
```bash
# システム設定の総合確認
python -c "
import sys
sys.path.insert(0, 'src')
from dotenv import load_dotenv
import os

load_dotenv()
print('=== システム設定確認 ===')
print(f'データディレクトリ: {os.getenv(\"KEIBA_DATA_ROOT_DIR\")}')
print(f'ログレベル: {os.getenv(\"LOG_LEVEL\")}')

# Cookie確認
cookies_ok = all([
    os.getenv('KEIBABOOK_SESSION'),
    os.getenv('KEIBABOOK_TK'), 
    os.getenv('KEIBABOOK_XSRF_TOKEN')
])
print(f'Cookie設定: {\"✅ OK\" if cookies_ok else \"❌ NG\"}')

# ディレクトリ確認
import pathlib
data_dir = pathlib.Path(os.getenv('KEIBA_DATA_ROOT_DIR', 'data'))
print(f'データディレクトリ存在: {\"✅ OK\" if data_dir.exists() else \"❌ NG\"}')
"
```

#### 2. ネットワーク接続確認
```bash
# 競馬ブックサイトへの接続確認
python -c "
import requests
try:
    response = requests.get('https://p.keibabook.co.jp/', timeout=10)
    print(f'✅ 接続OK: HTTP {response.status_code}')
except Exception as e:
    print(f'❌ 接続NG: {e}')
"
```

#### 3. 最小限のデータ取得テスト
```bash
# 従来版での簡易テスト（開催がある日を指定）
python -m src.batch_cli schedule --start-date 2024/12/28 --debug

# 結果確認
ls -la data/race_ids/
```

**期待される結果**:
```
data/race_ids/20241228_info.json  # レースID情報ファイル
```

---

## 🔧 トラブルシューティング

### よくある問題と解決方法

#### 1. Python/pip関連
```bash
# 問題: ModuleNotFoundError
# 解決: 仮想環境の確認・再作成
deactivate  # 仮想環境を終了
rm -rf keiba_env  # 仮想環境削除
python -m venv keiba_env  # 再作成
source keiba_env/bin/activate  # 再有効化
pip install -r src/requirements.txt  # 再インストール
```

#### 2. 権限関連（Linux/macOS）
```bash
# 問題: Permission denied
# 解決: 権限設定
chmod 755 data/
chmod 755 logs/
sudo chown -R $USER:$USER data/ logs/
```

#### 3. Windows特有の問題
```powershell
# 問題: 実行ポリシー制限
# 解決: PowerShell実行ポリシー変更
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# 文字化け問題解決
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
```

#### 4. 環境変数関連
```bash
# 問題: 環境変数が読み込まれない
# 解決: .envファイル確認
cat .env  # ファイル存在確認
python -c "from dotenv import load_dotenv; load_dotenv(); print('OK')"
```

---

## 🎯 環境構築チェックリスト

### ✅ 必須項目
- [ ] Python 3.8+インストール済み
- [ ] pip最新版にアップグレード済み
- [ ] 仮想環境作成・有効化済み
- [ ] 依存関係インストール済み
- [ ] 基本ディレクトリ作成済み
- [ ] .envファイル作成済み
- [ ] Cookie取得・設定済み
- [ ] 基本動作確認済み

### ✅ 推奨項目  
- [ ] SSD使用（パフォーマンス向上）
- [ ] 8GB以上RAM（並列処理最適化）
- [ ] ログローテーション設定
- [ ] バックアップディレクトリ設定
- [ ] 監視・アラート設定（将来対応）

### ✅ 開発者向け項目
- [ ] Git設定済み
- [ ] コードエディタ設定済み
- [ ] デバッグ環境設定済み
- [ ] テスト実行環境確認済み

---

## 🚀 次のステップ

環境構築完了後の推奨手順：

1. **初期設定**: [セットアップ/初期設定.md](初期設定.md) でCookie詳細設定
2. **基本操作**: [使い方/基本操作.md](../使い方/基本操作.md) で従来版CLI操作習得
3. **高速版**: [使い方/高速版の使い方.md](../使い方/高速版の使い方.md) で最適化版活用
4. **運用設定**: [運用/監視とログ.md](../運用/監視とログ.md) でモニタリング設定

---

**🎉 環境構築が完了したら、実際のデータ取得を開始できます！安定した運用のために、段階的にシステムを習得していきましょう。**