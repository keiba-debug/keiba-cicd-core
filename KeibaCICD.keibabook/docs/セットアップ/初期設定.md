# 競馬ブック データ取得システム - 初期設定ガイド

## 🔧 概要

環境構築完了後の詳細な初期設定手順を説明します。Cookie認証の詳細設定、環境変数の最適化、システムの動作確認まで網羅します。

**最終更新**: 2025年8月9日  
**前提条件**: [環境構築.md](環境構築.md)の完了  
**所要時間**: 30-60分

---

## 🍪 Cookie認証設定（詳細版）

### Phase 1: 競馬ブックサイトでの認証情報取得

#### 1. ブラウザでのログイン
```
URL: https://p.keibabook.co.jp/
```

**手順**:
1. 競馬ブックの公式サイトにアクセス
2. 右上の「ログイン」をクリック
3. アカウント情報でログイン
4. ログイン成功を確認

#### 2. 開発者ツールでのCookie取得

**Chrome での手順**:
1. **F12キー**を押して開発者ツール起動
2. **Application**タブをクリック
3. 左側メニューの**Storage**を展開
4. **Cookies**を展開
5. **https://p.keibabook.co.jp**をクリック

**取得するCookie一覧**:

| Cookie名 | 説明 | 例 |
|----------|------|-----|
| `keibabook_session` | セッションID | `eyJ0eXAiOiJKV1QiLCJhbGci...` |
| `tk` | 認証トークン | `abcd1234efgh5678...` |
| `XSRF-TOKEN` | CSRF保護トークン | `1234567890abcdef...` |

#### 3. Cookieの有効性確認

**手順**:
1. 各Cookieの値をメモ帳にコピー
2. 値が空でないことを確認
3. 有効期限が十分長いことを確認

**注意点**:
- Cookieは一定期間で無効になります
- 値にスペースや改行が含まれていないことを確認
- 特殊文字（`"`, `'`, `\`など）に注意

---

## ⚙️ 環境変数詳細設定

### Phase 2: .env ファイルの詳細設定

#### 1. .envファイルの全項目設定
```bash
# .envファイルを編集
nano .env
# または Windows の場合
notepad .env
```

**完全な.envファイル例**:
```bash
# === データ保存設定 ===
KEIBA_DATA_ROOT_DIR=./data
KEIBA_DATA_DIR=./data  
KEIBA_DEBUG_DIR=./data/debug
KEIBA_LOG_DIR=./logs

# === 認証設定 ===
KEIBABOOK_SESSION=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
KEIBABOOK_TK=abcd1234efgh5678ijkl...  
KEIBABOOK_XSRF_TOKEN=1234567890abcdef...

# === ログ設定 ===
LOG_LEVEL=INFO
DEBUG=false

# === 処理パラメータ設定 ===
DEFAULT_TIMEOUT=30
DEFAULT_SLEEP_TIME=1.0
MAX_RETRY_COUNT=3
DEFAULT_DELAY=1

# === 並列処理設定 ===
MAX_WORKERS=5
CONNECTION_POOL_SIZE=10

# === 品質監視設定 ===
QUALITY_THRESHOLD=95.0
ALERT_ENABLED=true

# === その他設定 ===
USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
```

#### 2. Windows PowerShell での環境変数設定
```powershell
# PowerShellでの一時的な環境変数設定
$env:KEIBA_DATA_ROOT_DIR = "C:\keiba_data"
$env:LOG_LEVEL = "INFO"

# 永続的な設定（ユーザー環境変数）
[Environment]::SetEnvironmentVariable("KEIBA_DATA_ROOT_DIR", "C:\keiba_data", "User")
[Environment]::SetEnvironmentVariable("LOG_LEVEL", "INFO", "User")

# 設定確認
echo $env:KEIBA_DATA_ROOT_DIR
```

#### 3. Linux/macOS での環境変数設定
```bash
# ~/.bashrc または ~/.zshrc への追加
echo 'export KEIBA_DATA_ROOT_DIR="/home/user/keiba_data"' >> ~/.bashrc
echo 'export LOG_LEVEL="INFO"' >> ~/.bashrc

# 即座に反映
source ~/.bashrc

# 設定確認
echo $KEIBA_DATA_ROOT_DIR
```

---

## 📁 ディレクトリ構造最適化

### Phase 3: 詳細ディレクトリ設定

#### 1. カスタムディレクトリ構造作成
```bash
# 基本構造（統一保存）
mkdir -p "$KEIBA_DATA_ROOT_DIR"
mkdir -p "$KEIBA_DATA_ROOT_DIR/race_ids"  
mkdir -p "$KEIBA_LOG_DIR"
mkdir -p "$KEIBA_DEBUG_DIR"

# バックアップディレクトリ（推奨）
mkdir -p "$KEIBA_DATA_ROOT_DIR/backup"
mkdir -p "$KEIBA_DATA_ROOT_DIR/archive"

# 一時ディレクトリ
mkdir -p "$KEIBA_DATA_ROOT_DIR/tmp"

# Windows PowerShell版
New-Item -ItemType Directory -Path "$env:KEIBA_DATA_ROOT_DIR" -Force
New-Item -ItemType Directory -Path "$env:KEIBA_DATA_ROOT_DIR\race_ids" -Force
New-Item -ItemType Directory -Path "$env:KEIBA_LOG_DIR" -Force
```

#### 2. ディレクトリ権限設定（Linux/macOS）
```bash
# 所有者とグループ設定
sudo chown -R $USER:$USER "$KEIBA_DATA_ROOT_DIR"
sudo chown -R $USER:$USER "$KEIBA_LOG_DIR"

# アクセス権限設定
chmod 755 "$KEIBA_DATA_ROOT_DIR"
chmod 755 "$KEIBA_DATA_ROOT_DIR/race_ids"
chmod 755 "$KEIBA_LOG_DIR"
chmod 755 "$KEIBA_DEBUG_DIR"

# 書き込み権限確認
touch "$KEIBA_DATA_ROOT_DIR/test_write" && rm "$KEIBA_DATA_ROOT_DIR/test_write" && echo "✅ 書き込みOK"
```

#### 3. ディスク容量設定確認
```bash
# ディスク使用量確認
df -h "$KEIBA_DATA_ROOT_DIR"

# 利用可能容量確認（推奨: 2GB以上）
python -c "
import os
import shutil
data_dir = os.getenv('KEIBA_DATA_ROOT_DIR', './data')
total, used, free = shutil.disk_usage(data_dir)
print(f'総容量: {total // (1024**3)} GB')
print(f'使用済み: {used // (1024**3)} GB') 
print(f'利用可能: {free // (1024**3)} GB')
if free // (1024**3) < 2:
    print('⚠️ 警告: 利用可能容量が2GB未満です')
else:
    print('✅ 容量OK')
"
```

---

## 🔍 システム動作確認

### Phase 4: 詳細動作テスト

#### 1. Cookie認証テスト
```bash
# Cookie認証の詳細テスト
python -c "
import sys
sys.path.insert(0, 'src')
from dotenv import load_dotenv
from keibabook.batch.core.common import create_authenticated_session
import os

load_dotenv()

# Cookie確認
cookies = {
    'KEIBABOOK_SESSION': os.getenv('KEIBABOOK_SESSION', ''),
    'KEIBABOOK_TK': os.getenv('KEIBABOOK_TK', ''),  
    'KEIBABOOK_XSRF_TOKEN': os.getenv('KEIBABOOK_XSRF_TOKEN', '')
}

print('=== Cookie設定確認 ===')
for name, value in cookies.items():
    if value:
        print(f'✅ {name}: 設定済み ({len(value)}文字)')
    else:
        print(f'❌ {name}: 未設定')

# セッション作成テスト
try:
    session = create_authenticated_session()
    print('✅ 認証セッション作成: OK')
    
    # テストリクエスト
    response = session.get('https://p.keibabook.co.jp/', timeout=10)
    print(f'✅ テストリクエスト: HTTP {response.status_code}')
except Exception as e:
    print(f'❌ 認証テスト失敗: {e}')
"
```

#### 2. システムコンポーネント確認
```bash
# 主要モジュールの詳細確認
python -c "
import sys
sys.path.insert(0, 'src')

components = [
    ('keibabook.utils.config', 'Config'),
    ('keibabook.batch.core.common', 'BatchStats'),
    ('keibabook.batch.data_fetcher', 'DataFetcher'),
    ('keibabook.batch.optimized_data_fetcher', 'OptimizedDataFetcher'),
    ('keibabook.scrapers.requests_scraper', 'RequestsScraper'),
    ('keibabook.parsers.seiseki_parser', 'SeisekiParser'),
]

print('=== システムコンポーネント確認 ===')
for module_name, class_name in components:
    try:
        module = __import__(module_name, fromlist=[class_name])
        cls = getattr(module, class_name)
        print(f'✅ {module_name}.{class_name}: OK')
    except Exception as e:
        print(f'❌ {module_name}.{class_name}: {e}')
"
```

#### 3. ファイル保存テスト
```bash
# ファイル保存・読み込みテスト
python -c "
import sys
sys.path.insert(0, 'src')
from dotenv import load_dotenv
from keibabook.batch.core.common import get_json_file_path, get_race_ids_file_path
import json
import os

load_dotenv()

# テストデータ
test_data = {
    'test': 'データ保存テスト',
    'timestamp': '2025-08-09',
    'status': 'OK'
}

print('=== ファイル保存テスト ===')

# JSON保存テスト
try:
    json_path = get_json_file_path('test', '20250809')
    with open(json_path, 'w', encoding='utf-8') as f:
        json.dump(test_data, f, ensure_ascii=False, indent=2)
    print(f'✅ JSON保存: {json_path}')
    
    # 読み込み確認
    with open(json_path, 'r', encoding='utf-8') as f:
        loaded_data = json.load(f)
    print(f'✅ JSON読み込み: {loaded_data[\"test\"]}')
    
    # クリーンアップ
    os.unlink(json_path)
    print('✅ テストファイル削除完了')
    
except Exception as e:
    print(f'❌ ファイル保存テスト失敗: {e}')
"
```

---

## 🚀 実データでの動作確認

### Phase 5: 実環境テスト

#### 1. 最小限のレース日程取得テスト
```bash
# 開催がある日でのテスト（例: 2024年12月28日）
python -m src.batch_cli schedule --start-date 2024/12/28 --debug

# 結果確認
echo "=== 取得結果確認 ==="
ls -la "$KEIBA_DATA_ROOT_DIR/race_ids/"

# JSON内容確認
if [ -f "$KEIBA_DATA_ROOT_DIR/race_ids/20241228_info.json" ]; then
    echo "✅ レースID取得成功"
    python -c "
import json
with open('$KEIBA_DATA_ROOT_DIR/race_ids/20241228_info.json', 'r', encoding='utf-8') as f:
    data = json.load(f)
print(f'取得開催数: {len(data.get(\"kaisai_data\", {}))}')
total_races = sum(len(races) for races in data.get('kaisai_data', {}).values())
print(f'総レース数: {total_races}')
"
else
    echo "❌ レースID取得失敗または開催なし"
fi
```

#### 2. 単一レースデータ取得テスト
```bash
# 特定レースの成績データ取得テスト
python -m src.batch_cli data --start-date 2024/12/28 --data-types seiseki --debug

# 結果確認
echo "=== 成績データ確認 ==="
ls -la "$KEIBA_DATA_ROOT_DIR/"seiseki_*.json | head -3

# 最初のファイルの内容確認
FIRST_FILE=$(ls "$KEIBA_DATA_ROOT_DIR/"seiseki_*.json 2>/dev/null | head -1)
if [ -f "$FIRST_FILE" ]; then
    echo "✅ 成績データ取得成功: $(basename $FIRST_FILE)"
    python -c "
import json
with open('$FIRST_FILE', 'r', encoding='utf-8') as f:
    data = json.load(f)
print(f'レース名: {data.get(\"race_info\", {}).get(\"race_name\", \"不明\")}')
print(f'出走頭数: {len(data.get(\"results\", []))}頭')
"
else
    echo "❌ 成績データ取得失敗"
fi
```

#### 3. 高速版動作確認（可能な場合）
```bash
# 高速版のテスト（修正済みの場合）
python -m src.fast_batch_cli schedule --start-date 2024/12/28 --delay 1 --debug 2>/dev/null
if [ $? -eq 0 ]; then
    echo "✅ 高速版動作確認成功"
else
    echo "⚠️ 高速版は現在修正中です（従来版を使用してください）"
fi
```

---

## 📊 システム設定の最適化

### Phase 6: 性能最適化設定

#### 1. メモリ使用量最適化設定
```bash
# メモリ設定確認・最適化
python -c "
import psutil
import os
from dotenv import load_dotenv

load_dotenv()

# システムメモリ確認
mem = psutil.virtual_memory()
print(f'=== システムメモリ情報 ===')
print(f'総メモリ: {mem.total // (1024**3)} GB')
print(f'利用可能: {mem.available // (1024**3)} GB')
print(f'使用率: {mem.percent}%')

# 推奨設定
if mem.total >= 8 * (1024**3):  # 8GB以上
    rec_workers = 12
    rec_delay = 0.3
elif mem.total >= 4 * (1024**3):  # 4GB以上
    rec_workers = 8
    rec_delay = 0.5
else:
    rec_workers = 3
    rec_delay = 1.0

print(f'\\n=== 推奨設定 ===')
print(f'MAX_WORKERS: {rec_workers}')
print(f'DEFAULT_DELAY: {rec_delay}')

# .envファイル更新提案
print(f'\\n# .envファイルに追加することを推奨:')
print(f'MAX_WORKERS={rec_workers}')  
print(f'DEFAULT_DELAY={rec_delay}')
"
```

#### 2. ネットワーク設定最適化
```bash
# ネットワーク接続テスト・最適化
python -c "
import requests
import time

print('=== ネットワーク性能テスト ===')

# 接続速度テスト
start_time = time.time()
try:
    response = requests.get('https://p.keibabook.co.jp/', timeout=10)
    elapsed = time.time() - start_time
    print(f'接続時間: {elapsed:.2f}秒')
    
    if elapsed < 1.0:
        print('✅ 高速接続 - delay 0.3秒推奨') 
    elif elapsed < 3.0:
        print('✅ 標準接続 - delay 0.5-1.0秒推奨')
    else:
        print('⚠️ 低速接続 - delay 2.0秒以上推奨')
        
except Exception as e:
    print(f'❌ 接続テスト失敗: {e}')
"
```

---

## 🔒 セキュリティ設定

### Phase 7: セキュリティ強化

#### 1. ファイル権限の詳細設定（Linux/macOS）
```bash
# .envファイルのセキュリティ強化
chmod 600 .env  # 所有者のみ読み書き可能
ls -la .env

# データディレクトリの適切な権限設定
find "$KEIBA_DATA_ROOT_DIR" -type d -exec chmod 755 {} \;
find "$KEIBA_DATA_ROOT_DIR" -type f -exec chmod 644 {} \;

echo "✅ ファイル権限設定完了"
```

#### 2. Cookieの定期更新設定
```bash
# Cookie有効期限チェッカーの作成
cat > check_cookies.py << 'EOF'
#!/usr/bin/env python3
import sys
sys.path.insert(0, 'src')
from dotenv import load_dotenv
from keibabook.batch.core.common import create_authenticated_session
import requests
import os

load_dotenv()

def check_cookies():
    """Cookie有効性確認"""
    try:
        session = create_authenticated_session()
        response = session.get('https://p.keibabook.co.jp/', timeout=10)
        
        if response.status_code == 200:
            print("✅ Cookie有効")
            return True
        else:
            print(f"⚠️ Cookie無効の可能性: HTTP {response.status_code}")
            return False
            
    except Exception as e:
        print(f"❌ Cookie確認失敗: {e}")
        return False

if __name__ == "__main__":
    check_cookies()
EOF

chmod +x check_cookies.py
python check_cookies.py
```

---

## ✅ 初期設定完了チェックリスト

### 🍪 認証設定
- [ ] 競馬ブックサイトでログイン確認
- [ ] 3つのCookie取得完了
- [ ] .envファイルへの設定完了
- [ ] Cookie認証テスト成功

### ⚙️ 環境変数設定  
- [ ] .envファイル全項目設定完了
- [ ] ディレクトリパス設定確認
- [ ] ログレベル設定確認
- [ ] 処理パラメータ設定確認

### 📁 ディレクトリ設定
- [ ] 基本ディレクトリ作成完了
- [ ] 権限設定完了（Linux/macOS）
- [ ] ディスク容量確認完了
- [ ] 書き込みテスト成功

### 🔍 動作確認
- [ ] システムコンポーネント確認完了
- [ ] ファイル保存テスト成功
- [ ] 実データ取得テスト成功  
- [ ] ログ出力確認完了

### 📊 性能最適化
- [ ] メモリ使用量確認完了
- [ ] 推奨設定値確認完了
- [ ] ネットワーク性能確認完了

### 🔒 セキュリティ
- [ ] ファイル権限設定完了
- [ ] Cookie定期確認設定完了

---

## 🚀 次のステップ

初期設定完了後の推奨アクション：

1. **基本操作習得**: [使い方/基本操作.md](../使い方/基本操作.md)で従来版CLI操作
2. **高速版活用**: [使い方/高速版の使い方.md](../使い方/高速版の使い方.md)で最適化版習得
3. **定期運用**: [使い方/バッチ処理.md](../使い方/バッチ処理.md)で自動化設定
4. **監視設定**: [運用/監視とログ.md](../運用/監視とログ.md)でモニタリング

---

**🎉 初期設定が完了しました！これで競馬ブックからのデータ取得を本格的に開始できます。段階的に機能を習得して、効率的なデータ収集を実現しましょう。**