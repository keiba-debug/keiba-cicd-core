# 実行コマンド一覧

## 📋 完全自動実行（推奨）

### 本番環境向け - 元ファイル削除付き完全処理

```bash
# 8月16日のデータを完全処理（拡張版MD新聞）
# ステップ1: 全データタイプを高速取得
python -m src.fast_batch_cli full --start 2025/08/16 --end 2025/08/16 --delay 0.5 --max-workers 8

# ステップ2: データ統合（騎手・短評・厩舎談話を含む）
python -m src.integrator_cli batch --date 2025/08/16

# ステップ3: 拡張版MD新聞生成（organized以下に出力）
python -m src.markdown_cli batch --date 2025/08/16 --organized
```  



```bash
# ステップ1: 日程データ取得とレースデータ一括取得
python -m src.fast_batch_cli full --start 2025/08/16 --end 2025/08/16 --delay 0.5 --max-workers 10

# ステップ2: データ統合（実際の開催日で作成）
python -m src.integrator_cli batch --start-date 2025/08/16 --end-date 2025/08/16

# ステップ3: Markdown生成（organized以下に出力）
python -m src.markdown_cli batch --date 2025/08/16 --organized

# ステップ4: ファイル整理とtempフォルダクリーンアップ
python -m src.organizer_cli organize --copy --delete-original

# ステップ5: インデックス作成
python -m src.organizer_cli index


# パドック情報を定期更新（5分間隔で20回）
python -m src.paddock_updater --date 2025/08/16 --continuous --interval 300 --max-iterations 20

# 統合ファイルとMarkdown生成（競馬場別フォルダに保存）
python -m src.integrator_cli single --race-id 202501080711
python -m src.markdown_cli single --race-id 202501080711

```

## 🚀 高速データ取得コマンド

### フル処理（推奨）
```bash
# 日程取得 → 全データタイプ取得を一括実行
# デフォルトで6種類すべて取得: seiseki,shutsuba,cyokyo,danwa,syoin,paddok
python -m src.fast_batch_cli full --start 2025/08/16 --end 2025/08/16 --delay 0.5 --max-workers 8
```

### 個別処理

#### 日程データのみ
```bash
python -m src.fast_batch_cli schedule --start 2025/08/16 --end 2025/08/16
```

#### 特定データタイプのみ
```bash
# 基本4データ
python -m src.fast_batch_cli data --start 2025/08/16 --end 2025/08/16 --data-types seiseki,shutsuba,cyokyo,danwa

# 新規データタイプのみ（前走インタビュー、パドック）
python -m src.fast_batch_cli data --start 2025/08/16 --end 2025/08/16 --data-types syoin,paddok

# 全データタイプ明示指定
python -m src.fast_batch_cli data --start 2025/08/16 --end 2025/08/16 --data-types seiseki,shutsuba,cyokyo,danwa,syoin,paddok
```

## 📊 データ統合コマンド

### バッチ統合（期間指定）
```bash
python -m src.integrator_cli batch --start-date 2025/08/16 --end-date 2025/08/16
```

### 単日統合
```bash
python -m src.integrator_cli batch --date 2025/08/16
```

### 個別レース統合
```bash
python -m src.integrator_cli integrate --race-id 202501080711
```

## 📝 Markdown生成コマンド

### バッチ生成（organized以下に出力）
```bash
# --organizedオプションでorganized/YYYY/MM/DD/以下に出力
python -m src.markdown_cli batch --date 2025/08/16 --organized
```

### 個別レース生成
```bash
python -m src.markdown_cli single --race-id 202501080711 --organized
```

### プレビュー（保存なし）
```bash
python -m src.markdown_cli preview --race-id 202501080711
```

### 既存JSONから一括変換
```bash
python -m src.markdown_cli convert --source-dir Z:/KEIBA-CICD/data/integrated --organized
```

## 🔀 レガシーシステム用コマンド（MD新聞改修版）

### レガシー版でのスクレイピングからMD生成まで
```powershell
# 作業ディレクトリに移動
cd C:\source\git-h.fukuda1207\_keiba\keiba-cicd-core\KeibaCICD.keibabook

# 全データタイプをスクレイピング（個別レース指定）
python -m src.main --race-id 202501080711 --mode scrape_and_parse --data-types seiseki syutuba cyokyo danwa

# integrated JSONファイルを作成
python -c "from src.integrator.race_data_integrator import RaceDataIntegrator; integrator = RaceDataIntegrator(); integrator.create_integrated_file('202501080711')"

# Markdownファイルを生成
python src\generate_race_md.py --date 20250816 --race-id 202501080711
```

### レガシー版での日付指定バッチ処理
```powershell
# 指定日の全レースをスクレイピング
python -m src.main --mode batch --from-date 20250816 --to-date 20250816 --data-types seiseki syutuba cyokyo danwa

# 指定日の全レースの統合JSONを作成  
python -c "from src.integrator.race_data_integrator import RaceDataIntegrator; integrator = RaceDataIntegrator(); integrator.batch_create_integrated_files('20250816')"

# 指定日の全レースのMarkdownを生成
python src\generate_race_md.py --date 20250816 --all
```

## 📁 ファイル整理コマンド

### 整理（コピー + tempフォルダ削除）
```bash
# tempフォルダからorganizedへコピー後、tempフォルダをクリーンアップ
python -m src.organizer_cli organize --copy --delete-original
```

### 整理（移動のみ）
```bash
python -m src.organizer_cli organize
```

### インデックス作成
```bash
python -m src.organizer_cli index
```

### ファイル検索
```bash
# 日付で検索
python -m src.organizer_cli find --date 2025/08/16

# 競馬場で検索
python -m src.organizer_cli find --venue 札幌

# データタイプで検索
python -m src.organizer_cli find --data-type integrated
```

### 統計情報表示
```bash
python -m src.organizer_cli stats --detailed
```

## 🔧 パラメータ説明

### 共通パラメータ

| パラメータ | 説明 | デフォルト | 例 |
|----------|------|-----------|-----|
| `--start` / `--start-date` | 開始日 | - | 2025-08-16, 2025/08/16, 20250816 |
| `--end` / `--end-date` | 終了日 | 開始日と同じ | 2025-08-17 |
| `--date` | 単一日付 | - | 2025/08/16 |

### fast_batch_cli専用

| パラメータ | 説明 | デフォルト | 推奨値 |
|----------|------|-----------|--------|
| `--delay` | リクエスト間の遅延（秒） | 1.0 | 0.5 |
| `--max-workers` | 並列ワーカー数 | 5 | 8-10 |
| `--data-types` | 取得データタイプ | seiseki,shutsuba,cyokyo,danwa,syoin,paddok | 全タイプ |
| `--wait-between-phases` | Phase間の待機時間 | 2.0 | 2.0 |

### データタイプ一覧

| タイプ | 説明 | URL | MD新聞での利用 |
|--------|------|-----|--------------|
| `seiseki` | 成績データ | /cyuou/seiseki/ | レース結果 |
| `shutsuba` | 出馬表（本誌印含む） | /cyuou/syutuba/ | **騎手、短評** |
| `cyokyo` | 調教データ | /cyuou/cyokyo/ | 調教評価 |
| `danwa` | 厩舎談話 | /cyuou/danwa/ | **厩舎コメント** |
| `syoin` | 前走インタビュー | /cyuou/syoin/ | 前走評価 |
| `paddok` | パドック情報 | /cyuou/paddok/ | パドック評価 |

## 📂 ディレクトリ構成

```
Z:/KEIBA-CICD/data/
├── temp/              # 一時ダウンロードフォルダ（自動削除）
├── race_ids/          # 日程データ
├── integrated/        # 統合JSONファイル
├── markdown/          # Markdownファイル（通常）
├── organized/         # 整理済みファイル
│   └── 2025/
│       └── 08/
│           ├── 16/    # 8月16日開催
│           │   ├── 札幌/
│           │   │   ├── integrated_202501080711.json
│           │   │   └── 202501080711.md
│           │   ├── 新潟/
│           │   └── 小倉/
│           └── 17/    # 8月17日開催
└── logs/              # ログファイル
```

## 💡 使用例

### 例1: 土日のデータを完全処理（推奨）
```bash
# すべて自動で処理（tempフォルダも自動削除）
python -m src.fast_batch_cli full --start 2025/08/16 --end 2025/08/17 --delay 0.5 --max-workers 8
python -m src.integrator_cli batch --start-date 2025/08/16 --end-date 2025/08/17
python -m src.markdown_cli batch --date 2025/08/16 --organized
python -m src.markdown_cli batch --date 2025/08/17 --organized
python -m src.organizer_cli organize --copy --delete-original
python -m src.organizer_cli index
```

### 例2: 過去データの補完
```bash
# 特定期間のデータを一括取得
python -m src.fast_batch_cli full --start 2025/08/01 --end 2025/08/15 --delay 0.8 --max-workers 6
```

### 例3: リアルタイム更新
```bash
# 当日のデータを高速更新
TODAY=$(date +%Y/%m/%d)
python -m src.fast_batch_cli full --start $TODAY --delay 0.3 --max-workers 12
python -m src.integrator_cli batch --date $TODAY
python -m src.markdown_cli batch --date $TODAY --organized
```

## ⚠️ 注意事項

1. **データフロー**: temp → integrated → organized の順序を守る
2. **日付形式**: `YYYY-MM-DD`, `YYYY/MM/DD`, `YYYYMMDD` すべて対応
3. **tempフォルダ**: `--delete-original`で自動削除される
4. **race_id形式**: 実際の開催日ではなく競馬の開催回次で管理
   - 例: 202501080711 = 2025年第1回札幌8日目第11レース（実際は8月16日開催）

## 🔄 MD新聞改修機能

### 2025年8月16日追加機能
- **騎手列**: shutsubaファイルから取得して出走表に表示
- **短評列**: shutsubaファイルから取得して出走表に表示  
- **厩舎コメント**: danwaファイルから「厩舎の話」を取得して別セクションに表示

### データ取得時の注意
- shutsubaファイル: スペース付きキー名（「騎　手」「短　評」）を正規化処理
- 正規化されたキー: 「騎手」「短評」「厩舎」として保存
- 後方互換性: 旧形式のキー名も引き続きサポート

## 🐛 トラブルシューティング

### エラー: 日付形式が認識されない
```bash
# ハイフン、スラッシュ、数字のみ すべて対応
--start 2025-08-16  # OK
--start 2025/08/16  # OK  
--start 20250816    # OK
```

### エラー: 騎手・短評データが表示されない
```bash
# shutsubaデータを再取得
python -m src.fast_batch_cli data --start 2025/08/16 --data-types shutsuba

# 統合ファイルを再生成
python -m src.integrator_cli batch --date 2025/08/16

# Markdownを再生成
python -m src.markdown_cli batch --date 2025/08/16 --organized
```

### エラー: syoin/paddokデータが取得できない
```bash
# 明示的にデータタイプを指定
python -m src.fast_batch_cli data --start 2025/08/16 --data-types syoin,paddok
```

### エラー: データが見つからない
```bash
# race_idsファイルを確認
ls Z:/KEIBA-CICD/data/race_ids/

# 日程データを再取得
python -m src.fast_batch_cli schedule --start 2025/08/16
```

### エラー: 統合ファイルが空
```bash
# 必要なデータタイプがあるか確認
ls Z:/KEIBA-CICD/data/temp/*202501080711*

# データを再取得
python -m src.fast_batch_cli data --start 2025/08/16 --data-types seiseki,shutsuba,cyokyo,danwa,syoin,paddok
```

## 🔄 更新履歴

### 2025/08/16 - MD新聞改修
- shutsubaファイルのキー名正規化処理追加
- 騎手列、短評列の表示対応
- 厩舎コメントセクションの追加

### 最新の変更点
- tempフォルダを作業用ディレクトリとして使用
- 実際の開催日付（8/16, 8/17）でorganizedディレクトリを構成
- syoin（前走インタビュー）とpaddok（パドック情報）をデフォルトに追加
- Markdownファイルをorganized以下に直接出力可能
- race_info要素にrace_idを追加
- 元ファイル自動削除オプションの改善
---
## 🟦 PowerShell スクリプトによる一括実行（run_daily.ps1）

```powershell
# 必須: -Date (yyyy/MM/dd)
powershell -ExecutionPolicy Bypass -File .\keiba-cicd-core\tools\run_daily.ps1 -Date 2025/08/16

# 期間指定＋パフォーマンス調整
y
powershell -ExecutionPolicy Bypass -File .\keiba-cicd-core\tools\run_daily.ps1 -Date 2025/08/16 -EndDate 2025/08/17 -Delay 0.5 -MaxWorkers 8
```
- 実行順: fast_batch_cli → integrator_cli → markdown_cli（各日）→ organizer_cli organize/index。
- 形式検証: 日付は `yyyy/MM/dd`。エラー時は即停止。
- `-SkipOrganize` 指定で整理/インデックス作成を省略可能。