# 競馬ブック データ取得システム - 基本操作ガイド

## 📋 概要

従来版CLI（batch_cli.py）を使用した基本的な操作方法を詳しく説明します。安定性を重視した確実なデータ取得手順を習得できます。

**最終更新**: 2025年8月9日  
**対象**: 従来版CLIシステム（batch_cli.py）  
**推奨レベル**: 初心者〜中級者  
**前提条件**: [セットアップ/初期設定.md](../セットアップ/初期設定.md)の完了

---

## 🚀 基本コマンド構造

### CLIの基本形式
```bash
python -m src.batch_cli <サブコマンド> <オプション>
```

### 新機能のCLI

| CLIツール | 機能 | コマンド例 |
|-----------|------|----------|
| `integrator_cli` | データ統合 | `python -m src.integrator_cli single --race-id 202501010101` |
| `organizer_cli` | ファイル整理 | `python -m src.organizer_cli organize --copy` |

### 利用可能なサブコマンド

| サブコマンド | 機能 | 説明 |
|-------------|------|------|
| `schedule` | レース日程取得 | 指定日の日程・レースID取得 |
| `data` | レースデータ取得 | 既存レースIDからデータ取得 |
| `full` | 一括処理 | 日程取得→データ取得の完全自動実行 |

---

## 📅 1. レース日程取得（schedule）

### 基本的な日程取得

#### 単日の日程取得
```bash
# 今日の日程取得
python -m src.batch_cli schedule --start-date $(date +%Y/%m/%d)

# 特定日の日程取得
python -m src.batch_cli schedule --start-date 2024/12/28
```

#### 期間指定での日程取得
```bash
# 週末2日間の日程取得
python -m src.batch_cli schedule --start-date 2024/12/28 --end-date 2024/12/29

# 1週間の日程取得
python -m src.batch_cli schedule --start-date 2024/12/23 --end-date 2024/12/29
```

### 詳細オプション付き実行

#### リクエスト間隔調整
```bash
# 間隔を5秒に設定（サーバー負荷軽減）
python -m src.batch_cli schedule --start-date 2024/12/28 --delay 5

# 間隔を10秒に設定（より慎重な取得）
python -m src.batch_cli schedule --start-date 2024/12/28 --delay 10
```

#### デバッグモード実行
```bash
# 詳細ログ付き実行
python -m src.batch_cli schedule --start-date 2024/12/28 --debug
```

### 実行結果の確認

#### 生成されるファイル
```bash
# レースID情報ファイル確認
ls -la data/race_ids/
# 例: 20241228_info.json

# ファイル内容確認
cat data/race_ids/20241228_info.json
```

#### 期待される出力例
```json
{
  "date": "20241228",
  "kaisai_data": {
    "中山": [
      {
        "race_no": "1",
        "race_name": "3歳未勝利",
        "course": "ダ1200m",
        "race_id": "202412286011"
      }
    ],
    "阪神": [
      {
        "race_no": "1", 
        "race_name": "3歳未勝利",
        "course": "芝1400m",
        "race_id": "202412280111"
      }
    ]
  }
}
```

---

## 📊 2. レースデータ取得（data）

### 基本的なデータ取得

#### 全データタイプの取得
```bash
# 全データタイプ（seiseki, shutsuba, cyokyo, danwa）を取得
python -m src.batch_cli data --start-date 2024/12/28
```

#### 特定データタイプのみ取得
```bash
# 成績データのみ取得
python -m src.batch_cli data --start-date 2024/12/28 --data-types seiseki

# 出馬表と調教データのみ取得
python -m src.batch_cli data --start-date 2024/12/28 --data-types shutsuba,cyokyo

# 厩舎の話のみ取得
python -m src.batch_cli data --start-date 2024/12/28 --data-types danwa
```

### データタイプ別詳細

#### seiseki（成績データ）
```bash
# 成績データ取得
python -m src.batch_cli data --start-date 2024/12/28 --data-types seiseki --delay 3

# 生成されるファイル例
# data/seiseki_202412286011.json
# data/seiseki_202412280111.json
```

**含まれるデータ**:
- レース結果・着順
- 騎手インタビュー
- 次走展望メモ
- オッズ・人気情報

#### shutsuba（出馬表）
```bash
# 出馬表データ取得
python -m src.batch_cli data --start-date 2024/12/28 --data-types shutsuba --delay 3

# 生成されるファイル例  
# data/shutsuba_202412286011.json
# data/shutsuba_202412280111.json
```

**含まれるデータ**:
- 出走馬・騎手・厩舎情報
- 血統情報（父・母・母父）
- umacd（馬コード）情報

#### cyokyo（調教データ）
```bash
# 調教データ取得
python -m src.batch_cli data --start-date 2024/12/28 --data-types cyokyo --delay 3

# 生成されるファイル例
# data/cyokyo_202412286011.json
# data/cyokyo_202412280111.json
```

**含まれるデータ**:
- 調教タイム・評価
- 調教コメント・解説
- 騎乗者情報

#### danwa（厩舎の話）
```bash
# 厩舎の話データ取得
python -m src.batch_cli data --start-date 2024/12/28 --data-types danwa --delay 3

# 生成されるファイル例
# data/danwa_202412286011.json
# data/danwa_202412280111.json
```

**含まれるデータ**:
- 厩舎関係者コメント
- コメント日時情報

---

## 🎯 3. 一括処理（full）

### 基本的な一括処理

#### 推奨設定での実行
```bash
# 標準的な一括処理（推奨）
python -m src.batch_cli full --start-date 2024/12/28
```

この実行により以下が自動で実行されます：
1. レース日程取得（schedule）
2. 5秒待機
3. 全データタイプ取得（data）

#### カスタム設定での実行
```bash
# カスタム設定例
python -m src.batch_cli full \
  --start-date 2024/12/28 \
  --data-types seiseki,shutsuba \
  --delay 5 \
  --wait-between-phases 10 \
  --debug
```

### 期間指定での一括処理

#### 週末の一括処理
```bash
# 土日の一括処理
python -m src.batch_cli full \
  --start-date 2024/12/28 \
  --end-date 2024/12/29 \
  --delay 5
```

#### 1週間の一括処理
```bash
# 1週間分の一括処理（時間がかかります）
python -m src.batch_cli full \
  --start-date 2024/12/23 \
  --end-date 2024/12/29 \
  --delay 5 \
  --wait-between-phases 10
```

---

## ⚙️ オプション詳細説明

### 必須オプション

#### --start-date（必須）
```bash
# 日付形式の例
--start-date 2024/12/28    # YYYY/MM/DD
--start-date 2024/1/5      # 月日の0埋めなしもOK
--start-date 24/12/28      # YY/MM/DD形式も可能
```

### オプション項目

#### --end-date（期間指定）
```bash
# 単日実行（end-date省略時）
python -m src.batch_cli full --start-date 2024/12/28

# 期間実行
python -m src.batch_cli full --start-date 2024/12/28 --end-date 2024/12/29
```

#### --data-types（データタイプ指定）
```bash
# 利用可能なデータタイプ
--data-types seiseki           # 成績のみ
--data-types shutsuba          # 出馬表のみ
--data-types cyokyo            # 調教のみ  
--data-types danwa             # 厩舎の話のみ
--data-types seiseki,shutsuba  # 複数指定（カンマ区切り）

# デフォルト（指定なし）
# seiseki,shutsuba,cyokyo,danwa（全データタイプ）
```

#### --delay（リクエスト間隔）
```bash
--delay 3    # 3秒間隔（デフォルト）
--delay 5    # 5秒間隔（推奨・安全）
--delay 10   # 10秒間隔（慎重）
--delay 1    # 1秒間隔（高速・非推奨）
```

#### --wait-between-phases（フェーズ間待機時間）
```bash
--wait-between-phases 5.0    # 5秒（デフォルト）
--wait-between-phases 10     # 10秒（推奨）
--wait-between-phases 15     # 15秒（慎重）
```

#### --debug（詳細ログ）
```bash
# 詳細ログモード
python -m src.batch_cli full --start-date 2024/12/28 --debug
```

---

## 📁 出力ファイル管理

### ファイル保存場所

#### 統一保存方式
全JSONファイルは`KEIBA_DATA_ROOT_DIR`（デフォルト：`./data`）直下に保存されます：

```
data/
├── race_ids/
│   └── 20241228_info.json        # レースID情報
├── nittei_20241228.json           # 日程データ（schedule実行時）
├── seiseki_202412286011.json      # 成績データ
├── seiseki_202412280111.json      # 成績データ
├── shutsuba_202412286011.json     # 出馬表データ
├── shutsuba_202412280111.json     # 出馬表データ
├── cyokyo_202412286011.json       # 調教データ
├── cyokyo_202412280111.json       # 調教データ
├── danwa_202412286011.json        # 厩舎の話データ
└── danwa_202412280111.json        # 厩舎の話データ
```

### ファイル命名規則

| データタイプ | ファイル名形式 | 例 |
|-------------|----------------|-----|
| レースID情報 | `race_ids/YYYYMMDD_info.json` | `race_ids/20241228_info.json` |
| 日程 | `nittei_YYYYMMDD.json` | `nittei_20241228.json` |
| 成績 | `seiseki_YYYYMMDDHHMM.json` | `seiseki_202412286011.json` |
| 出馬表 | `shutsuba_YYYYMMDDHHMM.json` | `shutsuba_202412286011.json` |
| 調教 | `cyokyo_YYYYMMDDHHMM.json` | `cyokyo_202412286011.json` |
| 厩舎の話 | `danwa_YYYYMMDDHHMM.json` | `danwa_202412286011.json` |

---

## 📊 実行結果の確認方法

### 1. ファイル確認コマンド

#### 基本的なファイル確認
```bash
# 全JSONファイル確認
ls -la data/*.json

# データタイプ別確認
ls -la data/seiseki_*.json
ls -la data/shutsuba_*.json

# 最新ファイル確認
ls -lat data/*.json | head -5
```

#### ファイルサイズ確認
```bash
# ディスク使用量確認
du -sh data/

# ファイル数確認
ls data/*.json | wc -l
```

### 2. JSON内容確認

#### JSONファイルの基本確認
```bash
# ファイル内容表示（先頭20行）
head -20 data/seiseki_202412286011.json

# jq使用（インストール済みの場合）
cat data/seiseki_202412286011.json | jq .

# Pythonでの確認
python -c "
import json
with open('data/seiseki_202412286011.json', 'r', encoding='utf-8') as f:
    data = json.load(f)
print(f'レース名: {data[\"race_info\"][\"race_name\"]}')
print(f'出走頭数: {len(data[\"results\"])}頭')
"
```

### 3. ログファイル確認

#### 実行ログの確認
```bash
# 最新ログファイル確認
ls -lat logs/*.log | head -1

# ログ内容確認
tail -50 logs/batch_cli_*.log

# エラーログのみ確認
grep -i error logs/batch_cli_*.log
```

---

## 🔧 実用的な使用パターン

### パターン1: 日次処理
```bash
# 毎日の基本処理
python -m src.batch_cli full --start-date $(date +%Y/%m/%d) --delay 5
```

### パターン2: 週末処理
```bash
# 土曜日の処理
python -m src.batch_cli full --start-date $(date -d "saturday" +%Y/%m/%d) --delay 5

# 日曜日の処理  
python -m src.batch_cli full --start-date $(date -d "sunday" +%Y/%m/%d) --delay 5
```

### パターン3: 成績データのみ集中取得
```bash
# 成績データのみを効率的に取得
python -m src.batch_cli data --start-date 2024/12/28 --data-types seiseki --delay 3
```

### パターン4: 過去データの補完取得
```bash
# 過去1週間のデータ補完
for i in {1..7}; do
    date=$(date -d "$i days ago" +%Y/%m/%d)
    python -m src.batch_cli full --start-date $date --delay 5
    sleep 60  # 1分間隔
done
```

---

## ⚠️ 注意事項とベストプラクティス

### 1. サーバー負荷への配慮
- **推奨間隔**: `--delay 3`以上（5秒推奨）
- **フェーズ間待機**: `--wait-between-phases 5`以上（10秒推奨）
- **同時実行回避**: 複数のコマンドを同時実行しない

### 2. Cookie有効期限
- Cookieは定期的に無効になります
- エラーが頻発する場合は再ログイン・Cookie更新

### 3. 開催がない日の処理
- 開催がない日（月曜日など）はJSONファイルが生成されません
- これは正常な動作です

### 4. エラーハンドリング
- 404エラー: 指定日に開催がない
- 認証エラー: Cookie有効期限切れ
- タイムアウト: ネットワークまたはサーバー負荷

---

## 🆕 新機能の活用

### 統合ファイル生成

出走表、調教、厩舎談話、成績を1つのファイルに統合：

```bash
# 単一レースの統合
python -m src.integrator_cli single --race-id 202412286011

# 指定日の全レース統合
python -m src.integrator_cli batch --date 2024/12/28

# 成績データで統合ファイル更新
python -m src.integrator_cli update --race-id 202412286011

# 統合データの分析レポート
python -m src.integrator_cli analyze --race-id 202412286011
```

### ファイル整理機能

年/月/日/競馬場別にファイルを整理：

```bash
# データファイルを整理（移動）
python -m src.organizer_cli organize

# データをコピーして整理（元ファイル保持）
python -m src.organizer_cli organize --copy

# インデックス作成
python -m src.organizer_cli index

# ファイル検索
python -m src.organizer_cli find --date 2024/12/28 --venue 東京

# ストレージ統計
python -m src.organizer_cli stats --detailed
```

## 🚀 次のステップ

基本操作を習得したら：

1. **高速版活用**: [高速版の使い方.md](高速版の使い方.md)で最適化版を学習
2. **統合機能活用**: `integrator_cli`でデータを統合して分析効率を向上
3. **ファイル管理**: `organizer_cli`でデータを整理して管理を効率化
4. **バッチ処理**: [バッチ処理.md](バッチ処理.md)で自動化を設定
5. **トラブル対応**: [運用/トラブルシューティング.md](../運用/トラブルシューティング.md)でエラー対応を習得

---

**🎯 従来版CLIをマスターすることで、安定したデータ取得の基盤ができます。慣れてきたら高速版に移行して効率を向上させましょう！**