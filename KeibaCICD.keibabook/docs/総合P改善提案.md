# 総合P（総合ポイント）計算方法の改善提案

## 現在の計算方法

### 1. 基本ロジック
- **場所**: `src/parsers/syutuba_parser.py`
- **処理フロー**:
  1. 各予想者（CPU、本誌など）の印を収集
  2. 印を点数に変換
  3. 最大5者分の印ポイントを合計

### 2. 現在の配点
```python
mark_values = {
    '◎': 5,
    '○': 4,
    '▲': 3,
    '△': 2,
    '穴': 1,
    '注': 1,
    '×': 0
}
```

### 3. 問題点
- すべての予想者を同じ重みで扱っている
- CPU予想や本誌予想の精度が高いにもかかわらず、他と同等の扱い
- 最大5者しか考慮していない


## 改善内容（実装済み）

### 1. 予想者別の重み付け
```python
def to_point(mark_text: str, source_label: str = None) -> float:
    # 基本ポイント取得
    base_point = mark_values.get(mark_text, 0)

    # ソース別の重み付け
    weight = 1.0
    if source_label == 'CPU':
        weight = 1.5  # CPU予想は1.5倍
    elif source_label == '本誌':
        weight = 1.3  # 本誌予想は1.3倍
    elif source_label in ['牟田雅', '西村敬', '広瀬健']:
        weight = 1.0  # 専門家は標準
    else:
        weight = 0.8  # その他は0.8倍

    return base_point * weight
```

### 2. 考慮する予想者数の拡大
- 最大5者 → 最大7者に拡大
- より多くの予想情報を総合的に評価

### 3. 予想者の優先順位明確化
```python
candidate_sources = [
    ('CPU', ['CPU', 'ＣＰＵ']),
    ('本誌', ['本誌', '本紙', '本誌見解', '本紙見解']),
    ('牟田雅', ['牟田雅', '牟田']),
    ('西村敬', ['西村敬', '西村']),
    ('広瀬健', ['広瀬健', '広瀬']),
    ('予想1', ['印', '印_2', '印_3', '印_4']),
]
```


## 期待される効果

1. **より精度の高い総合評価**
   - 実績のある予想者の意見をより重視
   - CPU予想の高い精度を活かした配点

2. **情報の多角的な活用**
   - 7者まで考慮することで、より多くの視点を反映
   - 予想の偏りを減らし、バランスの取れた評価

3. **計算例**
   - 旧方式: ピエタンツァ（◎×4人 + ○×1人）= 5×4 + 4×1 = 24点
   - 新方式:
     - CPU◎: 5×1.5 = 7.5
     - 本誌○: 4×1.3 = 5.2
     - 牟田雅◎: 5×1.0 = 5.0
     - 西村敬◎: 5×1.0 = 5.0
     - 広瀬健◎: 5×1.0 = 5.0
     - 合計: 27.7 → 28点（四捨五入）


## 今後の改善案

### 1. 過去実績の活用
- 各予想者の的中率を計測し、動的に重みを調整
- 競馬場・条件別の予想者別成績を反映

### 2. AIスコアとの連携
- AI指数との相関を分析
- 総合Pと実際の着順の相関分析

### 3. 表示の改善
- 総合P算出根拠の可視化（どの予想者が何点寄与しているか）
- 信頼度の表示（予想者数による信頼度表示）

### 4. カスタマイズ機能
- ユーザーが重み付けをカスタマイズできる機能
- 特定の予想者を除外・追加できる機能


## 使用方法

改善済みのコードは既に実装されているため、通常通り以下のコマンドで実行：

```powershell
python -m src.markdown_cli batch --date 2025/09/27 --organized
```

総合Pの値は、MD新聞の出走表に自動的に反映されます。