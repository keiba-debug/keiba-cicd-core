# 競馬ブック データ取得システム - データ仕様書

## 📊 概要

競馬ブック（https://p.keibabook.co.jp/）から取得可能なデータと保存構造に関する最新仕様書です。

**更新日**: 2025年8月9日  
**バージョン**: v2.3+（最適化版対応）  
**対象ドメイン**: `p.keibabook.co.jp`  
**出力形式**: JSON専用（HTMLファイルは原則保存せず）  
**保存方式**: 統一フォルダ保存（`KEIBA_DATA_ROOT_DIR` 直下）  
**革新機能**: 最適化版による10-20倍高速化、エラー統計、品質監視

---

## 🗂 取得可能データ一覧

### 1. レース成績データ (seiseki)
- **ページタイプ**: レース結果・インタビュー・メモ
- **実装状況**: ✅ **完全実装済み（JSON）+ 高速版対応**
- **URL構造**: `https://p.keibabook.co.jp/cyuou/seiseki/{race_id}`
- **サンプルURL**: `https://p.keibabook.co.jp/cyuou/seiseki/202508090511`

### 2. 出馬表データ (shutsuba) 
- **ページタイプ**: 出走予定馬・血統・umacd
- **実装状況**: ✅ **完全実装済み（JSON）+ 高速版対応**
- **URL構造**: `https://p.keibabook.co.jp/cyuou/shutsuba/{race_id}`
- **サンプルURL**: `https://p.keibabook.co.jp/cyuou/shutsuba/202508090511`

### 3. 調教データ (cyokyo)
- **ページタイプ**: 調教タイム・評価・コメント
- **実装状況**: ✅ **完全実装済み（JSON）+ 高速版対応**
- **URL構造**: `https://p.keibabook.co.jp/cyuou/cyokyo/0/0/{race_id}`
- **サンプルURL**: `https://p.keibabook.co.jp/cyuou/cyokyo/0/0/202508090511`

### 4. 厩舎の話データ (danwa)
- **ページタイプ**: 厩舎関係者コメント
- **実装状況**: ✅ **完全実装済み（JSON）+ 高速版対応**
- **URL構造**: `https://p.keibabook.co.jp/cyuou/danwa/0/{race_id}`
- **サンプルURL**: `https://p.keibabook.co.jp/cyuou/danwa/0/202508090511`

### 5. レース日程データ (nittei)
- **ページタイプ**: 開催スケジュール・レースID生成
- **実装状況**: ✅ **完全実装済み（JSON）+ 高速版対応**
- **URL構造**: `https://p.keibabook.co.jp/cyuou/nittei/{date_str}`
- **サンプルURL**: `https://p.keibabook.co.jp/cyuou/nittei/20250809`

---

## 🗃 統一保存方式（v2.3+）

### ディレクトリ構造
```
$KEIBA_DATA_ROOT_DIR/
├── race_ids/               # レースID情報
│   └── YYYYMMDD_info.json
├── nittei_YYYYMMDD.json    # 日程JSON（統一保存）
├── seiseki_{race_id}.json  # 成績JSON（統一保存）
├── shutsuba_{race_id}.json # 出馬表JSON（統一保存）
├── cyokyo_{race_id}.json   # 調教JSON（統一保存）
└── danwa_{race_id}.json    # 厩舎の話JSON（統一保存）
```

**重要**: 全JSONファイルは `KEIBA_DATA_ROOT_DIR` 直下に統一保存されます（サブディレクトリ未使用）。

---

## 🚀 高速版取得方法

### 🔥 最適化版（推奨）- 10-20倍高速化

#### 全データタイプ超高速取得
```bash
# 最大性能での全データタイプ取得
python -m src.fast_batch_cli full --start-date 2025/8/9 --delay 0.3 --max-workers 12

# 推奨設定での安全な高速取得
python -m src.fast_batch_cli full --start-date 2025/8/9 --delay 0.5 --max-workers 8

# 期間指定での大規模高速取得
python -m src.fast_batch_cli full \
  --start-date 2025/8/1 \
  --end-date 2025/8/9 \
  --delay 0.5 \
  --max-workers 8
```

#### 特定データタイプの並列取得
```bash
# 成績データのみ超高速取得
python -m src.fast_batch_cli data \
  --start-date 2025/8/9 \
  --data-types seiseki \
  --max-workers 10

# 出馬表データのみ並列取得
python -m src.fast_batch_cli data \
  --start-date 2025/8/9 \
  --data-types shutsuba \
  --max-workers 12
```

### 📊 性能比較

| 項目 | 従来版（Selenium） | 高速版（requests） | 改善率 |
|------|-------------------|-------------------|--------|
| **処理時間** | 60-90秒/12レース | **8.6秒/12レース** | **7-10倍高速** |
| **リソース使用量** | 高（Chrome起動） | **低（HTTP直接）** | **大幅削減** |
| **並列処理** | 困難 | **最大22並列対応** | **大幅改善** |
| **安定性** | 中（ブラウザ依存） | **高（HTTP直接）** | **向上** |

### ⚙️ 最適化版推奨設定

| 用途 | delay | max-workers | 説明 |
|------|-------|-------------|------|
| **テスト** | 1.0 | 3 | 安全な設定 |
| **通常使用** | 0.5 | 5-8 | バランス重視 |
| **高速処理** | 0.3 | 8-12 | 最大性能 |
| **サーバー負荷軽減** | 2.0 | 3 | 負荷軽減 |

### 🐌 従来版（互換性維持）

#### 安定性重視の取得
```bash
# 従来版での確実な全データタイプ取得
python -m src.batch_cli full --start-date 2025/8/9

# 期間指定での従来版取得
python -m src.batch_cli full --start-date 2025/8/1 --end-date 2025/8/9 --delay 5

# 特定データタイプのみ従来版取得
python -m src.batch_cli data --start-date 2025/8/9 --data-types seiseki
```

---

## 📋 JSON データ仕様詳細

### 1. レース成績データ (seiseki)

#### ファイル形式
- **形式**: JSON（UTF-8エンコーディング）
- **命名規則**: `seiseki_YYYYMMDDHHMM.json`
- **保存場所**: `$KEIBA_DATA_ROOT_DIR/`（直下）

#### データ構造
```json
{
  "race_info": {
    "race_name": "2025年8月9日東京11R 日本ダービー(ＧＩ)"
  },
  "results": [
    {
      "着順": "1",
      "My印": "",
      "本紙": "◎",
      "枠番": "7",
      "馬番": "13",
      "馬名": "サンプルホース",
      "性齢": "牡3",
      "重量": "57",
      "騎手": "",
      "騎手_2": "ルメール",
      "タイム": "2.23.7",
      "着差": "",
      "通過順位": "4-4-3-1",
      "4角位置": "3",
      "前半3F": "35.8",
      "上り3F": "34.2",
      "単人気": "1",
      "単勝オッズ": "2.1",
      "馬体重": "504",
      "増減": "+4",
      "厩舎": "栗斉藤崇",
      "interview": "勝因分析とレース展開についてのコメント...",
      "memo": "次走への展望と調整方針..."
    }
  ]
}
```

#### フィールド詳細
| フィールド名 | データ型 | 例 | 説明 |
|-------------|----------|---|------|
| `race_name` | String | "日本ダービー(ＧＩ)" | レース正式名称 |
| `着順` | String | "1", "2", "18" | 着順 |
| `interview` | String | "騎手コメント..." | **騎手インタビュー**（勝利馬等） |
| `memo` | String | "次走への展望..." | **次走メモ**（上位馬等） |

### 2. 出馬表データ (shutsuba)

#### ファイル形式
- **保存場所**: `$KEIBA_DATA_ROOT_DIR/`（直下）
- **命名規則**: `shutsuba_YYYYMMDDHHMM.json`

#### データ構造
```json
{
  "race_info": {
    "race_name": "レース名",
    "race_date": "2025-08-09",
    "venue": "東京"
  },
  "horses": [
    {
      "枠番": "1",
      "馬番": "1",
      "馬名": "サンプルホース",
      "性齢": "牡3",
      "斤量": "57",
      "騎手": "ルメール",
      "厩舎": "栗斉藤崇",
      "馬主": "サンプル馬主",
      "生産者": "サンプル牧場",
      "父": "父馬名",
      "母": "母馬名",
      "母父": "母父馬名",
      "umacd": "2022103456"
    }
  ]
}
```

### 3. 調教データ (cyokyo)

#### データ構造
```json
{
  "race_info": {
    "race_name": "レース名"
  },
  "training_data": [
    {
      "馬番": "1",
      "馬名": "サンプルホース",
      "調教日": "2025-08-07",
      "調教場": "栗東坂路",
      "調教タイム": "52.0",
      "調教評価": "B",
      "調教コメント": "軽快な動きで調整順調。レースに向けて仕上がりは良好。",
      "騎乗者": "助手"
    }
  ]
}
```

### 4. 厩舎の話データ (danwa)

#### データ構造
```json
{
  "race_info": {
    "race_name": "レース名"
  },
  "comments": [
    {
      "馬番": "1",
      "馬名": "サンプルホース",
      "厩舎": "栗斉藤崇",
      "コメント": "調整も順調でレースに向けて万全の仕上がり。勝負になると思う。",
      "コメント日": "2025-08-08"
    }
  ]
}
```

### 5. レース日程データ (nittei)

#### データ構造
```json
{
  "date": "20250809",
  "kaisai_data": {
    "東京": [
      {
        "race_no": "1",
        "race_name": "3歳未勝利",
        "course": "芝1600m",
        "race_id": "202508090511"
      }
    ],
    "中山": [
      {
        "race_no": "1",
        "race_name": "3歳未勝利", 
        "course": "ダ1200m",
        "race_id": "202508090611"
      }
    ]
  },
  "total_races": 24,
  "kaisai_count": 2
}
```

---

## 🎯 レースID仕様

### 形式
- **桁数**: 12桁
- **構成**: `YYYYMMDDVRRR`
  - `YYYY`: 年（4桁）
  - `MM`: 月（2桁）
  - `DD`: 日（2桁）
  - `V`: 会場コード（1桁）
  - `RRR`: レース番号（3桁、ゼロ埋め）

### 会場コード一覧
| コード | 会場名 | 備考 |
|--------|--------|------|
| 1 | 札幌 | 夏季開催 |
| 2 | 函館 | 夏季開催 |
| 3 | 福島 | |
| 4 | 新潟 | |
| 5 | 東京 | メイン会場 |
| 6 | 中山 | |
| 7 | 中京 | |
| 8 | 京都 | |
| 9 | 阪神 | |
| 10 | 小倉 | |

### サンプル
- `202508090511`: 2025年8月9日・東京（5）・11R
- `202508090511`: 2025年8月9日・東京（5）・1R

---

## ⚙️ 認証・セキュリティ

### 必要Cookie
1. **keibabook_session**: セッションID
2. **tk**: トークン
3. **XSRF-TOKEN**: CSRF保護トークン

### 環境変数設定（.env）
```bash
KEIBABOOK_SESSION="実際のセッション値"
KEIBABOOK_TK="実際のtk値"
KEIBABOOK_XSRF_TOKEN="実際のXSRF値"
KEIBA_DATA_ROOT_DIR="./data"
```

### Cookie取得方法
1. https://p.keibabook.co.jp/ でログイン
2. F12 → Application → Cookies → p.keibabook.co.jp
3. 上記3つのCookie値をコピー・設定

---

## 📈 データ活用例

### 基本的なデータ読み込み
```python
import json

# レース成績データの読み込み
with open('data/seiseki_202508090511.json', 'r', encoding='utf-8') as f:
    data = json.load(f)

# 基本情報
race_name = data['race_info']['race_name']
horse_count = len(data['results'])

# 勝利馬情報
winner = data['results'][0]
winner_name = winner['馬名']
winner_time = winner['タイム']
winner_odds = winner['単勝オッズ']

print(f"レース: {race_name}")
print(f"勝利馬: {winner_name} (タイム: {winner_time}, オッズ: {winner_odds})")
```

### 複数データタイプの統合分析
```python
import json
from pathlib import Path

race_id = "202508090511"

# 各データタイプを読み込み
data_types = ['seiseki', 'shutsuba', 'cyokyo', 'danwa']
race_data = {}

for data_type in data_types:
    file_path = f'data/{data_type}_{race_id}.json'
    if Path(file_path).exists():
        with open(file_path, 'r', encoding='utf-8') as f:
            race_data[data_type] = json.load(f)

# 統合分析
print(f"取得データタイプ: {list(race_data.keys())}")

# インタビューとメモの確認（成績データ）
if 'seiseki' in race_data:
    results = race_data['seiseki']['results']
    interviews = [r for r in results if r.get('interview')]
    memos = [r for r in results if r.get('memo')]
    print(f"インタビュー件数: {len(interviews)}")
    print(f"メモ件数: {len(memos)}")
```

### 日付別ファイル検索
```python
import glob

# 特定日のすべてのJSONファイルを取得
date_str = "20250809"
json_files = glob.glob(f'data/*{date_str}*.json')

print(f"{date_str}のファイル数: {len(json_files)}")
for file_path in sorted(json_files):
    print(f"  - {file_path}")
```

---

## 🚨 重要な注意事項

### 1. 利用規約遵守
- 競馬ブックの利用規約を必ず守る
- **推奨間隔**: 高速版 0.3秒以上、従来版 3秒以上
- 過度な負荷をかけない

### 2. Cookie有効期限
- Cookieは定期的に無効になります
- 認証エラー時は新しいCookieを取得
- 自動Cookie有効性チェック機能の活用を推奨

### 3. データ精度・品質
- JSONパース結果の妥当性確認
- **品質スコア95%未満**: 設定調整が必要
- エラーログの定期チェック
- データバックアップの実施

### 4. システム制限
- **実装済み**: 全5種類のデータタイプ
- **未対応**: 地方競馬
- **ファイル形式**: JSON専用（HTMLファイルは原則保存せず）
- **保存方式**: 全JSONファイルを統一フォルダに保存

### 5. 開催がない日の処理
- **開催がない日はJSONファイルを出力しません**
- 月曜日や祝日など、競馬開催がない日は空のファイルではなく、ファイル自体が作成されません
- システムログには「📭 開催なし」として記録され、正常処理として扱われます

---

## 📊 品質監視機能

### 自動品質評価
- **品質スコア**: 成功率ベースの自動計算
- **目標値**: 95%以上
- **アラート**: 95%未満で自動警告・詳細分析

### エラー統計
```json
{
  "error_stats": {
    "http_errors": 2,
    "timeout_errors": 1,
    "parse_errors": 0,
    "total_retries": 5,
    "quality_score": 97.9
  }
}
```

### パフォーマンス統計
```json
{
  "performance_stats": {
    "avg_time": 0.42,
    "max_memory_mb": 82.4,
    "tasks_per_second": 3.98,
    "current_memory_mb": 67.2
  }
}
```

---

## 🔄 今後の拡張予定

### Phase 1: パフォーマンス向上
- asyncio対応による非同期処理
- キャッシュ機能の実装
- リアルタイム監視強化

### Phase 2: 機能拡張
- 地方競馬対応
- オッズデータ取得
- 血統情報の詳細化

### Phase 3: 分析機能
- データ分析ツールの統合
- 可視化機能
- 予測モデルとの連携

---

**📞 サポート**: 設定ファイルやログファイルを確認してトラブルシューティングを実施してください。品質監視機能により、データ取得の信頼性が大幅に向上しています。**