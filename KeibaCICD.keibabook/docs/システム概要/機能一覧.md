# 競馬ブック データ取得システム - 機能一覧

## 📋 概要

競馬ブック データ取得システムが提供する全機能の一覧と詳細説明です。

**最終更新**: 2025年8月23日  
**システムバージョン**: v2.4（MD新聞対応）  
**対応データタイプ**: 7種類（nittei, seiseki, shutsuba, cyokyo, danwa, syoin, paddok）

---

## 📰 MD新聞（Markdown自動生成）

- 定義: `python -m src.markdown_cli batch`（または`single`）で生成されるレース別Markdownを「MD新聞」と呼称
- 出力先: `Z:/KEIBA-CICD/data/organized/YYYY/MM/DD/[競馬場]/`
- 主な内容:
  - レース情報（日時・コース・グレード・距離等）
  - 出走表（騎手・オッズ・本誌印・AI指数・短評 など）
  - 調教・厩舎談話（danwa）
  - 前走インタビュー（syoin）
  - パドック情報（paddok）
  - 展開予想（Mermaid図）/ 買い目メモ
  - 結果/騎手コメント/成績サマリー
- 連携: `src.integrator_cli`が作成するintegrated JSONを基に生成（拡張出力対応）

---

## 🚀 メインシステム機能

### 1. 高速データ取得システム（最新・推奨）

#### A. 超高速データ取得
- 実装: `OptimizedDataFetcher`
- 技術: RequestsScraperベース、並列処理
- 性能: 従来比10-20倍高速化
- 特徴: 
  - 最大22並列処理対応
  - リトライ機能（エクスポネンシャルバックオフ）
  - リアルタイムメモリ監視
  - 動的接続プール最適化

#### B. 品質監視・統計機能
- エラー分類: HTTP/タイムアウト/パース/その他の詳細分析
- 品質スコア: 成功率ベースの自動評価（95%基準）
- パフォーマンス統計: 実行時間・メモリ使用量の自動追跡
- アラート機能: 品質基準未達時の自動警告

### 2. 従来システム（互換性維持）

#### A. 安定版データ取得
- 実装: `DataFetcher`
- 技術: Seleniumベース、逐次処理
- 特徴: 
  - 安定性重視の設計
  - 詳細なエラーハンドリング
  - BatchStats統計管理

#### B. 単一レース処理
- 実装: `main.py`
- 用途: 個別レースの詳細取得・テスト
- モード: scrape_and_parse, parse_only, multi_type

---

## 📊 データ取得機能

### 1. レース日程データ取得（nittei）
```
URL: https://p.keibabook.co.jp/cyuou/nittei/{YYYYMMDD}
出力: nittei_YYYYMMDD.json
```

### 2. レース成績データ取得（seiseki）
```
URL: https://p.keibabook.co.jp/cyuou/seiseki/{race_id}
出力: seiseki_YYYYMMDDHHMM.json
```
- 着順・馬名・騎手、タイム、オッズ、人気
- 騎手コメント（インタビュー）

### 3. 出馬表データ取得（shutsuba）
```
URL: https://p.keibabook.co.jp/cyuou/shutsuba/{race_id}
出力: shutsuba_YYYYMMDDHHMM.json
```
- 出走馬・騎手・厩舎、血統、umacd
- 本誌印、短評（キー名正規化対応:「騎手」「短評」「厩舎」）

### 4. 調教データ取得（cyokyo）
```
URL: https://p.keibabook.co.jp/cyuou/cyokyo/0/0/{race_id}
出力: cyokyo_YYYYMMDDHHMM.json
```

### 5. 厩舎の話データ取得（danwa）
```
URL: https://p.keibabook.co.jp/cyuou/danwa/0/{race_id}
出力: danwa_YYYYMMDDHHMM.json
```

### 6. 前走インタビュー（syoin）【拡張】
- 取得・統合に対応、MD新聞へ表示

### 7. パドック情報（paddok）【拡張】
- 取得・統合に対応、MD新聞へ表示（評価・短評）

---

## 🔧 システムインターフェース

### 1. 高速版CLI（fast_batch_cli.py）- 推奨

#### コマンド一覧
```bash
# 超高速一括処理
python -m src.fast_batch_cli full --start YYYY/MM/DD --end YYYY/MM/DD --delay 0.5 --max-workers 8

# データタイプ別取得
python -m src.fast_batch_cli data --start YYYY/MM/DD --end YYYY/MM/DD --data-types seiseki,shutsuba,cyokyo,danwa,syoin,paddok
```

### 2. 統合CLI（integrator_cli）
```bash
# 単日統合
python -m src.integrator_cli batch --date YYYY/MM/DD

# 期間統合
python -m src.integrator_cli batch --start-date YYYY/MM/DD --end-date YYYY/MM/DD
```
- 機能: 各データを統合した`integrated_*.json`を生成（MD新聞の入力）

### 3. Markdown生成CLI（markdown_cli）
```bash
# 単日一括生成（organized出力）
python -m src.markdown_cli batch --date YYYY/MM/DD --organized

# 個別レース生成（organized出力）
python -m src.markdown_cli single --race-id 202501080811 --organized
```
- 機能: MD新聞を競馬場別フォルダに出力

---

## 🔄 データ処理機能

- HTMLパース最適化、JSON統一保存、キー名正規化（shutsuba拡張）
- 統合（integrator）で拡張項目（騎手列・短評・厩舎コメント・syoin・paddok）をマージ
- Markdown生成（markdown_cli）でMD新聞を出力

---

## 📈 監視・運用機能

- 実行時間/メモリ/品質スコアの監視
- 失敗時の詳細ログとアラート

---

## 🛠️ ユーティリティ機能

- 設定管理、ディレクトリ自動作成、ログ統合

---

## 🎯 推奨運用パターン

```powershell
# 週末二日分（例: 8/23-24）
python -m src.fast_batch_cli full --start 2025/08/23 --end 2025/08/24 --delay 0.5 --max-workers 8
python -m src.integrator_cli batch --start-date 2025/08/23 --end-date 2025/08/24
python -m src.markdown_cli batch --date 2025/08/23 --organized
python -m src.markdown_cli batch --date 2025/08/24 --organized
```