# 競馬ブック データ取得システム - 機能一覧

## 📋 概要

競馬ブック データ取得システムが提供する全機能の一覧と詳細説明です。

**最終更新**: 2025年8月9日  
**システムバージョン**: v2.3+（最適化版含む）  
**対応データタイプ**: 5種類（nittei, seiseki, shutsuba, cyokyo, danwa）

---

## 🚀 メインシステム機能

### 1. 高速データ取得システム（最新・推奨）

#### A. 超高速データ取得
- **実装**: `OptimizedDataFetcher`
- **技術**: RequestsScraperベース、並列処理
- **性能**: 従来比10-20倍高速化
- **特徴**: 
  - 最大22並列処理対応
  - リトライ機能（エクスポネンシャルバックオフ）
  - リアルタイムメモリ監視
  - 動的接続プール最適化

#### B. 品質監視・統計機能
- **エラー分類**: HTTP/タイムアウト/パース/その他の詳細分析
- **品質スコア**: 成功率ベースの自動評価（95%基準）
- **パフォーマンス統計**: 実行時間・メモリ使用量の自動追跡
- **アラート機能**: 品質基準未達時の自動警告

### 2. 従来システム（互換性維持）

#### A. 安定版データ取得
- **実装**: `DataFetcher`
- **技術**: Seleniumベース、逐次処理
- **特徴**: 
  - 安定性重視の設計
  - 詳細なエラーハンドリング
  - BatchStats統計管理

#### B. 単一レース処理
- **実装**: `main.py`
- **用途**: 個別レースの詳細取得・テスト
- **モード**: scrape_and_parse, parse_only, multi_type

---

## 📊 データ取得機能

### 1. レース日程データ取得（nittei）
```
URL: https://p.keibabook.co.jp/cyuou/nittei/{YYYYMMDD}
出力: nittei_YYYYMMDD.json
```

**取得データ**:
- 開催場所・レース数
- レース名・コース情報
- レースID自動生成
- 開催状況の自動判定

**特別処理**:
- **開催なし判定**: 開催がない日はJSONファイルを出力しない
- **自動レースID生成**: 12桁レースID（YYYYMMDDVRRR）の自動作成

### 2. レース成績データ取得（seiseki）
```
URL: https://p.keibabook.co.jp/cyuou/seiseki/{race_id}
出力: seiseki_YYYYMMDDHHMM.json
```

**取得データ**:
- 着順・馬名・騎手情報
- タイム・オッズ・人気
- **インタビューデータ**: 騎手コメント
- **メモデータ**: 次走展望

### 3. 出馬表データ取得（shutsuba）
```
URL: https://p.keibabook.co.jp/cyuou/shutsuba/{race_id}
出力: shutsuba_YYYYMMDDHHMM.json
```

**取得データ**:
- 出走馬・騎手・厩舎情報
- 血統情報（父・母・母父）
- 馬主・生産者情報
- **umacd**: 馬コード情報

### 4. 調教データ取得（cyokyo）
```
URL: https://p.keibabook.co.jp/cyuou/cyokyo/0/0/{race_id}
出力: cyokyo_YYYYMMDDHHMM.json
```

**取得データ**:
- 調教日・調教場
- 調教タイム・評価
- 調教コメント
- 騎乗者情報

### 5. 厩舎の話データ取得（danwa）
```
URL: https://p.keibabook.co.jp/cyuou/danwa/0/{race_id}
出力: danwa_YYYYMMDDHHMM.json
```

**取得データ**:
- 厩舎関係者コメント
- コメント日時
- 馬番・馬名対応

---

## 🔧 システムインターフェース

### 1. 高速版CLI（fast_batch_cli.py）- 推奨

#### コマンド一覧
```bash
# レース日程高速取得
python -m src.fast_batch_cli schedule --start-date YYYY/MM/DD

# 並列データ高速取得
python -m src.fast_batch_cli data --start-date YYYY/MM/DD --max-workers 8

# 超高速一括処理
python -m src.fast_batch_cli full --start-date YYYY/MM/DD --delay 0.5
```

#### 高度なオプション
- `--max-workers`: 並列処理数（推奨: 5-12）
- `--delay`: リクエスト間隔（推奨: 0.3-1.0秒）
- `--wait-between-phases`: フェーズ間待機時間
- `--data-types`: 対象データタイプ指定

### 2. 従来版CLI（batch_cli.py）- 安定版

#### コマンド一覧
```bash
# 日程取得
python -m src.batch_cli schedule --start-date YYYY/MM/DD

# データ取得  
python -m src.batch_cli data --start-date YYYY/MM/DD --data-types seiseki

# 一括処理
python -m src.batch_cli full --start-date YYYY/MM/DD
```

#### 基本オプション
- `--delay`: リクエスト間隔（推奨: 3-5秒）
- `--wait-between-phases`: フェーズ間待機時間（推奨: 5-10秒）
- `--debug`: 詳細ログ出力

---

## 🔄 データ処理機能

### 1. HTMLパース機能

#### パーサー一覧
- **SeisekiParser**: レース成績の詳細解析
- **SyutubaParser**: 出馬表の血統・基本情報解析  
- **CyokyoParser**: 調教データの評価・コメント解析
- **DanwaParser**: 厩舎コメントの構造化
- **NitteiParser**: 日程・開催情報の抽出

#### 最適化機能
- **直接パース**: HTMLの一時ファイルを使わない処理
- **エラー回復**: パース失敗時の詳細エラー情報
- **データ検証**: 取得データの妥当性確認

### 2. データ保存機能

#### 統一保存方式
```
KEIBA_DATA_ROOT_DIR/
├── race_ids/YYYYMMDD_info.json    # レースID情報
├── nittei_YYYYMMDD.json           # 日程データ
├── seiseki_YYYYMMDDHHMM.json      # 成績データ  
├── shutsuba_YYYYMMDDHHMM.json     # 出馬表データ
├── cyokyo_YYYYMMDDHHMM.json       # 調教データ
└── danwa_YYYYMMDDHHMM.json        # 厩舎の話データ
```

#### 保存特徴
- **JSON専用**: HTMLファイルは原則保存しない
- **UTF-8エンコーディング**: 日本語完全対応
- **統一ディレクトリ**: 全データを同一フォルダに保存
- **自動作成**: 必要ディレクトリの自動生成

---

## 🔐 認証・セキュリティ機能

### 1. Cookie認証システム

#### 必要Cookie
- `keibabook_session`: セッションID
- `tk`: 認証トークン
- `XSRF-TOKEN`: CSRF保護トークン

#### 自動認証機能
- **セッション管理**: HTTPセッションの自動作成・維持
- **Cookie設定**: 環境変数からの自動読み込み
- **認証検証**: 無効Cookie時のエラーハンドリング

### 2. セキュリティ対策

#### アクセス制御
- **適切な間隔**: サーバー負荷を考慮したリクエスト間隔
- **User-Agent設定**: 適切なブラウザ識別情報
- **接続プール管理**: 過度な同時接続の抑制

---

## 📈 監視・運用機能

### 1. リアルタイム監視

#### パフォーマンス監視
- **実行時間追跡**: 平均/最大/最小時間の自動計算
- **メモリ監視**: psutilによるリアルタイムメモリ監視
- **処理速度監視**: タスク/秒の自動計算
- **品質スコア**: 成功率ベースの品質評価

#### 進捗表示
- **リアルタイム進捗**: 処理中の進捗パーセンテージ
- **経過時間表示**: 開始からの経過時間
- **残り時間予測**: 処理速度ベースの予測時間

### 2. エラー処理・統計

#### 詳細エラー分析
```python
ErrorStats:
  - http_errors: HTTPエラー数
  - timeout_errors: タイムアウトエラー数  
  - parse_errors: パースエラー数
  - total_retries: 総リトライ回数
  - error_details: 詳細エラー情報
```

#### 自動アラート
- **品質基準監視**: 95%未満で自動アラート
- **アラートファイル**: JSON形式での詳細情報保存
- **ログ出力**: 重大度に応じた適切なログレベル

### 3. 統計レポート機能

#### BatchStats統計
- **成功率**: 処理成功率の自動計算
- **処理時間**: 開始〜終了時間の記録
- **処理件数**: 成功・失敗・スキップ件数
- **詳細リスト**: 処理済み・失敗レースID一覧

---

## 🛠️ ユーティリティ機能

### 1. 設定管理

#### 環境変数管理（config.py）
- **データディレクトリ**: `KEIBA_DATA_ROOT_DIR`での統一管理
- **Cookie設定**: 認証情報の環境変数管理
- **ログレベル**: `LOG_LEVEL`での出力制御

#### ディレクトリ管理
- **自動作成**: 必要ディレクトリの自動生成
- **パス管理**: 統一的なファイルパス生成
- **権限確認**: ディレクトリ作成権限の事前チェック

### 2. ログ機能

#### 統一ログシステム（logger.py）
- **複数出力**: コンソール・ファイル同時出力
- **レベル制御**: DEBUG/INFO/WARNING/ERROR
- **自動ローテーション**: 日付ベースのログファイル管理
- **UTF-8対応**: 日本語ログの完全対応

---

## 🔄 互換性・移行機能

### 1. レガシーサポート

#### 従来システム維持
- **main.py**: 単一レース処理の継続サポート
- **legacy_scrapers.py**: 旧機能の統合保持
- **互換CLI**: 従来版CLIの完全サポート

### 2. 段階的移行

#### 移行パス
1. **現状維持**: 従来版での安定運用継続
2. **並行テスト**: 高速版での部分的テスト実行
3. **段階移行**: データタイプ別の段階的移行
4. **完全移行**: 高速版への完全切り替え

---

## 🎯 推奨運用パターン

### 1. 通常運用（推奨）
```bash
# 高速版での日次処理
python -m src.fast_batch_cli full --start-date $(date +%Y/%m/%d) --delay 0.5 --max-workers 8
```

### 2. 安定運用
```bash
# 従来版での確実な処理
python -m src.batch_cli full --start-date $(date +%Y/%m/%d) --delay 5
```

### 3. 大量データ処理
```bash
# 期間指定での高速一括処理
python -m src.fast_batch_cli full --start-date 2025/08/01 --end-date 2025/08/31 --delay 0.3 --max-workers 12
```

---

**このシステムは従来の安定性を保ちながら、最新技術による大幅な性能向上を実現し、大規模な競馬データ処理を効率的に実行できます。**