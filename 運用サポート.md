# 運用サポート - 競馬予想準備

## 0. KeibaCICD.WebViewer 起動

### 起動方法

```powershell
cd .\keiba-cicd-core\KeibaCICD.WebViewer
npm run dev
```

ブラウザで http://localhost:3000 を開きます。

### 主要ページ

| ページ | URL | 説明 |
|:---|:---|:---|
| トップ | http://localhost:3000 | 日付選択・レース一覧 |
| 管理画面 | http://localhost:3000/admin | keibabookデータ取得・バッチ実行 |
| 馬検索 | http://localhost:3000/horses | 馬名検索・プロファイル表示 |
| マルチビュー | http://localhost:3000/multi-view | JRA映像並列表示（2画面/4画面） |

### データソース

デフォルト: `Z:/KEIBA-CICD/data2/`

変更する場合は環境変数を設定:
```powershell
$env:DATA_ROOT = "C:/path/to/your/data"
npm run dev
```

---

## 1. 競馬ブックWEBスクレイピング

### 1.1 騎手情報を更新

```powershell
cd .\keiba-cicd-core\KeibaCICD.keibabook
python -m src.jockey_cli leading
python -m src.jockey_cli update --top 200
```

### 1.2 開催日設定

```powershell
cd .\keiba-cicd-core\KeibaCICD.keibabook
$from_date = "2026/01/18"
$to_date = "2026/01/18"
$date = "20260118"
```

### 1.3 基本データ取得

```powershell
# スケジュール取得
python -m src.fast_batch_cli schedule --start $from_date --end $to_date

# 基本データ取得（出馬表、調教、談話、勝因）
python -m src.fast_batch_cli full --start $from_date --end $from_date --data-types shutsuba,cyokyo,danwa,syoin

# パドック、成績データ取得
python -m src.fast_batch_cli full --start $from_date --end $from_date --data-types paddok,seiseki

# データ統合・MD生成
python -m src.integrator_cli batch --date $from_date
python -m src.markdown_cli batch --date $from_date --organized

# 馬プロフィール生成
python -m src.horse_profile_cli --date $from_date --all --with-history --with-seiseki-table
```

### 1.4 調教データ集計（TARGET連携）

```powershell
# スクリプトの場所: keiba-cicd-core\KeibaCICD.TARGET\scripts\training_summary.py
# データの場所: Z:\KEIBA-CICD\調教データ\

cd Y:\TXT
cd Z:\KEIBA-CICD\調教データ
$script = "C:\source\git-h.fukuda1207\_keiba\keiba-cicd-core\KeibaCICD.TARGET\scripts\training_summary.py"
$date = "20260124"

# 馬名・調教タイムをクリップボードにコピー（TARGETに貼り付け用）
python $script --sakamichi chokyo_坂路.csv --course chokyo_コース.csv --date $date --output output.txt --clip-time

# 馬名・調教ラップをクリップボードにコピー（TARGETに貼り付け用）
python $script --sakamichi chokyo_坂路.csv --course chokyo_コース.csv --date $date --output output.txt --clip-lap

# 馬名・調教詳細をクリップボードにコピー
python $script --sakamichi chokyo_坂路.csv --course chokyo_コース.csv --date $date --output output.txt --clip-detail
```

### 1.5 調教コメント・本誌印出力（競馬ブックデータ）

```powershell
cd .\keiba-cicd-core\KeibaCICD.keibabook\scripts

# 調教コメントをクリップボードにコピー
python clip_training_comment.py --date $date

# 本誌印をクリップボードにコピー
python clip_honshi_mark.py --date $date
```

**出力形式**:
- 調教コメント: `馬名<TAB>調教コメント`
- 本誌印: `馬名<TAB>本誌印`

---

## 2. 調教データ集計（TARGET用）詳細

> **スクリプト配置場所**: `keiba-cicd-core\KeibaCICD.TARGET\scripts\training_summary.py`
> **仕様書**: `keiba-cicd-core\KeibaCICD.TARGET\docs\調教データ作成スクリプト開発.md`
> **使い方ガイド**: `keiba-cicd-core\KeibaCICD.TARGET\docs\training_summary_使い方.md`

### 2.1 基本的な使い方

```powershell
cd Z:\KEIBA-CICD\調教データ
$script = "C:\source\git-h.fukuda1207\_keiba\keiba-cicd-core\KeibaCICD.TARGET\scripts\training_summary.py"
```

### 2.2 テキストファイル出力

```powershell
python $script --sakamichi chokyo_260104_坂路.csv --course chokyo_260104_コース.csv --date 20260111 --output chokyo_260104.txt
```

### 2.3 Excel出力

```powershell
python $script --sakamichi chokyo_260104_坂路.csv --course chokyo_260104_コース.csv --date 20260111 --output chokyo_260104.xlsx --excel
```

### 2.4 クリップボード出力

```powershell
# 馬名・調教ラップをクリップボードにコピー（TARGETに貼り付け用）
python $script --sakamichi chokyo_坂路.csv --course chokyo_コース.csv --date 20260111 --output output.txt --clip-lap

# 馬名・調教タイムをクリップボードにコピー（TARGETに貼り付け用）
python $script --sakamichi chokyo_坂路.csv --course chokyo_コース.csv --date 20260111 --output output.txt --clip-time

# 馬名・調教詳細をクリップボードにコピー（TARGETに貼り付け用）
python $script --sakamichi chokyo_坂路.csv --course chokyo_コース.csv --date 20260111 --output output.txt --clip-detail
```

### 2.5 オプション一覧

| オプション | 説明 |
|:---|:---|
| `-s`, `--sakamichi` | 坂路CSVファイルのパス |
| `-c`, `--course` | コース調教CSVファイルのパス |
| `-d`, `--date` | 基準日（YYYYMMDD形式）**必須** |
| `-o`, `--output` | 出力ファイルのパス **必須** |
| `--clip-lap` | 馬名・調教ラップをクリップボードにコピー |
| `--clip-time` | 馬名・調教タイムをクリップボードにコピー |
| `--clip-detail` | 馬名・調教詳細をクリップボードにコピー |
| `--excel` | Excelファイル(.xlsx)で出力 |

### 2.6 調教ラップ分類ルール

| 分類 | 条件 | 説明 |
|:---:|:---|:---|
| **SS** | 好タイム + S分類 + 加速or同タイム | 最高（好タイム + 好ラップ） |
| **S** | Lap2・Lap1が11秒台以下 | 好ラップ（2F連続11秒台以下） |
| **A** | Lap1が11秒台以下、Lap2が12秒台以上 | 好（加速して終い11秒台以下） |
| **B** | Lap2・Lap1が12秒台 | 良（2F連続12秒台） |
| **C** | Lap1が12秒台 | 普通（終い12秒台） |
| **D** | Lap1が13秒台以上 | 軽め |

記号: `+` = 加速, `-` = 減速, `=` = 同タイム

### 2.7 調教タイム分類

| 記号 | 意味 |
|:---:|:---|
| **坂** | 坂路で好タイム |
| **コ** | コースで好タイム |
| **両** | 坂路+コース両方で好タイム |
| (ブランク) | 好タイムなし |

**好タイム基準（4F）:**
- 美浦坂路: 52.9秒以下
- 栗東坂路: 53.9秒以下
- 美浦/栗東コース: 52.2秒以下

---

## 3. 調教データ直接取得（TARGETデータ参照）[NEW]

> **CSVを毎回出力しなくても、TARGETのデータを直接参照して調教サマリーを生成できます。**

### 3.1 調教サマリーAPI

KeibaCICD.WebViewerが起動している状態で、ブラウザまたはcurlでアクセス：

```
http://localhost:3000/api/training/summary?date=YYYYMMDD
```

**パラメータ:**
- `date`: レース開催日（基準日）YYYYMMDD形式
- `format`: `json`（デフォルト）または `tsv`（TARGET取り込み用）

**例:**
```powershell
# JSON形式で取得
Invoke-WebRequest -Uri "http://localhost:3000/api/training/summary?date=20260125" -UseBasicParsing

# TSV形式でファイル保存
Invoke-WebRequest -Uri "http://localhost:3000/api/training/summary?date=20260125&format=tsv" -OutFile "training_20260125.txt"
```

### 3.2 デバッグAPI（調教データ確認）

特定日の調教データを直接確認：

```
http://localhost:3000/api/debug/training?date=YYYYMMDD
```

**例:**
```powershell
Invoke-WebRequest -Uri "http://localhost:3000/api/debug/training?date=20260123" -UseBasicParsing
```

### 3.3 データソース

TARGETの調教データを直接参照：
- **パス**: `Y:\CK_DATA\YYYY\YYYYMM\`
- **坂路調教**: `WC{0|1}YYYYMMDD.DAT` (0=美浦, 1=栗東)
- **コース調教**: `HC{0|1}YYYYMMDD.DAT`

**仕様書**: `KeibaCICD.TARGET\docs\CK_DATA_調教データ仕様.md`

### 3.4 データ保存と出走表表示

管理画面で「データ保存」ボタンをクリックすると、以下のファイルが生成されます：

```
Z:\KEIBA-CICD\data2\races\{year}\{month}\{day}\temp\training_summary.json
```

このファイルが存在すると、出走表に「ﾀｲﾑ」「ﾗｯﾌﾟ」列が自動表示されます。

**ワークフロー:**
1. 管理画面（/admin）でレース開催日を選択
2. 「サマリー生成」ボタンをクリック
3. 結果を確認して「データ保存」ボタンをクリック
4. 出走表ページ（/races-v2/...）で自動的にタイム・ラップが表示

### 3.5 従来方式との比較

| 項目 | 従来方式（CSV） | 新方式（API） |
|:---|:---|:---|
| 事前準備 | TARGETからCSV出力が必要 | 不要（自動取得） |
| データソース | CSVファイル | TARGET CK_DATAを直接参照 |
| 馬名取得 | CSVに含まれる | SE_DATAから自動取得 |
| 実行方法 | Pythonスクリプト | WebViewer API |
| 出力形式 | TXT/Excel | JSON/TSV |
| 出走表連携 | 手動 | 自動（保存後自動表示） |