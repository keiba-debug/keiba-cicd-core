# 予想支援ツール

**対象**: ふくださん（手動予想時の支援）

---

## 📦 ツール一覧

### 1. prediction_helper.py - 予想ヘルパー
手動で予想した馬の期待値計算と賭け金推奨を行う。

### 2. race_selector.py - レース選定支援
データの完全性と予想しやすさを評価し、予想すべきレースを推奨する。

---

## 🚀 使い方

### ステップ1: レース選定

まず、どのレースを予想すべきか確認します。

```bash
cd E:\share\KEIBA-CICD\_keiba

# 明日(1/31)のレースを評価
python keiba-ai/tools/race_selector.py --date 20260131

# スコア60点以上のレースが表示される
```

**出力例:**
```
=========================================================================================
レース選定結果
=========================================================================================
No   レースID        レース名                   場所     スコア   推奨   理由
-----------------------------------------------------------------------------------------
1    202601310101   東京1R 3歳未勝利           東京     78.5    高     データ完全性: 85% / 予想しやすさ: 70%
2    202601310203   中山2R 3歳新馬             中山     72.3    中     データ完全性: 80% / 予想しやすさ: 62%
3    202601310305   京都3R 4歳上1勝クラス      京都     68.9    中     データ完全性: 75% / 予想しやすさ: 60%
-----------------------------------------------------------------------------------------
合計: 3レース
=========================================================================================
```

**推奨度の目安:**
- **高** (75点以上): データが充実、予想推奨
- **中** (60-74点): データはそこそこ、予想可能
- **低** (45-59点): データ不足、注意が必要
- **不可** (44点以下): データ不足、予想非推奨

---

### ステップ2: 出走馬確認

予想するレースを決めたら、出走馬を確認します。

```bash
# 東京1Rの出走馬一覧を表示
python keiba-ai/tools/prediction_helper.py --race-id 202601310101
```

**出力例:**
```
================================================================================
レース: 東京1R 3歳未勝利
ID: 202601310101
================================================================================
馬番 馬名                 騎手            単勝オッズ  複勝オッズ
--------------------------------------------------------------------------------
1    ミライノヒカリ       横山武史        3.5        1.5-2.0
2    カガヤクセイシュン   福永祐一        5.2        2.0-2.5
3    ハヤテノコトク       ルメール        2.1        1.2-1.5
...
================================================================================
```

---

### ステップ3: 予想入力（対話モード）

対話モードで予想を入力します。

```bash
# 対話モード起動
python keiba-ai/tools/prediction_helper.py --interactive
```

**対話例:**
```
================================================================================
予想ヘルパーツール - 対話モード
================================================================================
コマンド:
  list [YYYYMMDD]  - レース一覧を表示
  show <race_id>   - 出走馬一覧を表示
  predict          - 予想を入力
  quit             - 終了
================================================================================

コマンド> predict

--- 予想入力 ---
レースID: 202601310101
馬名: ハヤテノコトク
予想勝率 (例: 15 for 15%): 18
券種 (win/place) [win]: win

================================================================================
分析結果
================================================================================
レース: 東京1R 3歳未勝利
馬名: ハヤテノコトク (3番)
券種: win
--------------------------------------------------------------------------------
予想勝率: 18.0%
オッズ: 2.1倍
期待値: -62.00円 (93.8%)
--------------------------------------------------------------------------------
推奨: NO
理由: 期待値が110%未満
--------------------------------------------------------------------------------
推奨賭け金: 0円
購入可否: 不可
リスク理由: 期待値が基準未満
================================================================================

他にも予想を追加しますか？ (y/n): y

--- 予想入力 ---
レースID: 202601310101
馬名: カガヤクセイシュン
予想勝率 (例: 15 for 15%): 20
券種 (win/place) [win]: win

================================================================================
分析結果
================================================================================
レース: 東京1R 3歳未勝利
馬名: カガヤクセイシュン (2番)
券種: win
--------------------------------------------------------------------------------
予想勝率: 20.0%
オッズ: 5.2倍
期待値: 40.00円 (140.0%)
--------------------------------------------------------------------------------
推奨: YES
理由: 期待値が110%以上
--------------------------------------------------------------------------------
推奨賭け金: 2,800円
購入可否: 可
================================================================================

他にも予想を追加しますか？ (y/n): n

================================================================================
予想サマリー
================================================================================
No   馬名                 勝率%    オッズ    期待値%    推奨   賭け金
--------------------------------------------------------------------------------
1    ハヤテノコトク       18.0     2.1      93.8       NO     0円
2    カガヤクセイシュン   20.0     5.2      140.0      YES    2,800円
--------------------------------------------------------------------------------
合計: 2件 (推奨: 1件)
合計賭け金: 2,800円
================================================================================

結果を保存しますか？ (y/n): y

予想結果を保存しました: E:\share\KEIBA-CICD\_keiba\logs\user_predictions\predictions_20260131_123456.json
```

---

## 📊 期待値の見方

### 期待値率とは

**期待値率 = (予想勝率 × オッズ) × 100**

- **110%以上**: 購入推奨（プラス期待値）
- **100-110%**: ボーダーライン
- **100%未満**: 購入非推奨（マイナス期待値）

### 例

| 予想勝率 | オッズ | 期待値率 | 判定 |
|---------|-------|---------|------|
| 20% | 7.0倍 | 140% | ✅ 推奨 |
| 15% | 8.0倍 | 120% | ✅ 推奨 |
| 18% | 5.0倍 | 90% | ❌ 非推奨 |
| 10% | 12.0倍 | 120% | ✅ 推奨 |

---

## 💰 賭け金の決まり方

### Kelly基準（Quarter Kelly）

```
賭け金 = 資金 × Kelly係数 × 0.25
```

**Kelly係数の計算:**
```
Kelly係数 = (オッズ × 勝率 - (1 - 勝率)) / (オッズ - 1)
```

### 例

**資金: 100,000円、予想勝率: 20%、オッズ: 5.2倍**

1. Kelly係数 = (5.2 × 0.2 - 0.8) / 4.2 = 0.0571
2. Quarter Kelly = 0.0571 × 0.25 = 0.0143
3. 賭け金 = 100,000 × 0.0143 = 1,430円 → **約1,400円**

**特徴:**
- 期待値が高いほど賭け金が増える
- 勝率が低くてもオッズが高ければ賭ける
- リスク管理が組み込まれている（Quarter Kellyで保守的）

---

## ⚙️ 設定のカスタマイズ

### 資金を変更

```bash
python keiba-ai/tools/prediction_helper.py --interactive --bankroll 50000
```

### Kelly係数を変更

```bash
# 0.5 = Half Kelly (より積極的)
python keiba-ai/tools/prediction_helper.py --interactive --kelly-fraction 0.5

# 0.125 = 1/8 Kelly (より保守的)
python keiba-ai/tools/prediction_helper.py --interactive --kelly-fraction 0.125
```

### レース選定の閾値を変更

```bash
# スコア50点以上のレースを表示
python keiba-ai/tools/race_selector.py --date 20260131 --min-score 50

# スコア70点以上のレースを表示（厳しめ）
python keiba-ai/tools/race_selector.py --date 20260131 --min-score 70
```

---

## 📁 保存されるファイル

### 予想結果

```
E:\share\KEIBA-CICD\_keiba\logs\user_predictions\
  └─ predictions_20260131_123456.json
```

**内容:**
```json
[
  {
    "race_id": "202601310101",
    "race_name": "東京1R 3歳未勝利",
    "horse_name": "カガヤクセイシュン",
    "win_prob": 0.2,
    "odds": 5.2,
    "expected_value": 40.0,
    "expected_value_rate": 140.0,
    "recommended": true,
    "bet_amount": 2800
  }
]
```

### レース選定結果

```
E:\share\KEIBA-CICD\_keiba\logs\race_selection\
  └─ race_scores_20260131_123456.json
```

---

## 💡 予想のコツ

### 1. レース選定を活用

- まず `race_selector.py` でスコアを確認
- スコア75点以上のレースを優先
- データが不足しているレースは避ける

### 2. 期待値重視

- 期待値率110%以上を目安に
- 期待値が高い馬に集中
- 低オッズ（堅い馬）でも期待値が低ければパス

### 3. 勝率の見積もり

- 過去成績を参考に
- オッズから逆算してみる（オッズ5倍 → 市場は約20%と見ている）
- 自分の予想が市場より高ければチャンス

### 4. リスク管理

- 1レースあたりの賭け金は資金の2%程度まで
- Quarter Kelly（0.25）を推奨
- 連敗が続いたら休憩

---

## 🔄 ワークフロー例

### 週末の予想フロー

**金曜夜:**
1. `race_selector.py` で土日のレースを評価
2. 推奨レースをリストアップ

**土曜朝:**
1. `prediction_helper.py` (対話モード) で予想入力
2. 期待値と賭け金を確認
3. 推奨された馬券を購入

**土曜夜:**
1. 結果を記録
2. 日曜の予想を調整

**日曜:**
1. 土曜の結果を参考に予想
2. 同じフローで馬券購入

**月曜:**
1. 週末の成績を振り返り
2. 勝率の見積もり精度をチェック

---

## ❓ トラブルシューティング

### Q. レースデータが見つからない

**A.** データ作成処理が必要です。WebViewerのadmin画面でデータ作成を実行してください。

### Q. オッズ情報がない

**A.** レース確定前のデータの可能性があります。オッズ発表後に再度確認してください。

### Q. 推奨賭け金が0円になる

**A.** 以下の理由が考えられます:
- 期待値が110%未満
- リスク管理により制限されている
- Kelly係数が負（オッズが低すぎる）

### Q. レース選定で全レースが「不可」

**A.** データが不足しています。以下を確認:
- 過去成績データの取得
- オッズ情報の更新
- JRA-VANデータの同期

---

## 📞 サポート

ツールの使い方や改善要望は、カカシまでご連絡ください。

---

**「データを駆使して、期待値で勝つってばよ！」 - ナルト**

---

*作成日: 2026-01-31*
*作成者: カカシ*
