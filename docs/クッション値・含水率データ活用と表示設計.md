# クッション値・含水率データ活用と表示設計

## 1. 概要

**クッション値**・**ゴール前含水率**・**4コーナー含水率** を、場所は常に **JV_DATA_ROOT_DIR のサブディレクトリ _BABA 以下** に格納されている BABA データとして、レース結果分析画面（`/races-v2/[date]/[track]/[id]`）および今後のデータ分析・コースデータコーナーで活用するための設計・アイデアをまとめる。

- **目的**: 馬場コンディション（クッション値・含水率）を考慮した「上がり3F」「走破タイム」の解釈を深め、より良い分析体験を提供する。
- **参照**: 添付いただいたJRA公表資料（含水率と馬場状態の関係、クッション値の基準、含水率早見表など）を前提とする。

---

## 2. BABAデータの構造とキー対応

### 2.1 ファイル一覧（JV_DATA_ROOT_DIR/_BABA 以下）

| 種別 | ファイル例 | 内容 |
|------|------------|------|
| クッション値 | `cushion2021.csv` ～ `cushion2026.csv` | 芝/ダート別のクッション値 |
| ゴール前含水率 | `moistureG_2021.csv` ～ `moistureG_2026.csv` | ゴール前含水率（芝・ダートで行が分かれる） |
| 4コーナー含水率 | `moisture4_2021.csv` ～ `moisture4_2026.csv` | 4コーナー含水率（同上） |

### 2.2 CSVフォーマット

- **cushion\*.csv**  
  - 列: `レースラベル`, `RX_ID`, `値`  
  - 値: `00 9.4`（芝）, `0D10.7`（ダート）など。先頭2文字が芝(00)/ダ(0D)、続く数値がクッション値。
- **moistureG\*.csv / moisture4\*.csv**  
  - 同一レースで芝・ダートの2行がある場合あり。  
  - 値: `0012.5`（芝 %）, `0D 7.1`（ダート %）など。先頭2文字が芝(00)/ダ(0D)、続く数値が含水率（%）。

### 2.3 レースIDの対応関係

- **WebViewerのレースID（URLの id）**  
  - 形式: `YYYYMMDD` + `場コード2桁` + `レース番号2桁`（例: `202601250601` = 2026/01/25 中山 1R）  
  - 場コード: 01札幌, 02函館, 03福島, 04新潟, 05東京, **06中山**, 07中京, 08京都, 09阪神, 10小倉（`jra-viewer-url.ts` の 1～10 を 2桁ゼロ埋め）。
- **BABAのキー（RX_ID）**  
  - 形式: `RX` + `場コード2桁` + `年2桁` + `回1桁` + `日1桁` + `レース2桁`  
  - 例: `RX06261101` = 2026年 中山(06) 1回 1日 01R。

**対応の取り方**

- 日付・競馬場・レース番号は既存の `race_id` から取得可能。
- **回・日** は `race_info.json` の `kaisai_data` と `getKaisaiInfoFromRaceInfo()` で取得しているため、同じ情報で RX_ID を組み立て可能。
- 実装方針:
  - **案A**: バッチで BABA を読み、`(date, track, race_number)` または `race_id` をキーにした JSON/DB を生成し、WebViewer はそれを参照する。
  - **案B**: WebViewer 側で `(date, track, race_number, kai, nichi)` から RX_ID を生成し、BABA の CSV を参照する API/reader を用意する（BABA は年単位なので、年でファイルを切り替える）。

---

## 3. 馬場状態の解釈（JRA資料に基づく）

### 3.1 クッション値と馬場表層の関係（芝）

| クッション値 | クッション性 | 水分状態 |
|-------------|-------------|----------|
| 12以上 | 硬め | 乾燥気味 |
| 10～12 | やや硬め | やや乾燥気味 |
| 8～10 | 標準 | 標準 |
| 7～8 | やや軟らかめ | やや湿潤気味 |
| 7以下 | 軟らかめ | 湿潤気味 |

※ 芝は競馬場ごとに路盤が異なるため、含水率と馬場状態の関係は**競馬場ごとに異なる**。ダートは全場共通の目安でよい。

### 3.2 含水率と馬場状態（目安）

- **芝**: 競馬場別の「含水率～馬場状態」早見表あり（良・稍重・重・不良の範囲が競馬場ごと）。
- **ダート**: 全場共通の目安（例: 良 9%以下、稍重 7～13%、重 11～16%、不良 14%以上）。
- 馬場状態は「含水率だけで自動決定されるものではない」が、表示時には「〇〇%（良馬場相当）」のように**参考表示**する価値はある。

### 3.3 クッション値と含水率の関係

- 含水率が高いほどクッション値は低くなる傾向（馬場が軟らかくなる）。
- クッション値は「芝＋路盤」、含水率は「路盤の水分」を測るため、両方あると解釈がしやすい。

---

## 4. 表示・分析のアイデア

### 4.1 レース結果ページ（/races-v2/…）での表示

#### A. ヘッダー付近（馬場コンディション概要）

- **表示内容**  
  - 当該レースの **芝/ダート** に応じた **クッション値**・**ゴール前含水率**・**4コーナー含水率**。  
  - 可能なら「馬場状態の目安」（例: 良・稍重・重・不良のどれに近いか）を、JRAの早見表に基づき**参考**で表示（「含水率 XX%（稍重馬場の目安範囲）」など）。
- **見せ方**  
  - 既存の RPCI バッジの近くに、コンパクトな「馬場コンディション」ブロックを追加。  
  - 例: 「クッション 9.4（標準） / G前 12.5% / 4C 13.6%」＋馬場状態ラベル（色分け可: 良=緑、稍重=黄、重=オレンジ、不良=赤など）。

#### B. 結果セクション内（上がり3F・走破タイムの文脈付け）

- **現在**: `Last3FComparisonChart` で上がり3Fを比較表示している。
- **追加案**  
  - 同じブロックの上または横に、そのレースの **クッション値・含水率** を 1 行で表示。  
  - 文言例: 「このレースの馬場: クッション 9.4（標準）、含水率 G前 12.5% / 4C 13.6%（稍重の目安範囲）」  
  - これにより「上がりが速い/遅い」を「馬場が硬い/軟らかい」と合わせて解釈しやすくする。

#### C. 走破タイムとの関係

- 走破タイムは既に結果テーブルなどで表示されている。  
- 馬場コンディション欄に「馬場が硬めの日はタイムが通りやすい」「軟らかめの日はタイムが遅れやすい」といった**短文の注釈**を出してもよい（固定文言 or クッション値/含水率の範囲で出し分け）。

### 4.2 見せ方の具体案

| 要素 | 案 |
|------|-----|
| 配置 | RaceHeader のコース情報・RPCI の近くに「馬場コンディション」を追加。結果タブ内では「レース結果」の上または「上がり3F」チャートの上に同じ要約を表示。 |
| 数値 | クッション値（1桁小数）、ゴール前含水率（%）、4コーナー含水率（%）をそのまま表示。 |
| 解釈 | クッション値 → 「硬め/標準/軟らかめ」等のラベル。含水率 → 競馬場・芝/ダート別の早見表から「良/稍重/重/不良」の目安範囲に対応するラベルを参考表示。 |
| 視覚 | 馬場状態に応じたバッジ色（良=緑、稍重=黄、重=オレンジ、不良=赤）。ツールチップで「JRA 早見表に基づく目安です」と注記。 |

#### 表示例（文言イメージ）

- **ヘッダー用（1行）**  
  「馬場: クッション 9.4（標準） / G前 12.5% / 4C 13.6% （稍重の目安）」
- **結果セクション用（補足）**  
  「このレースの馬場コンディション: クッション 9.4・含水率 G前 12.5%・4C 13.6%。上がり3Fは馬場がやや重めの日の参考値としてご利用ください。」
- **含水率のみある場合**  
  「含水率: G前 XX% / 4C YY%（良馬場相当）」のように、早見表に基づく目安のみ表示。

#### JRA資料との対応（実装時の参照）

- **含水率と馬場状態区分の関係**: 芝は競馬場ごと・ダートは全場共通の「良・稍重・重・不良」の含水率範囲が公表されている。表示時はこの早見表に合わせて「〇〇%（良の目安範囲）」等を算出する。
- **含水率早見表**: 「G」= ゴール前含水率、「4」= 4コーナー含水率の測定位置。同一レースで G と 4 の両方を表示すると、馬場のばらつきが分かりやすい。
- **クッション値の基準**: 12以上=硬め、10～12=やや硬め、8～10=標準、7～8=やや軟らかめ、7以下=軟らかめ。水分状態（乾燥気味～湿潤気味）と対応付けて表示すると理解しやすい。

### 4.3 分析の深掘り（将来的な拡張）

- **上がり3Fとの相関**  
  - 同一コース・距離で、クッション値や含水率の範囲別に「平均上がり3F」を集計し、  
    「硬めの日は平均 XX 秒」「軟らかめの日は平均 YY 秒」のように表示する。  
  - データ分析コーナーで、コース×馬場コンディション別の分布や傾向グラフを追加可能。
- **走破タイムとの相関**  
  - 同様に、馬場コンディション別の平均走破タイムや RPCI との関係を可視化する。
- **RPCI との統合**  
  - 既存の RPCI 基準値は「コース×距離」の統計。ここに「馬場コンディション（クッション値・含水率）」を軸にした補正やフィルタを加えると、  
    「今日の馬場では RPCI が高め/低めに出やすい」といった分析ができる。

---

## 5. データ分析コーナー・コースデータコーナーへの展開

### 5.1 データ分析コーナー

- **馬場コンディション別集計**  
  - クッション値・含水率の範囲（例: 硬め/標準/軟らかめ、または 良/稍重/重/不良）ごとに、  
    上がり3F・走破タイム・RPCI の平均・分布を表示。
- **時系列**  
  - 開催日ごとのクッション値・含水率の推移（同一競馬場・芝 or ダート）をグラフ化。
- **相関**  
  - 含水率 vs クッション値、含水率 vs 平均上がり3F などの簡易散布図。

### 5.2 コースデータコーナー

- **競馬場×芝/ダート** の「馬場状態と含水率の関係」早見表を、JRA 資料に基づいて静的または設定で保持し、参照表示する。
- **クッション値の基準表**（芝馬場のクッション値と硬さ・水分状態の対応）を同じく参照表示する。
- 必要に応じて「洋芝/野芝」の説明や、ダートは全場共通である旨の注記を追加できる。

### 5.3 新たに追加し得るデータ

- 当日雨量（JRA の「注記」にあるような情報）が入手できれば、含水率の変動の補足説明に使える。
- 芝の種類（洋芝 3 種混合 / 野芝）は競馬場で決まっているため、コースデータとして持っておくとクッション値の解釈に役立つ。

---

## 6. 実装ステップ案

1. **BABA 読み込みとキー対応**  
   - BABA の CSV を読むユーティリティ（Node またはバッチで JSON 化）を用意。  
   - `race_id` または `(date, track, race_number)` ＋ 開催回・日 → RX_ID の変換を実装。
2. **馬場コンディション取得 API/reader**  
   - 指定レースのクッション値・ゴール前含水率・4コーナー含水率を返す。  
   - 必要なら競馬場・芝/ダート別の「含水率→馬場状態」早見表を定数または設定で持つ。
3. **RaceHeader / 結果セクションの表示**  
   - 上記データを渡し、クッション値・含水率・馬場状態の目安を表示。  
   - デザインは既存の RPCI バッジやコースバッジに合わせ、レイアウト・色は既存ルールに従う。
4. **データ分析・コースデータへの追加**  
   - 馬場コンディション別集計・早見表表示は、分析コーナー・コースデータコーナーの既存構成に合わせて追加。

---

## 7. 注意事項

- 馬場状態は JRA が「総合的に判断」しており、含水率の数値で自動決定されるものではないため、UI では「目安」「参考」であることを明示する。
- BABA の CSV は文字コード（Shift_JIS 等）や改行・引用符の扱いに注意する。
- 既存の `analyze_moisture_pci.py` は別フォーマット（PCI3・レース印２）を対象としており、BABA の moistureG/moisture4 とは別。必要に応じて BABA 用の読み込みを新規に用意する。

---

## 8. まとめ

- **BABA データ**: クッション値・ゴール前/4コーナー含水率を、RX_ID と芝/ダート識別子で保持。WebViewer の `race_id` とは「日付・場・回・日・レース番号」から RX_ID を組み立てて対応可能。
- **表示**: レース結果ページのヘッダーと結果ブロックで、馬場コンディション（数値＋馬場状態の目安）をコンパクトに表示し、上がり3F・走破タイムの解釈を補助する。
- **分析**: 馬場コンディション別の上がり3F・走破タイムの集計や、含水率早見表の参照を、データ分析コーナー・コースデータコーナーに追加していくことで、より有効なデータ活用が可能になる。
