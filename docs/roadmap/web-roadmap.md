# Web機能開発ロードマップ

WebViewer (Next.js) の機能追加・UI改善・TARGET連携に関する開発候補の管理。

> **ML開発の候補**: `roadmap/ml-roadmap.md`
> **WebViewer実装**: `keiba-v2/web/`
> **TARGET連携**: FF CSV出力（`target-pd-writer.ts`）、UmaMark書込み（`target-mark-writer.ts`）

---

## 現在の到達点（2026-02-15時点）

### 実装済みページ
- **レース一覧** (`/races`): 日付別レース表示、タブ/全表示モード
- **レース詳細** (`/races/[id]`): 出走表、レース分析、調教、コメント
- **予測一覧** (`/predictions`): VB候補テーブル、推奨買い目、ROI計算
- **馬検索** (`/horses`): 馬名検索 → 馬詳細
- **レース検索** (`/search`): 条件検索
- **資金管理** (`/bankroll`): 購入リスト、残高管理
- **管理画面** (`/admin`): データ構築、スクレイプ、ML実行

### 実装済みTARGET連携
- **UmaMark2**: VB印一括書込み（`/api/target-marks/auto-vb`）
- **FF CSV**: 推奨買い目出力（`/api/target-marks/auto-bet` → `C:\TFJV\TXT\`）
- **Kelly配分**: 1/4 Kelly × 日予算 × フィルタ連動

---

## 1. 購入情報モーダル ⭐高優先

### 概要
レース詳細画面に「購入情報」ボタン表示（購入記録がある場合のみ）。
モーダルで買い目詳細を確認できる。

### 仕様
- **表示条件**: 該当レースの購入記録が `userdata/purchases/` に存在する場合
- **モーダル内容**:
  | 券種 | 買い目 | 金額 | オッズ | 払戻 | 結果 |
  |------|--------|------|--------|------|------|
  | 単勝 | 8 | ¥300 | 7.8 | - | × |
  | 単勝 | 3 | ¥100 | 10.4 | ¥1,040 | ✓ |
  | 単勝 | 11 | ¥100 | 166.9 | - | × |
- **合計表示**: 投資合計、払戻合計、収支、回収率
- **参考UI**: TARGETの買い目一覧画面

### 実装方針
- レース詳細ページ（Server Component）に購入有無チェック
- ボタンクリックでモーダル表示（Client Component）
- データソース: `userdata/purchases/YYYY-MM-DD.json` or TARGET PD CSV

### 難易度: 低〜中

---

## 2. 馬券メモ機能 ⭐中優先

### 概要
各購入にメモ・タグを紐づけて振り返りを可能に。

### 仕様
- **タグ（プリセット）**:
  - `ML推奨`: ML予測一覧の推奨買い目に基づく購入
  - `VB単勝`: VB候補の単勝狙い
  - `VB複勝`: VB候補の複勝狙い
  - `応援馬券`: 推しの馬への応援購入
  - `直感勝負`: データ外の判断
  - `検証用`: 仮説検証のための少額購入
- **自由メモ**: テキスト入力（例: 「ML予測一覧 推奨買い目購入」「応援馬券で勝負して敗北」）
- **入力タイミング**: 購入時 or レース後振り返り時

### データスキーマ
```json
{
  "race_id": "2026021506010408",
  "bets": [
    {
      "bet_type": "tansho",
      "umaban": 3,
      "amount": 100,
      "odds": 10.4,
      "payout": 1040,
      "tags": ["ML推奨", "VB単勝"],
      "memo": "VR2推奨、EV 1.35で購入"
    }
  ],
  "race_memo": "東京4R 1勝クラス ダ1600。ロンギングフォーユーが東京ダートで好走パターン。"
}
```

### 保存先
- `userdata/purchases/memos/YYYY-MM-DD.json`
- API: `POST /api/purchases/memo`

### 難易度: 低

---

## 3. SHAP予測インタビュー表示 ⭐中優先

### 概要
馬ごとに「なぜこの評価か」をSHAP値ベースでWebViewerに表示。

### 詳細設計
→ `knowledge/insights/model/prediction_interview_feature.md`

### Web側の実装範囲
- **Phase 1**: predict.pyが出力するSHAP JSONを読み込み、テキスト表示
- **Phase 2**: 馬クリック → モーダルで好材料/懸念材料の詳細表示
- **Phase 3**: ウォーターフォールチャート（SHAP値の積み上げ図）
- **Phase 4**: AIエージェント解説との連携

### UI案
```
┌────────────────────────────────────────────┐
│ 🐎 ロンギングフォーユー  予測: 18.2%(2位)   │
│                                            │
│ ★ 好材料                                  │
│  1. 前走1着の好走 (+4.5%)                  │
│  2. 東京ダート1600m [2-1-0-1] (+3.2%)      │
│  3. 上がり3F 36.8秒（出走馬中3位）(+2.1%)   │
│                                            │
│ ▼ 懸念材料                                │
│  1. 牝馬限定→混合戦 (-1.2%)                │
│  2. 枠番8番（外枠）(-0.8%)                  │
│                                            │
│ 📝 メモ: VR2推奨、東京ダートで安定。         │
└────────────────────────────────────────────┘
```

### 前提
- ML側: `ml-roadmap.md` Sprint C-3（SHAP JSON出力）が必要
- 特徴量名→日本語ラベル辞書の作成

### 難易度: 中〜高

---

## 4. レース後振り返り機能 ⭐中優先

### 概要
「予測 vs 結果」の突合を自動生成。SHAP予測根拠 + 馬券メモ + 実際の結果を一画面で。

### 仕様
- **自動生成部分**:
  - 予測確率 vs 実際の着順
  - VB判定の的中/外れ
  - SHAP好材料が的中したか（前走好走→今回も好走、など）
- **手動入力部分**: 馬券メモ（#2）
- **蓄積**: 振り返りデータを蓄積 → パターン分析
  - 「AIが過大評価しやすい条件」の検出
  - 「特定の特徴量が効かなかったレースの共通点」

### 表示場所
- レース詳細ページに「振り返り」タブ追加
- 予測一覧ページに「振り返りモード」（結果確定後）

### 前提: #2 メモ機能 + #3 SHAP表示

### 難易度: 中

---

## 5. 収支ダッシュボード強化 ⭐中優先

### 概要
月別/条件別の収支推移、VBギャップ別のROI、ドローダウン表示。

### 現状
- 購入リスト（`/bankroll`）で日別の収支確認は可能
- VBバックテスト結果（`ml-experiments/`）で過去実績は確認可能

### 追加候補
- **月別ROI推移グラフ**: 折れ線チャート
- **条件別収支**: 芝/ダート、場所別、クラス別
- **VBギャップ別ROI**: gap≥3, ≥4, ≥5の実績比較
- **タグ別収支**: ML推奨 vs 応援馬券 vs 直感勝負（#2メモ機能連携）
- **ドローダウン表示**: 最大連敗数、最大ドローダウン額
- **分散ドラッグ指標**: 対数リターン推移（ROIだけでなく複利成長率も表示）

### 難易度: 中

---

## 6. オッズ鮮度問題の修正 ⭐高優先（技術的課題）

### 問題
FF CSV出力時にオッズが最新化されない。画面表示は古いオッズのまま。

### 実運用での影響（2026-02-15 東京5R実例）
- 予測時オッズ: 10.6倍 → 最終オッズ: 5.9倍（**44%下落**）
- 予測時EV: 1.35（購入判断）→ 実際EV: 0.75（見送りすべきだった）
- 的中したが、長期的にはこのパターンがROIを蝕む

### 現状の対策（効果なし）
- `cache: 'no-store'` + `_t=` タイムスタンプパラメータ追加
- `fetchAllOdds()` 呼び出し + 500ms wait

### 調査候補
- Next.jsサーバーサイドキャッシュ（Route Handler Cache）
- DB接続プールのキャッシュ
- SWR/React stateの更新タイミング
- `max-age=30` のCache-Controlヘッダー

### 難易度: 低〜中（調査次第）

---

## 7. TARGET連携の拡張

### 7-1. 三連単FF CSV出力
- FF CSV券種7（三連単）対応 — フォーマットは対応済み
- 目1(馬番), 目2(馬番), 目3(馬番) のフィールドに着順指定
- 前提: `ml-roadmap.md` Sprint B-4（三連単EVエンジン）

### 7-2. UmaMark3（推奨買い目印）
- 現在のFF CSV出力に加え、TARGETの印セット3に推奨マーク
- ◎=単勝強推奨、○=単勝推奨、▲=複勝強推奨、△=複勝推奨、★=単複両方

### 7-3. 自動購入パイプライン（将来）
- TARGET IPAT連携 → 自動購入
- 締切直前にEV再計算 → 最終オッズで判断 → 自動投票
- 安全策: 日予算上限、レース単位上限、手動承認モード
- → #13 Just-in-Time購入と密接に連携

---

## 8. 馬プロフィールページ ⭐低優先

### 概要
馬の詳細ページに過去走一覧・適性・成長曲線を表示。

### 内容
- 過去走一覧テーブル（着順、タイム、上がり、通過順）
- 距離/馬場/コース適性サマリー
- スピード指数×レイティング推移グラフ（2軸チャート）
- 調教履歴（CK_DATA + keibabook調教）
- 成長曲線（キャリア全体の指数推移）

### 難易度: 中

---

## 9. レース選別スコア改良（RaceScore多次元化）⭐中優先

### 概要
投資対象レースの選別を多次元スコアで行う。現在は全レース均等に扱っているが、モデルの確信度が高いレースに集中投資すべき。

### スコア構成要素
| 要素 | 重み | 説明 |
|------|------|------|
| データ充足度 | 15% | 特徴量の欠損率 |
| VB候補の質 | 30% | VB馬のgap・EV |
| モデル確信度 | 20% | 予測確率のエントロピー（低=明確な順位付け） |
| 市場乖離度 | 20% | VBの平均gap |
| 歴史的ROI | 15% | 同条件レースの過去ROI |

### 活用
- 予測一覧ページに「レーススコア」カラム追加
- スコア≥60のレースのみに投資 → 購入レース絞り込み
- FF CSV出力でスコアフィルタ対応

### 難易度: 中

---

## 10. レース内相関管理（horse exposure）⭐中優先

### 概要
同じ馬に依存する複数の馬券のリスク集中を防ぐ。

### 問題
7番の複勝 + 3-7ワイド + 3-7-xの三連複を買うと、7番が飛んだ場合に全滅。

### 対策
- 馬番ごとのexposure（依存金額合計）を計算
- 最大exposure = レース予算の40%以内に制限
- 超過時は比例縮小
- 予測一覧ページにexposure警告表示

### 前提: 馬券種の多様化（馬連/ワイド/三連複）

### 難易度: 中

---

## 11. ドローダウン防御の多重構造 ⭐中優先

### 概要
松風の教訓（-97%ドローダウン、160万→5.5万）を踏まえた4層防御。

### 4層構造
```
第1層: 追い下げ方式（バンクロール減少 → 購入額自動減少）
第2層: フラクショナルケリー (safety_factor = 0.25)
第3層: ドローダウンアラート
  -20%: safety_factor → 0.15 に引き下げ
  -30%: 投資停止勧告（翌週まで見送り）
  -40%: 緊急全停止
第4層: 最低バンクロール閾値（初期の10%を下回ったら全停止）
```

### UI
- 残り予算表示に「ドローダウン率」追加
- アラート時に色変更（黄→橙→赤）
- safety_factor自動調整 or 手動調整ボタン

### 難易度: 中

---

## 13. Just-in-Time購入（締切直前EV再判定）⭐高優先

### 背景
予測時のオッズと最終オッズの乖離が大きい場合、EV > 1.0で購入を決めた馬が最終的にEV < 1.0になるケースがある。一括購入ではなくレースごとに締切直前で判断する運用が必要。

### 実例（2026-02-15 東京5R）
- ナックホワイト: 予測時10.6倍→最終5.9倍（-44%）
- 的中したが、EV観点では見送りが正解だった可能性

### Phase 1: オッズ変動記録 + アラート（低コスト・即効）
- 予測時オッズと最新オッズの乖離率をリアルタイム表示
- 推奨テーブルに「オッズ変動」カラム追加（↑↓矢印 + 変動率%）
- EV < 1.0に転落した馬に「見送り推奨」警告バッジ
- 「オッズが何%下がるとEV < 1.0になるか」の閾値を事前計算して表示

### Phase 2: レース単位の締切直前判定（中コスト）
- 一括FF CSV出力ではなく、**レースごとに発走30分前にEV再計算**
- 運用切替: 「一括モード」と「レース単位モード」の選択
- レース単位モード: 各レースの締切前にWebViewerでEV確認 → 手動で「購入」「見送り」を選択
- 「見送り」にした分の予算を残りレースに再配分

### Phase 3: 半自動購入（高コスト・将来）
- 締切10分前に自動EV再計算
- EV > 1.0を維持 → 自動でFF CSV出力 → TARGET取り込み
- EV < 1.0に転落 → アラート通知 + 見送り推奨
- 人間の最終承認ボタン付き（完全自動ではない）
- → #7-3 自動購入パイプラインと合流

### Kelly再計算の考慮
- オッズ変動 → Kelly配分も変動 → 金額の再計算が必要
- 日予算の中で「前半レースで使わなかった分を後半に回す」動的配分

### 難易度: Phase 1=低, Phase 2=中, Phase 3=高

---

## 12. 馬場傾向リアルタイム反映 ⭐低優先

### 概要
当日の前半レース結果から馬場バイアス（内有利/外有利）を推定。

### 活用
- レース詳細ページに「本日の馬場傾向」バッジ表示
- 推奨買い目の補正（内枠有利時は内枠馬のEVを上方修正）
- 当日限定の特徴量として予測に反映

### 難易度: 高

---

## 実装済み（アーカイブ）

- ✅ レース一覧/詳細ページ（Server Component）
- ✅ 予測一覧ページ + VBテーブル + ROI計算
- ✅ 推奨買い目セクション（Kelly配分 + EV > 1.0フィルタ）
- ✅ FF CSV出力（TARGET買い目取り込み連携）
- ✅ UmaMark2 VB印書込み
- ✅ 推奨テーブルのソート/フィルタ + CSV出力フィルタ連動
- ✅ 日予算のlocalStorage永続化
- ✅ DBオッズAPI + 時系列/確定フォールバック
- ✅ 危険な人気馬検出

---

**最終更新**: 2026-02-15
