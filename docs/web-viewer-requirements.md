# 競馬データビューアー Webアプリケーション 要件定義書

## 📋 概要

### プロジェクト名
**KEIBA Data Viewer** (仮称)

### 目的
`data2`フォルダに保存されているマークダウン形式のレース情報・馬情報を、Webブラウザで閲覧できるようにする。

### 現状の課題
- マークダウンエディタでファイルを個別に開く必要がある
- ファイル間のリンク（馬→レース、レース→馬）がローカルパス形式
- 検索・フィルタリング機能がない
- 複数デバイスからのアクセスが困難

---

## 📁 対象データ構造

### ディレクトリ構成
```
Z:\KEIBA-CICD\data2\
├── races/
│   └── {YYYY}/{MM}/{DD}/{競馬場}/
│       └── {レースID}.md        # レース別マークダウン
├── horses/
│   └── profiles/
│       └── {馬ID}_{馬名}.md     # 馬プロファイル
└── debug/
```

### データ規模
| データ種別 | 件数 | 備考 |
|:---|---:|:---|
| レースMD | 約1,000件 | 2025-2026年 |
| 馬プロファイル | 約5,756件 | |
| JSON（詳細データ） | 約50,000件 | temp配下 |

### マークダウンファイル内容

**レース情報**
- レース概要（日付、競馬場、距離、クラス）
- 本紙の見解
- 出走表（馬名、騎手、オッズ、AI指数、印）
- 調教・厩舎情報
- 展開予想
- パドック情報

**馬プロファイル**
- 基本情報（馬ID、馬名、性齢）
- 完全成績（全レース履歴）
- 過去成績分析（距離別、馬場別）
- 分析メモ

---

## 🎯 機能要件

### Phase 1: MVP（最小実行可能製品）

#### 1.1 レース一覧・閲覧
- [ ] 日付別レース一覧表示
- [ ] 競馬場でのフィルタリング
- [ ] レース詳細ページ（MD→HTML変換表示）
- [ ] レスポンシブ対応（PC/タブレット/スマホ）

#### 1.2 馬情報閲覧
- [ ] 馬プロファイル検索（馬名、馬ID）
- [ ] 馬詳細ページ表示
- [ ] 過去成績のテーブル表示

#### 1.3 リンク連携
- [ ] レース→出走馬へのリンク
- [ ] 馬→過去出走レースへのリンク
- [ ] ローカルパスの自動変換

### Phase 2: 拡張機能

#### 2.1 検索・フィルタ
- [ ] 全文検索（レース名、馬名、騎手名）
- [ ] 日付範囲指定
- [ ] クラス別フィルタ（G1、G2、G3、OP、条件）
- [ ] 距離・コース種別フィルタ

#### 2.2 データ可視化
- [ ] 馬の成績グラフ
- [ ] オッズ推移
- [ ] AI指数の分布

#### 2.3 お気に入り・注目馬
- [ ] 馬のブックマーク機能
- [ ] 注目レースのマーキング
- [ ] メモ機能

### Phase 3: 高度な機能

#### 3.1 分析ツール連携
- [ ] PCI基準値の表示
- [ ] 展開予想データの可視化
- [ ] 調教評価のハイライト

#### 3.2 通知・アラート
- [ ] 注目馬の出走通知
- [ ] データ更新通知

---

## 🛠 技術要件

### 技術スタック候補

#### Option A: シンプル構成（推奨）
| 層 | 技術 | 理由 |
|:---|:---|:---|
| Frontend | Next.js 14+ (App Router) | SSR対応、高速表示 |
| Styling | Tailwind CSS | 高速開発、レスポンシブ |
| MD Parsing | remark / rehype | MD→HTML変換 |
| Data | ファイルシステム直接参照 | 追加DB不要 |
| Hosting | ローカルサーバー | 社内利用想定 |

#### Option B: フル構成
| 層 | 技術 | 理由 |
|:---|:---|:---|
| Frontend | Next.js 14+ | - |
| Backend | Next.js API Routes | - |
| Database | SQLite / PostgreSQL | 検索高速化 |
| Search | Meilisearch / Algolia | 全文検索 |

### 非機能要件

| 要件 | 目標値 |
|:---|:---|
| ページ表示速度 | < 2秒 |
| 同時接続数 | 1-5ユーザー（個人利用想定） |
| 対応ブラウザ | Chrome, Edge, Safari (最新版) |
| モバイル対応 | 必須 |

---

## 🎨 UI/UX設計方針

### デザインコンセプト
- **競馬新聞風**: 情報密度を高く、視認性重視
- **ダークモード対応**: 長時間閲覧に配慮
- **シンプルナビゲーション**: 3クリック以内で目的情報へ

### 主要画面構成

```
┌─────────────────────────────────────────┐
│  Header: 日付選択 / 競馬場タブ / 検索    │
├─────────────────────────────────────────┤
│                                         │
│  [レース一覧]          [馬検索]          │
│  ├ 1R 未勝利           馬名で検索...      │
│  ├ 2R 1勝              ─────────────    │
│  ├ 3R 未勝利           最近閲覧した馬     │
│  │ ...                 ・ジャスティンパレス│
│  └ 12R メインレース    ・ソウルラッシュ    │
│                                         │
├─────────────────────────────────────────┤
│  Footer: データ更新日時 / バージョン      │
└─────────────────────────────────────────┘
```

### レース詳細画面

```
┌─────────────────────────────────────────┐
│ ◀ 戻る    中山1R 未勝利 ダ1200m         │
├─────────────────────────────────────────┤
│                                         │
│ 📋 レース情報                           │
│ 発走: 10:05 / 3歳未勝利 / ダート1200m    │
│                                         │
│ 📰 本紙の見解                           │
│ グレイシエーションは前進気勢の強さ...    │
│                                         │
│ 🐎 出走表                               │
│ ┌────┬────┬─────┬────┬────┐           │
│ │馬番│馬名    │騎手  │印 │指数│           │
│ ├────┼────┼─────┼────┼────┤           │
│ │ 5  │グレイシ│杉原 │◎ │241 │           │
│ │12  │クリオロ│横山武│○ │277 │           │
│ └────┴────┴─────┴────┴────┘           │
│                                         │
│ 📝 調教・厩舎情報                       │
│ [展開可能セクション]                    │
│                                         │
└─────────────────────────────────────────┘
```

---

## 📅 開発ロードマップ

### Phase 1: MVP（2-3週間）
1. **Week 1**: 環境構築、データ読込基盤
2. **Week 2**: レース一覧・詳細画面
3. **Week 3**: 馬情報画面、リンク連携

### Phase 2: 拡張（2週間）
4. **Week 4**: 検索機能、フィルタ
5. **Week 5**: UI改善、モバイル最適化

### Phase 3: 高度機能（随時）
- 分析ツール連携
- 通知機能

---

## ✅ 決定事項

### 1. 利用形態
- [x] **個人利用のみ**
- [x] **ローカルPCのみ**（`localhost`）

### 2. 機能優先度

| 優先度 | 機能 | 状態 |
|:---:|:---|:---|
| 🔴 必須 | A. レース閲覧（日付別一覧→詳細） | Phase 1 |
| 🔴 必須 | C. リンク連携（レース⇔馬の相互リンク） | Phase 1 |
| 🟡 希望 | B. 馬検索（馬名で検索→プロファイル） | Phase 2 |
| 🟡 希望 | D. 検索・フィルタ（全文検索、条件絞り込み） | Phase 2+ |

### 3. 技術選定
- [x] **Option A: シンプル構成**（ファイル直接読込）
- [x] **将来拡張**: DB化（SQLite → PostgreSQL）
- [x] **将来連携**: KeibaCICD.JraVanSync（JRA-VAN連携）

### 4. 画面イメージ
- [x] **表示モード切替機能**（競馬新聞風 / モダンカード型）

---

## 🏗 技術アーキテクチャ

### 確定構成

```
┌─────────────────────────────────────────────────────┐
│                   Frontend                          │
│              Next.js 14+ (App Router)               │
│         Tailwind CSS + shadcn/ui                    │
│         テーマ切替（新聞風/カード型）                 │
├─────────────────────────────────────────────────────┤
│                   Data Layer                        │
│    Phase 1: ファイルシステム直接読込                 │
│    Phase 2+: SQLite/Prisma（移行容易な設計）         │
├─────────────────────────────────────────────────────┤
│                   Data Source                       │
│         Z:\KEIBA-CICD\data2\                        │
│         ├── races/{YYYY}/{MM}/{DD}/*.md             │
│         └── horses/profiles/*.md                   │
└─────────────────────────────────────────────────────┘
```

### ディレクトリ構成（予定）

```
keiba-cicd-core/
└── KeibaCICD.WebViewer/          # 新規プロジェクト
    ├── src/
    │   ├── app/                  # Next.js App Router
    │   │   ├── page.tsx          # トップ（日付選択）
    │   │   ├── races/
    │   │   │   └── [date]/
    │   │   │       ├── page.tsx  # レース一覧
    │   │   │       └── [id]/
    │   │   │           └── page.tsx  # レース詳細
    │   │   └── horses/
    │   │       └── [id]/
    │   │           └── page.tsx  # 馬プロファイル
    │   ├── components/
    │   │   ├── ui/               # shadcn/ui
    │   │   ├── race/             # レース関連
    │   │   └── horse/            # 馬関連
    │   ├── lib/
    │   │   ├── data/             # データ読込
    │   │   │   ├── race-reader.ts
    │   │   │   └── horse-reader.ts
    │   │   ├── markdown/         # MD変換
    │   │   └── utils/
    │   └── types/
    ├── public/
    ├── package.json
    ├── tailwind.config.ts
    └── next.config.js
```

### 将来拡張設計

```typescript
// データアクセス層の抽象化（将来のDB移行に備える）
interface DataProvider {
  getRacesByDate(date: string): Promise<RaceSummary[]>;
  getRaceDetail(id: string): Promise<RaceDetail>;
  getHorseProfile(id: string): Promise<HorseProfile>;
  searchHorses(query: string): Promise<HorseSummary[]>;
}

// Phase 1: ファイルシステム実装
class FileSystemDataProvider implements DataProvider { ... }

// Phase 2+: SQLite実装
class SQLiteDataProvider implements DataProvider { ... }

// 将来: JRA-VAN連携
class JraVanDataProvider implements DataProvider { ... }
```

---

## 📅 開発ロードマップ（更新版）

### Phase 1: MVP（1-2週間）
**目標**: レース閲覧 + リンク連携

| 週 | 作業内容 | 成果物 |
|:---:|:---|:---|
| Week 1 | 環境構築、データ読込基盤、レース一覧 | 動作するトップ画面 |
| Week 2 | レース詳細、馬プロファイル、リンク連携 | MVP完成 |

#### Week 1 タスク
- [ ] Next.js プロジェクト作成
- [ ] Tailwind CSS + shadcn/ui 設定
- [ ] data2 フォルダ読込ロジック
- [ ] 日付選択UI
- [ ] レース一覧コンポーネント

#### Week 2 タスク
- [ ] MD→HTML変換（remark/rehype）
- [ ] レース詳細ページ
- [ ] 馬プロファイルページ
- [ ] ローカルパス→URLリンク変換
- [ ] テーマ切替（新聞風/カード型）

### Phase 2: 機能拡充（随時）
- [ ] 馬名検索
- [ ] 日付範囲フィルタ
- [ ] お気に入り機能

### Phase 3: DB化・拡張
- [ ] SQLite移行
- [ ] 全文検索
- [ ] JRA-VAN連携準備

---

## 📝 次のステップ

1. ✅ 要件確定
2. **→ プロジェクト作成**: `KeibaCICD.WebViewer` フォルダ作成
3. **開発開始**: Phase 1 Week 1

開発を開始しますか？

---

*ドキュメント作成日: 2026-01-17*
*バージョン: 1.0.0*
