# 競馬AIでポルシェを買う話 6〜11週目（ドローダウンとチューニング論）

- **出典**: Matsukaze.AI「競馬AIでポルシェを買う話」
  - 6週目: http://matsukaze.ai/?p=660 (2018-12-05)
  - 7週目: http://matsukaze.ai/?p=667 (2018-12-06)
  - 8週目: http://matsukaze.ai/?p=672 (2018-12-08)
  - 9週目: http://matsukaze.ai/?p=676 (2018-12-08)
  - 11週目: http://matsukaze.ai/?p=684 (2018-12-08)
- **日付**: 2025-02-11
- **前編**: [006 ポルシェを買う話 1-5週目](006_ポルシェを買う話_1-5週目.md)

## 収支サマリー

| 週 | バンクロール | 週次回収率 | 累計複利回収率 | 備考 |
|---|---|---|---|---|
| 5週目 | 469,520円 | 113% | 96% | 前回最終 |
| 6週目 | 269,520円 | 71% | 49% | ワイドオッズ計算の重大バグ発覚 |
| 7週目 | 188,800円 | 53% | 37% | 追い下げが効いて損失縮小 |
| 8週目 | 131,740円 | 67% | 26% | 一時8万円まで下落 |
| 9週目 | 221,350円 | 141% | 44% | チューニング戻して復活 |
| (10週目) | - | - | - | (記事なし) |
| 11週目 | 301,340円 | 122% | 60% | チューニング論の深掘り |

累計: 総購入約400万円、総損失約20万円、回収率約95%

## 要点

### 6週目: ワイドオッズ計算の重大バグ ★

- **ワイドの期待値計算の具体的方法が明かされた**:
  - ワイド1-2を買う時、上位3頭が (1,2,3), (1,2,4), ... と**全組み合わせ**を計算
  - 各組み合わせごとに「発生確率 × その時のワイド払戻」を算出
  - 全通りの合計 = **ワイド1-2の払戻の期待値**
- このオッズ計算にバグがあった → 「今までの成績が全て信用ならない」
- 新アルゴリズムを1ヶ月間ずっと学習させていた（PC限界稼働）

### 7週目: 追い下げの動作確認

- バンク減少 → 購入金額自動減少 → 払戻も減少
- **「エアバッグがちゃんと作動した」** = 破産回避メカニズムの実証
- 追い下げ方式の資金管理が正しく機能していることを確認

### 8週目: 「複利で効率よく負ける」問題

> 複利で効率良く資金を回転させるチューニングをミスると、複利でとても効率よく負けてしまう

- 3週間でバンクの7〜8割を溶かした
- 原因推定: 「チューニングをやや攻め過ぎた」
- ギリギリのチューニング（攻め）を諦め、雑なチューニング（保守的）に戻す決断
- **総購入320万 / 損失37万 = 回収率88%** → 複利回収率26%との乖離

### 9週目: 外国人騎手の影響

- 京都で12R中11R外国人騎手が勝つ異常事態
- 松風にとって「かなり苦手なレース」
- **短期免許外国人の大量騎乗はAIにとって未知の変数**
- 追い下げ + 破産確率計算の範囲内ではあった

### 11週目: チューニング最適化論 ★★★（最重要）

#### 的中率 vs 回収率 vs 収支の最適化

> 的中率5% 回収率150%よりも的中率30% 回収率110%の方が遥かに優秀

- これは006(5週目)の発見の数学的深掘り
- **収支最大化 = 的中率・回収率・購入金額・分散のバランス最適化**
- 有料予想の価格設定問題に例えた二次関数の最適化問題:
  - y = (1000 + 50x)(100 - x) → x=40（3000円）で最大値18万円
  - **微分してy'=0を解く** = チューニングの本質

#### 最終オッズ → 確定オッズの変動問題 ★★★

> 的中馬券の確定オッズをOt、最終オッズをO(t-1)としたとき、O(t-1)からOtの変化がブラウン運動ではない

> 的中馬券の、最終から確定までのオッズの変化はランダムではなく、的中馬券はオッズが下がる確率が高い

> 最終オッズ提示後から締切までに購入される馬券は、最終オッズ提示までに購入された馬券よりも的中を言い当てているものの割合が高い

- **締切直前の馬券購入（スマートマネー）は的中率が高い**
- 最終オッズで見てEV > 1.0 でも、確定オッズでは下がっている可能性
- この不確実性がチューニングの難所

#### 保守的チューニング vs 攻めのチューニング

| | 保守的（雑） | 攻め（ギリギリ） |
|---|---|---|
| EV閾値 | 高め（バッファ大） | 低め（バッファ小） |
| 購入点数 | 少なめ | 多め |
| 回収率 | 高い | 低い |
| 収支分散 | 小さい | 大きい |
| 最大ドローダウン | 小さい | 大きい |
| 破産リスク | 低い | 高い |

## AI開発への示唆

### 1. ワイド期待値の計算方法（実装仕様）

Matsukaze氏の方法が初めて明かされた:

```
ワイド(A, B)の期待値 =
  Σ P(上位3頭が A,B,C) × ワイド(A,B)のオッズ(Cが3着の時)
  for C in 全出走馬 - {A, B}
```

- 各馬の着順確率分布が必要（003の確率論的アプローチ）
- 各組み合わせのワイドオッズ推定が必要
- **計算量**: n頭レースでワイドnC2通り × (n-2)通りの3着馬 = O(n^3)

### 2. オッズ変動リスクのモデリング

最終オッズ→確定オッズの変動は:
- ランダム（ブラウン運動）ではない
- **的中馬券ほどオッズが下がる傾向がある（スマートマネー効果）**
- このバイアスを事前に見積もり、EV計算に織り込む必要がある

実装案:
- 過去データから「最終オッズ→確定オッズの変動分布」を馬券種別に推定
- EV計算時に、期待されるオッズ低下分を割り引く
- バッファパラメータで保守的/攻めのチューニングを制御

### 3. 複利の両刃性

- 複利の力: 回収率110%を13週間 → 1.15^13 ≈ 6倍
- 複利の罠: **チューニングミスも複利で加速する**
- 回収率が100%を下回る期間が続くと、追い下げが効いても急速に資金が溶ける
- **保守的なチューニングの方が長期的には安全**

### 4. 外国人騎手の影響への対処

- 短期免許の外国人騎手はAIにとって未知データ
- 対策案:
  - 騎手の代わりにライダースキルのプロキシ変数を使う
  - 外国人騎手の過去成績（海外含む）を特徴量に組み込む
  - 未知の騎手に対する不確実性をEV計算に反映

### 5. 収支最大化の数理フレームワーク

11週目の例題を一般化:

```
収支 = f(EV閾値, 購入金額比率, バンクロール)

最適化目標:
  max E[収支] subject to P(破産) < ε

制約:
  - 確定オッズのリスク（スマートマネー効果）
  - 複利効果（プラスにもマイナスにも効く）
  - 収支の分散（安定性）
```

これはケリー基準の馬券版であり、金融工学の最適ポートフォリオ理論に近い。

## 独自考察

### 「スマートマネー」の検証可能性

- JRA-VANで最終オッズと確定オッズの両方が取得可能
- 以下の検証が可能:
  1. 的中馬券の最終→確定オッズ変動の分布
  2. 不的中馬券の最終→確定オッズ変動の分布
  3. 両者の差 = スマートマネー効果の大きさ
- **これは即座に検証・実装可能な知見**

### 006→007で見えたリスク管理の階層

```
レベル1: 追い下げ（バンク連動で購入金額を下げる）
  → 7週目で実証: 破産回避の最終防衛ライン

レベル2: EV閾値のバッファ（保守的チューニング）
  → 11週目で解説: スマートマネーリスクを織り込む

レベル3: 破産確率の事前計算
  → 9週目で言及: ギリ攻めでも破産しない範囲を数学的に保証

レベル4: チューニングの切り替え判断
  → 8週目: 攻め→保守に戻す判断基準は未解決
```

### 回収率88% vs 複利回収率26%の乖離

- 単純回収率88%は「そこまで悪くない」
- しかし複利回収率26%は「資金の74%が溶けた」
- **この乖離は複利効果（特にマイナス方向）の恐ろしさを示す**
- 回収率が100%を少し下回るだけでも、複利で回すと急速に減る
- 逆に100%を少し上回れば急速に増える → **チューニングの1%が命運を分ける**

## 関連データ

| データ項目 | 用途 | 備考 |
|---|---|---|
| 最終オッズ / 確定オッズ | スマートマネー効果の検証 | JRA-VANオッズテーブル |
| ワイド全組合せオッズ | ワイドEV計算 | JRA-VANオッズテーブル |
| 外国人騎手フラグ | 騎手未知リスクの特徴量 | 短期免許騎手の特定 |
| バンクロール時系列 | ドローダウン/破産確率の検証 | モンテカルロシミュレーション |

## アクションアイテム

- [ ] ワイドEV計算の実装: P(上位3頭) × ワイドオッズの全組合せ列挙
- [ ] 最終オッズ→確定オッズの変動分布を過去データで分析（スマートマネー検証）
- [ ] EV閾値のバッファパラメータ設計（オッズ変動リスクの織り込み）
- [ ] 複利効果を含むドローダウンシミュレーション（モンテカルロ法）
- [ ] 破産確率の計算フレームワーク構築
- [ ] 外国人騎手の影響分析と特徴量設計

## タグ

`#馬券戦略` `#オッズ` `#バンクロール` `#運用` `#モデル` `#チューニング`
