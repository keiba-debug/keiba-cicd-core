# 競馬AIでポルシェを買う話（2020年 第1四半期 +343万）

- **出典**: Matsukaze.AI「競馬AIでポルシェを買う話（2020年 第1 四半期 +343万）」 http://matsukaze.ai/?p=929
- **日付**: 2025-02-11（元記事: 2020-05-06）
- **前編**: [010 馬券の税金と雑所得](010_馬券の税金と雑所得.md)

## 要点

### 2020年Q1の成績

| 項目 | 金額 |
|---|---|
| 購入金額 | 9,452万円 |
| 払戻金額 | 9,795万円 |
| 収支 | **+343万円** |
| 回収率 | **約103.6%** |

- 2019年の税金600万円をセルフ源泉徴収 + ふるさと納税100万円を先払い
- 約1,000万円のバンクロールからスタート
- 年10倍の保守的目標 → 四半期で10^(1/4) ≈ 1.8倍 → やや下回るペース
- 年始のバグで大負け → 3月半ばで取り返した

### 松風システムのアーキテクチャ ★★★

松風は**8つのモジュール**から構成される。各モジュールは独立した役割を持ち、連携して動作。

#### 判明しているモジュール

| モジュール名 | 由来 | 役割 |
|---|---|---|
| **Zeus** | ギリシャ神話の主神 | データベースの保守管理 |
| **Poseidon** | 馬を創った神・競馬の守護神 | モデリング（モデル構築） |
| **Themis** | 法と掟の女神 | **購入決定**（買い目の選定と金額決定） |
| （不明×5） | - | データ収集、整形、予測、ツイート、スケジューリング、分析基盤など |

#### Themisの設計思想 ★★★

> Themisにはもはや馬や騎手の具体的な情報は渡されません。
> Themisが知るのは、確率とオッズ、そして松風の預金残高のみです。

- **入力**: 確率、オッズ、バンクロール残高の3つだけ
- **出力**: どの買い目を、いくら買うか
- **設計原則**: 「目隠し」= 馬名・騎手名などの具体情報を排除
  - ルメールだろうが誰だろうが関係ない
  - 確率とオッズだけを天秤にかける
- 予測の最終レイヤーとして機能
- **関心の分離**: 予測（Poseidon）と購入判断（Themis）を完全に分離

> 「資金力なき予想は無力、予想なき資金力は散財」

### 年始のバグ: オブジェクトコピー問題 ★★

#### 背景
- 昨年まで: 1プロセスで全処理（データ収集→予測→購入→結果確認）
- 問題: 写真判定等で結果取得が遅れると後続の予測が間に合わない
- 改善: 別プロセスで実行するように変更

#### バグの内容
- 別プロセスに渡されたThemisが**実体ではなくコピー**だった
- コピーのバンクロールを更新しても、実体のバンクロールに反映されない
- **追い下げが機能しない** → 外れてもバンクロールが減らず、次のレースでオーバーレートで購入
- 推定損失: **約200万円**

#### 技術的含意
- Pythonでのマルチプロセス: オブジェクトはpickle化されてコピーされる
- 共有状態の管理（multiprocessing.Manager, 共有メモリ, DB経由など）が必要
- **バンクロール管理は全プロセスで一貫性が必須**

### 運用の安定性 vs 改善速度

> 松風はいつまで経っても動作が安定せず（略）
> でもそれは、今日に至るまで積極的な開発と改善の賜物。日々の膝の擦り傷は、歩みを進めている証拠

- システムの安定性と開発速度のトレードオフ
- Matsukaze氏は改善速度を優先する判断

## AI開発への示唆

### 1. レイヤー分離アーキテクチャ ★★★

松風のアーキテクチャから学ぶべき設計原則:

```
レイヤー構成（推定）:
  L1: データ収集・整形 → Zeus（DB管理）
  L2: モデリング       → Poseidon（モデル構築）
  L3: 予測             → （不明モジュール）
  L4: 購入決定         → Themis（確率×オッズ×バンクロール）
  L5: 執行・記録       → （不明モジュール群）
```

- **L4（Themis）が最も重要な設計上の発見**:
  - 予測レイヤーと購入レイヤーを分離
  - 購入レイヤーには確率・オッズ・残高だけを渡す
  - これにより購入ロジックがモデルに依存しない
  - モデルを入れ替えても購入ロジックは不変
  - 006-009で議論されたEV計算・追い下げ・バンクロール管理は全てThemisの担当

### 2. Themisの「目隠し」原則の重要性

馬名・騎手名を購入レイヤーに渡さないことの利点:
- **認知バイアスの排除**: 「有名馬だから多めに買う」等を構造的に防止
- **テスタビリティ**: 確率・オッズ・残高だけなので単体テストが容易
- **汎用性**: 競馬以外のギャンブル・投資にも同じThemisを適用可能
- 003の「確率的競馬観」の実装形態そのもの

### 3. マルチプロセスの状態管理

バンクロールの一貫性を保つ設計パターン:

```
NG: オブジェクトコピーを渡す
  → 各プロセスが独立したバンクロール状態を持つ
  → 追い下げが機能しない

OK: 共有状態を使う
  案1: DB経由（Zeus）でバンクロールを管理
  案2: multiprocessing.Manager で共有オブジェクト
  案3: Redis等の外部KVS
  案4: ファイルロック + JSON/SQLite
```

- 特にリアルタイム運用では**レース間でのバンクロール同期**が必須
- 006の運用ミス（購入失敗）と同根 = 運用基盤の堅牢性が収益に直結

### 4. 開発速度 vs 安定性のトレードオフ

009で「運用ミスが最大のリスク」と結論したが、Matsukaze氏は改善速度を優先:
- バグで200万失っても、改善による利益がそれを上回る判断
- ただし**バンクロール管理のバグは致命的**（追い下げが効かない = 破産リスク増大）
- **テスト戦略**: 少なくとも以下はテスト必須
  - バンクロール更新の一貫性
  - 追い下げロジックの正常動作
  - プロセス間での状態同期

## 独自考察

### 8モジュール構成の推定

判明した3つ + 記事中の言及から推定:

```
1. Zeus       - データベース保守管理
2. Poseidon   - モデリング（モデル構築）
3. Themis     - 購入決定（買い目×金額）
4. [データ収集]  - JRA-VAN等からのデータ取得・整形
5. [予測]       - 学習済みモデルによるレース予測
6. [購入実行]   - 実際のIPAT操作による馬券購入
7. [ツイート]   - Twitter自動投稿（証跡目的 → 010参照）
8. [分析基盤]   - スケジューリング・成績分析・ダッシュボード
```

- Poseidon（モデル構築）と予測（推論）は別モジュールの可能性
- 購入実行とThemis（購入決定）も分離されている可能性が高い

### Themis設計の数学的定式化

Themisの入力と出力を定式化:

```
入力:
  P[i]    = 馬券iの的中確率（Poseidon/予測モジュールから）
  O[i]    = 馬券iのオッズ（データ収集モジュールから）
  B       = 現在のバンクロール残高

計算:
  EV[i]   = P[i] × O[i]                  ... 期待値
  f[i]    = Kelly(P[i], O[i])             ... ケリー基準による最適掛け率
  bet[i]  = B × f[i] × safety_factor     ... 購入金額

出力:
  {(馬券i, bet[i]) | EV[i] > threshold}  ... EV閾値を超える全馬券の購入リスト
```

- 006の「EV > 1.0を全部買え」はthreshold = 1.0に相当
- 007の「追い下げ」はBの更新がリアルタイムであることが前提
- 008の「馬券ポートフォリオ」は馬券間の相関を考慮したf[i]の調整

### Q1回収率103.6%の評価

- 2019年通年: 114% → Q1: 103.6%
- バグによる-200万がなければ: +543万 → 回収率約105.7%
- 年始のバグ + 高松宮記念の降着(-500万) → 合計約700万の不運/ミス
- **これらがなければ+1,043万 → 回収率約111%** → 2019年とほぼ同水準
- モデル自体の性能は維持されている可能性が高い

## 関連データ

| データ項目 | 用途 | 備考 |
|---|---|---|
| モジュール間のインターフェース設計 | アーキテクチャ参考 | Themisへの入力は確率・オッズ・残高のみ |
| プロセス間のバンクロール同期方式 | 運用安定性 | コピーではなく共有状態が必須 |
| 四半期別回収率の推移 | モデル劣化検知 | Q1: 103.6%（バグ込み） |

## アクションアイテム

- [ ] Themis相当の購入決定モジュールの設計（確率×オッズ×残高のみを入力とする）
- [ ] マルチプロセス運用時のバンクロール同期方式の検討
- [ ] モジュール分離アーキテクチャの設計（最低限: データ管理/モデル/予測/購入決定/実行）
- [ ] バンクロール更新の一貫性テストの設計

## タグ

`#運用` `#モデル` `#馬券戦略` `#バンクロール`
