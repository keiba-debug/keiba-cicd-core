# 展開シミュレーションと条件付き着順予測

「出遅れる強い先行馬」のような馬がいる場合、展開パターンによって着順の組合せがガラリと変わる。この「展開依存の確率変動」をどこまでモデル化すべきか、できるのかを考察する。

> 起点: 「よく出遅れる強い先行馬がいて、早めに動いて逃げ馬を潰した場合はこの組合せ、出遅れた場合はこの組合せ、のような複雑な計算をすることはあるのか？」

---

## 1. 結論: ある。そしてそれが競馬AIの「最終形態」に近い

この種の計算は実在する。ただし難易度が段階的に上がるため、初期段階で目指すものではない。

```
レベル0: 各馬の1着確率を予測 → Harville変換 ★ここから始める
レベル1: 脚質ペアの補正係数をHarvilleにかける
レベル2: 展開シナリオを複数定義し、シナリオ別に確率を計算
レベル3: モンテカルロでレース自体をシミュレーション ★最終形態
```

重要なのは、**レベル0でも十分に利益は出せる**ということ。松風が2019年に+1,739万円を出した時点でも、おそらくレベル0〜1の段階だった（展開シミュレーションを実装していたらバグの報告が出ているはず）。展開シミュレーションは「精度をさらに上げたい」段階の話。

---

## 2. なぜ展開が着順を変えるのか: 具体例

### ケース: 出遅れ癖のある強い先行馬X

```
登場人物:
  A: 逃げ馬（先頭に立たないと力を発揮できない）
  X: 先行馬（強いが出遅れ率30%。好スタートなら積極的に前へ）
  B: 差し馬（後方待機、末脚勝負）
  C: 追込馬（最後方から、展開がハマれば一発）

■ シナリオ1: Xが好スタート → 前へ行く → Aを潰す（確率70%×??）
  展開: Xが早めにAに並びかける → ペースが上がる → Aが失速
  結果の傾向:
    1着: X（先行して押し切り）
    2着: B（差し馬が好位から差す）
    3着: C（追込が届く）or 他の差し馬
    → A は圏外（潰れた）

■ シナリオ2: Xが出遅れ → 後方から → Aが楽逃げ（確率30%×??）
  展開: Aが単独で逃げる → ペースが緩い → 前残り
  結果の傾向:
    1着: A（楽逃げ→押し切り）
    2着: Xが追い込んで2着、またはAの番手の馬
    3着: 先行勢の残り
    → C は届かない（スローで差し届かず）

2つのシナリオで上位3頭が全く変わる。
→ 三連単の「当たり組合せ」がシナリオ依存
→ Harvilleの「平均的な確率」ではこの構造を捉えられない
```

### Harvilleが出す答え vs 現実

```
Harvilleの計算（展開を考慮しない「平均」）:
  P(X) = 0.28, P(A) = 0.18, P(B) = 0.15, P(C) = 0.10 ...

  三連単 X→B→C: Harville = 0.28 × 0.15/0.72 × 0.10/0.57 = 1.02%
  三連単 A→X→B: Harville = 0.18 × 0.28/0.82 × 0.15/0.54 = 1.71%

現実（シナリオ加重）:
  シナリオ1（確率60%）での X→B→C: 3.5%
  シナリオ2（確率30%）での X→B→C: 0.1%
  その他（確率10%）: 0.5%

  加重平均: 0.60×3.5% + 0.30×0.1% + 0.10×0.5% = 2.18%

  → Harville(1.02%) vs 現実(2.18%)で2倍以上の差
  → この組合せのオッズがHarvilleベースのEV計算では「買わない」だが、
     展開を考慮すると「買い」になる可能性
```

---

## 3. この問題の本質: 「馬の強さは展開の関数」

### 固定能力モデル vs 展開依存モデル

```
Harvilleの前提（固定能力モデル）:
  各馬に固定の「強さ」パラメータがある
  着順はこの強さにランダムノイズを加えた結果
  → 馬同士の相互作用は考慮しない

現実（展開依存モデル）:
  各馬の「強さ」はレース展開の関数
  展開は出走メンバーの脚質構成で決まる
  → 馬同士の相互作用がある

具体的に何が展開依存か:
  - 逃げ馬が2頭以上 → ハイペース → 差し有利
  - 逃げ馬が1頭だけ → スローペース → 前残り
  - 出遅れ → 本来の脚質と違うポジション → 能力発揮できず
  - 強い先行馬が外枠 → 先行するのにエネルギー消費 → 終盤失速
  - 雨のダート → 内枠の砂被り → 外枠有利に構造が変わる
```

### 脚質構成が確率を変える例

```
同じ馬Aの勝率が、メンバー構成で変わる:

  レースα（逃げ馬A + 差し馬ばかり）:
    A は楽に逃げられる → P(A wins) = 0.35

  レースβ（逃げ馬A + 逃げ馬B + 先行馬C）:
    A はペース競りに巻き込まれる → P(A wins) = 0.12

  → 「Aの強さ」は一定ではなく、メンバー次第で変わる
  → Harvilleの「固定された勝率」は両レースの平均にすぎない

ただし注意:
  LightGBM等のモデルに「同レースの逃げ馬頭数」等を
  特徴量として入れれば、1着確率自体に展開の影響をある程度反映できる。
  問題は「着順間の相関」（展開がAに有利ならBにも有利）が
  Harvilleでは捉えられないこと。
```

---

## 4. アプローチの段階

### レベル0: Harville（展開無視）★ここから始める

```
手法: 1着確率を予測 → Harville変換
利点: シンプル、実装容易、計算高速
欠点: 展開の影響を無視
精度: 組合せ馬券の確率に体系的バイアスあり（ただし全体の傾向は捉える）

十分な場面:
  - 逃げ馬が1頭だけ（展開が読みやすい）
  - 出走頭数が少ない（展開の変動が小さい）
  - ワイド・馬連（着順の依存性が三連単ほど効かない）
```

### レベル1: 脚質ペア補正

```
手法: Harvilleの結果に「脚質ペアの補正係数」をかける
  P_補正(A→B) = P_Harville(A→B) × correction(脚質A, 脚質B)

補正係数の例（過去データから推定）:
  逃げ→逃げ: 0.6（同時に来にくい、共倒れ）
  逃げ→先行: 0.9（やや来にくい）
  逃げ→差し: 1.1（逃げ切り＋差し届くはスローの典型パターン）
  差し→差し: 1.2（展開がハマると同時に来る）
  差し→追込: 1.3（ハイペースで前総崩れパターン）

利点: Harvilleの枠組みのまま、展開の影響を近似的に反映
欠点: 補正係数が「平均的な補正」でしかない（個別のレース展開は見ない）
実装: 過去データから脚質ペア別の「Harville残差」を集計するだけ
```

### レベル2: シナリオベースモデリング

```
手法: レース前に展開シナリオを複数定義し、各シナリオでの着順確率を計算

Step 1: シナリオの定義（手動 or ルールベース）
  S1: ハイペース（逃げ馬2頭以上 or 先行争い）→ P(S1) = 40%
  S2: スローペース（逃げ馬1頭、先行馬少ない）→ P(S2) = 35%
  S3: 超スロー or 出遅れ発生 → P(S3) = 25%

Step 2: シナリオ別の1着確率を推定
  S1: P(A|S1) = 0.10, P(B|S1) = 0.25, P(C|S1) = 0.20 ...
  S2: P(A|S2) = 0.35, P(B|S2) = 0.12, P(C|S2) = 0.08 ...
  S3: P(A|S3) = 0.40, P(B|S3) = 0.08, P(C|S3) = 0.05 ...

Step 3: シナリオ別にHarville変換
  各シナリオで全組合せ確率を計算

Step 4: シナリオ確率で加重平均
  P(三連単X→B→C) = P(S1)×P(X→B→C|S1) + P(S2)×P(X→B→C|S2) + ...

利点: 展開依存の着順変動を明示的にモデル化
欠点: シナリオの定義が恣意的、シナリオ確率の推定が難しい
実装: 中程度の複雑さ。特徴量からシナリオ確率を推定するモデルが必要
```

### レベル3: モンテカルロ展開シミュレーション ★最終形態

```
手法: レースそのものを仮想的に「走らせる」

Step 1: 各馬のパラメータを設定
  - 基礎能力（スピード、スタミナ、瞬発力）
  - 脚質（ポジション取りの傾向）
  - 出遅れ確率
  - 馬場適性
  - コース適性

Step 2: レースをシミュレーション
  - スタート: 出遅れ判定（各馬の出遅れ率で乱数生成）
  - 序盤: 脚質に応じたポジション取り
  - 中盤: ペースの決定（逃げ馬のペース × 後続のプレッシャー）
  - 終盤: 残りスタミナ × 瞬発力で最終スパート
  - ゴール: 各馬のゴールタイムを計算 → 着順決定

Step 3: 10,000回繰り返す
  → 各組合せの出現頻度 = 確率の推定

Step 4: EV計算

利点:
  - 展開の全パターンが自然に網羅される
  - 出遅れ、脚質相互作用、ペース変動が全て反映
  - 「Xが出遅れた場合の確率」も直接出せる
  - 新しい要素の追加が容易（馬場、天候等）

欠点:
  - パラメータの推定が極めて難しい
  - 計算コストが高い（1レース10,000回 × 36レース/日）
  - シミュレーションの妥当性検証が困難
  - 「レースの物理モデル」の構築自体が研究レベル
```

---

## 5. 現実的な判断: どこまでやるべきか

### コスト vs リターンの分析

```
レベル0（Harville）:
  実装コスト: 低（数日）
  精度向上: ベースライン
  利益への影響: これだけで松風の2019年水準（+1,700万）は可能

レベル1（脚質ペア補正）:
  実装コスト: 低（1-2週間）
  精度向上: 組合せ馬券で推定5-10%改善
  利益への影響: 三連単のEV計算が改善される

レベル2（シナリオベース）:
  実装コスト: 中（1-2ヶ月）
  精度向上: 特定のレース（展開が読みにくいレース）で大きく改善
  利益への影響: 不確実。全体への影響は限定的な可能性

レベル3（モンテカルロ）:
  実装コスト: 高（3-6ヶ月以上）
  精度向上: 理論的には最も高い
  利益への影響: 不確実。パラメータ推定の精度に大きく依存
  ★研究プロジェクトに近い
```

### 推奨ロードマップ

```
今（Phase 1-2）:
  → レベル0（Harville）で全馬券種のEV計算を実装
  → まず利益を出す基盤を作る
  → この段階で展開のことは考えない

Phase 3（運用開始後）:
  → レベル1（脚質ペア補正）を追加
  → 過去データから補正係数を推定
  → 三連単の精度向上を確認

Phase 4以降（利益が安定してから）:
  → レベル2を検討（必要性があれば）
  → レベル3は「研究テーマ」として位置づけ

理由:
  松風が4.34億円稼いだ段階でも、おそらくレベル0-1程度。
  展開シミュレーションなしでも十分な利益は出せる。
  レベル2-3は「さらに上を目指す」段階の話。
```

---

## 6. それでも特徴量で展開の影響をある程度取り込む方法

### レベル0のまま、1着確率の予測精度を上げるアプローチ

展開シミュレーションを実装しなくても、**特徴量設計で展開の影響をモデルに教える**ことは可能。

```
展開を反映する特徴量（1着確率モデルの入力として）:

■ ペース予測系
  - 同レースの逃げ馬頭数
  - 同レースの先行馬頭数
  - 予想ペース指数（逃げ馬の持ちタイムから推定）
  - 前走のペース（H/M/S）と当該馬の位置取り

■ 出遅れ系
  - 出遅れ率（過去N走での出遅れ回数/出走数）
  - ゲート番号（外枠ほど出遅れ影響大）

■ 脚質相互作用系
  - 同レースの脚質分布（逃げN頭/先行N頭/差しN頭/追込N頭）
  - 当該馬の脚質 × 同脚質の頭数（逃げ馬で逃げ馬が3頭→不利）
  - 当該馬の脚質 × ペース予想（差し馬でハイペース予想→有利）

■ 枠順×脚質系
  - 逃げ馬の枠番（内枠の逃げ馬は有利）
  - 先行馬の枠番（外枠だとポジション取りに体力消費）

LightGBMはこれらの交互作用を自動学習するので:
  「逃げ馬が3頭いるレースで、差し馬は1着確率が上がる」
  「出遅れ率30%の馬は、全体的に1着確率が割り引かれる」
  といったパターンを特徴量から拾える。

→ 展開シミュレーションをしなくても、
   展開の「平均的な影響」は1着確率に反映される
→ ただし「出遅れた場合は着順がこう変わる」という
   シナリオ分岐は捉えられない（レベル2-3の領域）
```

### この方法の限界

```
特徴量で捉えられるもの:
  ✅ 「逃げ馬が多いレースでは差し有利」（平均的な傾向）
  ✅ 「出遅れ率が高い馬は全体的に割引」（期待値への反映）
  ✅ 「外枠の逃げ馬は不利」（条件付き傾向）

特徴量では捉えられないもの:
  ❌ 「この馬が出遅れたら、この組合せが来る」（シナリオ分岐）
  ❌ 「AがBを潰したら、Cが漁夫の利」（三者間の因果連鎖）
  ❌ 「ペースが緩んだ場合と流れた場合で2着以降が入れ替わる」

つまり:
  1着確率自体は展開特徴量でかなり改善できる。
  しかし「着順間の相関」（展開がAに有利ならBにも有利）は
  1着確率 → Harville変換の枠組みでは構造的に捉えられない。
  これがレベル2-3が必要になる理由。
```

---

## 7. 出遅れ問題の深掘り: 確率の「分岐」

### 出遅れ率をどう扱うか

ユーザーの問いの核心である「出遅れ癖のある馬」を例に考える。

```
馬Xの出遅れ率: 30%

■ 現在のアプローチ（レベル0）:
  出遅れ率30%を特徴量に入れる
  → モデルが「出遅れ率30%の馬の平均的な勝率」を学習
  → P(X wins) = 0.28 として1つの値を出力

  これは「出遅れる確率30%を織り込んだ期待値」。
  つまり: P(X) = 0.70 × P(X|好スタート) + 0.30 × P(X|出遅れ)
  例:     0.28 = 0.70 × 0.35      + 0.30 × 0.12

  → 平均として正しいが、組合せ確率の計算では情報が失われる。

■ なぜ情報が失われるか:
  好スタート時: Xが前に行く → 逃げ馬Aと競り合い → 差し馬B,Cが浮上
    → X→B→C が最頻出組合せ
  出遅れ時: Aが楽逃げ → Xは後方から追い込み
    → A→X→D が最頻出組合せ

  Harvilleは「平均のP(X)=0.28」しか見ないので、
  どちらのシナリオの組合せにも中途半端な確率を割り当てる。
  結果として、どちらの組合せも「微妙にEVが足りない」となり、
  本来買うべき組合せを見逃す可能性がある。

■ シナリオベース（レベル2）なら:
  S1（好スタート、確率70%）: P(X|S1) = 0.35, P(A|S1) = 0.10 ...
  S2（出遅れ、確率30%）:     P(X|S2) = 0.12, P(A|S2) = 0.35 ...

  S1でのX→B→C確率 = Harville(S1の確率) = 3.5%
  S2でのA→X→D確率 = Harville(S2の確率) = 2.8%

  加重平均:
  P(X→B→C) = 0.70 × 3.5% + 0.30 × 0.2% = 2.51%
  P(A→X→D) = 0.70 × 0.3% + 0.30 × 2.8% = 1.05%

  → レベル0のHarvilleとは異なる確率になり、
     EV計算の結果（買う/買わない）が変わりうる。
```

### 現実的な実装案（レベル2の簡易版）

```
全レースでフルのシナリオ分析は不要。
「展開が大きく変わりうるレース」だけ特別扱いする。

判定条件（シナリオ分岐を適用するレース）:
  1. 出遅れ率 > 20%の有力馬（人気上位5頭以内）がいる
  2. 逃げ馬が2頭以上いる
  3. 脚質構成が極端（逃げ馬0頭、または3頭以上）
  4. 有力馬の脚質が競合する（逃げ×逃げ、先行×先行）

上記に該当しないレース → 通常のHarville
該当するレース → 2-3シナリオに分岐してHarville → 加重平均

これならレベル2の恩恵を低コストで得られる。
```

---

## 8. 松風はどうしていたか（推測）

```
直接的な証拠はないが、ブログから推測できる:

007の記述:
  「ワイドの期待値計算で全組み合わせを計算」
  → Harvilleベース（レベル0）の全列挙をしている

011の記述:
  「Themisは確率とオッズとバンクロールしか知らない」
  → 展開シミュレーションの結果ではなく「確率」が入力
  → 確率がどう計算されたかはThemisの外側の話

012の記述:
  2020年Q3に三連単を解放して+1億65万
  → 三連単のEV計算が正確だったことを示唆
  → ただし展開シミュレーションの言及はない

推測:
  松風はおそらくレベル0（Harville）+ 精密なキャリブレーション
  展開シミュレーションではなく、1着確率の精度で勝負していた可能性が高い。
  → 我々もまずこのアプローチで十分。
```

---

## 9. 将来の研究テーマとしての展開シミュレーション

### レベル3の実現に必要なもの

```
データ:
  - 各馬の通過順位（1コーナー、2コーナー、3コーナー、4コーナー）
    → JRA-VANから取得可能
  - 各馬のラップタイム（区間タイム）
    → 一部取得可能（全体ラップは取れるが個別は困難）
  - ゲート出の速さ（スタートの巧拙）
    → 直接的なデータはない。通過順位の変化から推定

モデル:
  - 各馬のスタート能力（出遅れ確率、ダッシュ力）
  - 各馬の脚質パラメータ（目標ポジション、仕掛けのタイミング）
  - ペースモデル（先頭のペース × 後続の追走 → 中盤〜終盤のペース変化）
  - スタミナモデル（ペースが速いほどスタミナ消費 → 終盤の失速）
  - 瞬発力モデル（残りスタミナ × 固有の瞬発力 → 上がりタイム）

計算:
  - 1レースあたり10,000回のシミュレーション
  - 各シミュレーションで全馬のレースを「走らせる」
  - 着順の出現頻度から組合せ確率を推定

検証:
  - シミュレーション結果と実際の着順の一致度
  - 特に「展開が荒れた」レースでの予測精度
  - Harvilleとの比較（改善幅がコストに見合うか）
```

### 段階的に近づく方法

```
Step A: 通過順位の分析（データ探索）
  → 各馬の通過順位パターンを脚質分類に使う
  → これ自体は特徴量として即座に使える

Step B: ペースモデルの構築
  → レース前半のペース（前半3F）を予測するモデル
  → 特徴量: 逃げ馬の持ちタイム、逃げ馬頭数、距離、馬場
  → これも特徴量として使える

Step C: 脚質ペア補正テーブルの構築（レベル1）
  → 過去データから脚質ペア別のHarville残差を集計
  → 三連単の精度向上を確認

Step D: シンプルなシナリオ分岐（レベル2簡易版）
  → 高リスクレース（逃げ馬競合等）のみ適用
  → シナリオ数は2-3で十分

Step E: フルシミュレーション（レベル3）
  → Step A-Dの知見を統合
  → 研究プロジェクトとして長期的に取り組む
```

---

## 10. 他のinsightsとの接続

| この考察の論点 | 関連するinsight |
|---|---|
| Harvilleの限界（脚質相互作用） | [組合せ馬券の確率計算](../market/combination_ticket_probability.md セクション8 |
| 展開を特徴量で反映 | [features.md](../../features.md) のペース・ラップ系 |
| 展開シナリオの確率 | [仮説検証マスター](../operations/hypothesis_verification_master.md H-25 |
| 三連単での展開依存性 | [馬券市場の構造的非効率性](../market/market_structural_inefficiencies.md 2-5 |
| モデル分離と展開 | [モデル分離戦略](../model/model_separation_strategy.md 芝/ダートで展開構造が異なる |
| 過学習の警告 | [005](../../blog-analyses/005_ランダムネスと平均回帰.md) 展開分類も細かすぎると過学習 |

---

## アクションアイテム

- [ ] 脚質分類の定義（逃げ/先行/差し/追込の判定基準）を設計
- [ ] 通過順位データの取得と脚質分類の自動化
- [ ] 脚質ペア補正テーブルの構築（レベル1の実装）
- [ ] 展開予測用の特徴量候補をfeatures.mdに追加
- [ ] 「逃げ馬頭数 × 差し馬の回収率」の基礎分析（展開の影響の定量化）
- [ ] レベル2簡易版の適用条件の設計（どのレースでシナリオ分岐するか）

## タグ

`#モデル` `#展開` `#確率論` `#三連単` `#特徴量` `#馬券戦略`
