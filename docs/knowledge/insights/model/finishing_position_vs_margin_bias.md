# 着順バイアス: 0.5秒差の5着 vs 0.2秒差の6着

> 起点: 「0.5秒差の5着と0.2秒差の6着とで前者を評価してしまいがちな問題について考察したい」

---

## 1. この問題の本質

```
あるレースの結果:
  馬A: 5着（1着との着差 0.5秒）
  馬B: 6着（1着との着差 0.2秒）

人間の直感的な評価:
  「馬Aの方が上位（5着 > 6着）だから馬Aの方が良い走りをした」

実際の走力:
  馬Bの方が1着との差が0.3秒も小さい = 馬Bの方が強い走り

→ 着順だけを見ると誤評価が発生する。
  これは [着順以外の評価基準](beyond_finishing_position.md) と
  [着順以外の目的変数](alternative_target_variables.md) の核心問題の具体例。
```

---

## 2. なぜこの誤評価が起こるか

### 2-1. 着順は序数（順位）、着差は基数（量）

```
着順: 1, 2, 3, 4, 5, 6 ...（順番しかわからない）
着差: 0.0, 0.1, 0.2, 0.3 ...（実際の差がわかる）

着順の問題:
  5着と6着の「差」は、0.001秒かもしれないし3秒かもしれない。
  着順だけでは差の大きさがわからない。

具体例:
  1着 A: 2:00.0
  2着 B: 2:00.1  （Aと0.1秒差）
  3着 C: 2:00.1  （Aと0.1秒差、Bとはハナ差）
  4着 D: 2:00.2  （Aと0.2秒差）
  5着 E: 2:00.5  （Aと0.5秒差）← 馬A
  6着 F: 2:00.2  （Aと0.2秒差）← 馬B ★実は4着Dと同タイム

→ 着順だけ見ると E(5着) > F(6着)
→ 着差で見ると F(0.2秒差) >> E(0.5秒差)

★ 問い: なぜFが6着でEが5着なのか？
  → Fは後方から追い込んで最後に追い上げたが、
    5頭に先着された（展開の問題）。
  → Eは好位にいて5着に粘ったが、1着から離されている。
  → Fの方が「能力」は高い可能性が大きい。
```

### 2-2. この誤評価が予測モデルに与える影響

```
■ 目的変数が着順の場合:
  モデルは「5着 > 6着」と学習する。
  → 馬Eの特徴量パターンが「良い」と学習
  → 馬Fの特徴量パターンが「悪い」と学習
  → 実際は逆（Fの方が能力が高い）
  → モデルにノイズが入る

■ 特徴量に「前走着順」を使う場合:
  馬Eの前走: 5着 → 「まあまあ」と評価
  馬Fの前走: 6着 → 「微妙」と評価
  → 次走の予測で馬Eが過大評価、馬Fが過小評価
  → 馬Fがオッズで軽視される → 期待値が高い可能性

■ 人間（一般ファン）も同じ誤り:
  「前走5着」の馬 → 「好走」と認識
  「前走6着」の馬 → 「凡走」と認識
  → オッズに反映 → 馬Fが過小評価される

★ この誤評価は:
  (a) モデルの学習を歪める（目的変数として）
  (b) 特徴量を歪める（前走着順として）
  (c) オッズを歪める（市場の認知バイアスとして）
  の3重の影響がある。
```

---

## 3. 問題が特に深刻なケース

### 3-1. 着順の「壁」（3着と4着、5着と6着）

```
着順には心理的・制度的な「壁」がある:

■ 3着の壁（複勝・3連系の境界）
  3着: 「馬券になった」→ 好走扱い
  4着: 「馬券にならなかった」→ 凡走扱い
  → 0.01秒の差で「好走/凡走」の評価が反転する

■ 5着の壁（掲示板の境界）
  5着: 「掲示板に載った」→ まあまあの評価
  6着: 「掲示板にも載らなかった」→ 凡走扱い

■ 1着の壁（勝利の境界）
  1着: 「勝った」→ 高い評価、クラス昇級
  2着: 「負けた」→ 1着とは大きく異なる評価
  → ハナ差の2着でも「負けは負け」

これらの壁の前後では、着差に比べて評価の差が不釣り合いに大きい。
```

### 3-2. 接戦のレース vs 大差のレース

```
接戦のレース（全馬が0.5秒以内）:
  1着 2:00.0
  2着 2:00.1
  3着 2:00.2
  4着 2:00.2
  5着 2:00.3
  6着 2:00.4
  → 1着と6着の差は0.4秒。全馬がほぼ同じ能力。
  → 着順の差に意味がほとんどない。
  → 展開や枠順の微差で着順が入れ替わるだけ。

大差のレース（1着が抜けている）:
  1着 2:00.0
  2着 2:00.8
  3着 2:01.0
  4着 2:01.2
  5着 2:01.5
  6着 2:02.0
  → 着順間の差が大きい。着順に意味がある。
  → ただし「1着が強すぎただけ」の可能性もある。

★ 同じ「5着」でも:
  接戦の5着（着差0.3秒）: 能力は上位とほぼ同じ
  大差の5着（着差1.5秒）: 明確に能力差がある
  → 着順だけでは区別できない
```

### 3-3. 頭数による着順の意味の変化

```
8頭立ての5着 = 下から4番目（全体の62.5%の位置）
18頭立ての5着 = 上から5番目（全体の27.8%の位置）

→ 同じ「5着」でも、頭数が違えば意味が全く異なる。
→ 着順を絶対値として使うと、少頭数の好着順が過大評価される。

対策:
  着順パーセンタイル = 着順 / 頭数
  8頭立て5着: 5/8 = 0.625（下位）
  18頭立て5着: 5/18 = 0.278（上位）
  → こちらの方が正確な位置づけ。
```

---

## 4. 解決策: 着差ベースの評価への移行

### 4-1. 着差を特徴量として使う

```
最もシンプルな解決策:
  「前走着順」の代わりに「前走着差（秒）」を使う。

  前走着差: 1着との走破タイムの差（秒）
    馬A: 0.5秒 → 「やや離された」
    馬B: 0.2秒 → 「僅差」

  → 着差の方が着順より情報量が多い。
  → LightGBMが「0.2秒差の前走 > 0.5秒差の前走」を学習できる。

★ ただし着差にも問題がある:
  - 長距離ほど着差が大きくなる（2000mの0.5秒 ≠ 1200mの0.5秒）
  - ペースによって着差が変わる（ハイペースは着差が開きやすい）
  - 馬場によって着差が変わる（重馬場は着差が大きくなりやすい）

→ 生の着差より「標準化した着差」の方が良い。
```

### 4-2. 着差の標準化方法

```
■ 方法1: レース内偏差値
  そのレースの着差の平均と標準偏差で標準化。
  = (自分の着差 - レース平均着差) / レース着差の標準偏差

  メリット: レースの条件差を吸収
  デメリット: レースのレベルが反映されない

■ 方法2: 距離補正着差
  着差(秒) × (基準距離 / 実際の距離)
  例: 2000mの0.5秒差 → 0.5 × (1600/2000) = 0.4秒（1600m換算）
      1200mの0.5秒差 → 0.5 × (1600/1200) = 0.67秒（1600m換算）

  メリット: 距離の影響を除去
  デメリット: ペースや馬場の影響は残る

■ 方法3: パフォーマンススコア化（最も推奨）
  [着順以外の目的変数](alternative_target_variables.md) で提案した
  パフォーマンススコアを使う。
  = クラス基準値 + 着差補正 + 上がり補正 + 斤量補正

  メリット: 着順・着差・クラス・条件を全て反映
  デメリット: 設計・実装のコストが高い
```

### 4-3. 具体的な対処法（特徴量設計）

```
以下の特徴量を「着順」の代替として使う:

■ 前走1着との着差(秒) [features.mdに既存]
  → 着順の代わりにこちらを使う

■ 前走着差パーセンタイル
  = 前走着差 / そのレースの最下位馬の着差
  → 0に近いほど上位、1に近いほど下位
  → 頭数やレースの接戦度に依存しない

■ 前走着順 - 着差順位の差
  着差で並べ直した場合の順位と実際の着順の差。
  例: 着順5位だが着差では3番目に小さい → 差 = 5-3 = 2
  → 正: 着順の割に実は強かった（過小評価されている）
  → 負: 着順の割に実は弱かった（過大評価されている）
  ★ この特徴量が正の馬は「隠れた好走馬」

■ 前走レースの接戦度
  = 1着と最下位の着差 / 頭数
  → 小さいほど接戦（着順の意味が薄い）
  → 大きいほど差がある（着順に意味がある）
  → 接戦のレースでは着順を割り引いて評価すべき

■ 着順の壁効果の補正
  3着と4着の間に:
    実際の着差が0.1秒以内 → 「ほぼ同じ」として扱う
    実際の着差が0.5秒以上 → 「明確な差」として扱う
  → 壁の前後で評価を不連続にしない
```

---

## 5. 目的変数としての影響

### 着順を目的変数にする場合の歪み

```
LightGBMに「着順を予測」させる場合:

問題:
  5着（0.5秒差）の方が6着（0.2秒差）より「良い値」。
  → モデルは「0.5秒差で5着の特徴量パターン」を
    「0.2秒差で6着の特徴量パターン」より上位と学習。
  → 能力の実態と逆の学習が起こる。

影響の大きさ:
  接戦のレース（着差0.1-0.3秒でゴールが密集）では、
  着順は「ほぼランダム」に決まる部分がある。
  → ランダムノイズを目的変数にしているのと同じ。
  → モデルがノイズを学習 → 過学習のリスク。

対策:
  (a) 着差ベースのパフォーマンス指標を目的変数にする
      → [着順以外の目的変数](alternative_target_variables.md) の提案
  (b) 着順を使うが、着差で「信頼度weight」をつける
      → 大差のレースの着順は高weight、接戦は低weight
  (c) 着順そのものではなく「勝ったか否か」の二値分類にする
      → 1着 vs それ以外。これなら着差の問題は最小化される。
      → ただし「2着と最下位が同じ扱い」という別の問題が発生。
```

### 推奨: 着差weightの導入

```
最もバランスの良い対策:

sample_weight = f(着差のレース内標準偏差)

着差のバラつきが大きいレース:
  → 着順に明確な意味がある → weight高
着差のバラつきが小さいレース（接戦）:
  → 着順がほぼランダム → weight低

LightGBMはsample_weightパラメータをサポートしているので:
  model.fit(X, y_着順, sample_weight=weights)
  で実装可能。

weight計算例:
  race_spread = max(着差) - min(着差[2着以降])  # レースの着差レンジ
  weight = race_spread / median_race_spread  # 全レースの中央値で正規化
  → 接戦のレースはweight < 1（軽視）
  → 大差のレースはweight > 1（重視）
```

---

## 6. オッズへの影響（馬券戦略の観点）

### 「着順バイアス」はオッズに反映されている

```
一般的な競馬ファンの行動:
  「前走5着」の馬 → 「掲示板に載った」→ そこそこ評価
  「前走6着」の馬 → 「掲示板にも載らなかった」→ 評価低い

→ 前走5着の馬は人気になりやすい
→ 前走6着の馬は軽視されやすい
→ 着差の実態に関わらず

★ 実際には:
  0.2秒差の6着（僅差で負けただけ）→ オッズで過小評価
  0.5秒差の5着（着順は上だが離されている）→ オッズで過大評価

→ 「前走着差が小さいのに着順が中途半端（4-8着）な馬」は
  市場に過小評価されている可能性がある。
  = [馬券市場の構造的非効率性](../market/market_structural_inefficiencies.md
    の新たな歪み候補。
```

### 「僅差の敗北馬」を狙う戦略

```
条件:
  - 前走着差が0.3秒以内
  - 前走着順が4-8着（「掲示板に載らなかった」or 「ギリギリ」）
  - 今回のオッズが前走着順を反映して高め
  - 前走のレースが接戦だった（着差の分散が小さい）

期待:
  実力は上位とほぼ変わらないのに、着順だけで軽視されている。
  今回も同等の走りをすれば好走する可能性が高い。
  オッズが歪んでいるので期待値が高い。

検証方法:
  1. 過去データで「前走着差0.3秒以内 & 着順4-8着」の馬を抽出
  2. 次走の成績と回収率を計算
  3. 「前走着順3着以内 & 同着差」の馬の次走成績と比較
  4. 着順バイアスの大きさ（回収率の差）を定量化
```

---

## 7. 関連する認知バイアス

```
■ 序数思考バイアス（Ordinal Thinking Bias）
  人間は「順位」で考える傾向が強く、「量」を軽視する。
  1位 > 2位 > 3位 ... という順序情報に過度に依存。
  → 「5着 > 6着」は直感的に正しいと感じる。
  → しかし「0.5秒差 > 0.2秒差」には気づかない。

■ アンカリング効果
  「着順」という数字にアンカーされると、
  着差という追加情報を十分に調整しない。
  → 5着という数字を見た瞬間に「まあまあ」と判断が固定。

■ カテゴリ思考（掲示板の壁）
  「5着以内 = 好走」「6着以下 = 凡走」というカテゴリ分け。
  → 連続量（着差）をカテゴリ（好走/凡走）に変換する際の情報損失。
  → [ランダムネスの認知錯誤](../market/randomness_cognitive_errors.md と同根の問題。

■ 代表性ヒューリスティック
  「5着の馬」は「次も好走しそう」と感じる。
  「6着の馬」は「微妙」と感じる。
  → 着差ではなく着順が「代表的な指標」として使われる。

★ AIモデルはこれらのバイアスに影響されない。
  着差ベースの特徴量を使えば、人間が見落とす
  「僅差の敗北馬」を正しく評価できる。
  これがAIの優位性。
```

---

## 8. 特徴量設計

```
■ F25: 前走着差パーセンタイル
  定義: 前走着差 / そのレースの最下位馬の着差
  用途: 頭数・レース条件に依存しない相対的な着差評価

■ F26: 着順-着差順位の乖離
  定義: 着順 - (着差で並べた順位)
  用途: 正=着順の割に実は強い（過小評価）。
        最も「着順バイアス」が大きい馬を検出。

■ F27: レースの接戦度
  定義: (1着〜最下位の着差) / 頭数
  用途: 小さいほど接戦。接戦のレースの着順は割り引いて評価。

■ F28: 着順の壁との距離
  定義: 着順が3着/5着の壁にどれだけ近いか
  計算: min(|着順-3|, |着順-5|)
  用途: 壁の近く（3-4着、5-6着）で着差が小さい場合、
        着順の信頼度が低い（ほぼランダム）ことを示す。

■ F29: 着差補正着順
  定義: 着差を基準にした「真の順位」
  計算: 着差でソートした場合の順位
  用途: 着順の代替。着差が同じなら同順位。
        LightGBMに着順の代わりにこちらを入れる。
```

---

## 9. 他のinsightsとの接続

| この考察の論点 | 関連するinsight |
|---|---|
| 着順以外の評価基準全般 | [着順以外の評価基準](beyond_finishing_position.md) |
| パフォーマンススコアの設計 | [着順以外の目的変数](alternative_target_variables.md) |
| 認知バイアスと誤判断 | [ランダムネスの認知錯誤](../market/randomness_cognitive_errors.md |
| 着差・上がりギャップの特徴量 | [features.md](../../features.md) パフォーマンス評価系 |
| オッズの歪みと市場の非効率性 | [馬券市場の構造的非効率性](../market/market_structural_inefficiencies.md |
| 前走不利の検出と次走戦略 | [スムーズな走りと展開予測の必要性](../race/smooth_trip_without_simulation.md |

---

## アクションアイテム

- [ ] 「前走着差0.3秒以内 & 着順4-8着」の馬の次走回収率分析
- [ ] 着順バイアスの定量化（着順評価 vs 着差評価の回収率差）
- [ ] 接戦のレース（着差の分散が小さい）での着順の予測精度検証
- [ ] sample_weightの導入による学習精度の改善検証
- [ ] 「着差補正着順」(F29) vs 「生の着順」での目的変数比較

## タグ

`#確率論` `#特徴量` `#モデル` `#馬券戦略` `#オッズ` `#前処理`
