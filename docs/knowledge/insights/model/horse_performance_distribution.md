# 馬の着順分布の形状: 勝てる馬・馬券になる馬・一発がある馬

「1着確率が同じ15%の馬」が2頭いても、馬券的な価値はまったく違うことがある。1頭は安定して2-3着に来る「馬券になる馬」、もう1頭は勝つか大敗かの「一発型」。この違いは1着確率だけでは捉えられない。

> 起点: 「勝ちやすい馬と、馬券になりやすい（2,3着になりやすい）馬と、勝つ確率は不明だが勝つ可能性を秘めてる馬を分けて考えるべきではないか」

---

## 1. この直感は正しい。そして非常に重要

この問いが突いているのは、**確率の「平均」だけでなく「分布の形」が馬券に影響する**という本質的な問題。

### 3つの馬の類型

```
■ タイプA: 安定強者（勝ちやすい馬）
  着順の傾向: 1着, 2着, 1着, 3着, 2着, 1着, ...
  1着率: 35%  複勝率: 85%
  特徴: 高い平均値、低い分散
  典型: クラスの実力上位馬、能力が抜けた馬

■ タイプB: 安定好走（馬券になりやすい馬）
  着順の傾向: 3着, 2着, 4着, 3着, 2着, 3着, ...
  1着率: 5%   複勝率: 70%
  特徴: 中程度の平均値、非常に低い分散
  典型: 堅実な先行馬、相手なりに走る馬、善戦マン

■ タイプC: 一発型（勝つ可能性を秘めてる馬）
  着順の傾向: 12着, 8着, 1着, 15着, 10着, 1着, ...
  1着率: 15%  複勝率: 25%
  特徴: 中程度の平均値、非常に高い分散
  典型: 追込馬、展開次第の馬、ムラ馬、脚質転換を試みている馬
```

### この3タイプの着順分布を図示する

```
タイプA（安定強者）:
  着順:  1  2  3  4  5  6  7  8  ...
  確率: ████████
        ██████
        ████
        ██
        █
        :
  → 1着に山があり、急速に減衰。裾が短い。

タイプB（安定好走）:
  着順:  1  2  3  4  5  6  7  8  ...
  確率: ██
        ██████
        ████████
        ██████
        ███
        █
        :
  → 2-3着に山がある。1着は少ないが圏外も少ない。

タイプC（一発型）:
  着順:  1  2  3  4  5  6  7  8  9  10 ...
  確率: ████
        ██
        █
        █
        ██
        ██
        ███
        ████
        ████
        ████
  → 二峰性。1着にも小さな山があるが、8-12着にも大きな山。
    「来るか来ないか」のどちらか。
```

---

## 2. なぜこれが重要なのか: Harvilleの盲点

### Harvilleは「1着確率」しか見ない

前回の考察（組合せ馬券の確率計算）で述べたHarville公式:

```
P(B 2着 | A 1着) = P(B) / (1 - P(A))

ここでP(B)はBの「1着確率」。
Harvilleは「1着確率が高い馬は、2着確率も高い」と仮定する。
```

しかし現実は違う:

```
タイプBの馬（安定好走型）:
  1着確率: 5%（低い）
  Harvilleが推定する2着確率: 低い
  実際の2着確率: 25%（非常に高い）
  → Harvilleは大幅に過小評価

タイプCの馬（一発型）:
  1着確率: 15%（そこそこ）
  Harvilleが推定する2着確率: そこそこ
  実際の2着確率: 5%（低い。勝つか飛ぶかなので）
  → Harvilleは過大評価
```

### 具体的な数値で見る

```
1着確率が同じ15%の2頭:

■ 馬X（安定好走型）:
  実際の着順分布: 1着15%, 2着25%, 3着20%, 4着15%, 5着10%, 6着以降15%
  複勝率: 60%
  → ワイドや三連複に「入りやすい」

■ 馬Y（一発型）:
  実際の着順分布: 1着15%, 2着5%, 3着5%, 4着3%, 5着2%, 6着以降70%
  複勝率: 25%
  → 勝つ時は勝つが、馬券に絡まないことが多い

Harvilleの計算:
  P(X 2着 | A 1着) = P(X) / (1-P(A)) = 0.15 / 0.70 = 0.214
  P(Y 2着 | A 1着) = P(Y) / (1-P(A)) = 0.15 / 0.70 = 0.214

  → Harvilleは2頭に同じ2着確率を割り当てる！
  → 実際にはXの方がはるかに2着に来やすい
  → この差がEV計算を歪める
```

---

## 3. 馬券種ごとの影響

### 各馬券種で「どのタイプが得か」

```
■ 単勝: タイプAが有利（当然）
  → 1着確率が直接効く。分布の形は関係ない。
  → Harvilleの問題は発生しない。

■ 複勝: タイプBが最も有利 ★
  → 複勝率が圧倒的に高い
  → 1着確率が低くてもオッズはそれなりに付く
  → EV > 1.0 になりやすい可能性

■ ワイド: タイプBが最も有利 ★★
  → 相方を選ばないほど3着内に入る
  → タイプB × タイプB のワイドは「ほぼ鉄板」だが
     オッズは2頭とも低人気のため意外と高いことがある

■ 馬連・馬単: タイプAとタイプBの組合せが有利
  → タイプA（1着要員）× タイプB（2着要員）
  → Harvilleが「タイプBの2着確率」を過小評価しているなら
     この組合せはEVが高い

■ 三連単・三連複: ここが最も影響が大きい ★★★
  → タイプA→B→B の三連単: Harvilleより実際の確率が高い
  → タイプC が絡む三連単: Harvilleが過大評価（2-3着に来にくい）
  → この歪みが利益源泉になりうる
```

### 市場の非効率性との接続

```
一般ファンの思考:
  「Yは1着なら万馬券。夢がある！」→ 三連単の1着にYを入れる
  「Xは地味。2-3着がせいぜい」→ 三連単の2-3着にXを入れる

しかしファンが計算していないこと:
  → Yが2-3着に来る確率は極めて低い
  → Yを2着に入れた三連単は、ファンが思うより当たらない
  → でもフォーメーションで「とりあえず入れている」
  → Yの2-3着を含む組合せのオッズが「割安」になっている

AIの優位性:
  → Xの2-3着確率の高さを正しく評価できる
  → Yの2-3着確率の低さを正しく評価できる
  → 「地味なX」が2-3着に入る組合せのEVが高いことを検出できる
```

---

## 4. この「分布の形」をどう数値化するか

### 4-1. 着順の分散

```
最もシンプルな指標: 過去N走の着順の標準偏差

  タイプA（安定強者）: 平均着順2.0、標準偏差1.2
  タイプB（安定好走）: 平均着順3.5、標準偏差1.0
  タイプC（一発型）:   平均着順7.0、標準偏差4.5

  → 標準偏差が小さい = 安定型（B寄り）
  → 標準偏差が大きい = 波がある型（C寄り）

特徴量として:
  - 過去5走の着順の標準偏差
  - 過去10走の着順の標準偏差
```

### 4-2. 勝率 vs 複勝率の比

```
1着率と3着内率の比率で、分布の「尖り方」がわかる:

  ratio = 複勝率 / 勝率

  タイプA: 85% / 35% = 2.4（勝率に対して複勝率がやや高い）
  タイプB: 70% / 5%  = 14.0（勝てないが圏内には来る） ★
  タイプC: 25% / 15% = 1.7（勝率の割に複勝率が低い）

  → ratio が高い = 「馬券になりやすいが勝てない」タイプ
  → ratio が低い = 「勝つか飛ぶか」タイプ

特徴量として:
  - 過去の複勝率 / 勝率（または連対率 / 勝率）
  → ただし勝率0%の場合の処理が必要（分母0回避）
```

### 4-3. 「圏内率」と「大敗率」

```
3着以内の安定度と、大敗の頻度を分けて見る:

  圏内率: 過去N走で3着以内に入った割合
  大敗率: 過去N走で(出走頭数の半分)以下の着順だった割合

  タイプA: 圏内率85%, 大敗率5%   → 安定して上位、めったに大敗しない
  タイプB: 圏内率70%, 大敗率5%   → 安定して圏内、めったに大敗しない
  タイプC: 圏内率25%, 大敗率55%  → 圏内率低い、大敗が多い

特徴量として:
  - 過去5走の3着内率
  - 過去5走の二桁着順率（10着以降の割合）
  - この2つの組合せでタイプを推定できる
```

### 4-4. 着順の尖度（kurtosis）

```
統計学の尖度を使うと、分布の「形」を直接測れる:

  正規分布: 尖度 = 3
  尖った分布（1着か大敗、二峰性）: 尖度 < 3
  平坦な分布（どの着順もまんべんなく）: 尖度 > 3

  ※着順分布は正規分布ではないので解釈に注意が必要だが、
    「分布の形が馬によって違う」ことの定量化には使える

特徴量として:
  - 過去10走の着順の尖度
  → サンプルが少ないと不安定なので、10走以上のデータが必要
```

---

## 5. モデル設計への影響: 1着確率だけでは不十分

### 現在の設計の限界

```
現在の設計（combination_ticket_probability.mdで定義）:

  Poseidon → P(各馬の1着確率) → Harville変換 → 組合せ確率 → Themis

この設計の暗黙の前提:
  「1着確率から、2着以降の確率は一意に決まる」
  → タイプBとタイプCの区別ができない
  → 組合せ馬券の確率が体系的に歪む
```

### 改善案: 1着確率 + 分散パラメータ

```
改善案1: 1着確率に加えて「安定度」を出力する

  Poseidon出力:
    - P(A wins) = 0.15
    - stability(A) = 0.8（高い = タイプB寄り）

  Harville改良版:
    P(B 2着 | A 1着) = f(P(B), stability(B), P(A))

  → stabilityが高い馬は2着確率を上方修正
  → stabilityが低い馬は2着確率を下方修正

  利点: Harvilleの枠組みを維持したまま分布の形を反映
  欠点: stabilityの推定精度が鍵。パラメータが1つ増える。
```

```
改善案2: 複数の着順確率を直接予測する

  Poseidon出力:
    - P(A 1着) = 0.15
    - P(A 2着) = 0.25  ← タイプBなら高い
    - P(A 3着) = 0.20

  → Harville変換を使わず、直接モデルから出力

  利点: 分布の形を最も正確に反映
  欠点: 整合性の問題（全馬の2着確率の合計が100%にならない等）
        モデルの複雑さが大幅に増す
```

```
改善案3: モンテカルロシミュレーションに分散を組み込む

  各馬のパラメータ:
    - 能力値（平均）: μ_A = 0.15 相当
    - 能力の分散: σ_A = 0.3（タイプBなら小、タイプCなら大）

  シミュレーション:
    performance_A = μ_A + N(0, σ_A) × random
    → 分散が大きい馬はパフォーマンスの振れ幅が大きい
    → 1着になることもあるが大敗もする

  利点: 分布の形が自然に反映される。最も柔軟。
  欠点: 計算コスト、パラメータ推定の難しさ。
```

### 推奨: 段階的に精度を上げる

```
Phase 1: Harvilleのまま。ただし「安定度」を特徴量に入れる
  → 1着確率モデルの入力に着順の標準偏差、複勝率/勝率比を追加
  → 1着確率自体が「安定度」を織り込む（安定型は複勝寄りの確率が出る）
  → Harville変換は変更しない
  → ★まずこれで十分

Phase 2: Henery補正にstabilityを組み込む
  → P(B 2着|A 1着) = P(B)^γ(B) / Σ P(k)^γ(k)
  → γ(B) を馬ごとに変える（安定型はγ小、一発型はγ大）
  → Harvilleの枠組みを拡張するだけなので実装は中程度

Phase 3: モンテカルロで分散を直接モデル化
  → 展開シミュレーション（race_scenario_simulation.md）と統合
  → 最も精度が高いが実装コストも高い
```

---

## 6. この視点で見えてくる馬券戦略

### 6-1. 複勝の「隠れた期待値」

```
タイプB（安定好走型）の複勝:
  1着確率: 5% → 人気: 6-8番人気 → 複勝オッズ: 5-10倍
  実際の複勝率: 70%
  複勝EV = 0.70 × 5.0 = 3.5 ← 非常に高い！

なぜこうなるか:
  → 複勝のオッズは大まかに「1着確率」に連動している
  → でも「複勝率」は1着確率とは別の分布パラメータに依存
  → 市場は1着確率が低い馬の複勝率を過小評価している

  ★これはFavorite-Longshot Biasの逆パターン:
    「地味な安定型の馬」は、1着の夢がないのでファンに買われにくい
    → 複勝オッズが割高のまま放置される
```

### 6-2. ワイドでの「堅い組合せ」の妙味

```
タイプB × タイプB のワイド:
  2頭とも3着内に入る確率: 高い（お互い独立なら0.7×0.7=49%）
  しかし2頭とも人気薄 → ワイドオッズ: 意外と高い

例:
  6番人気X（安定好走型、複勝率70%）
  7番人気Y（安定好走型、複勝率65%）
  ワイド X-Y のオッズ: 15倍
  P(ワイド X-Y 的中) ≈ 30-40%（展開の相関を考慮）
  EV = 0.35 × 15 = 5.25 ← 極めて高い

  ★007で松風がワイドを主力にしていた理由の一端かもしれない
```

### 6-3. 三連単での「一発型の罠」

```
タイプC（一発型）を2着3着に入れた三連単:
  ファンの思考: 「来たら万馬券！」→ フォーメーションに入れる
  現実: タイプCは2着3着にはほとんど来ない
  → この組合せのオッズは「割安」（ファンが買いすぎ）
  → EV < 1.0 の可能性が高い

AIの判断:
  タイプCは1着のみ検討。2-3着には入れない。
  代わりにタイプBを2-3着に入れる。
  → 「地味だが堅い」組合せのEVが高い
```

---

## 7. 「なぜ安定好走するのに勝てないのか」の構造

### 競馬における「勝てない理由」

```
能力は十分あるのに勝ちきれない馬が存在する理由:

1. 脚質の限界（差し・追込）
   → 前が止まらないと届かない
   → 2-3着には来るが最後の一押しが足りない
   → 展開依存度が高い（ただしタイプCほどではない）

2. 勝負根性の問題
   → 先頭に立つと「ソラを使う」（気を抜く）
   → 並ばれると交わされる
   → 常に2-3着に好走

3. クラスの天井
   → 今のクラスでは3着内に入れるが、勝てるほどではない
   → 長期間同じクラスに滞留
   → 条件戦の「万年2-3着馬」

4. コース・距離の微妙なずれ
   → 最適距離が1800mだが2000mを使われている
   → 能力は出し切れないが大敗もしない
   → 微妙に足りない2-3着

5. 枠順や馬場への適応力
   → 多少不利な条件でも大崩れしない堅実さ
   → ただし有利な条件が揃わないと勝ちきれない
```

### これらの「理由」は特徴量で捉えられるか

```
| 理由 | 特徴量化 | 難度 |
|---|---|---|
| 脚質の限界 | 上がり3Fの順位、脚質分類 | 低 |
| 勝負根性 | 直接的なデータなし。先頭に立った後の成績から間接推定 | 高 |
| クラスの天井 | 同クラス連続出走数、昇級初戦フラグ | 低 |
| 距離のずれ | ベスト距離の推定 × 今回の距離との差 | 中 |
| 適応力 | 着順の標準偏差（低い=適応力高い） | 低 |

→ 着順の標準偏差や複勝率/勝率比で間接的に捉えるのが現実的
→ 「なぜ安定しているか」の理由まで分解する必要はない（モデルに任せる）
```

---

## 8. 「勝つ可能性を秘めてる馬」の正体

### タイプCの情報構造

```
「勝つ確率は不明だが勝つ可能性を秘めている馬」の正体:

1. 能力は高いが、発揮条件が限られている
   → 特定の展開（ハイペース）でのみ能力全開
   → 大半のレースでは力を出し切れず凡走
   → 条件が揃えば圧勝する

2. 成長途上で能力が読めない
   → 若い馬（3歳、キャリアが浅い）
   → 過去の成績が少なく、真の能力が不確定
   → 「化ける」可能性がある

3. 調子のムラが大きい
   → 体調、気分、馬場、あらゆる条件で大きく変動
   → 好調なら上位、不調なら二桁着順

これらに共通するのは「不確実性が大きい」こと。
→ 不確実性 = 分散 = タイプCの定義そのもの
```

### 不確実性の大きい馬はオッズ的にどうなるか

```
市場の反応:
  タイプCの馬は「わからない」ので:
  → 一部のファンは「万馬券の夢」で買う（オッズを下げる）
  → 多くのファンは「信用できない」で避ける（オッズを上げる）
  → どちらが勝つかはケースバイケース

AIの利点:
  → 不確実性自体を定量化できる
  → 「この馬の1着確率は15%だが、分散が大きい」と表現
  → 単勝のEV計算には影響しないが、組合せ馬券のEV計算に影響する
  → タイプCの馬の「2着に入れた三連単」は避ける判断ができる
```

---

## 9. 具体的な特徴量リスト

```
■ 安定度の直接指標
  - 過去5走の着順の標準偏差
  - 過去10走の着順の標準偏差
  - 過去5走の着順の最大値-最小値（レンジ）

■ 着順分布の形状
  - 複勝率 / 勝率 の比（高い=タイプB、低い=タイプC）
  - 過去5走の3着内率
  - 過去5走の二桁着順率（10着以降の割合）
  - 過去5走の掲示板率（5着以内の割合）

■ 「一発型」の検出
  - 過去の最高着順と平均着順の差
    （大きい = 一発がある）
  - 過去の1着回数 / 3着内回数
    （高い = 勝つ時は勝つが2-3着は少ない）
  - 上がり3Fの最高値と平均値の差
    （大きい = ハマれば末脚が使える）

■ クラス適性
  - 同クラスでの連対率
  - 昇級初戦フラグ
  - 同クラスの出走回数（多い = 天井の可能性）
```

---

## 10. まとめ: 3つのタイプと馬券戦略の対応

```
┌────────────┬──────────────┬──────────────┬──────────────┐
│            │ タイプA       │ タイプB       │ タイプC       │
│            │ 安定強者      │ 安定好走      │ 一発型        │
├────────────┼──────────────┼──────────────┼──────────────┤
│ 1着確率     │ 高い(30%+)   │ 低い(5%)     │ 中程度(15%)  │
│ 複勝率      │ 非常に高い    │ 高い          │ 低い          │
│ 着順の分散  │ 小さい        │ 非常に小さい  │ 非常に大きい  │
├────────────┼──────────────┼──────────────┼──────────────┤
│ 単勝        │ ★★★ 本命   │ × 勝てない   │ ★ 万馬券狙い │
│ 複勝        │ ★ 固い      │ ★★★ 最適   │ × 危険       │
│ ワイド      │ ★★ 軸向き  │ ★★★ 最適   │ × 危険       │
│ 馬連1着固定 │ ★★★       │ × 1着に来ない│ ★ 穴馬連     │
│ 馬連2着     │ ★★         │ ★★★ 相手向き│ × 2着に来ない│
│ 三連単1着   │ ★★★       │ ×            │ ★ 穴三連単   │
│ 三連単2-3着 │ ★★         │ ★★★ 最適   │ × 入れない   │
├────────────┼──────────────┼──────────────┼──────────────┤
│ Harvilleの  │ やや過大評価  │ 大幅に過小評価│ 大幅に過大評価│
│ 2-3着確率   │ (OK程度)     │ (★問題大)    │ (★問題大)    │
├────────────┼──────────────┼──────────────┼──────────────┤
│ 市場での扱い│ 適正〜過剰人気│ 過小評価      │ 過大/過小混在 │
│ AIの機会    │ 少ない        │ ★★★ 大きい │ ★ ある      │
└────────────┴──────────────┴──────────────┴──────────────┘

核心: タイプBの馬は市場で最も過小評価されやすく、
      AIにとって最大の利益源泉になる可能性がある。
      「地味な安定好走馬」を2-3着に入れた組合せは、
      Harvilleが過小評価し、市場も軽視するため、
      EVが高くなりやすい。
```

---

## アクションアイテム

- [ ] 着順の標準偏差、複勝率/勝率比、二桁着順率をfeatures.mdに追加
- [ ] 過去データでタイプA/B/Cの分類を実行し、馬券種別の回収率を比較
- [ ] Harvilleの2着確率推定と実際の2着率の乖離を、タイプ別に検証
- [ ] タイプBの馬のワイド・複勝のEVを過去データで検証
- [ ] Henery補正のγを馬のタイプ別に推定する方法の検討
- [ ] H-27（着順分布の形状がEV計算に与える影響）を仮説検証マスターに追加

## タグ

`#モデル` `#確率論` `#馬券戦略` `#特徴量` `#三連単`
