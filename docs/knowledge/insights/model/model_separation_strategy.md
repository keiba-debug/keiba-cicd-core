# モデル分離戦略: 芝/ダート/障害をどう扱うか

芝・ダート・障害のモデルを分離すべきか、統合すべきかを考察する。005（平均回帰と過学習）の教訓を踏まえ、「分けるべき境界線」と「分けすぎの罠」を整理。

> 起点: 「芝/ダートは分けるべきか？距離帯やコース別まで分けるべきか？どこからが過学習か？」

---

## 1. 結論: 芝/ダートは分ける、それ以上は慎重に

芝とダートは物理的に異なる競技である。求められる能力、有利な脚質、馬場状態の影響、血統の適性、すべてが異なる。一つのモデルで「芝/ダートフラグ」を特徴量として入れることも可能だが、実質的にモデル内部で分岐を学習するだけなので、最初から分けた方が素直である。

### 推奨構成

```
Model-Turf     (芝)     ← 主力、データ豊富
Model-Dirt     (ダート)  ← 主力、データ豊富
Model-Jump     (障害)   ← 補助、データ少のため正則化強め or 初期スコープ外

各モデル共通の特徴量で距離・コースの違いを吸収:
  - 距離(m)
  - コースID
  - 回り(右/左/直線)
  - 馬場状態
  - 枠番
  - ...
```

---

## 2. 芝とダートが「別競技」である根拠

### 2-1. 物理的・構造的な違い

| 要素 | 芝 | ダート |
|---|---|---|
| 求められる能力 | スピード持続力、瞬発力 | パワー、先行力 |
| 上がり3Fの重要度 | 極めて高い | 芝ほどではない |
| 重馬場の影響 | タイム遅化、差し有利に傾きやすい | タイム速化（脚抜き良化） |
| 血統の適性 | サンデー系（SS系）が圧倒的 | ミスプロ系、A.P.Indy系が強い |
| 枠順の影響 | コース形態による（外回り/内回り） | 内枠有利の傾向が強い |
| 逃げ馬の勝率 | 距離・クラスで大きく変動 | 相対的に高い |

### 2-2. 特徴量の重要度が変わる

一つのモデルで芝/ダート両方を扱うと、特徴量の重要度が「平均化」されてしまう。

```
例: 「上がり3F」の特徴量重要度

  統合モデル: 重要度 = 0.15（芝の高い重要度とダートの低い重要度の平均）
  芝モデル:   重要度 = 0.25（正しく高い評価）
  ダートモデル: 重要度 = 0.05（正しく低い評価）

  → 統合モデルでは芝レースで上がり3Fを過小評価し、
    ダートレースで過大評価するバイアスが生じる
```

LightGBMは交互作用を学習できるので「芝フラグ × 上がり3F」は拾えるが、データ全体で分岐を繰り返す分、木の深さが浪費される。最初から分けた方が各モデルの表現力を有効に使える。

### 2-3. 馬のキャリアパス

芝馬とダート馬は基本的に別のキャリアパスを歩む。芝→ダート転向（or その逆）は「適性が合わなかった」ケースが多く、転向データをどう扱うかはモデル設計に影響する。

```
設計上の論点:
  - 芝成績をダートモデルの特徴量に使うか？
    → 「芝で走れなかった馬がダートで走れるか」の指標になりうる
  - ダート→芝転向馬のデータは芝モデルに入れるか？
    → サンプルとしてはノイズが多い。特徴量としての「ダート経験」は有用
  - 初出走馬（芝/ダート未経験）はどちらのモデルを使うか？
    → 血統とトレーニング情報で推定
```

---

## 3. 障害レースの特殊性

### なぜ分離が必要か

障害レースは芝/ダートとは次元が異なる。飛越能力という固有の要素が勝敗を大きく左右し、コース形態も平地とまったく違う。

```
障害レースの特殊要素:
  - 飛越能力（落馬リスク = 平地にない不確実性）
  - コース距離が3,000m以上
  - 出走頭数が少ない（8〜14頭）
  - レース数が極端に少ない（年間約200レース）
  - 平地成績との相関が低い
  - 専門騎手の影響が大きい
```

### データ量の問題

```
年間レース数（概算）:
  芝:   ~1,800レース  → モデル訓練に十分
  ダート: ~1,400レース → モデル訓練に十分
  障害:  ~200レース   → 単独モデルには厳しい

5年分でも障害は~1,000レース。
LightGBMの最低推奨サンプルは数千〜なので、
正則化を強くかけるか、シンプルなモデル（少ない特徴量）にする必要がある。
```

### 推奨: 初期スコープ外

障害レースは馬券市場としても規模が小さく（売上が平地の数十分の一）、EV計算の精度も出しにくい。初期段階では芝/ダートの2モデルに集中し、障害は十分な精度が出せる段階で拡張するのが現実的。

---

## 4. 分けすぎへの警告: 005の教訓

### 過学習の温床

005（ランダムネスと平均回帰）の核心教訓: 少数サンプルの好成績は偶然であり、平均回帰する。

モデル分離にも同じリスクがある。分ければ分けるほど各モデルのサンプルサイズは減り、「たまたま上手くいったパターン」を学習してしまう。

### 分離のサンプルサイズ基準

| 区分 | 年間レース数(概算) | 5年分 | モデル分離 | 理由 |
|---|---|---|---|---|
| 芝 | ~1,800 | ~9,000 | ○ 分ける | 十分なサンプル |
| ダート | ~1,400 | ~7,000 | ○ 分ける | 十分なサンプル |
| 障害 | ~200 | ~1,000 | △ 要注意 | サンプル少、正則化必須 |
| 芝短距離(~1400m) | ~500 | ~2,500 | × やりすぎ | 特徴量で吸収 |
| 芝中距離(1600-2200m) | ~900 | ~4,500 | × やりすぎ | 特徴量で吸収 |
| 芝・東京 | ~250 | ~1,250 | × やりすぎ | 特徴量で吸収 |
| ダート・1800m | ~400 | ~2,000 | × やりすぎ | 特徴量で吸収 |

### 「分ける」と「特徴量で吸収する」の判断基準

```
分けるべき条件（全て満たす場合）:
  1. 物理的に異なる競技と言える（芝 vs ダート、平地 vs 障害）
  2. 特徴量の重要度ランキングが根本的に変わる
  3. サンプルサイズが5年で5,000以上ある
  4. 分けることで予測対象の定義が変わらない

特徴量で吸収すべきもの:
  - 距離の違い → 「距離(m)」を特徴量に入れる
  - コースの違い → 「コースID」「回り」を特徴量に入れる
  - クラスの違い → 「クラスコード」を特徴量に入れる
  - 季節の違い → 「開催月」を特徴量に入れる
  - 馬場状態の違い → 「馬場状態コード」を特徴量に入れる

LightGBMは交互作用を自動的に学習するので、
「芝1200mの東京コースでは内枠有利」は特徴量さえ正しく入れれば
モデルが勝手に拾ってくれる。
```

---

## 5. 統合モデル vs 分離モデルの検証方法

### 仮説: 芝/ダート分離モデルは統合モデルよりEVベースの回収率が高い

```
検証手順:
  1. 同一の特徴量セットを使用
  2. 統合モデル: 芝/ダートフラグを特徴量に追加して1モデル
  3. 分離モデル: 芝/ダートを別々に訓練
  4. Walk-Forward Validationで評価
  5. 評価指標: ブライアスコア + EVベース回収率

期待される結果:
  - ブライアスコア: 分離の方がやや良い
  - EVベース回収率: 分離の方が良い（特に芝の上がり系が効く場面）
  - 差が小さい場合: 統合でも十分 → 運用の簡潔さを優先

★注意: この検証はH-12（確率推定 vs ランキング）やH-13（LightGBM vs RF）と
       同じフレームワークで実行できる。バックテスト基盤の構築が前提。
```

### 仮説検証マスターへの追加提案

```
H-21: 芝/ダート分離モデルは統合モデルよりEVベース回収率が高い
  重要度: ★★（モデル構造の決定に直結）
  容易度: 中（ベースラインモデル構築後に検証）
  Tier: 3（モデル設計の検証）
  Phase: 2

H-22: 距離帯別モデル分離は芝/ダート分離ほどの効果がない
  重要度: ★（過学習リスクの定量化）
  容易度: 中（H-21と同じフレームワーク）
  Tier: 3
  Phase: 2（H-21の後に実行）
```

---

## 6. 追加考察

### 6-1. 芝/ダート共通の「コア特徴量」と「専用特徴量」

```
モデルを分離する場合でも、特徴量セットを完全に別にする必要はない。
むしろ、共通部分と専用部分を意識的に分けることで保守性が上がる。

コア特徴量（芝/ダート共通）:
  - 枠番、馬番
  - 斤量
  - 性齢
  - 距離
  - コースID
  - 馬場状態
  - 前走着順、前走人気
  - 騎手成績（全体）
  - 調教師成績
  - 血統（父、母父）
  - 馬体重、馬体重増減
  - 休養期間

芝専用特徴量:
  - 上がり3Fベスト
  - 上がり3F平均
  - 芝適性指数（芝での過去成績）
  - 瞬発力指数
  - 道悪適性（芝重の成績）

ダート専用特徴量:
  - 先行力（序盤位置取りの傾向）
  - ダート適性指数（ダートでの過去成績）
  - パワー指数（坂路調教の時計等から推定）
  - 砂被り耐性（内枠での成績低下率）

この分離により:
  - コア特徴量のパイプラインは1つで済む
  - 専用特徴量の追加・削除が他方に影響しない
  - features.mdでの管理が明確になる
```

### 6-2. 転向馬の扱い: データのリーク vs 有用情報

```
芝→ダート転向（or逆）の馬のデータは、モデル設計上のジレンマを生む。

問題: 「芝で3戦して成績が出ず、ダートに転向」
  → この馬の芝3戦のデータはダートモデルに使うべきか？

選択肢:
  A. 使わない（ダートモデルにはダート成績のみ）
     利点: クリーンなデータ、過学習リスク低
     欠点: 転向馬の初ダートで情報がゼロ

  B. 特徴量として「芝成績」を入れる
     利点: 転向馬でも情報がある
     欠点: 芝とダートの成績相関が低い場合ノイズになる

  C. 「転向フラグ + 前走面変更」を特徴量に
     利点: 転向という事象自体の情報を使う（転向馬は陣営の判断がある）
     欠点: サンプルが少ない

推奨: B + C の組合せ
  - 「過去の芝成績サマリ」をダートモデルの特徴量に入れる
  - 「今回が初ダート」「芝→ダート転向」のフラグも入れる
  - LightGBMが有用でないと判断すれば勝手に重要度を下げる
  → まず入れて、重要度を見てから削るアプローチ
```

### 6-3. Themis（購入決定）はモデル分離の影響を受けない

```
運用アーキテクチャ設計指針で定義したThemisの「目隠し」原則がここでも活きる。

Themisの入力:
  - Dict[馬券ID, 確率]
  - Dict[馬券ID, オッズ]
  - float（バンクロール残高）

Themisは「この確率がどのモデルから出力されたか」を知らない。
芝モデルだろうがダートモデルだろうが統合モデルだろうが、
Themisの実装は一切変わらない。

これが松風のモジュール分離原則の実証的な利点:
  - 予測層（Poseidon相当）のモデル構成を自由に変更できる
  - 購入決定層（Themis）に影響が波及しない
  - A/Bテスト（統合 vs 分離）が購入決定ロジックの変更なしで実行可能
```

### 6-4. 段階的拡張戦略

```
Phase 0（現在）: モデル構造の検討
  → この考察ドキュメントを作成 ✓

Phase 1: 芝モデル単独で構築
  → データ量が最も多く、知見も豊富
  → ベースラインの精度を確認
  → バックテストフレームワークの構築

Phase 2: ダートモデルを追加
  → 芝モデルのパイプラインを流用
  → 特徴量セットの調整（ダート専用の追加）
  → 芝 vs ダートの特徴量重要度を比較分析

Phase 3: モデル統合 vs 分離の定量比較（H-21）
  → Phase 1-2で作ったモデルと統合モデルをWalk-Forwardで比較
  → 差が有意でなければ統合に一本化（運用コスト削減）
  → 差が有意なら分離を維持

Phase 4（将来）: 障害モデルの追加検討
  → データの蓄積状況を見て判断
  → 正則化を強めに設定
  → 障害専門の特徴量（飛越実績等）の設計
```

---

## アクションアイテム

- [ ] H-21（芝/ダート分離 vs 統合の定量比較）を仮説検証マスターに追加
- [ ] features.mdの特徴量を「コア」「芝専用」「ダート専用」に分類
- [ ] 転向馬の扱いに関するデータ分析（芝成績とダート成績の相関）
- [ ] 芝/ダートそれぞれの特徴量重要度の事前仮説を作成
- [ ] 障害レースの市場規模・データ量を定量的に確認

## タグ

`#モデル` `#特徴量` `#過学習` `#馬場`
