# バンクロール管理の原則

松風ブログ006-012から抽出した、資金管理・リスク制御に関する知見を横断整理する。
バンクロール管理は「モデル精度と同等以上に重要」であり、ここを間違えると優秀なモデルでも破産する。

> 「資金力なき予想は無力、予想なき資金力は散財」（011）

---

## 1. 複利の二面性：利益も損失も指数関数

### 複利の威力（実績データ）

| 年 | 初期バンクロール | 最終バンクロール | 倍率 | 出典 |
|---|---|---|---|---|
| 2019 | 50万円 | 1,739万円 | **35倍** | 009 |
| 2020 | 1,000万円 | 4.3億円 | **43倍** | 012 |

### 複利の恐怖（ドローダウン実績）

| 期間 | ピーク | ボトム | ドローダウン | 出典 |
|---|---|---|---|---|
| 2019上半期 | 160万円 | 5.5万円 | **-97%** | 009 |
| 2018 5週目 | 78万円 | 35万円 | **-56%** | 006 |

### 機会損失の計算

```
2019年のドローダウンがなかった場合:
  160万 × (1,739万 / 5.5万) ≈ 5億円

実際の結果: 1,739万円
機会損失:   約4.8億円

原因: チューニングの攻めすぎ + 不運の重なり
教訓: パラメータ1つのミスが最終結果を32分の1にする（009）
```

---

## 2. 追い下げ方式（バンクロール連動購入）

### 基本原則

松風システムは**バンクロール連動の購入金額決定**を採用。残高が減れば購入額も減る（追い下げ）、増えれば増える（追い上げ）。

```
購入金額 = バンクロール × ケリー係数 × 安全係数

ケリー係数: f = (p × odds - 1) / (odds - 1)
  p: AI予測確率
  odds: オッズ
  
安全係数: 0.25〜0.5（フルケリーの1/4〜1/2が推奨）
```

### なぜ追い下げが必要か

```
固定金額方式の場合:
  バンクロール: 100万
  1レース: 1万円 × 100点 = 10万円
  10連敗: 100万 → 0円 → 破産

追い下げ方式の場合:
  バンクロール: 100万
  1レース: 残高の10% = 10万円
  負け後: 90万 × 10% = 9万円
  さらに負け: 81万 × 10% = 8.1万円
  → 理論上は0にならない（ただし最低購入金額制約あり）
```

### 追い下げの実装上の注意（011の教訓）

```
致命的バグの事例:
  マルチプロセスでThemisのコピーを渡した
  → コピーのバンクロールを更新しても実体に反映されない
  → 追い下げが機能しない
  → 外れてもバンクロールが減らず、次のレースでオーバーレート
  → 推定損失: 200万円

必須要件:
  - バンクロール残高はプロセス間で一貫性を保つ
  - レースごとにバンクロールを即座に更新
  - 更新の原子性を保証（レース間で中途半端な状態を作らない）
```

---

## 3. バンクロール回転率と収益の関係

### 回転率の定義（006）

```
回転率 = 週あたりの購入金額 / バンクロール

1回転: 110% → 10%増
3回転: 110%^3 → 33%増（複利効果）

回転率を上げる方法:
  1. EV閾値を下げる（例: 1.2 → 1.01）→ 購入点数が増える
  2. 馬券種を追加（ワイド、枠連、複勝、単勝、三連単...）
  3. より多くのレースに参加する

回転率のトレードオフ:
  回転率↑ → 利益の期待値↑、ドローダウンリスク↑
  回転率↓ → 利益の期待値↓、安定性↑
```

### 実績から逆算する適切な回転率

```
Matsukaze 2019年:
  年間購入: 1.24億、年間バンクロール平均: 推定500万〜1,000万
  年間回転率: 124〜248回転
  週あたり: 2.4〜4.8回転

Matsukaze 2020年:
  年間購入: 25億、年間バンクロール平均: 推定5,000万〜1億
  年間回転率: 25〜50回転
  週あたり: 0.5〜1.0回転（スケール後は回転率が下がる）

初期フェーズ（小規模）:
  週2〜4回転が目安
  → 「EV > 1.0の馬券を全て購入」で自然にこの範囲に入る
```

---

## 4. EV閾値のチューニング

### 閾値と収益の関係（006, 007, 009）

| EV閾値 | 購入点数 | 回収率 | 安定性 | リスク |
|---|---|---|---|---|
| 1.5以上 | 少（精鋭） | 高（150%+） | 低 | 大数の法則が働かない |
| 1.2以上 | 中 | 中（120%） | 中 | バランス型 |
| **1.01以上** | **多（全量）** | **低（110%）** | **高** | **大数の法則で安定** |
| 1.0以上 | 最大 | 最低（100%+α） | 最高 | EV=1.0付近は推定誤差大 |

### Matsukaze氏の実践（006, 009）

- 初期: EV閾値を高めに設定 → 購入点数少 → 分散大
- 5週目のチューニング: 閾値を下げ、購入点数を増やした → 安定化
- 結論: **EV > 1.0の馬券を「全部」買うのが最適解**

### 閾値変更時の注意（009の教訓）

```
やってはいけないこと:
  × 短期の結果を見てEV閾値を変更する
  × 好調時に閾値を攻める（1.01 → 0.95など）
  × 不調時に閾値を上げて縮小する（心理的防衛）

正しいアプローチ:
  ○ バックテストで閾値ごとの回収率×購入金額を検証
  ○ モンテカルロで閾値ごとの破産確率を計算
  ○ 事前に決めた閾値を機械的に適用（感情排除）
  ○ 変更するなら十分なサンプル（数千レース）を根拠に
```

---

## 5. 破産確率の管理

### 破産確率の計算（008, 009）

```
Matsukaze氏は「3万年分」のシミュレーションを実施:
  → 約1億レース分のモンテカルロシミュレーション
  → 破産確率の精密な推定
  → ドローダウン分布の把握
  → パラメータの最適値探索

簡易的な破産確率の近似:
  固定ベット率fの場合:
    破産確率 ≈ (1 - edge/variance)^(bankroll/bet_size)
  
  ケリー基準の場合:
    理論上の破産確率 = 0（ただし離散的な実装では非ゼロ）
    フラクショナルケリー → 破産確率を任意に低くできる
```

### 破産防止の多重防御

```
第1層: 追い下げ方式
  → バンクロールが減れば自動的に購入額も減少

第2層: フラクショナルケリー（安全係数）
  → フルケリーの25%〜50%で運用
  → 破産確率を指数関数的に低減

第3層: ドローダウンアラート
  → -20%: 投資額半減警告
  → -30%: 投資停止勧告
  → -40%: 緊急停止

第4層: 最低バンクロール閾値
  → 初期バンクロールの10%を下回ったら全停止
  → 再開条件: パラメータ見直し + バックテストの再実施
```

---

## 6. 馬券種ポートフォリオによるリスク分散

### 推奨ポートフォリオ構成（008）

```
主力: ワイド（高的中率、低分散、EV良好）
分散: 枠連（ワイドと相関が低い）
拡張: 三連複 → 三連単（バンクロール成長に応じて解放）

注意:
  × 馬連+枠連（相関が鬼高い）
  × 単勝+複勝（複勝外れ→単勝も必ず外れ）
  ○ ワイド+枠連（的中パターンが異なる）
  ○ 複勝+三連単（リスク/リターンが正反対 → 分散効果大）
```

### バンクロール規模と馬券種の対応

```
〜50万円: 複勝・ワイド中心（安定重視）
50万〜200万円: ワイド+枠連+複勝（基本ポートフォリオ）
200万〜1,000万円: 上記+三連複（中リスク追加）
1,000万円〜: 全馬券種（三連単含む）

理由:
  三連単は分散が大きい → 小バンクロールでは破産リスク
  バンクロールが十分なら三連単の高EVを取りに行ける
  Matsukaze氏もQ3（バンクロール成長後）に三連単を解放
```

### 馬券種事後選択バイアスへの警告（012）

```
やってはいけないこと:
  × 直近でワイドの収支が悪い → ワイドを止める
  × 三連単で大負け → 三連単を止める

正しい判断プロセス:
  1. 各馬券種のEV計算ロジックに理論的欠陥はないか？
  2. サンプル数は十分か？（数十レースでは不十分）
  3. レート変動の影響を除いた均等ベースの回収率は？
  4. 馬券種間の相関を考慮したポートフォリオ効果は？

「サイコロを100個振れば、どれかの目は平均よりも少し多く出る」（012）
→ 馬券種の事後選択は、たまたま偏った目を選んでいるだけ
```

---

## 7. 的中率と回収率の分離監視（009）

### なぜ分離が必要か

```
スランプの診断:
  的中率が安定 + 回収率が低下（009の実例）
  → 原因はモデルではなくチューニング（EV閾値や馬券種構成）

モニタリング指標:
  1. 的中率（モデル精度の指標）
  2. 的中時の平均回収率（チューニングの指標）
  3. 購入金額（資金管理の指標）
```

### アラート条件

| 的中率 | 回収率 | 診断 | 対応 |
|---|---|---|---|
| 維持 | 低下 | チューニング不良 | EV閾値・馬券種構成を見直し |
| 低下 | 低下 | モデル劣化の可能性 | モデル再訓練・特徴量見直し |
| 低下 | 維持 | 不運（一時的） | 様子見（数週間監視） |
| 維持 | 維持 | 正常 | 継続 |
| 上昇 | 低下 | 低オッズに偏重 | 購入対象の再検討 |

---

## 8. 税引後EVでの意思決定（010）

### 税区分による利益の劇的な差

```
利益1,739万円の場合:
  一時所得: 税金 ≈ 3,000万円（破産）
  雑所得:   税金 ≈ 600万円（手取り1,139万円）
  差額:     2,400万円

→ 税区分の設計はAI設計の一部（010の核心知見）
```

### 税引後EVによる購入判断

```
雑所得の場合（税率35%想定）:
  税引後EV = EV × 0.65

購入基準:
  税引後EV > 1.0 → 購入
  つまり税引前EV > 1.0 / 0.65 ≈ 1.54 が必要？

  → 違う。雑所得では経費（外れ馬券）を控除できるため、
    全体の回収率が100%を超えていれば、個々のEV > 1.0で十分。
    ただし「全体で確実にプラス」である必要がある。
```

---

## 9. KeibaCICDへの適用ロードマップ

### Phase 1: 基盤構築

- [ ] バンクロール管理クラスの設計・実装
- [ ] EV計算エンジンの実装（確率 × オッズ）
- [ ] ケリー基準計算（フラクショナルケリー対応）
- [ ] バックテストフレームワーク（過去データでのEV検証）

### Phase 2: 監視・分析

- [ ] 的中率/回収率の分離モニタリング
- [ ] ドローダウン追跡と可視化
- [ ] 馬券種別パフォーマンス分析（ポートフォリオ効果含む）
- [ ] 購入証跡の自動記録（税務対応）

### Phase 3: 最適化

- [ ] モンテカルロシミュレーションによる破産確率計算
- [ ] EV閾値の最適化（バックテスト×シミュレーション）
- [ ] 馬券種ポートフォリオの最適配分
- [ ] safety_factorの動的調整

---

## 10. 追加考察（横断的気づき）

### 10-1. 同一レース内の賭け同士の相関問題

追い下げ方式では「レース間」のバンクロール連動を考えるが、**同一レース内の複数馬券の相関**も重要。

```
例: 第5レースで以下を購入
  ワイド 1-3: 500円
  ワイド 1-5: 500円
  枠連 1-3:  300円

問題: 1番馬が飛ぶと3つとも外れ → 1レースで1,300円の損失
  → 実質的なベットサイズが個別の500円ではなく1,300円

対策:
  1. 同一レース内の合計購入額をバンクロールの一定割合以内に制限
  2. 同一馬に依存する馬券の総額を管理
  3. Themisの金額計算時に、既に同レースで計算済みの馬券との相関を考慮

松風がこれをどう扱ったかは不明だが、
008の「馬券種間の相関が鬼高い」指摘の同一レース版。
```

### 10-2. バンクロールの「更新タイミング」問題

```
問題: 1日に24レース開催される場合、バンクロール更新はいつ行う？

案A: レースごとに即時更新
  → 1Rで大勝ち → 2Rの購入額が急増 → 追い上げが効きすぎ
  → 1Rで大負け → 2Rの購入額が急減 → 回収の機会を逃す

案B: 午前/午後で分割更新
  → 午前の結果を反映して午後の購入額を調整
  → バランス型

案C: 1日単位で更新
  → 前日のバンクロールで1日分の購入額を事前計算
  → 日中のドローダウンに影響されない安定性

推奨: 案B（午前/午後分割）または案C（日単位）
  → 松風の011バグ（バンクロール同期不全）を考えると、
     更新頻度を下げた方が実装バグのリスクが低い
```

### 10-3. 「初期バンクロール問題」— 小さく始める際の注意

```
松風: 50万円スタート → 年35倍
我々: おそらく数万〜数十万円スタート

小バンクロール時の制約:
  1. 最低購入単位（100円）に引っかかる
     → ケリー計算で50円の馬券は買えない → 切り上げ/切り捨ての歪み
  2. 1レースの購入合計がバンクの大部分を占める
     → 追い下げが機能する前にバンクが溶ける
  3. 馬券種が限られる
     → 三連単（高分散）は論外、ワイド+複勝が現実的

対策:
  - 初期は固定金額方式（100円均等）で実績データを蓄積
  - 十分なデータとバンクが溜まったら追い下げ方式に移行
  - 最初の目標は「利益を出す」ではなく「モデルの検証」
```

### 10-4. パレートの法則のバンクロール管理への含意

```
008の知見: 収益の80%は全レースの20%から生まれる

含意:
  もし「どのレースが当たり期間か」が事前にわからないなら、
  全レースに均等にバンクロールを配分するのが最適。

  しかし「特定の条件（多頭数、特定コース等）でEVが高い」と判明した場合:
  → その条件のレースにバンクロールを傾斜配分する戦略もありうる

  ただし005の警告: 条件ごとの成績は平均回帰するかもしれない
  → 傾斜配分は統計的有意性が十分に確認できてから
```

## タグ

`#バンクロール` `#馬券戦略` `#運用` `#チューニング` `#確率論` `#ポートフォリオ` `#税金`
