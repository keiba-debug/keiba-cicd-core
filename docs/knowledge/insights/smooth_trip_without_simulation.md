# 「スムーズに走れる馬」の予測に展開・隊列予測は不可欠か？

> 起点: 「不利なくスムーズに走れる馬を予測するために、展開や隊列予測が不可欠なのか？」

---

## 1. 結論: 不可欠ではない。ただし「何を予測したいか」で答えが変わる

```
■ 「この馬はスムーズに走れるタイプか？」（馬の属性としての予測）
  → 展開予測は不要。特徴量だけで十分。

■ 「今日のこのレースでこの馬はスムーズに走れるか？」（当日の状況判断）
  → メンバー構成・枠順の特徴量でかなり近似できる。
  → 展開シミュレーションは精度を上げるが「不可欠」ではない。

■ 「スムーズに走れた場合と走れなかった場合で着順がどう変わるか？」
  → これは展開シミュレーション（レベル2以上）の領域。
  → ただしこれが必要になるのは三連単の精密なEV計算段階であり、
     初期フェーズでは不要。
```

**結局のところ**: スムーズに走れる馬の予測は、展開・隊列を「明示的にシミュレーション」しなくても、**特徴量設計で8割は捉えられる**。残り2割を取りに行く段階で初めて展開予測が視野に入る。

---

## 2. 「不利」の分類: 何が予測できて何が予測できないか

### 不利の4類型

```
タイプA: 構造的不利（予測可能度: ★★★★★）
  出走前に確定している、枠順・コース形態に起因する不利。

  例:
  - 大外枠の逃げ馬 → 先頭に立つまでに体力消耗
  - 多頭数の内枠・差し馬 → 包まれるリスク
  - 小回りコースの外枠 → 1コーナーまでの距離ロス
  - 内枠のダート → 砂を被る（特に雨）

  → 枠番 × 脚質 × コース × 頭数で特徴量化すれば、
    モデルが自動学習する。展開予測は不要。

タイプB: メンバー依存不利（予測可能度: ★★★★☆）
  出走メンバーの脚質構成で変わる不利。

  例:
  - 逃げ馬が3頭 → 先行勢の共倒れ
  - 逃げ馬がゼロ → スローペースで追込馬が届かない
  - 同脚質の馬が密集 → ポジション争いで消耗
  - 有力馬が同じ枠順帯 → 直接競合

  → 「同レース逃げ馬頭数」「同脚質馬数」等の特徴量で捉えられる。
    展開予測なしでLightGBMが交互作用を学習可能。

タイプC: 確率的不利（予測可能度: ★★★☆☆）
  起こるかどうかが確率的で、起こった場合の影響が大きい不利。

  例:
  - 出遅れ（確率は推定可能、発生は確率的）
  - 掛かる（前走の掛かり履歴から推定可能）
  - ペースの急変（逃げ馬の気分次第）
  - 前が壁になって追い出せない

  → 「出遅れ率」「掛かり率」等の特徴量で「平均的な影響」は捉えられる。
    「出遅れた場合の着順」を知るにはシナリオ分岐が必要。
    ただし平均的な影響だけでも十分実用的。

タイプD: 偶発的不利（予測可能度: ★☆☆☆☆）
  本質的に予測不可能な不利。

  例:
  - 他馬との接触・ぶつかり
  - 落鉄
  - 騎手の判断ミス
  - 馬場の急変（レース中の降雨）

  → 予測不可能。これはノイズとして受け入れるしかない。
    ただし「不利を受けやすい馬」の傾向は存在する
    （小柄な馬、気性が荒い馬、経験が浅い馬など）。
```

### 予測可能な不利の割合（推定）

```
タイプA（構造的）: レースの不利の約30% → 特徴量で100%捕捉可
タイプB（メンバー依存）: 約30% → 特徴量で80%捕捉可
タイプC（確率的）: 約25% → 特徴量で50%捕捉可（平均効果のみ）
タイプD（偶発的）: 約15% → 捕捉不可

→ 特徴量アプローチで捉えられる不利:
  0.30×1.0 + 0.30×0.8 + 0.25×0.5 + 0.15×0 = 0.665
  → 全不利の約67%を展開予測なしで捉えられる

→ 展開シミュレーションを追加した場合:
  タイプCの捕捉率が50% → 80%に改善
  0.30×1.0 + 0.30×0.8 + 0.25×0.8 + 0.15×0 = 0.74
  → 約74%に改善（+7ポイント）

→ この+7ポイントのために展開シミュレーションを実装すべきか？
  → 初期段階では明確にNo。67%で十分に利益は出せる。
```

---

## 3. 展開予測なしで「スムーズさ」を捉える特徴量設計

### 3-1. 馬自身の「スムーズに走れる力」を示す特徴量

```
■ 出遅れ率（過去N走）
  低い → ゲートが巧い → スタートで不利を受けにくい

■ 着順標準偏差（過去5走）
  低い → 安定型 → どんな展開でも大崩れしない
  ★これは「展開の影響を受けにくい馬」の検出に使える

■ 4角通過順位の安定度
  標準偏差が低い → 毎回同じポジションを取れる → 脚質が確立
  → ポジション取りで消耗しない＝スムーズ

■ 上がり3F順位の安定度
  常に上がり上位 → 末脚を使える位置で走れている → 不利が少ない

■ 騎手の不利回避率（難しいが有用）
  当該騎手が騎乗した馬の「不利を受けた率」の低さ
  → 上手い騎手は不利を避ける能力が高い
  → 直接データはないが、代理変数として:
    - 騎手の複勝率/勝率比（高い＝着実に持ってくる＝不利少ない）
    - 騎手の4角順位→着順改善率（高い＝仕掛け判断が的確）
```

### 3-2. 当日のレース条件から「スムーズさ」を予測する特徴量

```
■ 枠番 × 脚質
  逃げ馬+内枠 → スムーズ度高（先頭に立ちやすい）
  差し馬+中枠 → スムーズ度高（選択肢が多い）
  追込馬+大外 → スムーズ度やや高（外に出しやすい）
  差し馬+最内枠+多頭数 → スムーズ度低（包まれやすい）

■ 同脚質の出走数
  逃げ馬なのに逃げ馬が3頭 → 競り合いで消耗＝不利
  差し馬で逃げ馬が多い → ハイペースで差しやすい＝有利

■ 枠番近辺の有力馬密度
  自分の隣に強い先行馬がいる → ポジション取りで影響を受ける
  ★これは「隊列」の簡易近似

■ 出走頭数
  多頭数（16頭以上）→ 不利が起こりやすい
  少頭数（10頭以下）→ スムーズに走りやすい

■ コース形態
  直線が長い → 不利を挽回しやすい（東京、新潟外回り）
  小回り → 位置取りが全て（福島、小倉、中山内回り）
  → 同じ不利でも、コースによって影響度が異なる
```

### 3-3. 「前走不利だった馬」を検出する特徴量（事後評価）

```
むしろこちらの方が展開予測より実用的。

■ 前走の上がり3F順位 vs 着順ギャップ
  上がり2位なのに8着 → 何か不利があった
  → 次走で「実力通り」走れれば巻き返し候補

■ 前走の4角→ゴールの順位変動
  4角12番手 → ゴール4着（8つ上げ） → 強い末脚だが届かなかった
  → 枠順やメンバーが変われば好走の可能性

■ 前走の1角通過順位の急落
  通常の通過順位が3番手なのに、前走は10番手
  → 出遅れた可能性 → 度外視すべき凡走

■ 着順と着差の乖離
  8着だが1着との着差0.5秒 → 僅差で負けただけ
  → 展開次第で上位だった可能性

★ これらの「前走の不利検出」は、未来の展開を予測するより
  はるかに確実で実装も簡単。
  「前走不利で負けた馬が次走で巻き返す」パターンを
  拾うだけでも大きなエッジになる。
```

---

## 4. 展開・隊列予測が「効く」場面と「効かない」場面

### 展開予測が効かない場面（特徴量で十分）

```
1. ワイド・複勝の購入判断
   → 着順の精密な予測は不要。「3着以内に来るか」だけ。
   → 不利を受けにくい馬を選ぶだけで十分。
   → 特徴量アプローチで完全にカバー可能。

2. 展開が読みやすいレース
   → 逃げ馬が1頭だけ、脚質が分散しているレース。
   → 展開の変動が小さいので、平均的な予測で正確。

3. 少頭数レース
   → 不利が起こりにくい。隊列予測の付加価値が小さい。

4. 実力差が大きいレース
   → 圧倒的な馬がいる場合、展開に関わらず結果は同じ。
```

### 展開予測が効く場面（特徴量だけでは限界）

```
1. 三連単のEV計算
   → 着順の「組合せ」が問題。展開で組合せが入れ替わる。
   → [展開シミュレーション](race_scenario_simulation.md) セクション2の議論。
   → ただしレベル0のHarvilleでも松風は+1,700万円。

2. 逃げ馬競合のレース
   → 逃げ馬が2-3頭いると展開が読みにくい。
   → 「共倒れ」か「1頭が控えてスロー」かで結果が激変。
   → 特徴量では「逃げ馬3頭→平均的にはハイペース」と学習するが、
     「どの逃げ馬が引くか」までは予測できない。

3. 出遅れ常習犯が人気馬のケース
   → タイプCの確率的不利。
   → 「出遅れた場合」と「出遅れなかった場合」で
     他馬の着順も変わる（シナリオ分岐）。

4. 極端なメンバー構成
   → 追込馬だらけで逃げ馬ゼロ、等。
   → 誰がハナに立つかで全く違うレースになる。
```

---

## 5. 重要な視点転換: 「予測する」より「避ける」

### 展開を予測する代わりに「展開リスクを定量化」する

```
発想の転換:
  ✗ 「この馬はスムーズに走れるか予測しよう」（難しい）
  ○ 「このレースは展開リスクが高いか定量化しよう」（比較的簡単）

展開リスクが高いレースの特徴:
  - 逃げ馬の頭数が2頭以上（ペース読みにくい）
  - 脚質が偏っている（差し馬だらけ or 先行馬だらけ）
  - 多頭数（16頭以上）
  - 有力馬に出遅れ常習犯がいる
  - コースが小回り（不利が結果に直結）

展開リスクが低いレースの特徴:
  - 逃げ馬が1頭で明確
  - 脚質がバランスよく分散
  - 少頭数
  - 直線が長いコース

→ リスクが低いレースでは、展開予測なしでも予測精度が高い
→ リスクが高いレースでは、2つの戦略がある:
  (a) そのレースの購入を見送る（不確実性が高すぎる）
  (b) 展開シミュレーション（レベル2）を適用する

★ (a) の「見送り」は極めて強力な戦略。
  松風ブログでも「買わないレースを決める」ことの重要性が繰り返し強調される。
  展開リスクが高いレースを避けるだけで、
  展開予測なしでも回収率が改善する可能性がある。
```

### 展開リスク指数（実装案）

```python
def calc_race_scenario_risk(race):
    """レースの展開不確実性を0-1で定量化"""
    risk = 0.0

    # 逃げ馬の頭数リスク
    n_runners = count_by_style(race, "逃げ")
    if n_runners == 0:
        risk += 0.3   # 誰がハナか不明
    elif n_runners >= 2:
        risk += 0.2 * (n_runners - 1)  # 競合リスク

    # 脚質偏りリスク（エントロピーベース）
    style_entropy = calc_style_entropy(race)
    risk += (1 - style_entropy) * 0.2

    # 多頭数リスク
    if race.num_entries >= 16:
        risk += 0.15

    # 有力馬の出遅れリスク
    for entry in race.top5_favorites:
        if entry.gate_miss_rate > 0.2:
            risk += 0.1

    # コースリスク（小回りほどリスク高）
    risk += course_risk_table[race.course_id] * 0.15

    return min(risk, 1.0)
```

---

## 6. 隊列予測の特殊性: 予測するより「事後評価」が有効

### 隊列を事前に予測する困難さ

```
隊列（レース中の各馬の位置関係）を事前に予測するのは極めて難しい:

1. スタートの揃い方が不確定
   → 出遅れ1頭で隊列が全く変わる

2. 騎手の判断がリアルタイム
   → 「外に出す」「内に潜る」は状況判断

3. 馬の気性が当日わからない
   → 掛かる、引っ掛かる、折り合いがつかない

4. 隣の馬との相性
   → データがほぼない

→ 隊列の事前予測は、投資対効果が極めて低い。
```

### 代わりに: 隊列の「事後評価」で次走予測を改善

```
隊列を予測する代わりに、過去の隊列データを活用する:

■ 通過順位パターンから「理想の隊列」を推定
  馬Aの過去5走の4角通過順位: [3, 2, 4, 3, 3]
  → 理想ポジション = 3番手前後
  → 今回の枠順で3番手を取れそうか？ → スムーズ度の予測

■ 「理想ポジションからの乖離」と着順の関係
  理想3番手なのに8番手だった前走 → 着順悪化（不利の証拠）
  理想3番手で3番手だった前走 → 着順通り（スムーズ）
  → 乖離度を特徴量にすれば、不利の影響を間接的に捕捉

■ 枠番 → 通過順位の変換テーブル（コース×脚質別）
  「中山芝2000m、差し脚質、3枠」→ 過去の平均4角通過順位: 7.2番手
  「中山芝2000m、差し脚質、8枠」→ 過去の平均4角通過順位: 9.1番手
  → 外枠だと約2つポジションが後ろ → スムーズ度が下がる
  → この「枠順→想定通過順位」を特徴量に使えば、
    隊列を予測しなくても隊列の影響を特徴量で近似できる
```

---

## 7. 「スムーズに走れる馬」の予測: 推奨アプローチ

### Phase 1: 特徴量ベース（展開予測なし）★まずここ

```
目的: 「不利を受けにくい馬」の特定

使用する特徴量:
  [馬の属性]
  - 出遅れ率
  - 着順標準偏差（安定度）
  - 4角通過順位の安定度
  - 前走の上がり3F順位 vs 着順ギャップ（前走の不利検出）

  [当日のレース条件]
  - 枠番 × 脚質
  - 同レース逃げ馬頭数
  - 同脚質出走数
  - 出走頭数
  - コース形態（直線長、回り）

  [騎手の能力]
  - 騎手の複勝率
  - 騎手のコース別成績

→ これらをLightGBMの特徴量に入れるだけ。
  モデルが「不利を受けやすい条件」を自動学習する。
  明示的に「スムーズ度」を計算する必要はない。

利点: 実装コスト最小。特徴量追加だけで効果あり。
```

### Phase 2: 展開リスクによるレース選別

```
目的: 予測が難しいレースを避ける

手法:
  1. 展開リスク指数を計算（セクション5の式）
  2. リスクが高いレースは購入EV閾値を引き上げる
     例: 通常EV > 1.10 → リスク高レースはEV > 1.25に
  3. または単純に購入を見送る

利点: 展開を「予測する」のではなく「避ける」。
     実装コスト低、効果は大きい可能性。
```

### Phase 3: 前走不利馬の検出と重み付け（最も実用的）

```
目的: 「前走は不利で凡走したが実力は高い馬」を拾う

手法:
  1. 前走の不利指標を計算
     - 上がり3F順位 vs 着順ギャップ ≥ 5 → 不利の可能性大
     - 4角通過順位の急変（通常と5以上の乖離）→ 出遅れor展開崩壊
     - 着差0.5秒以内なのに着順が7着以下 → 僅差の負け

  2. 不利が検出された前走は「度外視」扱い
     → その走のパフォーマンス指標を割り引く
     → 代わりにその前の走（2走前）を重視

  3. 不利度外視後の「本来の能力」で予測

利点: 未来の展開を予測するより遥かに確実。
     過去のデータから「事実」を読み取るだけ。
     特にオッズが「前走凡走」を過剰に割り引いている場合、
     大きなエッジになる。
```

### Phase 4 以降: 展開シミュレーション（必要になったら）

```
→ [展開シミュレーション](race_scenario_simulation.md) のレベル1-2
→ Phase 1-3で十分な利益が出ている段階で検討
→ 三連単の精度向上が目的になった時に初めて必要
```

---

## 8. 核心的な問い: なぜ「展開予測なし」で十分なのか

### 理由1: LightGBMは交互作用を自動学習する

```
「差し馬 × 逃げ馬3頭 × 内枠 → 好走」

この知識を得るために、明示的に展開を予測する必要はない。
LightGBMに特徴量（脚質、逃げ馬頭数、枠番）を入れれば、
決定木の分岐で自動的にこのパターンを拾う。

展開シミュレーションがやることの大部分は、
結局「特徴量の交互作用を人間が明示的に計算する」ことであり、
勾配ブースティングが自動でやってくれることと重複する。
```

### 理由2: 展開の予測精度が低い

```
展開予測の精度を考える:
- ペース（ハイ/ミドル/スロー）の予測精度: 推定60-70%
- 個別の馬のポジションの予測精度: 推定40-50%
- 出遅れの予測: 確率は分かるが発生は確率的

精度60%の展開予測を使うのと、
特徴量で「展開の平均的な影響」を学習するのと、
最終的な着順予測の精度にどれだけ差があるか？

→ 展開予測の精度が低い場合、
  精密な展開シミュレーションはむしろノイズを増やす。
  「平均的な影響」の方が安定した予測になりうる。

→ 展開予測の精度が十分高くなるのは、
  大量のデータで精密なモデルを構築した後の話。
  初期段階では特徴量アプローチが優位。
```

### 理由3: 「スムーズに走れたか」は事後的に分かる

```
未来の展開を予測するのは難しいが、
過去のレースで「スムーズだったか」は客観的に分かる:

- 上がり3Fが速いのに着順が悪い → スムーズでなかった
- 4角から着順が大きく改善 → 前半で不利があった
- 着差が小さいのに着順が悪い → 僅差の不運

この事後情報を次走の予測に使う方が、
未来の展開を予測するより遥かに高精度。

★ 予測の世界では「観測可能な過去」>「予測した未来」
  常にこの原則が成り立つ。
```

---

## 9. まとめ: 不利予測の投資対効果マトリクス

```
┌─────────────────────┬──────────┬──────────┬──────────┐
│ アプローチ          │実装コスト│精度向上  │推奨Phase │
├─────────────────────┼──────────┼──────────┼──────────┤
│ 特徴量で構造的不利を│  低      │  高      │ Phase 1  │
│ 捕捉（枠×脚質等）  │          │          │ ★最優先 │
├─────────────────────┼──────────┼──────────┼──────────┤
│ 前走の不利を検出    │  低      │  高      │ Phase 1  │
│ して次走予測に反映  │          │          │ ★最優先 │
├─────────────────────┼──────────┼──────────┼──────────┤
│ 展開リスク指数で    │  低      │  中      │ Phase 2  │
│ レースを選別        │          │          │          │
├─────────────────────┼──────────┼──────────┼──────────┤
│ 脚質ペア補正        │  中      │  中      │ Phase 3  │
│ （Harvilleの修正）  │          │          │          │
├─────────────────────┼──────────┼──────────┼──────────┤
│ シナリオ分岐        │  高      │  中-低   │ Phase 4+ │
│ （展開予測）        │          │          │          │
├─────────────────────┼──────────┼──────────┼──────────┤
│ 隊列シミュレーション│  極高    │  低      │ 研究     │
│ （レース再現）      │          │          │          │
└─────────────────────┴──────────┴──────────┴──────────┘

★ 上2つ（特徴量＋前走不利検出）だけで
  「スムーズに走れる馬の予測」の8割はカバーできる。
  展開シミュレーションは投資対効果が悪い段階が長く続く。
```

---

## 10. 他のinsightsとの接続

| この考察の論点 | 関連するinsight |
|---|---|
| 展開シミュレーションのレベル0-3 | [展開シミュレーションと条件付き着順予測](race_scenario_simulation.md) |
| 前走不利の検出（上がりギャップ等） | [着順以外の評価基準](beyond_finishing_position.md) |
| 展開を反映する特徴量設計 | [features.md](../features.md) ペース・ラップ系 |
| レース選別と購入戦略 | [回収率と購入量のトレードオフ](roi_volume_tradeoff.md) |
| 着順標準偏差による安定度分類 | [馬の着順分布の形状](horse_performance_distribution.md) |
| 枠順×コースの構造的分析 | [環境物理学](environmental_physics.md) |
| パフォーマンススコアとの統合 | [着順以外の目的変数](alternative_target_variables.md) |

---

## アクションアイテム

- [ ] 「前走不利検出」の基準値設計（上がりギャップ≥5、4角乖離≥5 等）
- [ ] 枠番×脚質×コース別の「スムーズ度テーブル」を過去データから構築
- [ ] 展開リスク指数の計算ロジック設計と過去データでの検証
- [ ] 「展開リスクが高いレースを避けた場合の回収率改善」のバックテスト
- [ ] 「前走不利→次走巻き返し」パターンの回収率分析

## タグ

`#展開` `#特徴量` `#モデル` `#馬券戦略` `#コース`
