# 着順以外の評価基準: 馬の能力をどう測るか

着順は「そのレースの結果」でしかない。G1の10着とクラスの1着、どちらの馬が強いか？ 不利を受けた2着と楽勝の1着、どちらが次走で期待できるか？ 着順の裏にある「本当の能力」を測る方法のアイデアを整理する。

> 起点: 「着順じゃない評価基準についても考えていきたい。どのようなやり方があるかアイデアを出していきたい」

---

## 1. なぜ着順だけでは不十分なのか

### 着順が情報を失う3つのケース

```
ケース1: 「相手の質」が違う
  馬A: 有馬記念で8着（1着はイクイノックス級）
  馬B: 3勝クラスで1着

  着順だけ見ると B > A。しかし能力は A >> B の可能性。
  → 着順は「相対的な結果」であり、「絶対的な能力」を示さない。

ケース2: 「展開・不利」の影響
  馬C: 出遅れ + 大外を回して3着（本来なら勝っていた）
  馬D: 好位からスムーズに抜け出して1着

  着順だけ見ると D > C。しかし実質的な能力発揮は C > D の可能性。
  → 着順は「レースのスムーズさ」に大きく左右される。

ケース3: 「着差」の情報
  馬E: 2着（1着馬に0.1秒差、必死に追って届かず）
  馬F: 2着（1着馬に2.0秒差、追う気配もなく流した）

  同じ2着でも E は「あと少しで勝てた」、F は「勝負にならなかった」。
  → 着順は「着差」という重要情報を捨てている。
```

---

## 2. アプローチ一覧: 着順を超える評価軸

### 全体マップ

```
┌─────────────────────────────────────────────────┐
│           着順以外の評価基準マップ                  │
├─────────────────────────────────────────────────┤
│                                                 │
│  A. タイム系（スピード指数）                      │
│     → 走破タイムを標準化して比較可能にする        │
│                                                 │
│  B. 着差系（マージン分析）                        │
│     → 着差（秒差・馬身差）で勝ち負けの度合いを測る│
│                                                 │
│  C. 上がり系（末脚評価）                          │
│     → 上がり3Fタイム・順位で潜在能力を見る        │
│                                                 │
│  D. 位置取り系（レース内容分析）                  │
│     → 通過順位のパターンで走りの質を評価           │
│                                                 │
│  E. レーティング系（総合評価）                    │
│     → 複数要素を統合した能力値（RPR, SR等）       │
│                                                 │
│  F. 着順の「文脈補正」                            │
│     → 着順自体にレベル補正をかける                │
│                                                 │
│  G. 「負けの質」分析                              │
│     → 負けた理由を分解して、次走の期待値を推定     │
│                                                 │
│  H. 物理モデル系                                  │
│     → スタミナ・瞬発力を物理量として推定          │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 3. アプローチA: スピード指数（タイムベース）

### 概要

```
原理: 走破タイムを「標準化」して、異なるレースの成績を比較可能にする。

生のタイムの問題:
  東京1600m 1:33.5 と 中山2000m 2:00.0 は直接比較できない。
  同じ東京1600mでも、良馬場と重馬場ではタイムが全く違う。

スピード指数の考え方:
  指数 = (基準タイム - 走破タイム) × 定数 + 馬場補正 + 距離補正

  → 異なる条件のタイムを「同じ物差し」で測れるようにする。
```

### 具体的な方式

```
■ 西田式スピード指数（日本で有名）
  基準タイム: コース × 距離 × 馬場別の平均タイム
  指数 = (基準タイム - 走破タイム) / 0.1 × 1.0 + 馬場差
  → 0.1秒速いと指数が1上がる

■ 独自スピード指数（AI用に設計）
  Step 1: コース × 距離 × 馬場別の平均タイムを計算
  Step 2: 走破タイムと平均タイムの差を算出
  Step 3: 馬場差（当日のレース全体のタイム傾向）で補正
  Step 4: 斤量補正（負担重量の影響を考慮）

■ タイムランク
  同レース内での走破タイムの相対順位
  → レース間の比較はできないが、「そのレースで何番目に速かったか」はわかる
```

### 注意点

```
スピード指数の限界:
  1. 馬場差の推定が難しい（同じ「良」でも日によって速さが違う）
  2. ペースの影響を受ける（ハイペース→全体のタイムが速い→指数が高い）
  3. 展開利の反映ができない（楽に先行した馬と追い込んだ馬の差）
  4. 距離適性を反映しない（距離が合わなくてタイムが出なかった）

→ スピード指数は「有用だが万能ではない」。
→ 他の指標と組み合わせて使うべき。

AI向け特徴量として:
  - 前走スピード指数
  - 過去5走のスピード指数の平均・最大・標準偏差
  - スピード指数のトレンド（上昇中/下降中/安定）
```

---

## 4. アプローチB: 着差分析（マージンベース）

### 概要

```
原理: 着順ではなく「どれだけの差で負けたか/勝ったか」を見る。

  1着馬に0.2秒差の2着 → 能力はほぼ同等
  1着馬に3.0秒差の2着 → 実質的に完敗（少頭数の可能性）

着差の測り方:
  - タイム差（秒差）: 最も正確だが、距離やペースの影響を受ける
  - 馬身差: 「クビ差」「ハナ差」等。直感的だがタイム差の方が正確
  - 着差偏差値: その着差がどれくらい「普通」かを相対化
```

### 具体的な特徴量

```
■ 1着との着差（秒差）
  前走での1着馬とのタイム差。
  → 着順より情報が濃い。「惜しい2着」と「完敗の2着」を区別できる。

■ 前走着差の正規化
  着差 / (レースの平均着差)
  → レースの展開（団子レース vs バラけたレース）を補正

■ 前の馬との着差・後ろの馬との着差
  「2着で1着馬とは0.5秒差、3着馬とは0.1秒差」
  → 1着には離されたが3着以下は圧倒 → 2番手の能力は十分

■ 1着との着差の推移
  過去5走で1着との着差が [1.0, 0.8, 0.5, 0.3, 0.2] と縮小中
  → 能力が向上しているシグナル

■ 着差ゼロ（同着・写真判定レベル）の頻度
  接戦が多い = 能力が拮抗したレースに出ている
  → クラス適性の指標にもなる
```

---

## 5. アプローチC: 上がり3F（末脚評価）

### 概要

```
上がり3F = ゴールまでの最後の600mのタイム。
→ 「末脚の強さ」を直接測定できる唯一の指標。

なぜ重要か:
  - ペースに左右されにくい（前半のペースが遅くても、上がりが速ければ能力がある）
  - 脚質に依存しない（差し馬も先行馬も、上がり3Fの速さで能力を測れる）
  - 「負けたが上がり最速」= 展開が向かなかっただけで能力は高い
```

### 具体的な特徴量

```
■ 上がり3Fタイム（秒）
  → そのまま特徴量に。ただし馬場差の補正が必要。

■ 上がり3F順位
  レース内で何番目に速い上がりだったか。
  → タイムより馬場差の影響を受けにくい。★推奨。

■ 上がり最速フラグ
  そのレースで最速の上がりを使ったか。
  → 「上がり最速なのに負けた」= 展開不利の可能性。次走の巻き返し期待。

■ 上がり3Fタイムのトレンド
  過去5走の上がり3Fの推移。改善中か悪化中か。
  → コンディションの変化を検出。

■ 上がり3F順位 vs 着順のギャップ
  上がり3F順位が1位なのに着順が5着 → 展開不利で実力を出し切れなかった
  上がり3F順位が10位なのに着順が2着 → 展開利で拾った着順、実力以上の結果

  gap = 着順 - 上がり3F順位
  gap > 0: 上がりの割に着順が悪い = 展開不利
  gap < 0: 上がりの割に着順が良い = 展開利
  gap ≈ 0: 着順が実力通り

  ★ これは非常に有用な特徴量。
  「次走で巻き返す馬」を検出するシグナルになる。
```

---

## 6. アプローチD: 位置取り分析（レース内容評価）

### 概要

```
通過順位データ（1角, 2角, 3角, 4角の通過順位）から、
馬の「走りの質」を読み取る。

  例: 通過順位 [3, 3, 2, 1] → 好位から早めに先頭に立って押し切り
  例: 通過順位 [15, 15, 12, 3] → 後方から一気の追い込み
  例: 通過順位 [1, 1, 1, 8] → 先頭で逃げたが直線で失速
```

### 具体的な特徴量

```
■ 4角通過順位 - 着順
  「4角を何番手で通過して、最終的に何着になったか」の差。

  4角3番手 → 着順1着: +2（差を詰めた / 好位から抜け出し）
  4角3番手 → 着順5着: -2（失速した / 前が崩れなかった）
  4角15番手 → 着順3着: +12（★大まくり / 能力の高さを示唆）

  → 「終盤の加速力」の指標。

■ ポジション変動パターン
  1角→4角のポジション変化:
  - 前方維持: [2,2,2,2] → 安定した先行力
  - 徐々に上がる: [10,8,5,3] → 計画的なまくり
  - 急上昇: [15,15,15,3] → 直線のみの勝負（追込）
  - 下降: [1,1,2,5] → 失速（スタミナ切れ）

■ 脚質分類の精密化
  通過順位パターンから脚質を自動分類:
  - 逃げ: 1角1-2番手
  - 先行: 1角3-5番手
  - 差し: 1角6-10番手
  - 追込: 1角11番手以降

  → 固定的な脚質分類ではなく、レースごとの実際のポジションを使う。
  → 「普段は先行だが今回は出遅れて差しに回った」等の情報が取れる。

■ 位置取りのコスト
  「内を回ったか外を回ったか」はデータから直接取れない。
  しかし間接的に推定:
  - 逃げ馬が内枠 → スムーズに先頭（コスト低）
  - 先行馬が大外枠 → 先行するために外を回る（コスト高）
  → 枠順 × 通過順位の組合せで「位置取りのコスト」を間接推定
```

---

## 7. アプローチE: レーティングシステム（総合評価値）

### Elo/Glickoレーティング（チェスの仕組みを競馬に応用）

```
原理:
  各馬に「レーティング」を持たせ、レース結果で更新する。
  強い相手に勝てばレーティングが大きく上がり、
  弱い相手に負ければ大きく下がる。

チェスのEloシステムを競馬に適用:
  - 初期レーティング: 全馬 1500
  - レース後: 各馬のレーティングを着順に応じて更新
  - 「期待着順」との差でレーティング変動量を決定

  更新式（簡略版）:
    new_rating = old_rating + K × (actual_score - expected_score)

    actual_score: 実際の相対成績（1着=1.0, 最下位=0.0, 線形補間）
    expected_score: レーティングから算出した期待成績
    K: 更新の速さ（新馬は大きく、古馬は小さく）

利点:
  - 「相手の強さ」を自動的に考慮する
  - G1で10着 vs 未勝利で1着 の比較が自然にできる
  - レースを重ねるほど精度が上がる

欠点:
  - 初期値の設定が難しい（新馬はデータなし）
  - 着順だけでレーティングを更新すると、着差の情報が失われる
  - 距離・馬場・コースの適性は反映されない

改良案:
  - 着順ではなくタイム差でスコア化
  - 距離・馬場別にレーティングを持つ（芝1600mのレーティング、ダート1800mのレーティング等）
  - Glicko-2（不確実性も管理するEloの改良版）を使う
```

### TrueSkill的アプローチ

```
原理:
  各馬の能力を「平均μ」と「不確実性σ」の両方で管理。
  レースを重ねるとσが小さくなる（能力の推定が確定していく）。

利点:
  - 出走回数が少ない馬の「不確実性」を明示的に管理
  - 「この馬は強いかもしれないし弱いかもしれない」を数値化
  → horse_performance_distribution.md の「着順分散」と接続

特徴量として:
  - rating_mu: 能力の推定値
  - rating_sigma: 能力の不確実性（高い=よくわからない）
  - rating_mu × rating_sigma: 「強いかもしれないが不確実」= 一発型の指標
```

---

## 8. アプローチF: 着順の文脈補正

### 「G1の10着」と「未勝利の1着」を比べる

```
原理: 着順にレースのレベルを掛けて補正する。

方法1: クラスレベルによる補正
  補正着順 = 着順 - クラス補正値

  クラス補正値の例:
    G1:     -5（G1の5着は未勝利の1着相当）
    G2:     -4
    G3:     -3
    OP/L:   -2
    3勝:    -1
    2勝:    0（基準）
    1勝:    +1
    未勝利: +2
    新馬:   +3

  例: G1の8着 → 補正着順 = 8 - 5 = 3 → 「2勝クラスの3着」相当
      新馬の1着 → 補正着順 = 1 + 3 = 4 → 「2勝クラスの4着」相当

  → 異なるクラスの着順を「同じ物差し」で比較できる。

方法2: レース出走馬のレーティング平均で補正
  レースレベル = 出走馬のレーティング平均
  補正値 = (レースレベル - 全レース平均レベル) / 定数
  補正着順 = 着順 - 補正値

  → クラスよりも精密。同じG3でもメンバーの質が違う。

方法3: 勝ち馬の次走成績で事後的にレースレベルを評価
  「このレースの勝ち馬が次走G1で3着」→ レースレベルが高かった
  → 事後的な情報なので予測には使えないが、学習データの質向上に有用。
```

---

## 9. アプローチG: 「負けの質」分析

### 負けた理由を分解する

```
同じ「5着」でも、次走の期待度が全く違う:

■ 「実力負け」の5着:
  スムーズに走れたが力が足りなかった
  → 次走の好走確率: 低い
  特徴: 上がり3F順位もそれなり、位置取りもスムーズ

■ 「展開負け」の5着:
  ペースが合わなかった（スロー過ぎて差し届かず等）
  → 次走の好走確率: 展開次第で高い
  特徴: 上がり3Fは速い、4角→着順の差が大きい

■ 「不利負け」の5着:
  出遅れ、挟まれ、進路がなかった等
  → 次走の好走確率: 高い ★巻き返し候補
  特徴: 出遅れフラグ、通過順位の急落、不自然な位置取り

■ 「距離負け」の5着:
  距離が合わなかった
  → 次走で距離変更すれば好走可能
  特徴: 特定の距離帯で成績が極端に違う

■ 「馬場負け」の5着:
  重馬場が合わなかった等
  → 次走で良馬場なら好走可能
  特徴: 良馬場成績と道悪成績の乖離

特徴量化:
  → 直接的に「負けの理由」を分類するのは難しい
  → しかし以下の組合せで間接的に捉えられる:
    - 上がり3F順位 vs 着順のギャップ（展開負けの検出）
    - 出遅れフラグ（不利負けの一部）
    - 前走距離と今回距離の差（距離変更の影響）
    - 前走馬場と今回馬場の変化（馬場変更の影響）
```

### 「巻き返し候補」の検出

```
「次走で巻き返す馬」を検出するシグナル:

シグナル1: 上がり最速 + 着順5着以下
  → 末脚は使えたが届かなかった。展開が向けば勝てる。

シグナル2: 前走出遅れ + 今回好枠
  → 前走の敗因（出遅れ）が解消される可能性。

シグナル3: 前走重馬場凡走 + 今回良馬場予想
  → 馬場が合わなかっただけ。

シグナル4: 前走昇級初戦凡走 + 今回同クラス2戦目
  → クラスに慣れてくる。「叩き2戦目」的な効果。

シグナル5: 前走1着との着差小（0.2秒以内）
  → 能力的には勝ちレベル。次走で逆転の可能性。

これらは特徴量として明示的に作成し、LightGBMに入力する。
→ 「着順は悪いが次走で走る馬」をモデルが学習する。
```

---

## 10. アプローチH: 物理モデル系（上級）

### スタミナ・瞬発力の分離推定

```
原理: タイムを「スタミナ消費」と「瞬発力発揮」に分解する。

  走破タイム = 前半タイム + 上がりタイム

  前半タイム: ペースへの追随能力（スタミナ依存）
  上がりタイム: ラストスパートの質（瞬発力依存）

  同じ走破タイムでも:
    前半60秒 + 上がり35秒 = 95秒（先行して持続する力）
    前半63秒 + 上がり32秒 = 95秒（溜めて末脚を爆発させる力）
  → 同じ能力ではない。適性が違う。

特徴量化:
  - 前半3Fタイム（ペース追随能力）
  - 上がり3Fタイム（瞬発力）
  - 前半と上がりの比率（どちらの能力に依存しているか）
  - 中間ラップ（持続力の指標）
```

### エネルギー分配モデル（理論的）

```
概念的なモデル:
  各馬は「総エネルギーE」を持っている。
  レース中にエネルギーを消費する:
    - ペースが速いほど消費が大きい
    - 外を回ると消費が大きい
    - スパートで大量に消費

  最終的な着順 = 残りエネルギーの順

  → このモデルを直接推定するのは困難だが、
    「前半ペース × 距離 × 位置取り」から消耗度を間接推定し、
    上がりタイムとの関係で「潜在能力」を逆算できる可能性がある。

  → race_scenario_simulation.md のレベル3（モンテカルロ）と統合される概念。
  → 現時点では理論的な枠組みとしてのみ位置づけ。
```

---

## 11. 実装の優先順位

### 特徴量化のコスト vs リターン

```
■ すぐに実装可能（JRA-VANデータから直接計算）:
  ★★★ 上がり3F順位 vs 着順のギャップ → 巻き返し候補検出
  ★★★ 1着との着差（秒差） → 着順より情報量が多い
  ★★  4角通過順位 - 着順 → 終盤の加速力
  ★★  着順の文脈補正（クラスレベル） → 異なるレースの比較
  ★   上がり3Fタイムのトレンド → コンディション変化

■ 実装に工夫が必要:
  ★★  スピード指数（馬場差の推定が必要）
  ★★  Elo/Glickoレーティング（更新ロジックの設計）
  ★   脚質分類の自動化（通過順位からの分類ルール）

■ 将来の拡張:
  ★   TrueSkill的な不確実性管理
  ★   エネルギー分配モデル

推奨する実装順序:
  Phase 1: 着差 + 上がり3Fギャップ + 位置取り差分 → コスト低、効果大
  Phase 2: クラス補正 + スピード指数 → 中程度のコスト
  Phase 3: レーティング → やや複雑だが長期的に有用
```

---

## 12. 既存insightとの接続

```
■ horse_performance_distribution.md（着順分布の形状）:
  着順分布で「安定型/一発型」を分類した。
  本考察の評価基準を使えば、より精密な分類ができる:
  → 「上がり3Fギャップが大きい馬」= 展開に左右される = 一発型に近い
  → 「着差が常に小さい馬」= 安定して好走圏内 = 安定好走型

■ race_scenario_simulation.md（展開シミュレーション）:
  「展開負け」の検出は、展開シミュレーションの必要性を裏付ける。
  レベル0（Harville）では展開負けの馬を正しく評価できない。

■ combination_ticket_probability.md（組合せ馬券）:
  着順以外の評価で能力を正確に測れれば、
  1着確率の精度が上がり、Harville変換の精度も上がる。

■ rotation_interval_analysis.md（ローテーション）:
  「前走の内容」× ローテーション = 臨戦過程の評価。
  前走が「不利負け」の中2週は、巻き返し期待が高い。
  前走が「実力負け」の中2週は、好転の根拠が薄い。
```

---

## まとめ: 「着順は結果、能力は過程」

```
着順 = 「そのレースで何番目にゴールしたか」
能力 = 「条件が揃った時にどれくらい走れるか」

この2つは同じではない。AIが予測すべきは「次のレースでの着順」だが、
その予測精度を上げるためには、過去の「着順」だけでなく
「着順の裏にある能力」を特徴量化する必要がある。

最も実用的な3つの特徴量:
  1. 上がり3F順位 vs 着順のギャップ
     → 「着順以上の能力を持っている馬」を検出
  2. 1着との着差（秒差）
     → 着順という離散値より、連続値の方が情報量が多い
  3. 4角通過順位 - 着順
     → 終盤の脚力を直接測定

この3つだけでも、着順のみのモデルに対して有意な改善が見込める。
```

---

## アクションアイテム

- [ ] 上がり3F順位 vs 着順ギャップ特徴量の実装
- [ ] 着差（秒差）の特徴量化と前走着差のトレンド分析
- [ ] クラス補正着順の設計（クラスレベルの数値化）
- [ ] スピード指数の設計（馬場差推定方法の調査）
- [ ] Elo/Glickoレーティングのプロトタイプ実装
- [ ] 「巻き返し候補」シグナルの過去データでの検証
- [ ] features.mdに評価基準系の特徴量を追加

## 関連ドキュメント

| 関連insight | 接続点 |
|---|---|
| [馬の着順分布の形状](horse_performance_distribution.md) | 安定型/一発型の分類基準としての評価指標 |
| [展開シミュレーション](race_scenario_simulation.md) | 展開負けの検出、位置取り分析 |
| [ローテーション分析](rotation_interval_analysis.md) | 前走の「内容」× 間隔 = 臨戦過程 |
| [組合せ馬券の確率計算](combination_ticket_probability.md) | 1着確率の精度向上 → 組合せ確率の精度向上 |
| [Harville IIA批判](harville_iia_critique.md) | Thurstone σの推定に着差・上がりデータが使える |

## タグ

`#特徴量` `#モデル` `#ペース` `#コース`
