# 仮説検証計画マスター

001-012の考察ドキュメントおよび既存insightsから抽出した全アクションアイテム・検証仮説を統合し、実行可能性と優先度で整理する。

> 目的: 「何を検証すべきか」を一覧化し、開発のロードマップと接続する

---

## 1. 検証仮説一覧（優先度順）

### Tier 1: 基盤検証（モデル構築前に確認すべき）

| ID | 仮説 | 検証方法 | データ要件 | 出典 |
|---|---|---|---|---|
| H-01 | EV > 1.0の馬券を全購入すれば長期プラスになる | 過去5年分の全レース×全馬券種でEV計算→シミュレーション | 全レース結果+確定オッズ | 002, 006 |
| H-02 | キャリブレーションが正確なら回収率100%超が可能 | モデル予測確率の較正精度と回収率の相関を検証 | バックテスト結果 | 003 |
| H-03 | 人気別回収率にFavorite-Longshot Biasが存在する | 人気別の単勝/複勝/ワイド回収率を過去データで計算 | 全レース結果+オッズ | 003, market |
| H-04 | 追い下げ方式は固定額方式より破産確率が低い | モンテカルロシミュレーション（追い下げ vs 固定額） | 的中率・回収率の分布推定 | 006, 008, 009 |
| H-05 | フラクショナルケリー（25%）が最適なsafety_factor | safety_factor=0.1〜1.0でシミュレーション、破産確率×期待利益のトレードオフ | モンテカルロ | 008, 009 |

### Tier 2: 市場構造の検証（AIの利益源泉の確認）

| ID | 仮説 | 検証方法 | データ要件 | 出典 |
|---|---|---|---|---|
| H-06 | 三連単の本命決着組合せはEVが高い | 1-3番人気の三連単オッズ×的中確率を過去データで計算 | 三連単オッズ+結果 | market |
| H-07 | 着順入れ替え（A→B→C vs A→C→B）でEVが変わる | 同一メンバーの着順入替オッズ比 vs 確率比を比較 | 三連単全組合せオッズ | market |
| H-08 | 多頭数レースほど三連単のEVが高い | 出走頭数別に三連単のEV分布を計算 | 頭数別三連単データ | market |
| H-09 | 馬主クラブ馬のオッズは過剰に低い | 馬主クラブ馬 vs 非クラブ馬の人気別回収率を比較 | 馬主情報+回収率 | 001 |
| H-10 | 無観客開催ではオッズ構造が変化する | コロナ期間の無観客開催 vs 通常開催のオッズ分布を比較 | 開催情報+オッズ | 012 |
| H-11 | スマートマネー効果（最終→確定オッズの非ランダム変動）が存在する | 最終オッズと確定オッズの差分が的中馬券で有意に大きいか検定 | オッズ時系列 | 007 |

### Tier 3: モデル設計の検証（特徴量・ターゲット選択）

| ID | 仮説 | 検証方法 | データ要件 | 出典 |
|---|---|---|---|---|
| H-12 | 確率推定（predict_proba）はランキング学習より馬券収益に適する | 同一特徴量で確率推定 vs ランキング学習のEVベース回収率を比較 | バックテスト | 003, 004 |
| H-13 | LightGBMはRandomForestより馬券収益で優位 | 同一特徴量でアルゴリズム比較（EVベース） | バックテスト | 004 |
| H-14 | 少数条件分けは平均回帰する（例: 特定種牡馬×距離×コース） | 前半データで好成績の条件を抽出→後半データでの成績を検証 | 時系列分割データ | 005 |
| H-15 | 試行間の独立性は概ね成立する | ラン検定、自己相関分析、条件付き的中率の比較 | 購入結果時系列 | 009 |
| H-16 | 外国人騎手の騎乗はAI予測の不確実性を増大させる | 外国人騎手レースの予測較正精度 vs 日本人騎手レースの較正精度 | 騎手情報+予測結果 | 007 |

### Tier 4: 運用・ポートフォリオの検証

| ID | 仮説 | 検証方法 | データ要件 | 出典 |
|---|---|---|---|---|
| H-17 | ワイド+枠連のポートフォリオはワイド単独より安定性が高い | 馬券種間の相関行列を計算し、ポートフォリオ効果を検証 | 馬券種別的中データ | 008 |
| H-18 | EV閾値1.01は1.20より長期利益が大きい | 閾値別のバックテスト（利益=購入額×(回収率-1)で評価） | 全馬券種EV計算結果 | 006, 009 |
| H-19 | 馬券種の事後選択は成績を改善しない | ランダムに馬券種を除外した場合の回収率分布を検証 | 馬券種別収支データ | 012 |
| H-20 | 年間80%以上のレースで購入可能（雑所得要件） | EV > 1.0の馬券が存在するレースの割合を過去データで計算 | 全レースのEV計算結果 | 010 |

---

## 2. 検証の実行優先度マトリクス

### 優先度の決定基準

```
優先度 = 重要度 × 実行容易性

重要度:
  ★★★ = プロジェクトの成否を左右する
  ★★  = 精度向上・リスク低減に大きく寄与
  ★   = 有益だが必須ではない

実行容易性:
  易 = 公開データ + シンプルな計算で検証可能
  中 = 予測モデル構築後に検証可能
  難 = 大規模シミュレーション or 独自データが必要
```

### 実行順序の推奨

```
━━━ Phase 1: モデル構築前（データ分析のみ）━━━

1. H-03 (Favorite-Longshot Bias)      重要度★★★ 容易度:易
   → 公開データだけで即検証可能
   → AIの利益源泉の存在確認

2. H-09 (馬主クラブのオッズ歪み)      重要度★★  容易度:易
   → 馬主テーブル + 回収率計算

3. H-14 (少数条件の平均回帰)          重要度★★★ 容易度:易
   → 過学習の危険性を実データで確認

4. H-20 (年間80%購入可能性)           重要度★★★ 容易度:中
   → 税務要件の実現可能性を確認

━━━ Phase 2: ベースラインモデル構築後 ━━━

5. H-01 (EV全購入シミュレーション)    重要度★★★ 容易度:中
   → 基本戦略の有効性を検証

6. H-02 (キャリブレーション×回収率)    重要度★★★ 容易度:中
   → モデル評価指標の妥当性確認

7. H-12 (確率推定 vs ランキング)       重要度★★  容易度:中
   → ターゲット設計の方針決定

8. H-13 (LightGBM vs RandomForest)    重要度★   容易度:中
   → アルゴリズム選択（004で「何でもいい」が前提）

━━━ Phase 3: 運用準備段階 ━━━

9. H-04 (追い下げ vs 固定額)           重要度★★★ 容易度:中
   → バンクロール管理方式の決定

10. H-05 (最適safety_factor)           重要度★★★ 容易度:中
    → ケリー基準のパラメータ決定

11. H-18 (最適EV閾値)                 重要度★★  容易度:中
    → 購入戦略のパラメータ決定

12. H-15 (試行間の独立性)              重要度★★  容易度:難
    → 破産確率計算の前提確認

━━━ Phase 4: 精度向上・差別化 ━━━

13. H-06, H-07, H-08 (三連単市場)     重要度★★  容易度:難
    → 三連単の導入判断

14. H-11 (スマートマネー効果)          重要度★★  容易度:難
    → オッズ時系列データが必要

15. H-17 (馬券種ポートフォリオ)        重要度★★  容易度:中
    → ポートフォリオ最適化

16. H-10, H-16, H-19 (補助的検証)     重要度★   容易度:中〜難
    → モデル改善の材料
```

---

## 3. 各考察のアクションアイテム統合

### 001: ショート戦略

- [ ] 馬主クラブ馬の特定とフラグ化 → **H-09で検証**
- [ ] オッズ乖離度の計算ロジック実装

### 002: ブレークスルーの本質

- [ ] ケリー基準等の資金配分アルゴリズムを調査・実装 → **H-05で検証**
- [ ] 「全レース購入」戦略のシミュレーション → **H-01, H-20で検証**

### 003: 確率認知

- [ ] モデル評価指標をブライアスコア/対数損失ベースに設計 → **H-02で検証**
- [ ] 確率分布出力型のモデルアーキテクチャを検討 → **H-12で検証**
- [ ] 人気別回収率のバイアス分析 → **H-03で検証**

### 004: 逆算してゆく競馬AI

- [ ] target設計の方針決定: 着順予測 vs 確率推定 vs タイム予測 → **H-12で検証**
- [ ] 特徴量候補リスト（features.md）を充実させる → **継続タスク**
- [ ] 最小限のベースラインモデル構築 → **Phase 2の前提**

### 005: ランダムネスと平均回帰

- [ ] 少数条件分けの平均回帰を検証 → **H-14で検証**
- [ ] 過学習リスクの高い分析パターンのチェックリスト作成

### 006: ポルシェ1-5週目

- [ ] EV閾値パラメータの設計 → **H-18で検証**
- [ ] バンクロール管理ロジック（追い下げ方式）の実装設計 → **H-04で検証**
- [ ] 自動購入システムのリトライ・耐障害設計 → **Phase 3**

### 007: ポルシェ6-11週目

- [ ] スマートマネー効果の検証 → **H-11で検証**
- [ ] ワイドEV計算（全組合せ）の設計 → **Phase 4**

### 008: ポルシェ17-19週目

- [ ] 馬券種ポートフォリオの相関分析 → **H-17で検証**
- [ ] モンテカルロシミュレーションの構築 → **H-04, H-05**

### 009: ポルシェ20週目〜2019総まとめ

- [ ] 的中率/回収率の分離モニタリング設計 → **運用アーキテクチャに反映済**
- [ ] 試行間の独立性検定の実装 → **H-15で検証**
- [ ] チューニングパラメータの自動最適化 → **H-18で検証**

### 010: 馬券の税金

- [ ] 税務要件の自動チェック機能 → **H-20で検証**
- [ ] 購入証跡ログのスキーマ設計 → **運用アーキテクチャに反映済**

### 011: 松風アーキテクチャ

- [ ] Themis相当モジュールの設計書作成 → **運用アーキテクチャに反映済**
- [ ] バンクロール状態管理方式の選定 → **バンクロール管理に反映済**

### 012: 競争と参入障壁

- [ ] 馬券種の事後選択バイアス検証 → **H-19で検証**
- [ ] 三連単EV計算エンジンの設計 → **H-06, H-07, H-08で検証**

### market_structural_inefficiencies

- [ ] 三連単の着順条件付き確率モデルの設計 → **H-07で検証**
- [ ] フォーメーション vs 確率比例配分のシミュレーション → **Phase 4**

---

## 4. 検証結果の記録テンプレート

```markdown
# 仮説検証レポート: [仮説ID] [仮説名]

## 仮説
[仮説の内容]

## 検証方法
[使用したデータ、分析手法、期間]

## 結果
[検証結果の定量的サマリ]

## 結論
[仮説は支持されたか/棄却されたか/条件付きか]

## プロジェクトへの影響
[この結果を受けて何を変更/実装するか]

## 補足データ
[グラフ、表、統計値]

## 次のステップ
[追加検証や関連タスク]
```

---

## 5. 検証に必要なデータ基盤

### 最低限必要なデータ

| データ | 期間 | ソース | 現状 |
|---|---|---|---|
| 全レース結果（着順） | 過去5年+ | JRA-VAN SE | 取得可能 |
| 確定オッズ（単勝/複勝） | 過去5年+ | JRA-VAN HR | 取得可能 |
| ワイドオッズ | 過去3年+ | JRA-VAN HR | 取得可能 |
| 三連単オッズ | 過去3年+ | JRA-VAN HR | 取得可能 |
| 馬主情報 | 全期間 | JRA-VAN UM | 取得可能 |
| 騎手情報 | 全期間 | JRA-VAN KS | 取得可能 |
| 開催情報（有観客/無観客） | 2020-2022 | JRA公式 | 手動収集要 |
| オッズ時系列 | 直近1年+ | JRA-VAN HO | 取得可能 |

### Phase 1で即座に着手可能な検証

H-03, H-09, H-14は**レース結果 + オッズ + 馬主情報**だけで検証可能。モデル構築前の「データ探索」フェーズとして最適。

---

## アクションアイテム

- [ ] Phase 1の検証データセット構築（過去5年の全レース結果+オッズ）
- [ ] H-03の検証実行（Favorite-Longshot Bias）
- [ ] H-14の検証実行（少数条件の平均回帰）
- [ ] 検証結果の記録テンプレートをリポジトリに追加
- [ ] 検証スクリプトのディレクトリ構成を設計

---

## 6. 追加考察（横断的気づき）

### 6-1. 仮説間の依存関係グラフ

```
仮説を独立に検証すると見落とすが、実は仮説間に因果・前提関係がある。

依存関係:

  H-02 (キャリブレーション) ──前提──→ H-01 (EV全購入)
    │                                    │
    │  「確率が正確でないとEV計算が無意味」     │
    │                                    ↓
    └──────────────────────→ H-18 (最適EV閾値)
                                         │
                                         ↓
                              H-04, H-05 (バンクロール管理)

  H-03 (FLB) ──利益源泉確認──→ H-12 (確率推定 vs ランキング)
    │                              │
    │                              ↓
    │                      H-13 (LightGBM vs RF)
    │
    └──歪みが存在するなら──→ H-06-08 (三連単市場)

  H-14 (平均回帰) ──制約──→ 特徴量設計全般
    │
    └──「少数条件分けが無効なら、きめ細かい条件分岐は過学習」

  H-15 (独立性) ──前提──→ H-04, H-05 (ケリー基準の理論的妥当性)
    │
    └──「独立でないとケリー基準の前提が崩れる」

  H-20 (80%購入) ──制約──→ H-18 (EV閾値)
    │
    └──「EV閾値を上げると購入レース比率が下がり税務要件を満たせない」

重要な示唆:
  1. H-02（キャリブレーション）はほぼ全ての仮説の暗黙の前提
     → 最優先でベースラインの較正精度を確認すべき
  2. H-15（独立性）が棄却されると、バンクロール管理の理論が根本から変わる
     → Phase 3の前に必ず検証を終える
  3. H-20（税務要件）はH-18（EV閾値）と直接トレードオフ
     → 同時に検証して最適解を探る
```

### 6-2. 各仮説の定量的な成功基準

```
仮説を「検証した」と言えるために、事前に基準を決めておく。
（結果を見てから基準を決めると、確証バイアスに陥る）

H-01: EV全購入
  成功基準: 5年間の回収率が100%を超える
  棄却基準: 回収率が95%未満（控除率を超えられない）
  条件付き: 回収率95-100%（「確率推定の精度次第で逆転可能」）

H-02: キャリブレーション
  成功基準: 較正誤差（ECE）< 0.05 で回収率100%超
  棄却基準: ECE < 0.05 でも回収率100%未満
  評価指標: Expected Calibration Error (ECE)

H-03: Favorite-Longshot Bias
  成功基準: 1番人気の回収率 > 大穴の回収率（統計的有意）
  棄却基準: 人気間の回収率差が有意でない
  統計検定: χ²検定 or bootstrap confidence interval

H-04: 追い下げ vs 固定額
  成功基準: 追い下げの破産確率が固定額の1/2以下
  評価方法: 10,000回のモンテカルロ、破産確率 + 最終バンクロール中央値

H-05: 最適safety_factor
  成功基準: 期待利益/破産確率の比が最大となる値を特定
  出力: safety_factorごとの「効率フロンティア」

H-14: 平均回帰
  成功基準: 前半好成績条件の後半回収率が平均に回帰（差が±5%以内）
  棄却基準: 前半好成績が後半でも持続（条件分けに意味がある）
  ★棄却された場合: その条件は有効な特徴量候補として採用

H-18: EV閾値
  成功基準: 最適閾値が特定でき、閾値変更で利益が有意に変化
  出力: 閾値 vs 利益のグラフ + H-20との交差点

H-20: 年間80%購入
  成功基準: EV > 1.0の馬券が存在するレースが年間80%以上
  棄却基準: 50%未満（雑所得要件の実現が困難）
  条件付き: 50-80%（馬券種の追加で改善可能か検討）
```

### 6-3. 仮説が棄却された場合の代替戦略

```
仮説を検証する目的は「正しいことを確認する」だけでなく、
「間違っていた場合にどうするか」を事前に考えておくこと。

H-01が棄却（EV全購入で回収率100%未満）:
  → 原因分析: 控除率の壁 or 確率推定の不正確さ
  → 代替A: 高EVのみに絞る（H-18の閾値を上げる）
  → 代替B: 三連単等、控除率は高いが非効率性も大きい馬券種に移行
  → 代替C: オッズの時間変動を利用（スマートマネー、H-11）

H-03が棄却（FLBが存在しない or 逆方向）:
  → AIの利益源泉が「オッズの歪み」ではなく「純粋な予測精度」になる
  → 特徴量エンジニアリングがより重要になる
  → モデルの差別化（独自データ、独自特徴量）が競争優位の源泉

H-04が棄却（追い下げが固定額より不利）:
  → 理論上は起きにくいが、もし起きた場合:
    → 独立性の前提（H-15）が崩れている可能性
    → 連敗後の回収率が連勝後より高い（レジーム変化）
    → この場合、逆張り的な資金管理が有効

H-15が棄却（試行間が独立でない）:
  → ★プロジェクトへの影響が最大
  → ケリー基準の前提が崩れる → 修正ケリーが必要
  → 自己相関のパターンを分析し、マルコフ連鎖ベースのモデルに移行
  → バンクロール管理の再設計が必要

H-20が棄却（80%購入が困難）:
  → 税区分戦略の再検討
  → 代替A: 馬券種を増やして購入レース比率を上げる
  → 代替B: EV閾値を下げて多く購入（利益率と税率のトレードオフ）
  → 代替C: 税理士と相談し、別の要件充足方法を検討
```

### 6-4. サンプルサイズと統計的検出力

```
各仮説の検証に必要な最小サンプルサイズの見積もり。
サンプル不足で「差がない」と結論づける偽陰性を防ぐ。

基本前提:
  - 有意水準 α = 0.05
  - 検出力 1-β = 0.80
  - 効果量: 回収率で5%以上の差を検出したい

概算:

  H-03 (FLB):
    年間約3,500レース × 5年 = 17,500レース
    人気別に分割しても1,000+サンプル → 十分

  H-09 (馬主クラブ):
    クラブ馬の出走数: 年間約2,000頭 × 5年 = 10,000
    → 十分だが、クラブ別の分析には不足の可能性

  H-14 (平均回帰):
    「少数条件」の定義による
    条件ごとに最低50レースは必要 → 条件の粒度に注意
    ★過度に細かい条件分け自体が検証の趣旨に反する

  H-04, H-05 (モンテカルロ):
    シミュレーション回数: 最低10,000回
    各シミュレーション内の試行数: 年間購入数（約3,000点）× 5年
    → 計算コストは高いが、データ制約はない

  H-06-08 (三連単):
    三連単の的中確率が低い（1/4,896〜）ため、
    個別組合せの検証には膨大なサンプルが必要
    → レース単位の集計（EV > 1.0が存在するか）に簡略化すべき

  H-11 (スマートマネー):
    オッズ時系列データの取得期間に依存
    最低1年分（約3,500レース）は必要
    → 「直近1年」では季節性を検出できない。可能なら2年以上

注意点:
  - 競馬データは「大量だが非独立」（同日のレース間に馬場等の相関）
  - クラスター補正（レース単位、開催日単位）が必要な場合がある
  - 複数仮説の同時検定 → Bonferroni補正 or FDR制御を検討
```

### 6-5. 検証のタイムラインとデータ取得の現実的制約

```
理想的な検証順序と、データ取得の現実的制約を照合する。

現在利用可能なデータ（JRA-VAN経由）:
  ✅ レース結果（着順、タイム）: 即時取得可能
  ✅ 確定オッズ（全馬券種）: 即時取得可能
  ✅ 馬主情報: 即時取得可能
  ✅ 騎手情報: 即時取得可能
  ⚠️ オッズ時系列: 蓄積が必要（リアルタイム記録開始が必要）
  ❌ 無観客開催情報: 手動収集

タイムライン案:

  Month 1-2: Phase 1（データ分析のみ）
    Week 1-2: データセット構築（全レース結果+オッズ、5年分）
    Week 3-4: H-03実行（FLB）→ 結果次第で方針に影響
    Week 5-6: H-14実行（平均回帰）→ 特徴量設計の方針決定
    Week 7-8: H-09実行（馬主クラブ）、H-20の初期推定

  Month 3-4: Phase 2（ベースラインモデル）
    モデル構築と並行して:
    H-01, H-02の検証準備
    H-12, H-13の比較実験

  Month 5-6: Phase 3（運用準備）
    H-04, H-05のモンテカルロ構築
    H-18の閾値最適化
    H-15の独立性検定

  Month 7+: Phase 4（差別化）
    H-06-08（三連単、データが揃えば）
    H-11（オッズ時系列が蓄積されたら）
    H-17（ポートフォリオ最適化）

ボトルネック:
  1. オッズ時系列の蓄積にはリアルタイム収集の仕組みが必要
     → H-11の検証は蓄積を待つ間にインフラを構築
  2. 三連単の全組合せオッズは容量が大きい
     → 格納・集計の仕組みを先に設計
  3. モンテカルロシミュレーションは計算コスト大
     → 小規模テスト → パラメータ探索範囲を絞る → 大規模実行
```

### 6-6. 「検証しすぎ」のリスク

```
仮説検証は重要だが、検証に時間をかけすぎるリスクもある。

過剰検証のサイン:
  - Phase 1の検証に3ヶ月以上かかっている
  - 検証結果が明確なのに追加検証を続ける
  - 完璧な検証を目指して実装が進まない
  - 仮説の数が増え続け、20→30→40と膨らむ

松風の教訓（011）:
  「バグで200万失っても、改善による利益がそれを上回るなら改善速度を優先」
  → 検証も同じ。完璧な検証より「80%の確信で実装開始」が正解

実用的な判断基準:
  1. Tier 1の仮説が概ね支持されたら → Phase 2に進む（細部は後で）
  2. 仮説が「条件付き」で中途半端な結果なら → 実装して実運用データで検証
  3. 明確に棄却された仮説は → 代替戦略に切り替えて実装

「検証→実装→実運用データで再検証」のサイクルを回すことが重要。
バックテストだけで全てを決めようとしない。
```

---

## タグ

`#モデル` `#馬券戦略` `#オッズ` `#確率論` `#特徴量` `#過学習` `#バンクロール` `#三連単`
