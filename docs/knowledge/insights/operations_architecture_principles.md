# 運用アーキテクチャ設計指針

松風ブログ001-012から抽出した、競馬AIシステムの運用設計・アーキテクチャに関する知見を横断整理する。

> 起点: 「予測精度100%でも購入できなければ利益はゼロ」「運用ミスが最大のリスク」

---

## 1. 松風8モジュール構成から学ぶ分離原則

### 判明しているモジュール

| モジュール名 | 由来 | 役割 | 出典 |
|---|---|---|---|
| **Zeus** | ギリシャ神話の主神 | データベースの保守管理 | 011 |
| **Poseidon** | 馬を創った神 | モデリング（モデル構築） | 011 |
| **Themis** | 法と掟の女神 | 購入決定（買い目×金額） | 011 |
| （不明×5） | - | データ収集、整形、予測、執行、スケジューリング等 | 011 |

### 推定される全体構成

```
L1: データ収集・整形（Zeus連携）
  → JRA-VAN、スクレイピング、独自データ
  → データバリデーション、欠損値処理

L2: モデリング（Poseidon）
  → 特徴量エンジニアリング
  → モデル訓練・更新
  → バックテスト

L3: 予測（推論エンジン）
  → リアルタイム推論
  → 確率分布の出力
  → キャリブレーション適用

L4: 購入決定（Themis）★最重要
  → 確率 × オッズ × バンクロール → 買い目・金額
  → 馬名も騎手名も知らない「目隠し」設計

L5: 購入実行
  → PAT/即PAT経由の自動購入
  → リトライ・耐障害設計
  → 複数口座管理（三連単の点数上限対策）

L6: 記録・監視
  → 購入証跡のタイムスタンプ付き保存（税務要件）
  → 的中率/回収率の分離監視
  → アラート・異常検知

L7: スケジューリング
  → レース時刻に合わせた実行管理
  → 前処理→予測→購入の直列制御

L8: レポーティング
  → 日次/週次/月次の収支レポート
  → パフォーマンス分析
  → ドローダウン監視
```

### 核心: Themisの「目隠し」原則 ★★★

> Themisが知るのは、確率とオッズ、そして松風の預金残高のみ（011）

```python
# Themisの疑似コード
def themis_decide(predictions, odds, bankroll, config):
    """
    入力:
      predictions: Dict[馬券ID, 確率]
      odds: Dict[馬券ID, オッズ]
      bankroll: float（現在のバンクロール残高）
      config: ThemisConfig（EV閾値、安全係数等）
    出力:
      List[Tuple[馬券ID, 購入金額]]
    """
    bets = []
    for ticket_id in predictions:
        ev = predictions[ticket_id] * odds[ticket_id]
        if ev > config.ev_threshold:
            kelly_fraction = kelly(predictions[ticket_id], odds[ticket_id])
            bet_amount = bankroll * kelly_fraction * config.safety_factor
            bets.append((ticket_id, bet_amount))
    return bets
```

**設計上の利点**:

| 利点 | 説明 |
|---|---|
| 認知バイアス排除 | 「有名馬だから多めに」を構造的に防止 |
| テスタビリティ | 入力3つだけなので単体テストが容易 |
| モデル非依存 | Poseidonを入れ替えてもThemisは不変 |
| 汎用性 | 競馬以外（他のギャンブル、投資）にも適用可能 |
| 税務対応 | 「計算式に基づく購入パターン」の要件を自然に満たす |

---

## 2. 運用ミスの教訓集（006-012）

### 実際に発生した運用ミスと損失

| ミス | 推定損失 | 出典 | カテゴリ |
|---|---|---|---|
| 自動購入の障害（通信エラー等） | 数十万〜数百万 | 006 | 実行系 |
| 入金忘れ | 100万超（累計） | 009 | 人的ミス |
| チューニングの攻めすぎ | 4.8億（機会損失） | 007, 009 | パラメータ |
| オブジェクトコピーバグ（追い下げ不全） | 200万 | 011 | 実装バグ |
| 年始アップデートのバグ | 200万 | 011 | リリース |
| PAT購入点数上限への未対応 | 不明 | 012 | 設計漏れ |

### 教訓の分類と対策

#### A. 実行系リスク（自動購入の信頼性）

```
問題: 購入APIの障害で馬券が買えない
影響: 予測精度100%でも利益ゼロ

対策:
  1. リトライ処理（指数バックオフ）
  2. 複数口座のフェイルオーバー
  3. 購入結果の即座確認（購入→照会の自動化）
  4. 障害時のアラート通知
  5. 手動介入のためのダッシュボード
```

#### B. 状態管理リスク（バンクロール同期）

```
問題: マルチプロセスでバンクロールが不整合（011のコピーバグ）
影響: 追い下げが機能しない → 破産リスク増大

対策:
  NG: オブジェクトコピーを渡す
  OK案1: DB経由（Zeus）でバンクロールを管理
  OK案2: multiprocessing.Manager で共有オブジェクト
  OK案3: Redis等の外部KVS
  OK案4: ファイルロック + SQLite

  必須テスト:
  - レース間でのバンクロール更新の一貫性
  - 追い下げロジックの正常動作
  - プロセス間での状態同期
```

#### C. パラメータリスク（チューニング）

```
問題: EV閾値を攻めすぎて大ドローダウン
影響: 160万→5.5万（-97%）、機会損失4.8億

対策:
  1. 保守的パラメータをデフォルトに
  2. パラメータ変更は必ずバックテスト済みで
  3. 段階的な変更（一度に大きく変えない）
  4. ドローダウン閾値でのパラメータ自動巻き戻し
  5. モンテカルロシミュレーションによる事前検証
```

#### D. リリースリスク（デプロイ）

```
問題: 年始アップデートでバグ混入（011）
影響: 200万の損失

対策:
  1. ステージング環境でのテスト必須
  2. レース開催日の直前デプロイを禁止
  3. ロールバック手順の事前準備
  4. カナリアリリース（一部レースで検証）
  5. デプロイ後の監視強化（最初の数レース）
```

---

## 3. KeibaCICDへのアーキテクチャ適用

### 我々のシステムへのマッピング

| 松風モジュール | KeibaCICDの対応 | 現状 |
|---|---|---|
| Zeus（DB管理） | JRA-VAN統合ライブラリ + keibabook | 実装済み |
| Poseidon（モデリング） | KeibaCICD.AI / ML予想層 | 設計中 |
| Themis（購入決定） | **未実装** ← 最優先 | 設計待ち |
| データ収集 | keibabook + JraVanSync | 実装済み |
| 予測推論 | KeibaCICD.AI | 設計中 |
| 購入実行 | **未実装** | Phase 3 |
| 監視・記録 | WebViewer（部分的） | 拡張予定 |
| スケジューリング | PowerShellスクリプト | 基本版あり |

### 優先実装の提案

```
Phase 1: Themis相当モジュール（購入決定エンジン）
  → 確率 × オッズ → EV計算 → ケリー基準 → 購入金額
  → バンクロール管理ロジック（追い下げ）
  → バックテストフレームワーク

Phase 2: 監視・アラート基盤
  → 的中率/回収率の分離監視
  → ドローダウンアラート
  → 購入証跡の自動記録

Phase 3: 自動購入・実行基盤
  → PAT連携（手動→半自動→全自動）
  → リトライ・フェイルオーバー
  → 運用ダッシュボード
```

---

## 4. 開発速度 vs 安定性のトレードオフ

> 松風はいつまで経っても動作が安定せず。でもそれは積極的な開発と改善の賜物（011）

### Matsukaze氏の判断基準

- バグで200万失っても、改善による利益がそれを上回るなら改善速度を優先
- ただし**バンクロール管理のバグだけは致命的**（追い下げ不全 = 破産リスク）
- つまり「壊してもいい領域」と「絶対に壊してはいけない領域」を区別

### 我々のプロジェクトへの適用

```
壊してもいい（速度優先）:
  - データ収集の取得範囲
  - UIの表示・レイアウト
  - レポートのフォーマット
  - 新しい特徴量の実験

絶対に壊してはいけない（安定性優先）:
  - バンクロール計算・管理
  - 購入金額の算出ロジック
  - 購入実行の信頼性
  - 購入証跡のログ
  - 税務要件を満たすデータ保全
```

---

## 5. 検証すべき設計仮説

### 仮説A: Themisの分離は小規模でも有効か
```
検証: シンプルなEV計算モジュールを独立実装し、
      モデル入れ替え時の影響を確認
予想: 小規模でも分離の恩恵（テスト容易性、バグ局所化）は大きい
```

### 仮説B: 追い下げはケリー基準の何倍が最適か
```
検証: safety_factor = 0.1〜1.0でモンテカルロシミュレーション
      破産確率 × 最終バンクロール期待値のトレードオフを可視化
予想: 0.25〜0.5（フルケリーの1/4〜1/2）が現実的な最適解
```

### 仮説C: マルチプロセスは必要か
```
検証: レース間の処理時間を計測し、直列処理で間に合うか確認
予想: 初期段階では直列で十分。スケール時に並列化を検討
```

---

## アクションアイテム

- [ ] Themis相当モジュールの設計書作成（入出力仕様、EV計算ロジック、ケリー基準実装）
- [ ] バンクロール管理の状態管理方式の選定（DB vs ファイル vs KVS）
- [ ] 購入証跡ログのスキーマ設計（税務要件を満たす形式）
- [ ] 的中率/回収率分離モニタリングの設計
- [ ] ドローダウンアラートの閾値設計（-20%警告、-30%停止勧告）
- [ ] バックテストフレームワークの基本設計
- [ ] リリースプロセスの策定（テスト→ステージング→本番のフロー）

---

## 6. 追加考察（横断的気づき）

### 6-1. 「データの鮮度」とパイプラインの時間制約

```
レースの時間制約:
  出馬表確定: レース前日夕方
  最終オッズ: 発走約1分前
  確定オッズ: 発走直後
  結果確定: 発走後数分〜写真判定時は数十分

パイプラインの実行タイミング:
  前日夜: 出馬表取得 → 特徴量計算 → モデル推論 → 暫定EV計算
  当日朝: オッズ更新 → EV再計算 → 購入金額の決定
  発走前: 最終オッズ取得 → 最終EV確認 → 購入実行
  発走後: 結果取得 → バンクロール更新

問題: 各ステップに「間に合わない」リスクがある
  → 011のバグ（写真判定で結果取得が遅延→次レースの予測が間に合わない）

設計指針:
  1. 予測と結果取得を別プロセスに分離（011の学び）
  2. 各ステップにタイムアウトとフォールバックを設ける
  3. 「最終オッズに間に合わなかったら前回オッズで計算」等の縮退運転
  4. レース間隔（通常30分）の中で全処理が完了する設計
```

### 6-2. 「壊してはいけないコア」のテスト戦略

```
松風の教訓: バンクロール管理バグ = 致命的、それ以外 = 許容

テストの優先度:
  ★★★ 絶対にテストすべき（壊すと破産）:
    - バンクロール計算の正確性
    - 追い下げの正常動作（負けたら金額が減ること）
    - EV計算の正確性（確率×オッズ）
    - 購入金額の上限制限（バンクの一定%を超えない）
    - ログの完全性（1件も漏れない）

  ★★ テストすべき（壊すと損失だが致命的でない）:
    - オッズ取得の正常性
    - 予測の実行完了
    - 購入実行の成功/失敗判定

  ★ あれば良い（壊しても影響小）:
    - レポートの表示
    - 通知の送信
    - UIの見た目

具体的テスト:
  1. 「10連敗シナリオテスト」
     → 10回連続で外れた場合、バンクロールと購入額が正しく追い下がるか
  2. 「バンクロール0円テスト」
     → 極端な損失でも0円以下にならないか、購入停止するか
  3. 「同時実行テスト」
     → 2つのレースが同時に結果確定した場合、バンクロール更新が正しいか
```

### 6-3. 将来のスケーリングを見据えた設計メモ

```
松風のスケーリング経緯:
  2019: 年間1.24億 → 1プロセスで十分
  2020: 年間25億 → PAT口座3つ、購入点数上限問題

我々の当面の規模では不要だが、設計時に考慮しておくべきこと:
  1. PAT購入点数の上限（現在9,000点/口座/日）
  2. 購入金額の上限（レースごとの購入上限）
  3. 複数口座管理のインターフェース
  4. 馬券種追加（三連単等）時のThemisの拡張性

設計指針: 「今は不要だが、Themisのインターフェースだけは拡張可能にしておく」
  → 馬券種を追加しても、Themisの入出力の型（確率、オッズ、残高→買い目リスト）は変わらない
```

## タグ

`#運用` `#モデル` `#馬券戦略` `#バンクロール` `#チューニング`
