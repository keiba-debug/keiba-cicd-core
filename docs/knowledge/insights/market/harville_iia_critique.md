# Harvilleの「スライド仮定」への批判: 2着確率は再計算すべきか

Harville公式は「1着馬を除外して残りの馬の確率比をそのまま使う」。しかし現実には「誰が1着になったか」によって、残りの馬の相対的な強さが変わる。この「スライドではなく再計算すべき」という主張の数理的根拠と実用的な影響を考察する。

> 起点: 「Harvilleでは2着確率は1着馬がいなくなったと考えて1着確率をそのまま使って残りの馬をスライドするのではなく、全体の中で計算しなおすべきという主張について考察したい」

---

## 1. Harvilleが「何をしているか」を正確に理解する

### Harvilleのスライド構造

```
18頭のレース。各馬の1着確率:
  A: 30%  B: 20%  C: 15%  D: 10%  E: 8%  ...（合計100%）

「Aが1着になった後の2着争い」をHarvilleはこう計算する:

  Step 1: Aを「消す」
  Step 2: 残りの確率を再正規化（合計を100%に戻す）
    B: 20% / 70% = 28.6%
    C: 15% / 70% = 21.4%
    D: 10% / 70% = 14.3%
    E: 8%  / 70% = 11.4%
    ...

  Step 3: この再正規化した値を「2着確率」として使う

核心: 残りの馬の「確率の比」は変わらない。
  B:C = 20:15 = 4:3（1着確率の比）
  再正規化後も B:C = 28.6:21.4 = 4:3（同じ比）

→ Harvilleは「相対的な強さの序列は、誰が勝っても変わらない」と仮定している。
```

### これを「IIA仮定」と呼ぶ

```
IIA = Independence of Irrelevant Alternatives
    = 無関係な選択肢からの独立性

意味: 「BとCのどちらが強いか」は、Aが存在するかどうかに依存しない。

日常例:
  レストランで「魚と肉、どちらにしますか？」→ 「魚」と答えた人に
  「パスタも追加しました」と言ったら → 「じゃあ肉で」と変えるのはIIA違反。

  IIAが成り立つなら: 選択肢が増えても減っても、BとCの優劣は変わらない。

競馬での意味:
  「BとCのどちらが2着になるか」は、1着がAでもDでも同じ。
  → 直感的に「おかしい」と感じるのが、この考察の出発点。
```

---

## 2. なぜ「スライド」ではダメなのか: 3つの根拠

### 根拠1: 1着馬の正体が「レース条件」を教える

```
■ Aが逃げ馬で、Aが1着になった場合:
  「ペースが緩かった」ことを示唆する。
  → 他の逃げ・先行馬も好走しやすい
  → 差し・追込馬は届いていない可能性が高い

  つまり:
    P(先行馬Bが2着 | 逃げ馬Aが1着) > Harvilleの予測
    P(追込馬Cが2着 | 逃げ馬Aが1着) < Harvilleの予測

■ Cが追込馬で、Cが1着になった場合:
  「ハイペースで前が崩れた」ことを示唆する。
  → 他の差し・追込馬も好走しやすい
  → 逃げ・先行馬は失速している可能性が高い

  つまり:
    P(差し馬Dが2着 | 追込馬Cが1着) > Harvilleの予測
    P(逃げ馬Aが2着 | 追込馬Cが1着) < Harvilleの予測

Harvilleは「誰が勝ったか」からレース展開の情報を読み取らない。
勝った馬を消して確率をスライドするだけ。
これが構造的な欠陥。
```

### 根拠2: パフォーマンスの「分布の形」が馬ごとに違う（着順分布の形状との接続）

```
horse_performance_distribution.md で定義した3タイプ:

■ タイプB（安定好走型）: 1着確率15%, 着順分散が小さい
  → 勝たなくても2-3着に「残る」確率が高い
  → 1着確率15%から予想される以上に2着に来る

■ タイプC（一発型）: 1着確率15%, 着順分散が大きい
  → 勝つ時は勝つが、勝てない時は大敗
  → 1着確率15%から予想される以上に2着には来にくい

Harvilleの計算:
  P(B 2着 | A 1着) = 0.15 / (1-P(A))
  P(C 2着 | A 1着) = 0.15 / (1-P(A))
  → 同じ値！タイプBとCの区別がない。

正しくは:
  P(B 2着 | A 1着) >> 0.15 / (1-P(A))  （安定して好走するので2着に残る）
  P(C 2着 | A 1着) << 0.15 / (1-P(A))  （勝てなければ大敗してるので2着にいない）

これは「再計算すべき」の最も直感的な根拠。
1着確率をスライドしても、2着に来る確率にはならない。
```

### 根拠3: 赤バス・青バスの問題（IIA違反の古典的例）

```
離散選択理論の有名なパラドックス:

  通勤手段: 車(50%) vs バス(50%)
  バスを「赤バス」と「青バス」に分けると:

  IIAが成り立つなら:
    車(33%) vs 赤バス(33%) vs 青バス(33%)
    → 車のシェアが50%→33%に下がる。明らかにおかしい。

  正しくは:
    車(50%) vs 赤バス(25%) vs 青バス(25%)
    → 赤と青はバスという同じカテゴリなので、バス全体で50%を分け合う。

競馬への類推:
  逃げ馬A(20%) vs 差し馬B(20%) vs 差し馬C(20%) vs 他(40%)

  Aが勝った場合の2着争い:
    Harville: B(25%) vs C(25%) vs 他(50%)
    → BとCの比率は1:1のまま

  しかし:
    「Aが逃げ切り = スローペース = 差し馬には不利な展開」
    → BもCも不利だが、他の先行馬は有利かもしれない
    → B:Cの比率は1:1でいいかもしれないが、
      「差しグループ全体 vs 先行グループ全体」の比率が変わる

  さらに:
    BとCが「同脚質の差し馬」なら、赤バス・青バスと同じ構造。
    B+Cの合計シェアはHarvilleの予測より低くなる可能性がある。
```

---

## 3. 数学的に正しい「再計算」とは何か

### 3-1. Thurstone モデル（正規分布ベース）

```
Harvilleの裏にある確率モデル:
  各馬のパフォーマンス X_i ~ Exponential(λ_i)
  1着 = argmax(X_1, ..., X_n)
  → 指数分布の最大値の分布からHarville公式が導かれる
  → 指数分布の「無記憶性」がIIA仮定の数学的源泉

Thurstoneモデル:
  各馬のパフォーマンス X_i ~ Normal(μ_i, σ_i²)
  1着 = argmax(X_1, ..., X_n)

  ここでσ_iは馬ごとに異なる（タイプBはσ小、タイプCはσ大）

Thurstoneでの2着確率:
  P(B 2着 | A 1着) = P(X_B > X_k for all k≠A,B | X_A was maximum)

  これはHarvilleの「スライド」とは異なる。なぜなら:

  ① X_A が最大であるという条件が、X_B, X_C, ... の事後分布を変える
     → Aの勝ち方（大差か僅差か）で他馬の分布が変わる

  ② σ_i が馬ごとに違うと、「Aが消えた後の再正規化」では正しい確率にならない
     → σが小さい馬（安定型）は再正規化の影響が大きい
     → σが大きい馬（一発型）は再正規化の影響が小さい

直感的に:
  Thurstone = 「各馬が正規分布に従うパフォーマンスを出す世界で、
               Aが最も良いパフォーマンスを出した場合に、
               次に良いパフォーマンスは誰が出しているか？」

  → Aの存在を「消す」のではなく、「Aが最大値をとった世界」で
     他の馬のパフォーマンスがどう分布するかを計算し直す。
```

### 3-2. 具体例: HarvilleとThurstoneの違い

```
3頭のレース:
  A: μ=100, σ=5  （実力が高く安定）
  B: μ=90,  σ=3  （実力は劣るが非常に安定）
  C: μ=90,  σ=15 （実力は同程度だが波が激しい）

■ 1着確率（モンテカルロ推定、10万回）:
  P(A wins) ≈ 55%
  P(B wins) ≈ 10%
  P(C wins) ≈ 35%

  BとCはμが同じだが、Cの方がσが大きいので勝つ確率が高い。
  （高いパフォーマンスを引く確率が高い）

■ Harvilleの2着確率:
  P(B 2着 | A 1着) = 0.10 / (1-0.55) = 22.2%
  P(C 2着 | A 1着) = 0.35 / (1-0.55) = 77.8%
  → B:C = 10:35

■ Thurstoneの2着確率（モンテカルロ推定）:
  P(B 2着 | A 1着) ≈ 45%
  P(C 2着 | A 1着) ≈ 55%
  → B:C ≈ 45:55

  ★ Harvilleは 22:78、Thurstoneは 45:55。大きな差！

■ なぜこうなるか:
  Aが1着になるのは「Aが普通に走った場合」が多い。
  Aが普通に走った（X_A ≈ 100-105）世界では:

  B: X_B ~ N(90, 3²) → ほぼ確実に87-93の範囲
  C: X_C ~ N(90, 15²) → 60-120まで散らばる

  Cが「たまたま高いパフォーマンス」を出す確率は高くない（σが大きいので
  低い方に振れることも多い）。
  一方、Bは「堅実に90前後」を出すので、Cが低い値を引いた場合にBが上回る。

  結果: 安定したBが2着に来る確率は、Harvilleが予測するよりずっと高い。
        波の激しいCが2着に来る確率は、Harvilleが予測するよりずっと低い。

これがまさに horse_performance_distribution.md の
  「タイプBの2着確率をHarvilleは過小評価する」
の数学的証明。
```

### 3-3. いつHarvilleとThurstoneが一致するか

```
一致する条件: 全馬のσが同じ場合

  A: μ=100, σ=10
  B: μ=90,  σ=10
  C: μ=90,  σ=10

  → σが同じなら、Harvilleの「スライド」と
     Thurstoneの「再計算」はほぼ一致する（厳密には指数分布と
     正規分布の違いがあるが、実用上ほぼ同じ）。

つまり:
  Harvilleが正しいのは「全馬の安定度が同じ」場合のみ。
  現実の競馬では馬ごとに安定度が大きく異なるため、
  Harvilleには構造的なバイアスがある。

  × Harvilleが正確: 全馬の着順分散が等しい（ありえない）
  ○ Harvilleが不正確: 安定型と一発型が混在する（現実）
```

---

## 4. 「再計算」のイメージを直感的に

### ポーカーの類推

```
5人のポーカープレイヤー:
  A: プロ（安定して強い）
  B: 堅実なアマ（大勝ちしないが大負けもしない）
  C: ギャンブラー（大勝ちか大負けか）

Aが1位になった場合、2位は？

Harvilleの考え方:
  「Aを除いて、残りの『勝つ確率』の比で2位を決める」
  → Cの方が「勝つ確率」が高いので、2位もC

正しい考え方:
  「Aが1位の時、Bはどのくらいのスコアを出しているか」
  → Bは安定して中程度のスコア → 2位圏にいることが多い
  「Aが1位の時、Cはどのくらいのスコアを出しているか」
  → Cはたまに高スコアだが、多くの場合は低スコア → 2位圏にいないことが多い

  → Bが2位の確率 > Harvilleの予測
  → Cが2位の確率 < Harvilleの予測
```

### もう一つの直感: 「Aがいない世界」と「Aが勝った世界」は違う

```
Harvilleが計算しているのは:
  「Aがいない世界で、Bが最強になる確率」

本当に計算すべきなのは:
  「Aがいる世界で、Aが1着になった場合に、Bが次点になる確率」

この2つが同じになるのは、Aの存在が他馬の結果に影響しない場合。
しかし競馬では:
  - Aの脚質がペースを決める → 他馬に影響する
  - Aが「実力通り」勝つ展開 vs 「波乱で」勝つ展開がある
  - 「Aが勝った」という情報が、展開について何かを教えてくれる

→ 「Aを消してスライド」は「Aの存在がもたらす情報」を捨てている。
```

---

## 5. Henery補正は「応急処置」であって「解決策」ではない

### Heneryが何をしているか

```
Henery (1981):
  P(B 2着 | A 1着) = P(B)^γ / Σ_{k≠A} P(k)^γ    (γ ≈ 0.81)

γ < 1 の効果:
  確率の差を圧縮する。

  例: P(B)=0.20, P(C)=0.05 の場合

  Harville (γ=1):
    B:C = 0.20:0.05 = 4:1

  Henery (γ=0.81):
    B:C = 0.20^0.81 : 0.05^0.81 = 0.170 : 0.056 = 3.0:1
    → 差が縮まった

  意味: 「人気馬が2着に来る確率はHarvilleほど高くない」
        「穴馬が2着に来る確率はHarvilleが思うより高い」
```

### Heneryの限界

```
問題1: γが全馬共通
  全馬に同じγ=0.81を適用する。
  しかし本来:
    タイプB（安定型）: γは1よりかなり小さい（2着に来やすい）
    タイプC（一発型）: γは1より大きいかもしれない（2着に来にくい）
  → 馬ごとに異なるγが必要

問題2: 「誰が1着か」に依存しない
  Heneryの補正は「2着争い」を一律に圧縮する。
  しかし本来:
    逃げ馬が1着 → 先行馬有利、差し馬不利（ペース情報）
    追込馬が1着 → 差し馬有利、逃げ馬不利（ペース情報）
  → 1着馬によって補正の方向が変わるべき

問題3: 統計的な平均補正
  γ≈0.81は「平均的に」Harvilleより良い。
  しかし個別のレースでは:
    - γ=0.81がちょうど良いレースもある
    - γ=0.6が良いレースもある（安定型が多いメンバー）
    - γ=1.0で良いレースもある（全馬が似た分散）
  → レース条件に適応しない

結論:
  Heneryは「Harvilleのバイアスの平均的な方向」を補正する。
  しかし「なぜバイアスが生じるか」の原因（分散の違い、展開依存性）には
  対処していない。薬で言えば「対症療法」であって「根本治療」ではない。
```

---

## 6. 「正しい再計算」の実装アプローチ

### アプローチA: 正規分布モンテカルロ（Thurstoneシミュレーション）

```
原理:
  各馬に「能力の平均μ」と「能力の分散σ²」を割り当て、
  パフォーマンスを正規分布からサンプリングしてレースを走らせる。

実装:
  for trial in range(10000):
      performances = {}
      for horse in horses:
          performances[horse] = np.random.normal(mu[horse], sigma[horse])
      ranking = sorted(performances, key=performances.get, reverse=True)
      record_result(ranking)  # 1着, 2着, 3着...を記録

  # 各組合せの出現頻度 → 確率
  P_exacta[A][B] = count(A 1st and B 2nd) / 10000

利点:
  - IIA問題が自動解消（再計算ではなく直接シミュレーション）
  - 馬ごとの分散を反映できる
  - 着順分布の形状の影響が自然に出る
  - Harville/Heneryの枠組みに縛られない

欠点:
  - μとσの推定が必要（特にσ）
  - σの推定精度がそのまま2着以降の精度に直結
  - 10,000回のシミュレーション × 全レース → それでも数秒で済む

σの推定方法:
  - 過去5-10走の着順の標準偏差を使う
  - 着順を「相対スピード指数」に変換してから標準偏差を取るとより正確
  - 出走回数が少ない馬はクラス/年齢の平均σを使う
```

### アプローチB: 馬ごとのγを推定する（拡張Henery）

```
原理:
  Heneryのγを馬ごとに変える。
  P(B 2着 | A 1着) = P(B)^γ_B / Σ_{k≠A} P(k)^γ_k

γ_B の推定:
  - タイプB（安定型）: γ_B ≈ 0.5-0.7（2着確率を大幅に上方修正）
  - タイプA（安定強者）: γ_A ≈ 0.8-0.9（標準的な補正）
  - タイプC（一発型）: γ_C ≈ 1.0-1.3（2着確率を下方修正）

γの推定には着順分散を使う:
  γ_i = f(着順の標準偏差_i)
  → 標準偏差が小さいほどγが小さい（2着に来やすい）
  → 過去データからこの関係を回帰で推定

利点:
  - Harvilleの枠組みを維持したまま改善
  - 計算コストはHarvilleと同程度（追加コストほぼゼロ）
  - γの推定が1回できれば全レースに適用可能

欠点:
  - 「誰が1着か」による影響は捉えない（根拠1の問題は残る）
  - γの推定自体にデータが必要
  - 理論的にはThurstoneより粗い近似
```

### アプローチC: 条件付きγ（1着馬の脚質別に補正を変える）

```
原理:
  アプローチBに加えて、1着馬の脚質によって補正を変える。

  P(B 2着 | 逃げ馬Aが1着) = P(B)^γ_B × correction(脚質A, 脚質B) / Z

  Z = 正規化定数（全馬の合計を1にする）

correction テーブル（1着脚質 × 2着脚質）:

  1着\2着  | 逃げ  | 先行  | 差し  | 追込
  ---------|-------|-------|-------|------
  逃げ     | 0.5   | 1.1   | 0.9   | 0.7
  先行     | 0.8   | 0.9   | 1.0   | 0.8
  差し     | 0.7   | 0.9   | 1.1   | 1.2
  追込     | 0.6   | 0.8   | 1.2   | 1.1

  読み方: 逃げ馬が1着の場合、2着に逃げ馬が来る確率を×0.5に下方修正
         （同脚質の共倒れ考慮）
         追込馬が1着の場合、2着に差し馬が来る確率を×1.2に上方修正
         （ハイペースで後方勢有利の展開）

利点:
  - 根拠1（1着馬がレース条件を教える）にも部分的に対処
  - 根拠2（分散の違い）はγ_iで対処
  - 計算コストは低い

欠点:
  - correctionテーブルの推定に大量データが必要
  - 脚質の分類自体に曖昧さがある
  - 3着以降の補正はさらに複雑になる
```

---

## 7. 実際にどれくらい差が出るのか: 定量的な影響

### ケーススタディ: 18頭レースでの乖離

```
シミュレーション条件:
  18頭、各馬の1着確率は市場オッズから推定（典型的な重賞レース）
  各馬の着順分散は過去成績から推定

  1番人気A: P=25%, σ=小（タイプA、安定強者）
  2番人気B: P=15%, σ=中（タイプA寄り）
  5番人気E: P=7%,  σ=極小（タイプB、安定好走型）
  8番人気H: P=4%,  σ=大（タイプC、一発型）

■ 馬単 A→E（1番人気→5番人気）:
  Harville:   P = 0.25 × 0.07/(1-0.25) = 2.33%
  Thurstone:  P ≈ 3.8%  （Eは安定しているので2着に来やすい）
  乖離: +63%

■ 馬単 A→H（1番人気→8番人気）:
  Harville:   P = 0.25 × 0.04/(1-0.25) = 1.33%
  Thurstone:  P ≈ 0.6%  （Hは一発型なので2着に来にくい）
  乖離: -55%

■ 影響:
  馬単 A→E のオッズが40倍だとする:
    Harville:  EV = 0.0233 × 40 = 0.93（買わない）
    Thurstone: EV = 0.038  × 40 = 1.52（★買い！）

  馬単 A→H のオッズが80倍だとする:
    Harville:  EV = 0.0133 × 80 = 1.07（買い）
    Thurstone: EV = 0.006  × 80 = 0.48（★買わない！）

→ HarvilleとThurstoneで「買い/見送り」の判断が逆転するケースがある。
→ 特にタイプBの2-3着とタイプCの2-3着で影響が大きい。
```

### 全体的な影響の大きさ

```
影響が大きい場面:
  - タイプBとタイプCが混在するレース → 常にある
  - 組合せ馬券（馬連、三連単）→ 影響が累積
  - 2着3着の予測精度に直結する馬券種

影響が小さい場面:
  - 単勝 → 影響なし（IIA問題は2着以降の話）
  - 全馬の分散が似ているレース → 稀だが、Harvilleで十分
  - 大本命が圧勝するレース → 2着以降の確率が小さいので金額影響も小さい

定量的な見積もり:
  三連単のEV計算精度: Harvilleに対して10-30%の改善が見込める
  回収率への影響: おそらく2-5%の改善
  → 単独で大きな改善ではないが、他の改善と積み重なると有意
```

---

## 8. 既存insightとの統合

### これまでの議論がすべてここに収束する

```
┌─────────────────────────────────────────────────────┐
│                Harvilleの問題の根源                    │
│             「スライドではなく再計算すべき」             │
│                  = IIA仮定の問題                      │
└───────┬───────────────┬───────────────┬──────────────┘
        │               │               │
        ▼               ▼               ▼
  ┌───────────┐  ┌──────────────┐  ┌──────────────┐
  │ 着順分布の │  │ 展開シミュ   │  │ 組合せ馬券の │
  │ 形状      │  │ レーション   │  │ 確率計算     │
  │           │  │              │  │              │
  │タイプBの2着│  │1着の脚質が   │  │キャリブレー  │
  │確率を過小 │  │展開情報を   │  │ション誤差の  │
  │評価       │  │与える       │  │増幅          │
  └───────────┘  └──────────────┘  └──────────────┘
  根拠2に対応    根拠1に対応      全体に対応

この3つのinsightは、実はすべて「IIA問題」という
同一の根から生えた枝だった。
```

### 各insightの記述との整合

```
combination_ticket_probability.md セクション5:
  「Harvilleは各馬の強さが一定と仮定。本命馬は安定して好走するが
   ぶっちぎり勝ちは少ない → 2着に残る確率はHarvilleの予測より低い」
  → これはIIA問題の「結果」を観察したもの。根拠2に対応。

horse_performance_distribution.md セクション2:
  「1着確率が同じ15%の2頭に、Harvilleは同じ2着確率を割り当てる」
  → IIA問題の「タイプ別の影響」を可視化したもの。

race_scenario_simulation.md セクション3:
  「Harvilleの暗黙の仮定: Aが1着になった場合のBの2着確率は、
   Aの脚質や展開に依存しない」
  → IIA問題の「展開依存性」の側面。根拠1に対応。

→ 3つのinsightが別角度から指摘していた問題が、
   「IIA仮定への批判 = スライドではなく再計算すべき」
   という一つの主張に集約される。
```

---

## 9. KeibaCICDへの実装ロードマップ

### 段階的に精度を上げる

```
Phase 1（現在の計画通り）: Harvilleで始める
  → 変更なし。まず動くものを作る。
  → Harvilleでも単勝確率が正確なら、大枠の組合せ確率は合っている。
  → 松風もおそらくこの段階で+1,700万円。

Phase 2: 馬ごとのγを導入（アプローチB）
  Step 1: 着順の標準偏差を特徴量として計算（features.md に既にある）
  Step 2: 過去データで「着順標準偏差 → 最適γ」の関係を推定
  Step 3: Harville変換をγ_i版に置き換え
  → コスト低、効果中。Phase 2の中盤で実施。

Phase 3: 条件付きγの導入（アプローチC）
  Step 1: 脚質分類の実装（展開シミュレーションと共通基盤）
  Step 2: 1着脚質 × 2着脚質のcorrectionテーブルを推定
  Step 3: 組合せ確率計算に組み込み
  → コスト中、効果中。Phase 3で実施。

Phase 4: モンテカルロシミュレーション（アプローチA）
  Step 1: 各馬のμとσを推定するモデルの構築
  Step 2: 10,000回シミュレーションで組合せ確率を推定
  Step 3: Harville + γ版との精度比較
  → コスト高、効果（理論上）大。必要性が確認されてから。
```

### Phase 2の具体的な実装設計

```
現在の確率変換層:
  win_probs: Dict[HorseID, float] → Harville → combo_probs: Dict[TicketID, float]

Phase 2の確率変換層:
  win_probs: Dict[HorseID, float]
  stability: Dict[HorseID, float]  ← 着順標準偏差から算出
  ↓
  extended_harville(win_probs, stability) → combo_probs

extended_harvilleの疑似コード:
  def gamma_from_stability(stability_score):
      """安定度 → γの変換。安定な馬ほどγが小さい"""
      # 回帰で推定した変換関数
      return 0.5 + 0.6 * stability_score  # 例: 安定(0.0)→γ=0.5, 不安定(1.0)→γ=1.1

  def extended_harville_exacta(win_probs, gammas, a, b):
      """拡張Harville: 馬単 A→B"""
      pa = win_probs[a]
      pb_adj = win_probs[b] ** gammas[b]
      denominator = sum(win_probs[k] ** gammas[k] for k in horses if k != a)
      return pa * pb_adj / denominator

★ Themisのインターフェースは変わらない。
  Themisは「馬券ID → 確率」しか受け取らないので、
  確率がどう計算されたかは知らなくてよい（目隠し原則維持）。
```

---

## 10. この議論の核心と注意点

### 核心: 「どれだけ間違っているか」と「直す価値があるか」は別の問い

```
Harvilleが理論的に間違っていることは学術的に確定している。
IIA仮定は現実の競馬では成立しない。

しかし:
  1. 間違いの大きさはレースによって異なる
  2. 「正しい方法」のパラメータ推定にもノイズがある
  3. 「正しい方法」の実装コストは無視できない
  4. Harvilleの間違いより、1着確率自体の精度向上の方が
     全体の利益に与える影響が大きい可能性がある

松風の事例:
  おそらくHarville（+ 精密なキャリブレーション）で年間+4.34億円。
  → 1着確率の精度が十分に高ければ、Harvilleのバイアスは
     市場の非効率性に比べて小さい「ノイズ」にすぎない可能性。

結論:
  「スライドではなく再計算すべき」は理論的に正しい。
  しかし「いつ」再計算に投資するかは戦略的判断。
  まずHarvilleで動かし、次にγ補正、最後にシミュレーション。
  各段階で「改善幅 > 実装コスト」かを確認してから進む。
```

### 注意: 「完璧な確率」を追求する罠

```
005の教訓（過学習）と009の教訓（認知バイアス）を忘れない:

  ✗ 「理論的に正しいThurstoneモデルを実装すれば利益が増える」
    → σの推定に過学習のリスクがある
    → パラメータが増えるほど過学習しやすくなる

  ✗ 「Harvilleの誤差は-55%〜+63%もある！大問題だ！」
    → これは最悪ケース。平均的な誤差はもっと小さい
    → この誤差を修正しても、オッズの誤差の方が大きいかもしれない

  ○ 「Harvilleで始めて、データを見て、改善が必要な部分を特定する」
    → 仮説検証のアプローチ（hypothesis_verification_master参照）
    → H-23（Harvilleのバイアス検証）の結果を見てから判断

全体の優先順位:
  1着確率の精度 >>> Harville→Thurstone の改善
  ↑ まずこちらに注力。ここが十分になってから変換層を改善。
```

---

## 仮説検証マスターへの追加提案

```
H-28: Harvilleの2着確率バイアスは着順分散の関数である
  仮説: 着順標準偏差が小さい馬ほど、Harville予測の2着確率より
        実際の2着確率が高い（逆も成立）
  検証方法:
    1. 過去データで各馬の着順標準偏差を計算
    2. 低分散群/中分散群/高分散群に分類
    3. Harville予測の2着確率 vs 実際の2着率を群別に比較
    4. 群間で乖離の方向と大きさが異なることを確認
  成功基準: 低分散群でHarvilleの過小評価が統計的に有意（p<0.05）
  重要度: ★★（Phase 2のγ導入の根拠になる）
  Phase: 2
  前提: H-02（キャリブレーション）の達成

H-29: 馬ごとのγ補正はHarvilleより組合せ馬券の精度を改善する
  仮説: γ_i = f(着順標準偏差_i) で補正した方が、
        素のHarvilleより馬連・三連単の予測精度が高い
  検証方法:
    1. H-28で推定したγ関数を使って補正Harvilleを実装
    2. 過去データで馬連・三連単の的中率/回収率を比較
    3. Harville vs 補正Harville vs Henery(γ=0.81)の3者比較
  成功基準: 補正HarvilleがHarvilleを有意に上回る
  重要度: ★★（Phase 2→3の移行判断に使う）
  Phase: 2-3
  前提: H-28
```

---

## アクションアイテム

- [ ] 過去データで着順分散別のHarville2着確率バイアスを検証（H-28）
- [ ] 着順標準偏差 → 最適γ の回帰式を推定
- [ ] 拡張Harville（馬ごとのγ）の実装と評価（H-29）
- [ ] 3頭シミュレーション（本文セクション3-2の例）を実際に実行して定量確認
- [ ] H-28, H-29を仮説検証マスターに追加
- [ ] combination_ticket_probability.md に本考察への参照リンクを追加

## 関連ドキュメント

| 関連insight | 接続点 |
|---|---|
| [組合せ馬券の確率計算](combination_ticket_probability.md) | Harville公式の定義、Henery補正（セクション5） |
| [馬の着順分布の形状](../model/horse_performance_distribution.md | タイプB/Cの2着確率乖離（セクション2） |
| [展開シミュレーション](../race/race_scenario_simulation.md | 1着馬が展開情報を与える問題（セクション3） |
| [モデル分離戦略](../model/model_separation_strategy.md | σの推定は芝/ダート別に行うべき |
| [仮説検証マスター](../operations/hypothesis_verification_master.md | H-23, H-24と本考察のH-28, H-29の関係 |

## タグ

`#確率論` `#モデル` `#馬券戦略` `#三連単` `#特徴量`
