# VBバックテスト: 芝/ダート別購入戦略

**日付**: 2026-02-15
**種別**: 戦略分析
**ツール**: `ml/backtest_vb.py`

---

## 概要

experiment_v3_result.json（テストセット: 3,570レース, 49,509馬）を使い、
芝/ダート × 各種フィルタ条件のグリッドサーチで最適購入戦略を探索。

## グリッドサーチ条件

| パラメータ | 値 |
|-----------|-----|
| track_type | 全体, 芝, ダート |
| min_gap | 2, 3, 4, 5 |
| min_ev | 0, 0.8, 1.0 |
| min_proba_a | 0, 0.15, 0.2 |
| min_proba_v | 0, 0.1, 0.15 |
| odds_range | 全て, 5-50, 10-100 |
| value_rank | 全て, top1, top2 |

合計: 約45,000条件の組み合わせ。

## 主要結果

### 芝 vs ダート ROI比較

| 条件 | 芝 単勝ROI | 芝 複勝ROI | ダ 単勝ROI | ダ 複勝ROI |
|------|-----------|-----------|-----------|-----------|
| gap>=3 | 95.2% | 113.3% | 83.3% | 128.1% |
| gap>=4 | 112.8% | 123.7% | 79.2% | 128.1% |
| gap>=5 | **134.3%** | 131.1% | 101.3% | **157.6%** |

### 戦略結論

| トラック | 推奨馬券 | 条件 | 期待ROI |
|---------|---------|------|---------|
| **芝** | **単勝** | gap>=4, odds>=10 | 110-135% |
| **ダート** | **複勝** | gap>=3 | 125-160% |
| ダート gap>=5 + odds>=10 | **単複** | 強VB | 150%+ |

### Model B Top1 特殊条件

| 条件 | n | 単勝ROI | 複勝ROI |
|------|---|---------|---------|
| Top1 + gap>=5 + odds>=10 (dirt) | 小 | **177.2%** | 高 |

※ サンプル数が小さいため過学習の可能性あり。

## 実装

### backtest_vb.py
- `build_horse_records()`: experiment result + race JSONからtrack_type/distance付きレコード構築
- `calc_roi()`: フィルタ条件適用 → 単勝/複勝ROI算出
- `run_grid_search()`: 全条件組み合わせを並列評価
- `print_track_comparison()`: 芝/ダート比較テーブル出力

### predictions-content.tsx 購入推奨ロジック
```
getBuyRecommendation(trackType, gap, valueRank, odds):
  芝 + gap>=4 + top1 + odds>=10 → 単勝(strong/赤)
  芝 + gap>=3                   → 単勝(normal/赤)
  ダ + gap>=5 + odds>=10        → 単複(purple)
  ダ + gap>=3                   → 複勝(normal/青)
```

## 注意事項

- 複勝ROIは推定値（確定複勝オッズなし → `max(win_odds/3.5, 1.1)` で近似）
- 2025年以降のmykeibadbデータで実複勝オッズ検証が可能（現在データ限定的）
- バックテスト結果はテストセット上のもの。実運用での過学習に注意
