# ML v3.0: JRA-VANネイティブ移行

**日付**: 2026-02-10
**種別**: データ基盤移行 + 特徴量エンジニアリング

---

## 概要

keibabookデータ依存からJRA-VAN直読みに移行。
trainer/jockey特徴量をJRA-VAN 5桁コードで100%マッチに改善し、
AUC +0.03という大幅な精度向上を達成。

## 変更内容

### データ基盤
- **keibabook依存排除**: integrated JSONからの特徴量抽出 → JRA-VAN SE_DATA/UM_DATA直読み
- **data3構造新設**: races/, masters/, indexes/ にJRA-VAN由来のJSONを構築
- **過去走カバレッジ倍増**: 17,335頭 → 36,008頭（horse_history_cache再構築）

### 特徴量改善
| 変更 | v2 | v3.0 | 効果 |
|------|-----|------|------|
| trainer_top3_rate | マッチ率0.5% | **100%マッチ** | AUC大幅向上 |
| trainer_win_rate | なし | 新規追加 | - |
| trainer_venue_top3_rate | なし | 新規追加 | Model B重要度上位 |
| jockey_win_rate | なし | 新規追加 | - |
| jockey_top3_rate | なし | 新規追加 | - |
| jockey_venue_top3_rate | なし | 新規追加 | **Model B重要度2位** |

### keibabookデータの扱い
- v3.0ではrating, mark_point等のkeibabook固有特徴量は未使用
- Phase 3でkeibabook拡張レイヤー（kb_ext_*.json）として統合予定
- Model Aの`odds`, `popularity`はJRA-VAN由来で問題なし

## 結果

| 指標 | v2 | v3.0 | 変化 |
|------|-----|------|------|
| Model A AUC | 0.7944 | **0.8241** | **+0.0297** |
| Model B AUC | 0.7635 | **0.7746** | **+0.0111** |
| 特徴量数 A/B | 32/27 | 32/29 | +0/+2 |
| VB gap>=3 ROI | 104.7% | **109.2%** | +4.5pt |
| VB gap>=4 ROI | 112.1% | **117.2%** | +5.1pt |
| VB gap>=5 ROI | 99.9% | **130.3%** | **+30.4pt** |

## Model B 特徴量重要度 Top 5
1. rating_deviation (使用不可 → v4でkeibabook統合後に復活予定)
2. **jockey_venue_top3_rate** ← 新規、場所別騎手適性
3. entry_count
4. trainer_venue_top3_rate ← 新規
5. age

## 学び

- **JRA-VAN IDでの100%マッチが最大の改善要因**: AUC +0.03は過去最大の単一改善
- **「正しいデータを与える」> 「特徴量を増やす」**: 特徴量数はv2と同じ32だがAUCは大幅向上
- **jockey_venue_top3_rateの発見**: 騎手の場所別適性は市場に織り込まれにくく、Value Bet検出に有効
- **gap>=5 ROIの急上昇**: 130.3%はデュアルモデルの真価。大きな乖離ほど信頼性が高い

## ファイル

- `keiba-v2/ml/experiment_v3.py`
- `keiba-v2/ml/features/{base,past,trainer,jockey}_features.py`
- `data3/ml/ml_experiment_v3_result.json`
