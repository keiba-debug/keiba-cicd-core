# ML v4.0: Sprint 1 特徴量拡張（+11特徴量）

**日付**: 2026-02-14
**種別**: 特徴量エンジニアリング

---

## 概要

ナレッジベースの考察と未使用データ分析を踏まえ、Sprint 1として既存データから
即座に追加可能な11特徴量を実装。新規データ取得は不要で、既存のhorse_history_cache、
kb_ext、pace_index、race JSONから計算。

大きく5カテゴリ:
1. KB印・レーティング（プロの目利き情報活用）
2. 末脚ピーク・展開不利検出
3. 着順安定度・盛り返し強度（馬タイプの数値化）
4. 騎手乗り替わり
5. 季節・開催日（馬場コンディションの間接指標）

## 変更内容

### 1. KB印・レーティング (training_features.py)

kb_ext JSONの `mark_point`, `aggregate_mark_point`, `rating` を特徴量化。
これらはkeibabook上にデータとして存在していたが、ML特徴量としては未使用だった。

| 特徴量 | 説明 | Model B | 根拠 |
|--------|------|---------|------|
| `kb_mark_point` | 本誌印ポイント（◎=8〜無印=0） | **除外** | 印はオッズと高相関 |
| `kb_aggregate_mark_point` | 全記者総合ポイント | **除外** | 同上 |
| `kb_rating` | keibabookレーティング（独自評価値） | o | 市場と独立した能力評価 |

**設計判断**: `kb_mark_point` / `kb_aggregate_mark_point` は記者の印であり、
オッズとの相関が高いためMARKET扱い（Model B除外）。
`kb_rating` はkeibabook独自算出の能力値で市場に直接反映されないためModel Bに投入。

### 2. 末脚ピーク・展開不利検出 (past_features.py + pace_features.py)

| 特徴量 | 説明 | モジュール |
|--------|------|-----------|
| `best_l3f_last5` | 直近5走の上がり3F最速値 | past_features |
| `l3_unrewarded_rate_last5` | L3がレース平均より速いのに着外のレース率 | pace_features |

**`l3_unrewarded_rate_last5` の設計**:
```python
# 各過去走で: horse_l3 < race_l3（馬がレース平均より速い）かつ着順 > 3
# → そのレース率 = 「脚はあるが結果が出ない」割合
# 高い = 展開不利が多い → 巻き返し候補
```

pace_featuresに配置した理由: `pace_index` （レース別L3データ）へのアクセスが必要。

### 3. 着順安定度・盛り返し強度 (past_features.py)

| 特徴量 | 説明 | 計算式 |
|--------|------|--------|
| `finish_std_last5` | 直近5走の着順標準偏差 | stdev(positions) |
| `comeback_strength_last5` | 直近5走の盛り返し強度 | mean((worst_corner - finish) / (num_runners - 1)) |

**設計根拠**: `ability_is_not_scalar` の3類型（安定強者/安定好走/一発型）を数値化。
- `finish_std_last5` 小 = 安定型（複勝向き）、大 = ムラ型（単勝・三連単向き）
- `comeback_strength_last5` 正 = 道中後方から巻き返す傾向（戦意旺盛）

### 4. 騎手乗り替わり (rotation_features.py)

| 特徴量 | 説明 |
|--------|------|
| `jockey_change` | 前走と今走で騎手が変わった場合 1、同じなら 0 |

関数シグネチャに `jockey_code` パラメータを追加。
experiment_v3.py / predict.py の呼び出し箇所も更新。

**将来拡張**: `jockey_quality_diff`（新騎手top3率 - 旧騎手top3率）を追加予定。
現時点ではjockey_indexがrotation_featuresに渡されていないため、フラグのみ。

### 5. 季節・開催日 (base_features.py)

| 特徴量 | 説明 | 抽出元 |
|--------|------|--------|
| `month` | 月（1-12） | race.date[5:7] |
| `nichi` | 開催日（1=開幕〜8=最終週） | race_id[12:14] |

**根拠**:
- 開幕週は芝が綺麗 → 内枠・先行有利（競馬の定説）
- 最終週は馬場が荒れ → 外差し有利
- 冬場は芝の成長が遅く馬場バイアスが大きい

### 6. その他の変更

| 変更 | 詳細 |
|------|------|
| version更新 | model_meta.json / result JSON: `3.5` → `4.0` |
| MARKET_FEATURES拡張 | `kb_mark_point`, `kb_aggregate_mark_point` を追加 |
| KB_MARK_FEATURES定数 | 新規。Model A専用のKB印特徴量リスト |
| Web対応 | `useMlResult.ts` のバージョンチェックに `4.x` を追加 |

## 結果

> **注**: v4.0は特徴量追加のコード実装のみ。実験実行は未実施。
> 以下は実験実行後に記入する。

### 主要指標

| 指標 | v3.5 | v4.0 | 変化 | 評価 |
|------|------|------|------|------|
| Model A AUC | 0.8241 | - | - | - |
| Model B AUC | 0.7809 | - | - | - |
| Model A Brier | 0.1277 | - | - | - |
| Model B Brier | 0.1392 | - | - | - |
| Model A ECE | 0.0041 | - | - | - |
| Model B ECE | 0.0047 | - | - | - |
| 特徴量数 A/B | 65/61 | **78/72** | +13/+11 | - |

### Value Bet ROI

| ギャップ | ベット数 | 複勝ROI | v3.5比 | 単勝ROI | v3.5比 |
|---------|---------|---------|--------|---------|--------|
| gap>=2 | - | - | - | - | - |
| gap>=3 | - | - | - | - | - |
| gap>=4 | - | - | - | - | - |
| gap>=5 | - | - | - | - | - |

### Model B 特徴量重要度 Top 10

> 実験実行後に記入

### 注目すべき新特徴量の重要度

> 以下の特徴量がTop 20に入るかが成否の判断基準:
> - `kb_rating`: keibabookの独自評価。有用なら大きなシグナル源
> - `finish_std_last5`: 馬タイプの数値化。既存の安定度指標がないため新情報
> - `best_l3f_last5`: `last3f_avg_last3`を補完する末脚ピーク
> - `jockey_change`: 市場が過剰反応する乗り替わりの直接検出

## 学び

> 実験実行後に記入。以下は検証すべき仮説:
>
> 1. **KB印はMARKET除外が正しいか**: mark_point / aggregate_mark_pointをModel Bに入れた場合との比較
> 2. **kb_ratingはModel Bで有効か**: 市場と独立した能力評価として機能するか
> 3. **finish_std_last5の馬タイプ検出**: 安定型と一発型でVB検出精度に差が出るか
> 4. **nichi（開催日）の効果**: 開幕週と最終週で先行/差しの有利不利が検出されるか
> 5. **l3_unrewarded_rate_last5の巻き返し検出**: 展開不利馬の次走パフォーマンスは向上するか

## ファイル

| ファイル | 変更 |
|---------|------|
| `ml/features/base_features.py` | 修正: `month`, `nichi` 追加 |
| `ml/features/past_features.py` | 修正: `best_l3f_last5`, `finish_std_last5`, `comeback_strength_last5` 追加 |
| `ml/features/pace_features.py` | 修正: `l3_unrewarded_rate_last5` 追加 |
| `ml/features/rotation_features.py` | 修正: `jockey_change` 追加、`jockey_code`引数追加 |
| `ml/features/training_features.py` | 修正: `kb_mark_point`, `kb_aggregate_mark_point`, `kb_rating` 追加 |
| `ml/experiment_v3.py` | 修正: 特徴量リスト更新、MARKET_FEATURES拡張、version 4.0 |
| `ml/predict.py` | 修正: rotation呼び出しに`jockey_code`追加 |
| `web/src/hooks/useMlResult.ts` | 修正: version 4.x対応 |
