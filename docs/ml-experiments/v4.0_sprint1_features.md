# ML v4.0: Sprint 1 特徴量拡張（+11特徴量）

**日付**: 2026-02-14
**種別**: 特徴量エンジニアリング

---

## 概要

ナレッジベースの考察と未使用データ分析を踏まえ、Sprint 1として既存データから
即座に追加可能な11特徴量を実装。新規データ取得は不要で、既存のhorse_history_cache、
kb_ext、pace_index、race JSONから計算。

大きく5カテゴリ:
1. KB印・レーティング（プロの目利き情報活用）
2. 末脚ピーク・展開不利検出
3. 着順安定度・盛り返し強度（馬タイプの数値化）
4. 騎手乗り替わり
5. 季節・開催日（馬場コンディションの間接指標）

## 変更内容

### 1. KB印・レーティング (training_features.py)

kb_ext JSONの `mark_point`, `aggregate_mark_point`, `rating` を特徴量化。
これらはkeibabook上にデータとして存在していたが、ML特徴量としては未使用だった。

| 特徴量 | 説明 | Model B | 根拠 |
|--------|------|---------|------|
| `kb_mark_point` | 本誌印ポイント（◎=8〜無印=0） | **除外** | 印はオッズと高相関 |
| `kb_aggregate_mark_point` | 全記者総合ポイント | **除外** | 同上 |
| `kb_rating` | keibabookレーティング（独自評価値） | o | 市場と独立した能力評価 |

**設計判断**: `kb_mark_point` / `kb_aggregate_mark_point` は記者の印であり、
オッズとの相関が高いためMARKET扱い（Model B除外）。
`kb_rating` はkeibabook独自算出の能力値で市場に直接反映されないためModel Bに投入。

### 2. 末脚ピーク・展開不利検出 (past_features.py + pace_features.py)

| 特徴量 | 説明 | モジュール |
|--------|------|-----------|
| `best_l3f_last5` | 直近5走の上がり3F最速値 | past_features |
| `l3_unrewarded_rate_last5` | L3がレース平均より速いのに着外のレース率 | pace_features |

**`l3_unrewarded_rate_last5` の設計**:
```python
# 各過去走で: horse_l3 < race_l3（馬がレース平均より速い）かつ着順 > 3
# → そのレース率 = 「脚はあるが結果が出ない」割合
# 高い = 展開不利が多い → 巻き返し候補
```

pace_featuresに配置した理由: `pace_index` （レース別L3データ）へのアクセスが必要。

### 3. 着順安定度・盛り返し強度 (past_features.py)

| 特徴量 | 説明 | 計算式 |
|--------|------|--------|
| `finish_std_last5` | 直近5走の着順標準偏差 | stdev(positions) |
| `comeback_strength_last5` | 直近5走の盛り返し強度 | mean((worst_corner - finish) / (num_runners - 1)) |

**設計根拠**: `ability_is_not_scalar` の3類型（安定強者/安定好走/一発型）を数値化。
- `finish_std_last5` 小 = 安定型（複勝向き）、大 = ムラ型（単勝・三連単向き）
- `comeback_strength_last5` 正 = 道中後方から巻き返す傾向（戦意旺盛）

### 4. 騎手乗り替わり (rotation_features.py)

| 特徴量 | 説明 |
|--------|------|
| `jockey_change` | 前走と今走で騎手が変わった場合 1、同じなら 0 |

関数シグネチャに `jockey_code` パラメータを追加。
experiment_v3.py / predict.py の呼び出し箇所も更新。

**将来拡張**: `jockey_quality_diff`（新騎手top3率 - 旧騎手top3率）を追加予定。
現時点ではjockey_indexがrotation_featuresに渡されていないため、フラグのみ。

### 5. 季節・開催日 (base_features.py)

| 特徴量 | 説明 | 抽出元 |
|--------|------|--------|
| `month` | 月（1-12） | race.date[5:7] |
| `nichi` | 開催日（1=開幕〜8=最終週） | race_id[12:14] |

**根拠**:
- 開幕週は芝が綺麗 → 内枠・先行有利（競馬の定説）
- 最終週は馬場が荒れ → 外差し有利
- 冬場は芝の成長が遅く馬場バイアスが大きい

### 6. その他の変更

| 変更 | 詳細 |
|------|------|
| version更新 | model_meta.json / result JSON: `3.5` → `4.0` |
| MARKET_FEATURES拡張 | `kb_mark_point`, `kb_aggregate_mark_point` を追加 |
| KB_MARK_FEATURES定数 | 新規。Model A専用のKB印特徴量リスト |
| Web対応 | `useMlResult.ts` のバージョンチェックに `4.x` を追加 |

## 結果

**実験実行日**: 2026-02-14
**データ範囲**: Train 2020-2023 (175,669) / Val 2024 (43,116) / Test 2025-2026 (49,509)

### 主要指標

| 指標 | v3.5 | v4.0 | 変化 | 評価 |
|------|------|------|------|------|
| Model A AUC | 0.8241 | **0.8242** | +0.0001 | = |
| Model B AUC | 0.7809 | **0.7839** | **+0.0030** | UP |
| Model A Brier | 0.1277 | **0.1277** | 0.0000 | = |
| Model B Brier | 0.1392 | **0.1385** | -0.0007 | = |
| Model A ECE | 0.0041 | **0.0031** | -0.0010 | UP |
| Model B ECE | 0.0047 | **0.0053** | +0.0006 | = |
| 特徴量数 A/B | 65/61 | **75/69** | +10/+8 | |

### Value Bet ROI

| ギャップ | ベット数 | 複勝ROI | v3.5比 | 単勝ROI | v3.5比 |
|---------|---------|---------|--------|---------|--------|
| gap>=2 | 2,777 | **107.0%** | +2.5pt | 89.3% | +4.3pt |
| gap>=3 | 1,666 | **120.2%** | +3.2pt | 89.7% | +6.7pt |
| gap>=4 | 994 | **127.6%** | +4.4pt | 96.7% | -1.9pt |
| gap>=5 | 570 | **146.0%** | **+8.6pt** | 118.0% | +5.6pt |

### Model B 特徴量重要度 Top 20

| Rank | 特徴量 | 重要度 | 新規 |
|------|--------|--------|------|
| 1 | avg_finish_last3 | 103,572 | |
| 2 | jockey_venue_top3_rate | 87,487 | |
| 3 | prev_race_popularity | 65,363 | |
| 4 | track_type_top3_rate | 39,828 | |
| 5 | trainer_venue_top3_rate | 38,677 | |
| 6 | entry_count | 19,544 | |
| 7 | recent_form_trend | 19,159 | |
| 8 | entry_count_change | 15,928 | |
| 9 | horse_weight | 15,308 | |
| 10 | best_finish_last5 | 14,753 | |
| 11 | days_since_last_race | 14,138 | |
| 12 | **finish_std_last5** | **12,784** | **NEW** |
| 13 | age | 11,560 | |
| 14 | **best_l3f_last5** | **11,372** | **NEW** |
| 15 | trainer_top3_rate | 10,770 | |
| 16 | **comeback_strength_last5** | **10,620** | **NEW** |
| 17 | last3f_vs_race_l3_last3 | 9,684 | |
| 18 | avg_last_corner_ratio | 9,595 | |
| 19 | win_rate_all | 9,555 | |
| 20 | jockey_win_rate | 8,901 | |

### 注目すべき新特徴量の重要度

判定基準: Top 20に入るか

| 特徴量 | Model B Rank | 重要度 | 判定 |
|--------|-------------|--------|------|
| `finish_std_last5` | **12/69** | 12,784 | **Top 20入り** |
| `best_l3f_last5` | **14/69** | 11,372 | **Top 20入り** |
| `comeback_strength_last5` | **16/69** | 10,620 | **Top 20入り** |
| `month` | 26/69 | 8,689 | 中位 |
| `kb_rating` | 40/69 | 4,871 | 低位 |
| `nichi` | 44/69 | 4,015 | 低位 |
| `jockey_change` | 49/69 | 3,638 | 低位 |
| `l3_unrewarded_rate_last5` | 51/69 | 3,549 | 低位 |

## 学び

### 1. 着順安定度・盛り返し強度が大成功
`finish_std_last5`(12位), `best_l3f_last5`(14位), `comeback_strength_last5`(16位) の3特徴量がModel B Top 20に入った。馬のタイプ（安定型/一発型/追い込み型）の数値化が有効。これらは既存特徴量にない「分散」「ピーク」「回復力」の情報を提供している。

### 2. KB印のMARKET除外は正しい
`kb_mark_point`はModel Aでもrank 68/75と低重要度。Model Bでは除外済み。記者の印はオッズに織り込まれているため、独立した情報源ではない。

### 3. kb_ratingは現時点では低重要度
Model Bで40/69。keibabookの独自評価値はモデルにとって有用なシグナルになっていない。ノイズが大きいか、他の特徴量と情報が重複している可能性。

### 4. jockey_changeは単独では弱い
49/69。フラグだけでは不十分。`jockey_quality_diff`（新旧騎手の能力差）を追加すれば効果が上がる可能性。

### 5. l3_unrewarded_rate_last5は要改善
51/69。展開不利検出のロジック自体は正しいが、計算条件が厳しすぎる可能性。閾値の調整やレース展開（ペース）を考慮した改良が必要。

### 6. VB ROI全面改善はデータ修正の効果も大きい
Session 19-20のCK_DATAバグ修正（WC/HC逆転、パーサーオフセット、5段階タイムレベル）により調教特徴量の精度が向上。新特徴量だけでなくデータ品質改善の寄与も大きい。

### 7. Model B AUC +0.0030は有意
テストデータ49,509件での+0.0030は統計的に意味のある改善。gap>=5のVB ROIが137.4%→146.0%（+8.6pt）と大幅改善。

## ファイル

| ファイル | 変更 |
|---------|------|
| `ml/features/base_features.py` | 修正: `month`, `nichi` 追加 |
| `ml/features/past_features.py` | 修正: `best_l3f_last5`, `finish_std_last5`, `comeback_strength_last5` 追加 |
| `ml/features/pace_features.py` | 修正: `l3_unrewarded_rate_last5` 追加 |
| `ml/features/rotation_features.py` | 修正: `jockey_change` 追加、`jockey_code`引数追加 |
| `ml/features/training_features.py` | 修正: `kb_mark_point`, `kb_aggregate_mark_point`, `kb_rating` 追加 |
| `ml/experiment_v3.py` | 修正: 特徴量リスト更新、MARKET_FEATURES拡張、version 4.0 |
| `ml/predict.py` | 修正: rotation呼び出しに`jockey_code`追加 |
| `web/src/hooks/useMlResult.ts` | 修正: version 4.x対応 |
