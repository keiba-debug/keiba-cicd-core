# ML v3.3: 調教詳細データ統合

**日付**: 2026-02-11
**種別**: データ基盤 + 特徴量エンジニアリング

---

## 概要

競馬ブックの調教HTMLから全セッションを構造化パースし、追い切りタイム・脚色・併せ馬等の
調教詳細データをML特徴量として統合。cyokyo_parser v2で10,641件のkb_extを補強。

## 変更内容

### 新インフラ

| ファイル | 内容 |
|---------|------|
| `keibabook/cyokyo_parser.py` | HTML→全セッション構造化パーサー (BeautifulSoup) |
| `keibabook/cyokyo_enricher.py` | debug HTML→kb_ext JSONにcyokyo_detail追加バッチ |

### 特徴量追加 (8個)

| 特徴量 | 計算方法 | 狙い |
|--------|---------|------|
| `oikiri_5f` | 追い切り5Fタイム | 仕上がり度合い |
| `oikiri_3f` | 追い切り3Fタイム | 末脚指標 |
| `oikiri_1f` | 追い切り1Fタイム | 瞬発力 |
| `oikiri_intensity_code` | 脚色コード (0-4: 馬なり〜一杯) | 追い切り強度 |
| `oikiri_has_awase` | 併せ馬有無 | 調教の本気度 |
| `training_session_count` | 調教セッション数 | 調教量 |
| `rest_weeks` | 休養週数 | コンディション |
| `oikiri_is_slope` | 坂路コースか | 調教場所 |

**データソース**: kb_ext JSON内のcyokyo_detail（cyokyo_enricherで補強済み）

### cyokyo_detail構造

```json
{
  "cyokyo_detail": {
    "sessions": [
      {
        "date": "2/9",
        "course": "栗坂良",
        "time_5f": "67.2",
        "time_3f": "38.5",
        "time_1f": "12.8",
        "intensity": "馬なり",
        "awase": null
      }
    ],
    "oikiri_summary": {
      "date": "2/9",
      "course": "栗坂良",
      "time_5f": "67.2",
      "time_3f": "38.5",
      "time_1f": "12.8",
      "intensity": "馬なり",
      "is_slope": true
    },
    "rest_period": {
      "weeks": 4,
      "last_race_date": "2026-01-12"
    }
  }
}
```

## 結果

| 指標 | v3.1 | v3.3 | 変化 | 評価 |
|------|------|------|------|------|
| Model A AUC | 0.8245 | **0.8247** | +0.0002 | 維持 |
| Model B AUC | 0.7777 | **0.7823** | **+0.0046** | 大幅改善 |
| Model A Iter | 315 | 304 | -11 | 安定 |
| Model B Iter | 492 | **575** | +83 | 学習シグナル増 |
| 特徴量数 A/B | 51/47 | **60/56** | +9/+9 | - |
| VB gap>=2 ROI | 100.0% | **103.2%** | +3.2pt | 改善 |
| VB gap>=3 ROI | 110.2% | **113.0%** | +2.8pt | 改善 |
| VB gap>=4 ROI | 122.6% | **127.2%** | +4.6pt | 改善 |
| VB gap>=5 ROI | 128.3% | **139.0%** | +10.7pt | 大幅改善 |

### Model B 特徴量重要度 Top 10

| 順位 | 特徴量 | 重要度(gain) |
|------|--------|-------------|
| 1 | avg_finish_last3 | 131,612 |
| 2 | jockey_venue_top3_rate | 103,655 |
| 3 | prev_race_popularity | 80,125 |
| 4 | trainer_venue_top3_rate | 49,789 |
| 5 | track_type_top3_rate | 41,347 |
| 6 | recent_form_trend | 27,438 |
| 7 | entry_count | 25,362 |
| 8 | best_finish_last5 | 20,721 |
| 9 | entry_count_change | 20,612 |
| 10 | days_since_last_race | 19,147 |

**注**: 調教特徴量は個別にはTop10圏外だが、集団効果でModel B AUCを+0.0046押し上げた。

## 特徴量別の評価

### 効果の考察
- **追い切りタイム (5f/3f/1f)**: コース別・馬場別の正規化なしでも有効。坂路67秒台とウッド65秒台は本来比較不可だが、モデルが`oikiri_is_slope`と組み合わせて学習している可能性。
- **rest_weeks**: days_since_last_raceとは異なる情報（調教再開からの期間を反映）。
- **oikiri_intensity_code/has_awase**: 重要度は低い。脚色テキストの数値化精度に改善余地（「強め」「末強め」の区別等）。

### 改善余地
- **追い切りタイムの正規化**: コース（坂路/ウッド/CW/ポリ）× 馬場状態（良/稍/重）で正規化すればタイム比較が正確に
- **併せ馬テキスト解析**: 先着/遅れ/同入の数値化、相手馬のクラス考慮
- **調教パターン**: 中間の調教リズム（セッション間隔、強度推移）の特徴量化

## 学び

1. **調教データは量で効く**: 個々の重要度は低くても8特徴量の集団効果は大きい
2. **Model B iterの延伸は良い兆候**: 過学習せず新しいシグナルを学習している
3. **VB全ギャップでROI向上**: gap>=2ですら103%超、実運用でベット機会が最大化
4. **正規化なしでも効果あり**: 完璧なデータでなくても投入する価値はある

## ファイル

| ファイル | 変更 |
|---------|------|
| `keibabook/cyokyo_parser.py` | 新規: HTML→構造化パーサー |
| `keibabook/cyokyo_enricher.py` | 新規: kb_extへcyokyo_detail補強バッチ |
| `ml/features/training_features.py` | 新規: 調教特徴量8個 |
| `ml/experiment_v3.py` | 修正: training_features呼び出し追加 |
| `ml/predict.py` | 修正: training_features呼び出し追加 |
