# ML v3.1: 脚質/ローテ/ペース特徴量 + ハイパラ調整

**日付**: 2026-02-11
**種別**: 特徴量エンジニアリング + ハイパーパラメータ調整

---

## 概要

JRA-VANデータの未使用フィールド（コーナー通過順、ペースデータ等）を活用し、
19個の新特徴量を3モジュールに分けて追加。
ユーザーの凡走予測仮説（消耗戦直後の出走、斤量増等）を特徴量として実装。

## 変更内容

### 特徴量追加 (19個、3モジュール)

#### 脚質特徴量 `running_style_features.py` — 8個
| 特徴量 | 計算方法 | 狙い |
|--------|---------|------|
| `avg_first_corner_ratio` | 直近5走のcorners[0]/num_runners平均 | 先行力 (0=逃げ, 1=追い込み) |
| `avg_last_corner_ratio` | 直近5走のcorners[-1]/num_runners平均 | 直線入口位置 |
| `position_gain_last5` | (corners[0]-finish)/num_runners平均 | 追い上げ力 |
| `front_runner_rate` | 直近5走でcorners[0]<=3の割合 | 逃げ馬率 |
| `pace_sensitivity` | 先行時vs非先行時の着順差 | 逃げ損ね崩壊度 |
| `closing_strength` | 直近3走の(最終corner-finish)平均 | 末脚力 |
| `running_style_consistency` | corners[0]/num_runnersの標準偏差 | 脚質安定度 |
| `last_race_corner1_ratio` | 前走のcorners[0]/num_runners | 最新の先行度合い |

**データソース**: horse_history_cache（cornersフィールド）

#### ローテ・コンディション特徴量 `rotation_features.py` — 5個
| 特徴量 | 計算方法 | 狙い |
|--------|---------|------|
| `futan_diff` | 今走斤量 - 前走斤量 | 斤量増の影響 |
| `futan_diff_ratio` | futan_diff / 前走斤量 | 相対的斤量変化 |
| `weight_change_ratio` | (今走体重-前走体重)/前走体重 | 体調シグナル |
| `prev_race_popularity` | 前走の人気順 | 消耗した人気馬の検出 |
| `popularity_trend` | 今走人気 - 前走人気 | 人気変動 **※MARKET→Model B除外** |

**データソース**: horse_history_cache + 当走データ

#### ペース特徴量 `pace_features.py` — 6個
| 特徴量 | 計算方法 | 狙い |
|--------|---------|------|
| `avg_race_rpci_last3` | 直近3走のレースRPCI平均 | 経験ペース傾向 |
| `prev_race_rpci` | 前走のRPCI | 直近のペース負荷 |
| `consumption_flag` | prev_rpci<=46 AND days<=21 → 1 | 凡走フラグ |
| `last3f_vs_race_l3_last3` | (馬L3-レースL3)の3走平均 | 末脚の相対評価 |
| `steep_course_experience` | 急坂場(中山06,阪神09)出走割合 | 坂経験 |
| `steep_course_top3_rate` | 急坂場での3着以内率 | 坂適性 |

**データソース**: horse_history_cache + pace_index（全レースJSONから構築）

### インフラ追加
- `build_pace_index()`: 19,404レースJSON → {race_id: {rpci, s3, l3, s4, l4}} 辞書構築

### ハイパーパラメータ変更 (Model A/B分離)

| パラメータ | v3.0 (共通) | v3.1 Model A | v3.1 Model B | 変更理由 |
|-----------|-------------|-------------|-------------|----------|
| `num_leaves` | 63 | 63 | **127** | 市場系除外で表現力不足を補う |
| `feature_fraction` | 0.7 | **0.8** | **0.8** | 51特徴量に増加、各木がより多くの特徴量を参照 |
| `min_child_samples` | 30 | 30 | **50** | num_leaves増に対する過学習防止 |
| `reg_lambda` | 1.0 | 1.0 | **1.5** | 同上 |
| `max_depth` | 7 | 7 | **8** | num_leaves増に対応 |

## 結果

| 指標 | v3.0 | v3.1 | 変化 | 評価 |
|------|------|------|------|------|
| Model A AUC | 0.8241 | **0.8245** | +0.0004 | 維持 |
| Model B AUC | 0.7746 | **0.7777** | +0.0031 | 改善 |
| Model A Iter | - | 315 | - | 安定 |
| Model B Iter | 494 | 492 | -2 | 安定 |
| 特徴量数 A/B | 32/29 | **51/47** | +19 | - |
| VB gap>=2 ROI | 93.3% | **100.0%** | +6.7pt | 初の100%超 |
| VB gap>=3 ROI | 109.2% | **110.2%** | +1.0pt | 改善 |
| VB gap>=4 ROI | 117.2% | **122.6%** | +5.4pt | 改善 |
| VB gap>=5 ROI | 130.3% | 128.3% | -2.0pt | 微減(bet数650、統計誤差) |

### Model B 特徴量重要度 Top 10
| 順位 | 特徴量 | 重要度(gain) | v3.0比 |
|------|--------|-------------|--------|
| 1 | avg_finish_last3 | 141,333 | - |
| 2 | jockey_venue_top3_rate | 96,432 | - |
| **3** | **prev_race_popularity** | **75,630** | **NEW** |
| 4 | trainer_venue_top3_rate | 48,955 | - |
| 5 | track_type_top3_rate | 47,538 | - |
| 6 | recent_form_trend | 27,005 | - |
| 7 | entry_count | 25,704 | - |
| 8 | best_finish_last5 | 20,796 | - |
| 9 | jockey_top3_rate | 19,464 | - |
| 10 | entry_count_change | 19,330 | - |

## 特徴量別の評価

### 効果が大きかったもの
- **prev_race_popularity (重要度3位)**: 「前走人気だった馬」の情報がModel Bで強く効いている。市場系を除外したモデルで前走の人気順が重要ということは、「前走で消耗した人気馬」の検出に成功している可能性が高い。

### 期待ほど効かなかったもの
- **脚質特徴量**: Top10圏外。corners正規化(÷num_runners)は妥当だが、コース形状（2コーナー vs 4コーナー）の差を未考慮。
- **consumption_flag**: 発火条件が厳しい（前走RPCI<=46 かつ 中間隔<=21日は稀）。条件緩和（28日以内、RPCI<=48等）を検討。
- **steep_course_experience/top3_rate**: 急坂は中山・阪神の2場のみで分類が粗い。コースレベル（内回り/外回り）の細分化が必要。

### 評価保留
- **futan_diff**: 重要度は中程度。斤量差は馬によって影響度が異なるため、交互作用特徴量（斤量差×体重など）が必要かも。
- **last3f_vs_race_l3_last3**: 末脚の相対評価として理論的には正しいが、重要度は低い。

## 学び

1. **prev_race_popularityの発見**: 凡走予測仮説が実証された。「前走で人気だった馬は次走でも過剰評価されがち」を市場非依存モデルが学習している。
2. **特徴量は「量より質」だが「量も効く」**: 個々の重要度は低くても19特徴量の集団効果でModel B AUC +0.0031。
3. **feature_fraction調整の重要性**: 特徴量増加時は0.7→0.8に上げないと新特徴量が使われない木が増える。
4. **Model A/Bのハイパラ分離は有効**: Model Bは市場系除外で情報量が少ないため、num_leavesを増やして表現力を補う。

## 今後の改善候補

### この実験から見えた次のステップ
- [ ] consumption_flag条件緩和（28日以内、RPCI<=48）
- [ ] コーナー通過順をコース形状別に正規化
- [ ] 急坂をコースレベル（中山内回り等）に細分化
- [ ] prev_race_popularityの派生特徴量（前走1番人気フラグ等）
- [ ] keibabookデータ統合（rating, training_arrow等）

## ファイル

| ファイル | 変更 |
|---------|------|
| `ml/features/running_style_features.py` | 新規 |
| `ml/features/rotation_features.py` | 新規 |
| `ml/features/pace_features.py` | 新規 |
| `ml/experiment_v3.py` | 修正: 特徴量リスト, pace_index, PARAMS_A/B分離 |
| `ml/predict.py` | 修正: 3特徴量モジュール呼び出し, pace_index注入 |
