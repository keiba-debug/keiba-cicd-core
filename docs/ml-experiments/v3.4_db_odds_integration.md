# ML v3.4: mykeibadb事前オッズ統合 + 結果出力強化

**日付**: 2026-02-14
**種別**: データ基盤 + データリーク解消 + 出力強化

---

## 概要

mykeibadb（MySQL）の時系列オッズデータを統合し、Model Aが使用する市場系特徴量を
「確定オッズ（レース後）」→「事前オッズ（レース前最終）」に置換。これによりModel Aの
データリークを根本解消。加えて、結果JSONにvalue_bet_picksとrace_predictionsを追加し、
WebViewerのVB一覧・レース予測タブを有効化。

## 変更内容

### 新インフラ

| ファイル | 内容 |
|---------|------|
| `core/db.py` | MySQL接続基盤（mykeibadb） |
| `core/odds_db.py` | 時系列→確定オッズの2段階フォールバック取得API |
| `mykeibadb_v3.61/` | JRA-VAN → MySQL自動取込ツール |

### データリーク解消

**問題**: v3.3以前のModel Aは確定オッズ（レース後に確定する値）を特徴量として使用していた。
テスト時は「未来の情報」を見ていることになり、本番予測と条件が異なる。

**解決**: mykeibadbの時系列オッズテーブル(`odds1_tansho_jikeiretsu`)から、
レース前最終スナップショットのオッズを取得。確定オッズと異なるが、レース前に
入手可能な「正当な」市場情報。

```
取得フロー:
1. 時系列単勝オッズ（HAPPYO_TSUKIHI_JIFUN < 発走時刻）の最新値
2. フォールバック: 確定単勝オッズ（odds1_tansho）
3. フォールバック: JSON内の確定オッズ（--no-dbモード）
```

### 結果JSON出力強化

| 追加フィールド | 内容 |
|--------------|------|
| `value_bet_picks` | テスト期間全VB候補（gap>=2、2,752件） |
| `race_predictions` | 全レース予測詳細（3,570レース） |
| `by_rank_gap[].win_hits` | ギャップ別単勝的中数 |
| `by_rank_gap[].win_roi` | ギャップ別単勝回収率 |

### 特徴量変更

特徴量の追加・削除はなし（A: 65, B: 61 — v3.3と同数）。
市場系3特徴量（odds, popularity, odds_rank）のデータソースが確定→事前に変更。

## 結果

| 指標 | v3.3 | v3.4 | 変化 | 評価 |
|------|------|------|------|------|
| Model A AUC | 0.8247 | 0.8246 | -0.0001 | 維持 |
| Model B AUC | 0.7823 | **0.7849** | **+0.0026** | 改善 |
| Model A Iter | 304 | 360 | +56 | 学習深化 |
| Model B Iter | 575 | 521 | -54 | 安定 |
| 特徴量数 A/B | 60/56 | 65/61 | +5 | speed_features追加 |
| VB gap>=2 ROI (複勝) | 103.2% | 103.3% | +0.1pt | 維持 |
| VB gap>=3 ROI (複勝) | 113.0% | 113.3% | +0.3pt | 維持 |
| VB gap>=4 ROI (複勝) | 127.2% | **128.5%** | +1.3pt | 改善 |
| VB gap>=5 ROI (複勝) | 139.0% | 139.4% | +0.4pt | 維持 |

### 単勝ROI（新規計測）

| ギャップ | ベット数 | 的中数 | 単勝ROI | 評価 |
|---------|---------|--------|---------|------|
| gap>=2 | 2,752 | 238 | 90.4% | 赤字 |
| gap>=3 | 1,633 | 100 | 89.5% | 赤字 |
| gap>=4 | 928 | 49 | **102.5%** | 黒字転換 |
| gap>=5 | 538 | 27 | **125.3%** | 高収益 |

**発見**: 単勝はgap>=4から黒字。複勝(128.5%)と合わせた複合ベット戦略が有効。

### Model B 特徴量重要度 Top 10

| 順位 | 特徴量 | 重要度(gain) | v3.3比 |
|------|--------|-------------|--------|
| 1 | avg_finish_last3 | 121,851 | -7.4% |
| 2 | jockey_venue_top3_rate | 98,152 | -5.3% |
| 3 | prev_race_popularity | 79,320 | -1.0% |
| 4 | track_type_top3_rate | 48,890 | +18.2% |
| 5 | trainer_venue_top3_rate | 48,522 | -2.5% |
| 6 | recent_form_trend | 25,587 | -6.8% |
| 7 | entry_count | 24,521 | -3.3% |
| 8 | best_finish_last5 | 22,792 | +10.0% |
| 9 | entry_count_change | 19,970 | -3.1% |
| 10 | jockey_top3_rate | 18,142 | 新Top10入り |

**注**: speed_features（5個）は個別にはTop10圏外。days_since_last_raceがTop10から外れ、jockey_top3_rateが新規ランクイン。

### DB事前オッズカバレッジ

| 対象 | カバー率 |
|------|---------|
| テスト期間（2025-2026） | 3,570/3,570 = **100%** |
| 時系列オッズ保有レース | 3,876レース（2025-01〜2026-02） |
| mykeibadb総レコード | 約9,600万件 |

## 特徴量別の評価

### 事前オッズの影響
- **Model A AUCが微減(-0.0001)**: 事前オッズは確定オッズより「ノイジー」。
  レース直前の変動（取消・出遅れ情報等）が反映されないため、若干の精度低下は想定内。
- **Model B AUCが改善(+0.0026)**: Model Bはオッズを使わないが、
  データセットの品質向上（事前オッズによる適切なodds_rank算出）が間接的に寄与した可能性。
- **VB戦略のROI維持〜改善**: 事前オッズベースのValue Bet判定がより現実的になり、
  実運用との乖離が縮小。

### speed_features（v3.5コード、v3.4で初学習）
- 5特徴量追加（speed_idx_latest/best5/avg3/trend/std）
- 個別重要度は低いが、Model B AUC +0.0026の一因と推定
- スピード指数パーサーはバッチ完了済み（10,701 kb_ext対応）

## 学び

1. **事前オッズでもAUC維持**: 確定→事前への切替でModel A AUCは-0.0001のみ。データリーク解消のコストは極めて小さい
2. **単勝ROIの閾値はgap>=4**: 複勝(128.5%)に加え、単勝(102.5%)も黒字。gap>=5なら単勝125.3%
3. **結果JSONの完全化が重要**: WebViewerのVB一覧・レース予測タブが有効化され、分析の視認性が大幅向上
4. **mykeibadb時系列オッズは実用的**: 100%カバレッジ、フォールバック設計で堅牢

## ファイル

| ファイル | 変更 |
|---------|------|
| `core/db.py` | 新規: MySQL接続基盤 |
| `core/odds_db.py` | 新規: オッズ取得API（時系列/確定/フォールバック） |
| `ml/experiment_v3.py` | 修正: DB事前オッズ連携 + win_roi算出 + VB picks/race predictions出力 |
| `ml/predict.py` | 修正: DB事前オッズ連携 |
| `ml/features/speed_features.py` | 新規: スピード指数特徴量5個 |
| `keibabook/parsers/speed_parser.py` | 新規: スピード指数HTMLパーサー |
| `keibabook/batch_speed_scrape.py` | 新規: 全kb_extスピード指数バッチ |
