# ML v4.1: CK_DATA調教特徴量追加（+7特徴量）

**日付**: 2026-02-15
**種別**: 特徴量エンジニアリング + 市場相関分析

---

## 概要

JRA-VAN CK_DATA（調教データ）のlapRank/timeRank/finalLap等をML特徴量として追加。
training_summary.json（661日分、230万馬エントリ）をインデックス化し、kettoNumでマッチ。

**重要な発見**: CK_DATA調教特徴量は**市場オッズに織り込み済み**であり、
Model B（市場独立）に含めるとAUCは微改善するがVB ROIが大幅悪化する。
最終的に**MARKET_FEATURESとしてModel Aのみに使用**する設計とした。

## 新規特徴量（7個）

| 特徴量 | 説明 | 元データ | Model B |
|--------|------|----------|---------|
| `ck_laprank_score` | 総合lapRankの順序スコア (1-16) | lapRank | **除外** |
| `ck_laprank_class` | lapRankの基本クラス (0-5: D〜SS) | lapRank | **除外** |
| `ck_laprank_accel` | 加速コード (-1/0/+1) | lapRank | **除外** |
| `ck_time_rank` | タイムレベル (1-5) | timeRank | **除外** |
| `ck_final_laprank_score` | 最終追い切りlapRankスコア (1-16) | finalLap | **除外** |
| `ck_final_time4f` | 最終追い切り4Fタイム (秒) | finalTime4F | **除外** |
| `ck_final_lap1` | 最終追い切りラスト1F (秒) | finalLap1 | **除外** |

### lapRankエンコーディング

```
SS=16, S+=15, S==14, S-=13,
A+=12, A==11, A-=10,
B+=9,  B==8,  B-=7,
C+=6,  C==5,  C-=4,
D+=3,  D==2,  D-=1
```

基本クラス: D=0, C=1, B=2, A=3, S=4, SS=5
加速コード: +=1(加速), ==0(等速), -=−1(減速)

## 実験結果

### Experiment A: CK_DATA をModel A+B両方に含めた場合

| 指標 | v4.0 | v4.1-AB | 変化 |
|------|------|---------|------|
| Model A AUC | 0.8242 | 0.8244 | +0.0002 |
| Model B AUC | 0.7839 | **0.7845** | **+0.0006** |
| Model B ECE | 0.0053 | **0.0037** | **-0.0016** |
| VB gap>=3 PlaceROI | 120.2% | **109.7%** | **-10.5pt** |
| VB gap>=5 PlaceROI | 146.0% | **124.2%** | **-21.8pt** |

**結論**: Model B AUCは改善するがVB ROIが大幅悪化。
調教情報がオッズに反映済み → Model BがModel Aに近づく → gap縮小 → ROI低下。

### Experiment B: CK_DATA をModel Aのみに含めた場合（最終版）

| 指標 | v4.0 | v4.1 | 変化 |
|------|------|------|------|
| Model A AUC | 0.8242 | **0.8243** | +0.0001 |
| Model B AUC | 0.7839 | 0.7837 | -0.0002 (=) |
| Features A/B | 75/69 | **82/69** | A+7, B変更なし |
| VB gap>=2 PlaceROI | 107.0% | **107.8%** | +0.8pt |
| VB gap>=3 PlaceROI | 120.2% | **121.1%** | +0.9pt |
| VB gap>=4 WinROI | 96.7% | **100.1%** | **+3.4pt (100%突破)** |
| VB gap>=4 PlaceROI | 127.6% | **128.8%** | +1.2pt |
| VB gap>=5 WinROI | 118.0% | **122.6%** | +4.6pt |
| VB gap>=5 PlaceROI | 146.0% | **147.7%** | +1.7pt |

**結論**: Model Aの精度微改善がVB検出精度を向上させ、全gap水準でROI改善。

### CK_DATA特徴量のImportance

| 特徴量 | Model A | Model B (参考: Exp.A) |
|--------|---------|----------------------|
| ck_final_time4f | 1,252 | 3,514 |
| ck_final_lap1 | 893 | 2,659 |
| ck_final_laprank_score | 621 | 1,138 |
| ck_laprank_score | 513 | 1,874 |
| ck_time_rank | 302 | 1,385 |
| ck_laprank_accel | 103 | 326 |
| ck_laprank_class | 57 | 401 |

Model Aでは低重要度（odds: 454,764 に対し最大1,252）だが、
Model Bでは中程度の重要度を持つ（= 市場と相関する独立情報）。

## 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `ml/features/training_features.py` | lapRankエンコード定数、_encode_laprank()、CK_DATA抽出ロジック追加 |
| `ml/experiment.py` | TRAINING_FEATURES+7, MARKET_FEATURES+7, build_training_summary_index(), ck_training threading |
| `ml/predict.py` | training_summary.json読み込み、ck_training threading |

## 教訓

1. **AUC改善 ≠ ROI改善**: Model Bの精度向上が市場との乖離を縮めてVB効果を殺す
2. **市場に織り込み済みの情報はMARKET_FEATURES**: 調教情報は馬券購入者が参考にするためオッズに反映済み
3. **Model Aのみに追加するメリット**: 精度モデル(A)を強化し、市場独立モデル(B)との乖離を拡大 → VB検出精度向上
4. **training_summary.jsonの規模**: 661日分、230万馬エントリ。インデックス構築は数秒で完了
