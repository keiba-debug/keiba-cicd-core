# MD新聞ヘッダー改善 改修指示（2025-08-23）

## 背景・目的
- MD新聞（`python -m src.markdown_cli batch` 出力）の見出しにレース特定情報が不足。
- 見出し（H1）だけで「競馬場・R番号・コース・レース名/クラス・発走予定時刻」が把握できるようにし、視認性・即応性を向上する。

### 現状（例）
```
# 11R

## 📋 レース情報
- **日付**: 2025年8月23日
- **競馬場**: 札幌
- **コース**: 芝 2000m
```

### 修正後の想定（例）
```
# 札幌11R 芝 2000m 札幌記念(G2)  発走予定 15:35

## 📋 レース情報
- **日付**: 2025年8月23日
- **競馬場**: 札幌
- **コース**: 芝 2000m
- **発走予定時刻**: 15:35
```

---

## 要件（必須）
1. 見出し1（`#`）フォーマットを以下に統一：
   - `# {競馬場}{R番号} {コース表記} {距離m} {レース名(クラス/グレード)}  発走予定 {HH:MM}`
   - 例）`# 中京10R ダ 1800m 浜名湖特別(2勝クラス)  発走予定 14:15`
2. 「📋 レース情報」に「発走予定時刻」を追加（存在時のみ）。
3. 発走予定時刻が取得できていない場合は省略。取得経路が無ければスクレイピング〜統合まで拡張し取得可能にする。
4. 既存出力の後方互換性を維持（表やMermaid等の体裁崩れ禁止）。
5. コース表記は既存スタイルに準拠（`芝` / `ダ`）。

---

## データ取得・参照方針（優先順）
- 優先1: integrated JSON（`integrator_cli` 出力）の `race_info` を参照
  - 使用フィールド候補：
    - `race_info.venue_name`（札幌/中京/新潟 等）
    - `race_info.race_number`（例: 11）
    - `race_info.track_type`（芝/ダ）
    - `race_info.distance`（例: 2000）
    - `race_info.race_name`（例: 札幌記念）
    - `race_info.grade` または `race_info.class`（例: G2 / 2勝クラス）
    - `race_info.post_time`（例: 15:35）
- 優先2: 統合時に不足する項目は `nittei`/`shutsuba` 由来で補完（統合ロジックでマージ）。
- 優先3: 不足が埋まらない場合は `scrapers`（nittei相当）で「発走予定時刻」取得処理を追加し、`integrator_cli` で `post_time` を反映。

---

## 実装対象（ガイド）
- 生成: `src/markdown_cli`（タイトル組立・テンプレート修正）
- 統合: `src/integrator_cli`（`post_time`/`race_name`/`grade|class` のマージ強化）
- 取得: `src/keibabook/scrapers/*`（必要時のみ、nitteiからの時刻取得を追加）

---

## 受入基準（Acceptance Criteria）
- AC1: H1に「競馬場/レース番号/コース/距離m/レース名(クラス)/発走予定時刻（任意）」が表示される。
- AC2: 「📋 レース情報」に「発走予定時刻」が追加（存在時のみ）。
- AC3: `markdown_cli batch/single` 双方で既存セクションの体裁崩れなし。
- AC4: `post_time` 不明ケースではヘッダー・本文ともに時刻を省略。
- AC5: Gレース/特別/条件戦/新馬/未勝利の各種で表記破綻なし。

---

## テスト観点 / 手順
1. サンプル（例）
   - `Z:/KEIBA-CICD/data/organized/2025/08/23/札幌/integrated_*.json`
   - 発走時刻あり/なしを含む複数Rで検証。
2. コマンド確認
   - `python -m src.markdown_cli single --race-id <race_id> --organized`
   - `python -m src.markdown_cli batch --date 2025/08/23 --organized`
3. 表・Mermaid・テーブル等のレンダリング確認（崩れがないこと）。

---

## ロールバック方針
- 必要時に旧フォーマット（`# {R番号}`）に戻せる切替フラグを `markdown_cli` に一時保持（実装判断に委ねる）。
- 変更はテンプレート差分を局所化し、迅速に戻せるようにする。

---

## メモ
- 距離表記は `{distance}m` とし、数値の全角/半角混在に注意。
- レース名後のクラス/グレードは括弧表記で統一（例: `(G2)` / `(2勝クラス)`）。
- 競馬場名・コース表記の全角/半角・余分なスペースに注意。
