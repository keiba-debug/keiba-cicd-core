# 収支管理画面 改善プロンプト Phase 1

## 概要
KeibaCICD.WebViewer の収支管理画面（`/bankroll`）を改善し、より実用的な収支管理機能を提供する。

---

## 背景・現状

### 現在の機能
1. **月間収支サマリー** - 購入計・払戻計・収支・回収率を表示
2. **馬券種別回収率** - 券種ごとの統計情報
3. **推奨配分** - 回収率ベースの配分提案（選択月のみで計算）
4. **予算設定** - 総資金・日次上限・レース上限
5. **本日の購入予定** - pending/purchased/skipped の管理（手動入力フォーム付き）
6. **結果入力** - 的中/不的中、払戻額の手動登録

### 問題点
- レース日当日に「今日どれだけ買って、どれだけ回収できたか」がすぐに分からない
- TARGETに登録した購入履歴を確認するにはTARGETを開く必要がある
- 推奨配分の計算期間が不明確（現在は選択月のみ）
- 本日の購入予定の手動入力が面倒（レース詳細画面から追加したほうがUXが良い）

---

## 改善要件

### 要件1: 本日の成績表示
**優先度: 高**

月間収支サマリーの上に「本日の成績」カードを追加する。

```
【本日の成績】2026年1月31日
購入計: ¥15,000  払戻計: ¥14,400  収支: -¥600  回収率: 96.0%
購入件数: 5件  的中: 2件
```

#### 実装方針
- APIは既存の `/api/bankroll/summary?date=YYYYMMDD` を使用
- TARGETデータ（PD{YYYY}{MM}.CSV）から当日分をフィルタして計算
- ページロード時に自動取得

#### UI仕様
- 月間サマリーより目立つ位置（最上部）に配置
- 収支がプラスなら緑、マイナスなら赤で表示
- 開催日以外は「本日は開催がありません」を表示

---

### 要件2: 本日の購入リスト表示
**優先度: 高**

TARGETから取得した当日の購入履歴を一覧表示する。

```
【本日の購入リスト】
場所 R  レース名         時刻  距離    馬場 頭数 購入計  払戻計  収支    回収率 的中
東京 10 クロッカ(L)     15:05 芝1400  良  15  ¥2,000 ¥4,500 +¥2,500 225.0% [ワイド]
東京 12 1勝クラス       16:25 芝1800  良  12  ¥4,000 ¥7,200 +¥3,200 180.0% [馬単]
```

#### 実装方針
- `/api/bankroll/daily/[date]` エンドポイントを使用（既存）
- TARGETのCSVから当日のレース別購入データを取得
- レース時刻でソート、結果確定済みのみハイライト

#### UI仕様
- テーブル形式で表示
- 的中したレースは行を緑背景でハイライト
- 未確定レースはグレーアウト
- 券種は的中したもののみ表示（例: [ワイド]）

#### 表示項目
| 項目 | 説明 |
|------|------|
| 場所 | 競馬場名（東京、京都、小倉など） |
| R | レース番号 |
| レース名 | レース名称 |
| 時刻 | 発走時刻 |
| 距離 | 芝/ダート + 距離 |
| 馬場 | 馬場状態 |
| 頭数 | 出走頭数 |
| 購入計 | そのレースの購入金額合計 |
| 払戻計 | そのレースの払戻金額合計 |
| 収支 | 払戻計 - 購入計 |
| 回収率 | (払戻計 / 購入計) × 100 |
| 的中 | 的中した券種（複数可） |

---

### 要件3: 馬券種別実績（期間選択対応）
**優先度: 中**

現在の「推奨配分」（配分%の自動計算）を廃止し、シンプルに**馬券種別の購入金額・回収率**を表示する。期間は選択可能で、設定を保持する。

#### 変更点
- **削除**: 推奨配分の配分%表示、「好調」「控えめ」などのレコメンド
- **追加**: 期間選択機能、購入金額の表示

#### 期間選択肢
1. **今月** - 現在の月のみ（デフォルト）
2. **直近3ヶ月**
3. **直近6ヶ月**
4. **過去1年**

#### 実装方針
- `AllocationGuide.tsx` → `BetTypeStats.tsx` にリネーム
- `/api/bankroll/stats` に `period` パラメータを追加
- 設定は `localStorage` または bankroll config に保存して維持

#### UI仕様
```
【馬券種別実績】
期間: [今月] [直近3ヶ月] [直近6ヶ月] [過去1年]
      ^^^^^^ 選択中（アクティブ表示）

券種      購入金額    払戻金額    収支      回収率   的中率
──────────────────────────────────────────────────────────
馬連      ¥45,000    ¥56,200   +¥11,200   124.9%   18.5%
ワイド    ¥32,000    ¥30,400    -¥1,600    95.0%   35.2%
単勝      ¥15,000    ¥12,000    -¥3,000    80.0%   20.0%
三連複    ¥28,000        ¥0   -¥28,000     0.0%    0.0%
  ⚠️ 三連複の回収率が0.0%です。購入を控えることを推奨します

※ 直近3ヶ月（2024/11〜2025/01）のデータ、購入件数: 87件
```

#### 表示項目
| 項目 | 説明 |
|------|------|
| 券種 | 馬券種別名 |
| 購入金額 | 期間内の購入金額合計 |
| 払戻金額 | 期間内の払戻金額合計 |
| 収支 | 払戻 - 購入 |
| 回収率 | (払戻 / 購入) × 100 |
| 的中率 | (的中件数 / 購入件数) × 100 |

#### ソート
- 回収率降順でソート（現在と同じ）

#### 警告表示ルール
回収率が低い券種に対して、該当行の下に警告メッセージを表示する。

| 条件 | 警告メッセージ |
|------|----------------|
| 回収率 0% | ⚠️ {券種}の回収率が0.0%です。購入を控えることを推奨します |
| 回収率 0〜30% | ⚠️ {券種}の回収率が低調です（{回収率}%）。購入金額を抑えることを推奨します |
| 回収率 30〜50% | ⚠️ {券種}の回収率がやや低調です（{回収率}%） |

- 警告は該当する券種の行の直下に表示
- 回収率50%以上は警告なし
- 購入件数が少ない場合（5件未満など）は警告を出さない（データ不足のため）

#### 設定の保持
- 選択した期間は `localStorage` に保存
- 次回ページ訪問時も同じ期間が選択された状態で表示

---

## ファイル構成

### 変更対象ファイル
```
KeibaCICD.WebViewer/src/
├── app/
│   ├── bankroll/
│   │   └── page.tsx              # メイン画面（本日の成績追加、不要コンポーネント削除）
│   └── api/
│       └── bankroll/
│           ├── stats/
│           │   └── route.ts      # 期間パラメータ対応追加
│           └── daily/
│               └── [date]/
│                   └── route.ts  # 日別詳細データ取得
└── components/
    └── bankroll/
        ├── TodaySummary.tsx      # 新規: 本日の成績
        ├── DailyPurchaseList.tsx # 新規: 購入リスト
        ├── BetTypeStats.tsx      # 新規: 馬券種別実績（期間選択付き）
        ├── AllocationGuide.tsx   # 削除対象
        └── PurchasePlanSection.tsx # 削除対象（購入予定の手動入力）
```

### データフロー
```
TARGET CSV (PD{YYYY}{MM}.CSV)
    ↓
target_reader.py (Python)
    ↓
/api/bankroll/summary, /api/bankroll/daily/[date]
    ↓
React Components (TodaySummary, DailyPurchaseList)
```

---

## API仕様

### GET /api/bankroll/summary
```typescript
// リクエスト
GET /api/bankroll/summary?date=20260131

// レスポンス
{
  "date": "20260131",
  "total_bet": 15000,
  "total_payout": 14400,
  "profit": -600,
  "recovery_rate": 96.0,
  "race_count": 5,
  "win_count": 2,
  "has_data": true,
  "file_exists": true
}
```

### GET /api/bankroll/daily/[date]
```typescript
// リクエスト
GET /api/bankroll/daily/20260131

// レスポンス
{
  "date": "20260131",
  "races": [
    {
      "venue": "東京",
      "race_number": 10,
      "race_name": "クロッカ(L)",
      "post_time": "15:05",
      "distance": "芝1400",
      "track_condition": "良",
      "entries": 15,
      "total_bet": 2000,
      "total_payout": 4500,
      "profit": 2500,
      "recovery_rate": 225.0,
      "hits": ["ワイド"]
    },
    // ...
  ],
  "summary": {
    "total_bet": 15000,
    "total_payout": 14400,
    "profit": -600,
    "recovery_rate": 96.0,
    "race_count": 5,
    "win_count": 2
  }
}
```

### GET /api/bankroll/stats（期間パラメータ追加）
```typescript
// リクエスト（既存: 年月指定）
GET /api/bankroll/stats?year=2026&month=1

// リクエスト（新規: 期間指定）
GET /api/bankroll/stats?period=3months

// period パラメータ
// - "current_month": 今月のみ（デフォルト）
// - "3months": 直近3ヶ月
// - "6months": 直近6ヶ月
// - "1year": 過去1年

// レスポンス
{
  "period": "3months",
  "period_label": "直近3ヶ月",
  "date_range": {
    "from": "2025-11-01",
    "to": "2026-01-31"
  },
  "total_count": 87,
  "stats": {
    "馬連": {
      "bet_type": "馬連",
      "total_bet": 45000,
      "total_payout": 56200,
      "profit": 11200,
      "count": 27,
      "win_count": 5,
      "recovery_rate": 124.9,
      "win_rate": 18.5
    },
    "ワイド": {
      "bet_type": "ワイド",
      "total_bet": 32000,
      "total_payout": 30400,
      "profit": -1600,
      "count": 34,
      "win_count": 12,
      "recovery_rate": 95.0,
      "win_rate": 35.2
    }
    // ...
  },
  "_meta": {
    "has_data": true,
    "file_exists": true
  }
}
```

---

## 注意事項

1. **既存UIの変更禁止** - レイアウト・色・フォントなどの既存デザインは変更しない
2. **既存APIの互換性維持** - 既存パラメータは引き続きサポート
3. **エラーハンドリング** - TARGET CSVが存在しない場合のフォールバック処理
4. **パフォーマンス** - 複数月のCSV読み込み時の遅延対策（キャッシュ検討）

---

## 実装順序

1. **Phase 1-1**: 本日の成績表示（TodaySummary.tsx）
2. **Phase 1-2**: 本日の購入リスト（DailyPurchaseList.tsx）
3. **Phase 1-3**: 馬券種別実績の期間選択対応（BetTypeStats.tsx）
4. **Phase 1-4**: 不要コンポーネント削除、page.tsx の整理
   - AllocationGuide.tsx 削除
   - PurchasePlanSection.tsx 削除（収支管理画面からのみ削除）
   - page.tsx から該当コンポーネントの参照を削除

---

## 参考情報

### 既存コード
- メイン画面: `src/app/bankroll/page.tsx`
- 馬券種別統計API: `src/app/api/bankroll/stats/route.ts`
- サマリーAPI: `src/app/api/bankroll/summary/route.ts`
- 日別API: `src/app/api/bankroll/daily/[date]/route.ts`

### 削除対象
- `src/components/bankroll/AllocationGuide.tsx`（推奨配分コンポーネント）
- `src/components/bankroll/PurchasePlanSection.tsx`（購入予定手動入力コンポーネント）
- `src/app/api/bankroll/allocation/route.ts`（配分API）
- `src/app/api/bankroll/plans/route.ts`（購入予定API）※レース画面から利用する場合は残す

### 購入予定機能について（Phase 2で検討）
収支管理画面からの手動入力は削除し、購入予定の追加は以下から行う方向で別途検討：
- レース詳細画面（`/races/[id]`）から追加
- レース一覧画面（`/races`）から追加

これにより：
- レース情報が自動入力される
- 馬番やオッズを見ながら追加できる
- ユーザー体験が向上

### データ構造
- TARGET CSV形式: `PD{YYYY}{MM}.CSV`
- 読み取りスクリプト: `keiba-ai/tools/target_reader.py`

### 設定保持
```typescript
// localStorage キー
const PERIOD_STORAGE_KEY = 'bankroll_stats_period';

// 使用例
const savedPeriod = localStorage.getItem(PERIOD_STORAGE_KEY) || 'current_month';
localStorage.setItem(PERIOD_STORAGE_KEY, selectedPeriod);
```

---

## 将来の拡張（Phase 2以降）

### Phase 2: 競馬場別・印分析

#### 2-1: 競馬場別収支
TARGETの「年間場所別集計」のような機能。
- 競馬場ごとの購入計・払戻計・収支・回収率
- 得意/苦手な競馬場の可視化
- 期間選択対応

#### 2-2: 印×結果分析
TARGETの「出馬表・本日集計」のような機能。
- 印（◎○▲△）ごとの的中率・回収率
- 印の組み合わせパターン分析
- 「◎が1着」「○が2着以内」などの統計

---

### Phase 3: WIN5分析（専用メニュー）

WIN5は通常の馬券と性質が異なるため、専用の分析メニューを作成。

#### 想定機能
| 機能 | 説明 |
|------|------|
| **購入履歴** | WIN5購入日ごとの対象レース・購入点数・結果 |
| **的中分析** | 何レース目まで的中したかの統計（1R的中、2R的中...） |
| **対象レース分析** | 各レースの◎○▲の成績（WIN5対象レース限定） |
| **キャリーオーバー追跡** | CO発生時の購入判断サポート |
| **回収率推移** | WIN5専用の回収率グラフ |

#### UI案
```
【WIN5分析】 /bankroll/win5

━━━ 2026年 WIN5成績 ━━━
購入回数: 12回  購入計: ¥192,000  払戻計: ¥0  回収率: 0.0%

━━━ 的中進捗分析 ━━━
5R的中（完全的中）: 0回
4R的中: 0回
3R的中: 2回
2R的中: 5回
1R的中: 3回
0R的中: 2回

━━━ 対象レース◎成績 ━━━
1R目（通常9R）: ◎1着率 25.0%
2R目（通常10R）: ◎1着率 16.7%
3R目（通常11R）: ◎1着率 8.3%
4R目（通常11R）: ◎1着率 16.7%
5R目（通常12R）: ◎1着率 8.3%

━━━ 購入履歴 ━━━
1/12(月) 144点 ¥14,400  3R的中まで  対象: [中山9R 京都10R 中山10R 京都11R 中山11R]
1/4(日)  48点 ¥4,800   2R的中まで  対象: [中山9R 京都10R 中山10R 京都11R 中山11R]
```

---

### Phase 4: 詳細統計

TARGETの「月間分析」にある詳細指標の追加。

| 指標 | 説明 |
|------|------|
| 購入シェア | 券種別の購入金額割合 |
| 購入レース数 | 券種別の購入レース数 |
| 勝利レース数 | 券種別の的中レース数 |
| R平均購入額 | 1レースあたりの平均購入額 |
| 購入点数 | 買い目の総点数 |
| 的中点数 | 的中した買い目の点数 |
| 目的中率 | 的中点数/購入点数 |
| 点平均購入額 | 1点あたりの平均購入額 |
| 最高配当 | 期間内の最高払戻額 |
