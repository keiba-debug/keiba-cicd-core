# 12/21のような「36R一括予想→各MD新聞に追記」作業をまとめて指示するプロンプト

@ai-team/knowledge/CLAUDE.md @ai-team/experts/TEAM.md @ai-team/prompts/gunner_playbook.md

あなたは KeibaCICD の「gunner」として行動し、指定日の **3場×12R＝36R** の各MD新聞ファイルに、複数の追記ブロックを自動で追加してください。

## 最重要ルール

- **既存本文（`# 追記` より前）は一切変更しない**
- 追記は **必ずファイル末尾（`# 追記` 以降）に追加**する
- 追記は **重複しない（同名見出しが既にある場合はスキップ）**
- 可能な限り **自動化（スクリプト化）**し、36ファイルを一括更新する
- 日本語で出力し、判断根拠は短くてもいいので「何が良い/悪い」が分かる形にする

---

## 入力（ユーザーが渡すもの）

### 1) 対象日（例）
- 日付: `{YYYYMMDD}`（例: `20251221`）

### 2) レースMDのルート
- `Z:\KEIBA-CICD\data2\races\{YYYY}\{MM}\{DD}\`
  - `中京\*.md` / `阪神\*.md` / `中山\*.md` が各12本ずつ
  - 例: `...\阪神\202505010601.md`

### 3) 調教CSV（文字コード注意）
- 同日のフォルダ直下にある想定:
  - `chokyo_{yymmdd}_コース.csv`
  - `chokyo_{yymmdd}_坂路.csv`
- **CP932（Shift-JIS系）**の可能性が高いので、読み込み時は `encoding="cp932"` を優先
- 日本語ファイル名はターミナルで文字化けする場合があるため、**glob（ワイルドカード）で探索**してパスを確定する

### 4) 馬プロフィール（過去成績/コメント）
- `Z:\KEIBA-CICD\data2\horses\profiles\*.md`
- 各レースMDの出走表にprofilesへのリンクが入っている前提

### 5) 調教師別「勝負パターン」辞書
- `Z:\KEIBA-CICD\調教データ\調教データ.md`
  - 参照は **「調教師別 最重要パターン一覧（クイックリファレンス）」** を主に使う

---

## 実行順（必須）

1. 対象日のフォルダを検出し、3場×12Rの **36ファイル一覧**を取得する
2. 追記位置が統一されていることを確認（`---` の後に `# 追記` がある想定）
3. 調教CSVの列（cp932）を確認し、馬名で突合できることを確認
4. スクリプトを作成して、次の追記ブロックを **36ファイルに一括で追加**する
5. 2〜3レースを目視確認して、追記位置/内容/重複がないことをチェックする

---

## 追記するブロック（見出し名は固定）

各レースMDの `# 追記` 以降に、以下のブロックを **順に**追加する（既にあればスキップ）。

### A) 調教重視（CSVベース）

- 見出し: `## GPT-5 追記（調教重視）`
- 内容:
  - 印（◎○▲△△）
  - 調教根拠（上位3頭：坂路/コースのタイム＋ラップ）
  - 点数を絞る買い目案（例: 馬単1点、3連単最大5点）
  - 見送り条件

### B) 適性重視（profilesコメント）

- 見出し: `## GPT-5 追記（適性重視：過去走コメント）`
- 内容:
  - profilesの「最近10走（統合）」や結果メモ等から、同条件/近い条件経験・特徴（出遅れ/砂被り/ワンペース等）を短く抽出
  - 印（適性を加味した再ランク）
  - 注意書き（当日馬場/枠/取消で前提が崩れたら見送り優先）

### C) 適性強化（優先度 C→B→A）

- 見出し: `## GPT-5 追記（適性強化：C→B→A）`
- 優先度:
  - **C**: 砂被り/右左/ゲート等（profilesコメント＋近走傾向）
  - **B**: 脚質×展開（MD内の展開予想テーブルを利用）
  - **A**: 距離（補助的）

### D) 調教分析：推奨理由の補足（読みやすさ強化）

- 見出し: `## GPT-5 追記（調教分析：推奨理由の補足）`
- 目的: Aの結論が「なぜ買いに繋がるか」を **判断軸→当てはめ**で短く説明
- 判断軸は「芝/ダ × 距離帯」によってテンプレを切り替える
- 可能なら Aブロックの「調教評価（上位3頭の根拠）」を引用して当てはめる

### E) 調教師ポイント該当（調教師別の勝負パターン）

- 見出し: `## GPT-5 追記（調教師ポイント該当）`
- 内容:
  - `調教データ.md` の「調教師別 最重要パターン一覧」に該当する調教師が出走している場合、
    - 当該馬がパターンに合致していれば **馬番・馬名・調教師・該当根拠（例: A2/A3、ウッド4F、前週土日あり等）** を列挙
  - 該当がなければ「該当なし」と明記（空欄にしない）

---

## 自動化の要件（スクリプト方針）

- Pythonでスクリプト化し、**一括更新**する
- 文字コード:
  - MDはUTF-8（読み書き）
  - 調教CSVはcp932で読み込み（必要なら `errors="replace"`）
- 突合キー:
  - 原則「馬名」で突合（空白/括弧表記の揺れは正規化）
- 重複防止:
  - 各ブロック見出しが既に含まれていれば追記しない

---

## 完了条件

- 36ファイルすべてに、上記A〜Eの追記が入っている（または既に入っている場合はスキップ扱い）
- `# 追記` より前の本文は変更されていない
- 2〜3ファイルを目視し、追記位置と内容が崩れていないことを確認済み

---

## 不明点が出たら（質問テンプレ）

- 対象日（YYYYMMDD）は？
- 対象フォルダは `Z:\KEIBA-CICD\data2\races\YYYY\MM\DD\` で合っていますか？
- 調教CSVは cp932 で良いですか？（文字化けする場合のみ確認）
- 「見送り」基準の厳しさ（強め/標準/弱め）はどれですか？


