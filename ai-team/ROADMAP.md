# KeibaCICD ロードマップ v3.1 〜 v6.0

> **プロジェクトのビジョン**: 毎週の競馬予想でプラス収支を実現し、推理エンターテインメントとして競馬を楽しむ

---

## 📌 基本方針

### プロジェクトの目的

1. **競馬で勝つ**：実際に馬券を当て、プラス収支を実現する
2. **過程を楽しむ**：データ分析、ML学習、システム設計を楽しむ
3. **エンジニア成長**：実践的な技術習得とスキル向上

### アーキテクチャ戦略

**確定した設計方針**：

- **Backend API分離は不要** — ML予測はバッチ処理で事前生成、JSONファイル経由で十分高速
- **JRA-VAN直接パース** — ketto_num/trainer_cd等のネイティブIDで100%マッチ
- **Server Components優先** — メインページはfs直接読み込み、SWRは使わない
- **段階的な進化** — 各バージョンで明確な価値を提供、技術的負債を最小化

---

## 🎯 バージョン別ロードマップ

---

### v3.1：フロントエンド最適化（2026年2月） ✅ 完了

**成果**:
- Server Components導入によるページ高速化
- レース詳細ページのデータ読み込み最適化
- SWR不使用の方針確定（fs直接読み込みで十分）

---

### v3.2：レース検索機能（2026年2月） ✅ 完了

**成果**:
- レース名・馬名検索のAPI Route実装
- 検索ページUI構築

---

### v3.3：ML v2 デュアルモデル導入（2026年2月） ✅ 完了

**成果**:
- Model A（全特徴量・精度重視）+ Model B（市場系除外・Value重視）のデュアルモデル設計
- 前走成績特徴量15個追加
- Value Bet戦略の基盤構築（odds_rank vs Model B rankの乖離）

---

### v4.0：JRA-VANネイティブ移行 + ML v3（2026年2月） ✅ 完了

**成果**:
- JRA-VANバイナリ直接パーサー（SE/SR/UM/KS）構築
- data3/配下にレース19,404件・馬211,681頭のマスタJSON生成
- trainer_id/jockey_idの100%マッチ達成（旧0.5%→100%）
- ML v3.0: Model B AUC 0.7746（+0.0111）
- ML v3.1: 脚質/ローテ/ペース特徴量19個追加、Model B AUC 0.7777
- ML v3.3: 調教詳細特徴量8個追加、Model B AUC 0.7823、VB gap>=5 ROI 139.0%
- WebViewer v4対応、管理画面統合

**セッション詳細**:
| Session | 内容 |
|---------|------|
| 1-2 | JRA-VANパーサー + マスタビルダー |
| 3 | ML v3（JRA-VANネイティブ特徴量） |
| 4 | keibabook拡張データ統合 |
| 5 | WebViewer v4対応 |
| 6 | パイプライン統合 + WebViewer移動 |
| 7-8 | ML v3.1（脚質/ローテ/ペース）+ v3.3（調教詳細） |

---

### v4.1：v1基盤整理（2026年2月） ✅ 完了

**成果**:
- 分析スクリプト（rating_standards, race_type_standards, trainer_patterns）のv2ネイティブ化
- 管理画面更新

---

### v4.2：Python data2依存解消（2026年2月） ✅ 完了

**成果**:
- SR_DATA GradeCD/RaceName/JyokenCD バイトオフセット解析
- Python側のdata2参照を完全排除

---

### v4.3：WebViewer data2→data3完全移行（2026年2月） ✅ 完了

**成果**:
- TypeScript側のdata2参照を完全排除
- config.tsからdata2パスを削除

---

### v4.4：v1スクレイパー→v2ネイティブ移行（2026年2月） ✅ 完了

**成果**:
- keibabook scraper/parser/batchを全てkeiba-v2/keibabook/に統合
- v1 KeibaCICD.keibabook/ への依存を解消

---

### v4.5：管理画面リネーム + レース表示バグ修正（2026年2月） ✅ 完了

**成果**:
- ボタンリネーム（前日準備→基本情報構築、レース後更新→直前情報・結果情報構築）
- 16桁race_idの直接使用対応（レース詳細ページ）
- race_info.json生成によるレース名・発走時刻の補完
- batch_scraper + race-reader.ts + race-date-index.tsの連携修正

---

## 📊 現在の成果サマリ（v4.5時点）

### ML v3.3 成果
| 指標 | v2初期 | v3.3最新 | 変化 |
|------|--------|----------|------|
| Model A AUC | 0.7944 | **0.8247** | +0.0303 |
| Model B AUC | 0.7635 | **0.7823** | +0.0188 |
| VB gap>=2 ROI | - | **103.2%** | - |
| VB gap>=4 ROI | - | **127.2%** | - |
| VB gap>=5 ROI | 99.9% | **139.0%** | +39.1pt |
| 特徴量数 A/B | 32/27 | **60/56** | +28/+29 |

### 実績（2026-02-08時点）
- **月間**: +57,310（180.9% ROI）
- **通算**: +56,010（166.8%）

---

## 🔮 今後のロードマップ（2026-02-12合意）

> **方針**: 実収支への直結度で優先順位を決定。アイデアは `docs/IDEAS_BACKLOG.md` に蓄積。

---

### v4.6：オッズ最新化 + 調教分析強化（次回〜）

**目的**: Value Bet判定精度の向上、予想根拠の可視化

**主要施策**:
1. **TARGETからの最新オッズ反映** — SE_DATA確定オッズではなく、レース前の最新オッズを取得・表示
2. **調教分析バージョンアップ** — cyokyo_detailの追い切りタイム・ラップを活用した評価方法
3. **WebViewer出走表に調教詳細表示** — 追い切りサマリ（タイム・脚色・併せ馬）の可視化
4. 開催情報のJRA-VAN化（レース名・発走時刻をTARGET/SR_DATAから取得）

---

### v4.7：馬プロフィール + コース分析

**目的**: data3資産の活用、情報の網羅性向上

**主要施策**:
1. **馬プロフィールページ新規作成** — data3/masters 211K馬の過去走・適性・調教履歴を表示
2. **コース・馬場分析ページ更新** — 全コースのラップ情報（RPCI分布・有利脚質）を整理
3. 馬名クリック → プロフィール遷移の導線整備

---

### v4.8：ML v3+ 改善 + 分析機能

**目的**: 予測精度とROIの更なる向上

**主要施策**:
- 降格ローテ検出（レイティング基準値で「相手が楽になる馬」検出）
- 追い切りタイムのコース別・馬場別正規化
- Optunaによるハイパーパラメータ体系的探索
- 特徴量選択（重要度低の特徴量削除による過学習削減）
- point-in-time調教師・騎手統計（時間的リーク解消）

---

### v5.0：期待値計算と購入判断（2026年中盤〜）

**目的**: オッズ連携と購入戦略の自動化

**主要施策**:
- 最新オッズ × ML予測勝率 → 期待値計算エンジン
- 資金配分戦略（ケリー基準等）
- 購入推奨リスト自動生成
- 収支レポート自動生成

**データフロー**:
```
ML予想生成（v4系）
  ↓
TARGETから最新オッズ取得
  ↓
期待値計算（予測勝率 × オッズ）
  ↓
購入推奨リスト生成
  ↓
WebViewerで購入推奨表示
  ↓
ふくだ君が最終判断 → 購入記録
```

---

### v5.1-v6.0：AIエージェント自律化（2026年後半〜）

**目的**: MCP連携による自律型競馬予想システム

#### 専門AIエージェント構成

| エージェント | 役割 | 主要機能 |
|------------|------|---------|
| **キバ**（データ追跡） | 調教データ収集・異常検知 | データ取得、異常パターン検出 |
| **アルテタ**（ML予想） | パターン分析・評価指数計算 | ML予測、類似レース検索 |
| **ひなた**（前走分析） | 各馬の前走パフォーマンス分析 | 前走調教比較、信頼度評価 |
| **シノ**（期待値計算） | オッズ × 勝率 → 期待値判定 | 期待値計算、購入候補抽出 |
| **シカマル**（購入戦略） | 資金配分・買い目決定 | ケリー基準、購入指示書作成 |
| **サイ**（実行記録） | 購入履歴・結果記録 | 購入記録、結果データベース |
| **ナルト**（改善学習） | 予想精度改善・ロジック調整 | モデル再学習、パラメータ調整 |
| **ベンゲル**（司令官） | 全体統括・最終判断 | エージェント統合、レポート作成 |

#### MCP連携アーキテクチャ

```
Claude Desktop (MCP Client)
  ↓ MCP Protocol
ベンゲル（Orchestrator MCP Server）
  ├─ → キバ（Data Tracker）
  ├─ → アルテタ（ML Predictor）
  ├─ → ひなた（Race Analyzer）
  ├─ → シノ（Expected Value Calculator）
  ├─ → シカマル（Betting Strategist）
  ├─ → サイ（Record Keeper）
  └─ → ナルト（Continuous Learner）
  ↓
統合レポート → ふくだ君に提示
```

---

## 📊 技術スタック

### フロントエンド
- Next.js 14+ (App Router)
- React 18+ / TypeScript
- Tailwind CSS
- Server Components（fs直接読み込み）

### バックエンド（Pythonバッチ処理）
- Python 3.11+
- LightGBM（デュアルモデル）
- Pandas / NumPy
- Requests + BeautifulSoup4（スクレイピング）

### データ
- JSONファイル（data3/配下）
- JRA-VANバイナリ直接パース

### AI/ML
- LightGBM（予測モデル）
- scikit-learn（前処理・評価）
- Matplotlib（可視化）
- Claude Desktop + MCP（v5.1〜予定）

---

## 🎓 学習ポイント

各バージョンで習得した/する技術：

### v3.1-v3.3（完了）
- Reactパフォーマンス最適化、Server Components
- LightGBMデュアルモデル、特徴量エンジニアリング
- Value Bet戦略設計

### v4.0-v4.5（完了）
- JRA-VANバイナリパース（Shift-JIS、固定長レコード）
- 大規模データパイプライン（211K馬、19K+レース）
- keibabook Webスクレイピング + 調教HTML構造化パース

### v4.6-v4.8（次）
- Optunaハイパーパラメータ探索
- 特徴量正規化・選択手法

### v5.0-v6.0（将来）
- 統計的意思決定（期待値計算、ケリー基準）
- AIエージェント設計（MCP Protocol）

---

## 🎯 成功基準

### v4系（完了分）
- ✅ ML予想のValue Bet ROI > 100%（達成: gap>=2で103.2%）
- ✅ JRA-VAN IDで100%マッチ
- ✅ data2依存の完全解消
- ✅ 月次プラス収支達成（+57,310）

### v4.6-v4.8
- 追い切りタイム正規化でModel B AUC > 0.79
- 馬プロフィールページ完成
- keibabook依存の開催情報をJRA-VAN化

### v5.0
- 期待値 > 1.0 の馬券抽出精度 > 70%
- 週次収支レポート自動生成

### v5.1-v6.0
- AIエージェントによる自律予想
- 通算ROI 150%以上の維持

---

**最終更新**: 2026-02-12（カカシ）
**承認**: ふくだ君
