# 引き継ぎ記録 2026-01-31

**作成日**: 2026-01-30
**作成者**: カカシ（AI相談役）
**次回対応者**: 全チームメンバー

---

## 📋 本日の作業サマリー

### 完成したこと

1. **予想ヘルパーツール** (`keiba-ai/tools/prediction_helper.py`)
   - ふくださんが手動で予想する際の支援ツール
   - 期待値計算、Kelly基準による賭け金推奨
   - 対話モードでレース一覧・出走馬確認・予想入力が可能

2. **レース選定ツール** (`keiba-ai/tools/race_selector.py`)
   - データ完全性と予想しやすさを評価
   - 推奨レースをスコア順に表示

3. **データ形式の確認**
   - `integrated_*.json` が統合レースデータ
   - `race_info.json` から正しい会場名を取得するよう修正済み

---

## 🔧 ツールの使い方

### 予想ヘルパー（対話モード）

```bash
cd E:\share\KEIBA-CICD\_keiba\keiba-ai
python tools/prediction_helper.py --date 20260131 --interactive
```

**コマンド:**
| コマンド | 説明 |
|---------|------|
| `list` | レース一覧を表示 |
| `show <race_id>` | 出走馬一覧を表示 |
| `predict` | 予想入力（データからオッズ取得） |
| `manual` | 予想入力（オッズ手動入力） |
| `quit` | 終了 |

### レース選定

```bash
python tools/race_selector.py --date 20260131
```

---

## 📊 データ構造

### ディレクトリ構成

```
E:\share\KEIBA-CICD\data2\races\2026\01\31\
├── race_info.json          # レース一覧（会場・時刻）
└── temp/
    ├── integrated_*.json   # 統合レースデータ（馬・オッズ・調教）
    ├── cyokyo_*.json       # 調教データ
    └── danwa_*.json        # 談話データ
```

### integrated_ファイルの構造

```json
{
  "meta": { "race_id": "202601040111" },
  "race_info": {
    "venue": "※要注意：誤った値が入っている場合あり",
    "race_number": 11,
    "distance": 2000,
    "track": "芝",
    "race_condition": "白富士Ｓ(4歳以上オープン )"
  },
  "entries": [
    {
      "horse_number": 1,
      "horse_name": "馬名",
      "entry_data": {
        "jockey": "騎手名",
        "odds": "3.5",
        "honshi_mark": "◎",
        "short_comment": "短評"
      },
      "training_data": {
        "short_review": "調教短評",
        "training_arrow": "→"
      }
    }
  ]
}
```

**注意**: `race_info.venue` が誤っている場合がある。`race_info.json` から正しい会場名を取得するロジックを実装済み。

---

## 📈 期待値計算の仕組み

### 計算式

```
期待値率 = 予想勝率 × オッズ × 100

例: 勝率20% × オッズ5.0倍 = 100% → トントン
例: 勝率25% × オッズ5.0倍 = 125% → プラス期待値
```

### 推奨判定

- **110%以上**: 購入推奨（YES）
- **110%未満**: 購入非推奨（NO）

### Kelly基準による賭け金

```
Kelly係数 = (オッズ × 勝率 - (1-勝率)) / (オッズ - 1)
賭け金 = 資金 × Kelly係数 × 0.25（Quarter Kelly）
```

---

## 🎯 明日（1/31）のレース

| 会場 | レース数 | 主なレース |
|------|---------|-----------|
| 東京 | 12R | 白富士S(11R)、クロッカス賞(10R) |
| 京都 | 12R | 舞鶴S(11R)、許波多特別(10R) |
| 小倉 | 12R | 巌流島S(11R) |

**合計**: 36レース

---

## ✅ 完了タスク（Phase 1-3）

| フェーズ | タスク | 状態 |
|---------|-------|------|
| Phase 1 | シカマル（STRATEGIST）実装 | ✅ 完了 |
| Phase 1 | シノ（EVALUATOR）実装 | ✅ 完了（ツール内蔵） |
| Phase 2 | サイ（EXECUTOR）実装 | ✅ 完了 |
| Phase 2 | ひなた（ANALYST）実装 | ✅ 完了 |
| Phase 3 | ナルト（LEARNER）実装 | ✅ 完了 |
| Phase 3 | 予想ヘルパーツール | ✅ 完了 |

---

## ⏳ 残りのタスク

### 高優先度

1. **キバ（TRACKER）実装** - データ自動収集
2. **アルテタ（PREDICTOR）実装** - ML予測モデル
3. **週次サイクルの確立** - 金→土→日→月のワークフロー

### 中優先度

4. **独自データ拡充** (`CUSTOM_DATA_ENHANCEMENT.md` 参照)
   - 調教師パターンデータ
   - 騎手×競馬場適性
   - 血統×距離適性

5. **コースデータ完成** (`競馬場コースデータ/` 参照)
   - 東京・阪神のデータ作成
   - 天気API連携

---

## 💡 ふくださんへの伝達事項

### 明日の予想フロー

1. WebViewer ( http://localhost:3000 ) で出馬表確認
2. `python tools/prediction_helper.py --date 20260131 --interactive`
3. `list` でレース一覧、`show <race_id>` で出走馬確認
4. `predict` で予想入力 → 期待値110%以上なら購入推奨

### 勝率の考え方

- オッズから市場評価を逆算（5倍 → 20%）
- 自分が市場より強いと思えば、勝率を高く見積もる
- 例: オッズ5倍で勝率25%と予想 → 期待値125% → 購入推奨

### 資金設定

- デフォルト: 10万円
- Kelly係数: 0.25（Quarter Kelly = 保守的）
- 変更可能: `--bankroll 50000 --kelly-fraction 0.5`

---

## 📁 関連ファイル

| ファイル | 説明 |
|---------|------|
| `keiba-ai/tools/prediction_helper.py` | 予想ヘルパーツール |
| `keiba-ai/tools/race_selector.py` | レース選定ツール |
| `keiba-ai/tools/README.md` | ツール使用ガイド |
| `ai-team/knowledge/DATA_SPECIFICATION.md` | データ仕様書 |
| `ai-team/knowledge/CUSTOM_DATA_ENHANCEMENT.md` | 独自データ拡充計画 |

---

## 🎭 チームメンバー状態

| メンバー | 役割 | 状態 |
|---------|------|------|
| カカシ | 相談役 | ✅ 稼働中 |
| シカマル | STRATEGIST | ✅ 実装済み |
| シノ | EVALUATOR | ✅ ツール内蔵 |
| サイ | EXECUTOR | ✅ 実装済み |
| ひなた | ANALYST | ✅ 実装済み |
| ナルト | LEARNER | ✅ 実装済み |
| キバ | TRACKER | ⏳ 未実装 |
| アルテタ | PREDICTOR | ⏳ 未実装 |

---

**ナルト**: 「明日は予想するってばよ！期待値で勝つ！」

**カカシ**: 「まあまあ、まずは少額で試してみよう。結果を記録して、次に活かすのが大事だね」

---

---

## 🚀 次フェーズの方針（ふくださん提案）

### コンセプト: 「点数評価 × オッズ × 壁打ち」

#### 1. 各馬を点数で評価（0-100点）
- AIが複数観点から評価
- 完全な順位付けは不要
- 差がない場合は「差がない」と判定

#### 2. レース全体の「買いやすさ」判定
```
パターンA: 50, 50, 50, 50 → 見送り（差がない）
パターンB: 80, 75, 30, 20 → 検討価値あり（差がある）
```

#### 3. 点数 × オッズで馬券戦略
```
①80点(1.2倍) → 堅いけど旨味なし
②75点(10倍) → 本命！単勝狙い
馬連①② → 押さえ
```

#### 4. AIとふくださんの壁打ち
- AIが評価と理由を提示
- ふくださんが疑問・反論
- 対話で評価を調整
- 最終判断はふくださん

#### 5. 従来の枠にとらわれない
- ◎○▲△ではなく点数ベース
- 「買っていいレース」「買ってはいけないレース」を明確に
- 馬券種類は点数とオッズから逆算

### 評価アプローチの候補

| 方式 | 概要 | メリット |
|------|------|---------|
| A. 総合点数 | 各馬0-100点 | シンプル |
| B. 軸別ポイント | 能力/調教/適性/展開で評価 | 強み弱みが明確 |
| C. 展開決め打ち | ペース想定→有利な馬を狙う | 穴馬発見しやすい |
| D. 組み合わせ | B+Cを組み合わせ | 精度高い |

### リスク管理ルール（シカマル担当）

| ルール | 内容 |
|-------|------|
| 1日の上限 | 資金の5%まで |
| 1レースの上限 | 資金の2%まで |
| 連敗制限 | 3連敗で一旦休止 |
| 熱くなり防止 | 負けた直後の増額禁止 |
| 自信度調整 | 自信度で購入額を増減 |

### 実装優先度
1. 各馬評価エンジン（ひなた/アルテタ）
2. レース買いやすさ判定
3. 馬券戦略提案
4. 壁打ち対話機能
5. リスク管理・購入制御（シカマル強化）

### チーム運営の方針

#### 対話パターン（状況に応じて選択）

| パターン | 流れ | 使う場面 |
|---------|------|---------|
| 壁打ち | AI評価 → ふくだ判断 → AI馬券決定 | 通常時 |
| 質問形式 | シカマルが質問 → ふくだ回答 → 馬券決定 | 迷う時 |
| 全自動 | AI評価 → AI馬券決定 | 時間がない時/検証時 |
| ふくだ主導 | ふくだ評価 → AIが壁打ち | 直感がある時 |

#### 成長サイクル
```
予想 → 購入 → 結果 → 振り返り → 改善
                         ↑
                   ナルトが提案
```

#### 大事にすること
- **同じやり方に固執しない** - 結果を見て改善
- **チームで成長** - AI・ふくださん両方が学ぶ
- **柔軟に対応** - 状況に応じてパターンを変える

---

*次回セッション: 2026-01-31（土）予定*
