# レース一覧で「この月にはレースデータがありません」となる場合

`/?year=2022&month=12` のように年月を指定したときに「この月にはレースデータがありません」と表示される原因と確認手順です。

## 表示の仕組み

- トップページ（レース一覧）は **利用可能な日付一覧** を `getAvailableDates()` で取得し、年月でグループ化して表示しています。
- 「この月にはレースデータがありません」は、**選択した年月（例: 2022-12）に属する日付が1件も無い**ときに表示されます。

## 想定される原因

### 1. データがディスクに無い（最も多い）

- レース一覧で「データあり」とみなすのは、次のどちらかが満たされている日付です。
  - **競馬場フォルダ**（中山・東京など）があり、その中に **MD出走表（.md）** がある
  - または **`race_info.json`** があり、その中に **`kaisai_data`** が存在する
- 参照先は **DATA_ROOT** の `races` フォルダです。
  - デフォルト: `C:/KEIBA-CICD/data2`（`.env` の `DATA_ROOT` で変更可能）
  - 日付ごとのパス: `{DATA_ROOT}/races/{年}/{月}/{日}/`
- 例: 2022年12月なら `C:/KEIBA-CICD/data2/races/2022/12/` の下に、各開催日フォルダ（`01`, `03`, …）があり、その中に上記のいずれかが必要です。

**確認方法**

- フォルダの存在:
  - `{DATA_ROOT}/races/2022/12/` が存在するか
  - その中に `01`, `03` などの日付フォルダがあるか
- データ状況APIで確認（範囲指定）:
  - `GET /api/data/status?startDate=2022-12-01&endDate=2022-12-31`
  - どの日付に `hasData: true` があるか確認できます。

### 2. キャッシュ（レース日付インデックス）が古い

- 利用可能な日付一覧は **キャッシュ** `{DATA_ROOT}/cache/race_date_index.json` に保存され、**キャッシュが存在する間はディスクをスキャンせずキャッシュだけを参照**します。
- そのため、
  - キャッシュ作成時点では 2022年12月のデータが無かった
  - または後から 2022/12 のデータを追加した  
  といった場合、**キャッシュを再構築しないと 2022年12月は「データが無い」まま**になります。

**対処方法**

- インデックスを再構築する:
  - 管理画面から「インデックス再構築」を実行する
  - または API を直接呼ぶ:
    - `POST http://localhost:3000/api/admin/rebuild-index`
- 再構築後、`getAvailableDates()` は再ビルドされた日付一覧を返すため、2022年12月にデータがあれば表示されます。

### 3. DATA_ROOT の設定違い

- 実行時に参照している **DATA_ROOT** と、実際にデータを置いているディスクのパスが違うと、その月のデータは「無い」と判定されます。
- `.env` または `.env.local` の `DATA_ROOT`、および本番/開発で環境変数が上書きされていないか確認してください。

**確認方法**

- 開発時は `DATA_ROOT=C:/KEIBA-CICD/data2` などが `.env` に書かれているか確認
- 必要ならデータ状況APIで特定の日を指定して確認:
  - `GET /api/data/status?date=2022-12-25`  
  - ここで `hasData: false` かつ、実際にはそのパスにデータがある場合は、**アプリが参照している DATA_ROOT と、データの実体のパスが一致していない**可能性があります。

## 確認手順のまとめ

| 確認項目 | 方法 |
|----------|------|
| 2022年12月のフォルダがあるか | `{DATA_ROOT}/races/2022/12/` をエクスプローラーで確認 |
| 各日に race_info または競馬場.md があるか | 上記フォルダ内の日付フォルダを開いて確認。または `/api/data/status?startDate=2022-12-01&endDate=2022-12-31` |
| キャッシュが古くないか | データを追加した覚えがあれば `POST /api/admin/rebuild-index` で再構築 |
| DATA_ROOT の値 | `.env` の `DATA_ROOT` と、実際のデータ配置パスが一致しているか確認 |

## 関連コード

- メッセージ表示: `keiba-v2/web/src/app/page.tsx`（`datesInMonth.length === 0` のとき）
- 日付取得: `getAvailableDates()` → `keiba-v2/web/src/lib/data/race-reader.ts`
- キャッシュ: `keiba-v2/web/src/lib/data/race-date-index.ts`（`race_date_index.json` の読み書き・再構築）
