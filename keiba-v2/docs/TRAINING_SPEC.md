# 調教データ仕様書 (v4.8)

> 元仕様: `keiba-v1/KeibaCICD.TARGET/docs/調教データ作成スクリプト開発.md`
> 最終更新: 2026-02-14 (Session 19: 閾値修正)

## 概要

CK_DATA（TARGET調教バイナリ）から馬ごとの調教ラップ分類・調教タイム分類・詳細を生成し、
WebViewer（レース詳細・調教タブ）で表示する。

### データソース

| ファイル | 種別 | レコード長 | 内容 |
|----------|------|-----------|------|
| `WC{loc}{YYYYMMDD}.DAT` | 坂路 | 94バイト (92 + CRLF) | 坂路調教タイム |
| `HC{loc}{YYYYMMDD}.DAT` | コース | 49バイト (47 + CRLF) | コース調教タイム |

- `{loc}`: `0` = 美浦, `1` = 栗東
- パス: `C:/TFJV/CK_DATA/{YYYY}/{YYYYMM}/`

### 実装ファイル

- `web/src/lib/data/target-training-reader.ts` — CK_DATAパーサー + サマリー生成
- `web/src/lib/data/training-summary-reader.ts` — キャッシュ読込 + オンデマンド生成
- `web/src/app/api/admin/batch-training-summary/route.ts` — 一括生成API

---

## WCレコード（坂路調教）フィールド配置

| オフセット | バイト数 | 内容 |
|-----------|---------|------|
| 0 | 1 | レコードタイプ ('0'=美浦, '1'=栗東) |
| 1 | 8 | 年月日 (YYYYMMDD) |
| 9 | 4 | 時刻 (HHMM) |
| 13 | 10 | 血統登録番号 (10桁) |
| 23-67 | 45 | 各種フラグ/予備 |
| 68 | 4 | **4Fタイム** (0.1秒単位, 例: 0527 = 52.7s) |
| 72 | 3 | Lap4 |
| 75 | 4 | 3Fタイム |
| 79 | 3 | Lap3 |
| 82 | 4 | 2Fタイム |
| 86 | 3 | Lap2 |
| 89 | 3 | Lap1 |

## HCレコード（コース調教）フィールド配置

| オフセット | バイト数 | 内容 |
|-----------|---------|------|
| 0 | 1 | レコードタイプ ('0'=美浦, '1'=栗東) |
| 1 | 8 | 年月日 (YYYYMMDD) |
| 9 | 4 | 時刻 (HHMM) |
| 13 | 10 | 血統登録番号 (10桁) |
| 23 | 4 | **5Fタイム** |
| 27 | 3 | 5F-3F差 (Lap5 + Lap4) |
| 30 | 4 | **3Fタイム** |
| 34 | 3 | Lap3 |
| 37 | 4 | **2Fタイム** |
| 41 | 3 | **Lap2** |
| 44 | 3 | **Lap1** |

> HC形式には4Fフィールドが存在しないため、好タイム判定用に `(5F + 3F) / 2` で近似計算する。

---

## 調教ラップ分類 (lapRank)

### 閾値定義（坂路・コース共通）

| 表記 | 範囲 |
|------|------|
| 11秒台以下 | x < 12.0 |
| 12秒台 | 12.0 ≤ x < 13.0 |
| 13秒台以上 | 13.0 ≤ x |

### 加速/減速/同タイムの判定

| 記号 | 条件 | 例 |
|------|------|-----|
| + (加速) | Lap2 > Lap1 | 12.4 → 12.0 |
| - (減速) | Lap2 < Lap1 | 12.0 → 12.4 |
| = (同タイム) | Lap2 == Lap1 | 12.0 → 12.0 |

### 主分類ルール

| 分類 | 条件 | 説明 |
|------|------|------|
| **SS** | 好タイム + S分類 + 加速or同タイム | 最高評価 |
| **S** | Lap2 < 12.0 AND Lap1 < 12.0 | 2F連続11秒台以下 |
| **A** | Lap1 < 12.0 AND Lap2 ≥ 12.0 | 終い11秒台以下 |
| **B** | 12.0 ≤ Lap2 < 13.0 AND 12.0 ≤ Lap1 < 13.0 | 12秒台キープ |
| **C** | 12.0 ≤ Lap1 < 13.0 (Lap2が範囲外) | 終い12秒台 |
| **D** | Lap1 ≥ 13.0 | 13秒台以上（軽め） |

### 優先度スコア (16段階)

| スコア | 分類 | スコア | 分類 |
|--------|------|--------|------|
| 16 | SS | 8 | B= |
| 15 | S+ | 7 | B- |
| 14 | S= | 6 | C+ |
| 13 | S- | 5 | C= |
| 12 | A+ | 4 | C- |
| 11 | A= | 3 | D+ |
| 10 | A- | 2 | D= |
| 9 | B+ | 1 | D- |

### 判定例

| Lap2 | Lap1 | 4Fタイム | 分類 | 解釈 |
|------|------|----------|------|------|
| 11.5 | 11.2 | 52.0 (美浦坂路) | **SS** | 好タイム + S分類 + 加速 |
| 11.5 | 11.2 | 54.0 (栗東坂路) | **S+** | S分類 + 加速（好タイムなし） |
| 10.5 | 11.2 | 52.0 (美浦坂路) | **S-** | S分類 + 減速（SSにならない） |
| 12.4 | 11.8 | 51.5 (コース) | **A+** | 12秒台→11秒台 加速 |
| 12.4 | 12.0 | 53.0 | **B+** | 両方12秒台で加速 |
| 12.8 | 12.5 | - | **B+** | 両方12秒台で加速 |
| 14.0 | 12.5 | - | **C+** | 終い12秒台（Lap2は13秒台以上） |
| 13.5 | 13.0 | - | **D+** | 終い13秒台以上 |

---

## 好タイム基準 (4F)

| 場所 | 種別 | 閾値 |
|------|------|------|
| 美浦 | 坂路 | ≤ 52.9秒 |
| 栗東 | 坂路 | ≤ 53.9秒 |
| 美浦 | コース | ≤ 52.2秒 |
| 栗東 | コース | ≤ 52.2秒 |

### SS判定フロー
1. S分類であること（Lap2 < 12.0 AND Lap1 < 12.0）
2. 加速(+) or 同タイム(=) であること（減速(-)はSSにならない）
3. 好タイム基準を満たすこと（4Fタイムが閾値以下）

---

## 調教タイム分類 (timeRank)

| 記号 | 意味 | 判定 |
|------|------|------|
| 坂 | 坂路で好タイム | 坂路レコードのいずれかが好タイム基準以下 |
| コ | コースで好タイム | コースレコードのいずれかが好タイム基準以下 |
| 両 | 坂路+コース両方 | 坂路・コース両方で好タイム |
| (空) | 好タイムなし | いずれの好タイム基準も未達 |

---

## 日付判定ルール

### 基準日からの追い切り期間

| 分類 | 対象日 |
|------|--------|
| 最終追い切り | 基準日から遡って直近の水曜・木曜 |
| 1週前追い切り | 最終追い切りの7日前の水曜・木曜 |

### 曜日別の扱い

| 曜日 | 扱い |
|------|------|
| 水曜・木曜 | 最終 or 1週前の追い切りとして集計 |
| その他 | SS, S, Aランクの場合のみ調教詳細に出力 |

---

## 集計ルール

### 同一馬・同一日に複数データ
- スコアが高い分類を採用

### 同じ週に坂路とコース両方
- **調教ラップ分類**: スコアが高い方を採用
- **調教詳細**: 両方を記載（スコア高い方を先に）

### 最終決定（重要）
- **全期間で最高スコアの分類を採用**
- 水木以外（土日など）で高評価の追切がある場合、そちらを優先

---

## 出力フォーマット

### training_summary.json

```json
{
  "meta": {
    "date": "20260214",
    "created_at": "2026-02-14T10:00:00.000Z",
    "ranges": {
      "finalStart": "20260211",
      "finalEnd": "20260213",
      "weekAgoStart": "20260204",
      "weekAgoEnd": "20260206"
    },
    "count": 3671
  },
  "summaries": {
    "馬名": {
      "horseName": "馬名",
      "kettoNum": "2022105559",
      "lapRank": "A+",
      "timeRank": "坂",
      "detail": "最終:坂路A+(52.5),コースB+ 1週前:コースC+",
      "finalLocation": "坂",
      "finalSpeed": "◎",
      "finalLap": "A+",
      "finalTime4F": 52.5,
      "finalLap1": 11.8
    }
  }
}
```

### 保存先
`data3/races/{YYYY}/{MM}/{DD}/temp/training_summary.json`

---

## 分布例 (2026-02-14, 3,671頭)

| ランク | 件数 | 割合 |
|--------|------|------|
| SS | 332 | 9.0% |
| S | 123 | 3.4% |
| A | 560 | 15.3% |
| B | 1,145 | 31.2% |
| C | 508 | 13.8% |
| D | 1,003 | 27.3% |

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2025-xx | v1 | 元仕様作成（CSV入力、TSV出力、TARGET取込み用） |
| 2026-02-08 | v4.6 | CK_DATAバイナリ対応、WebViewer統合 |
| 2026-02-14 | v4.8 | ラップ閾値を元仕様に復帰 (12.0/13.0)、好タイム閾値を元仕様に復帰 (52.9/53.9/52.2)、HCレコードtime4f近似計算追加、コース調教のB/C/Aランク正常化 |
