# 管理画面設計書

## 概要

競馬ブックデータの取得・統合・生成を GUI から実行できる管理画面。

## 利用シーン

- **前日準備**: 基本データ（出馬表、調教、談話）の取得
- **レース当日**: パドック情報・成績の取得、リアルタイム更新

## 要件

| 項目 | 内容 |
|------|------|
| 同時実行 | 不要（順次実行） |
| エラー通知 | 画面表示のみ |
| 実行権限 | 確認ダイアログなし |
| 認証 | なし（ローカル利用） |

---

## 画面設計

### URL構成

| URL | 内容 |
|-----|------|
| `/admin` | 管理画面トップ |
| `/admin/fetch` | データ取得 |
| `/admin/logs` | 実行ログ一覧（将来） |

### メイン画面 (`/admin`)

```
┌─────────────────────────────────────────────────────────┐
│  🏇 KEIBA Data Viewer                     📊 管理画面   │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  📅 対象日付                                             │
│  ┌──────────────────────────────────────────────────┐   │
│  │  [2026] 年 [01] 月 [18] 日   [今日に設定]        │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  ═══════════════════════════════════════════════════    │
│                                                          │
│  📥 データ取得                                           │
│  ┌──────────────────────────────────────────────────┐   │
│  │                                                    │   │
│  │  [📅 スケジュール取得]                            │   │
│  │  開催日程を取得                                    │   │
│  │                                                    │   │
│  │  [📋 基本データ取得]                              │   │
│  │  出馬表・調教・談話・勝因を取得                    │   │
│  │                                                    │   │
│  │  [🐎 パドック取得]                                │   │
│  │  パドック情報を取得（レース当日用）                │   │
│  │                                                    │   │
│  │  [🏆 成績取得]                                    │   │
│  │  レース結果を取得（レース後用）                    │   │
│  │                                                    │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  📝 データ統合・生成                                     │
│  ┌──────────────────────────────────────────────────┐   │
│  │                                                    │   │
│  │  [🔗 データ統合]                                  │   │
│  │  JSONデータを統合                                  │   │
│  │                                                    │   │
│  │  [📄 MD生成]                                      │   │
│  │  Markdownファイルを生成                            │   │
│  │                                                    │   │
│  │  [🐴 馬プロフィール生成]                          │   │
│  │  馬の詳細プロフィールを生成                        │   │
│  │                                                    │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  🚀 一括実行                                             │
│  ┌──────────────────────────────────────────────────┐   │
│  │                                                    │   │
│  │  [🌅 前日準備]                                    │   │
│  │  スケジュール → 基本データ → 統合 → MD生成        │   │
│  │                                                    │   │
│  │  [🔄 レース後更新]                                │   │
│  │  パドック → 成績 → 統合 → MD生成                  │   │
│  │                                                    │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  ═══════════════════════════════════════════════════    │
│                                                          │
│  📋 実行ログ                                             │
│  ┌──────────────────────────────────────────────────┐   │
│  │  [10:30:15] 🟢 パドック取得開始...                │   │
│  │  [10:30:45] 🟢 中山 12レース 完了                 │   │
│  │  [10:31:02] 🟢 京都 12レース 完了                 │   │
│  │  [10:31:15] ✅ パドック取得完了                   │   │
│  │  ─────────────────────────────────────           │   │
│  │  [10:31:20] 🟢 データ統合開始...                  │   │
│  │  [10:31:35] ✅ データ統合完了                     │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  ステータス: ✅ 待機中                                   │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 機能一覧

### データ取得

| ボタン | 実行コマンド | 説明 |
|--------|-------------|------|
| スケジュール取得 | `python -m src.fast_batch_cli schedule --start {date} --end {date}` | 開催日程 |
| 基本データ取得 | `python -m src.fast_batch_cli full --start {date} --end {date} --data-types shutsuba,cyokyo,danwa,syoin` | 出馬表等 |
| パドック取得 | `python -m src.fast_batch_cli full --start {date} --end {date} --data-types paddok` | パドック |
| 成績取得 | `python -m src.fast_batch_cli full --start {date} --end {date} --data-types seiseki` | レース結果 |

### データ統合・生成

| ボタン | 実行コマンド | 説明 |
|--------|-------------|------|
| データ統合 | `python -m src.integrator_cli batch --date {date}` | JSON統合 |
| MD生成 | `python -m src.markdown_cli batch --date {date} --organized` | MD生成 |
| 馬プロフィール生成 | `python -m src.horse_profile_cli --date {date} --all --with-history --with-seiseki-table` | 馬詳細 |

### 一括実行

| ボタン | 実行順序 |
|--------|----------|
| 前日準備 | スケジュール → 基本データ → 統合 → MD生成 |
| レース後更新 | パドック → 成績 → 統合 → MD生成 |

---

## API設計

### POST /api/admin/execute

コマンドを実行するAPI

**リクエスト:**
```typescript
interface ExecuteRequest {
  action: 'schedule' | 'basic' | 'paddok' | 'seiseki' | 
          'integrate' | 'markdown' | 'horse_profile' |
          'batch_prepare' | 'batch_after_race';
  date: string; // YYYY-MM-DD形式
}
```

**レスポンス (SSE):**
```typescript
interface ExecuteEvent {
  type: 'log' | 'progress' | 'complete' | 'error';
  message: string;
  timestamp: string;
  progress?: number; // 0-100
}
```

---

## 状態管理

### 実行状態

```typescript
type ExecutionStatus = 
  | 'idle'       // 待機中
  | 'running'    // 実行中
  | 'success'    // 成功
  | 'error';     // エラー

interface AdminState {
  status: ExecutionStatus;
  currentAction: string | null;
  logs: LogEntry[];
  lastExecuted: {
    action: string;
    date: string;
    timestamp: string;
    status: ExecutionStatus;
  } | null;
}
```

### ログエントリ

```typescript
interface LogEntry {
  id: string;
  timestamp: string;
  level: 'info' | 'success' | 'warning' | 'error';
  message: string;
}
```

---

## ファイル構成

```
KeibaCICD.WebViewer/
├── src/
│   ├── app/
│   │   ├── admin/
│   │   │   ├── page.tsx           # 管理画面メイン
│   │   │   ├── loading.tsx        # ローディング
│   │   │   └── error.tsx          # エラー
│   │   └── api/
│   │       └── admin/
│   │           ├── execute/
│   │           │   └── route.ts   # コマンド実行API
│   │           └── status/
│   │               └── route.ts   # 状態取得API
│   ├── components/
│   │   └── admin/
│   │       ├── action-button.tsx  # 実行ボタン
│   │       ├── date-picker.tsx    # 日付選択
│   │       ├── log-viewer.tsx     # ログ表示
│   │       └── status-badge.tsx   # 状態バッジ
│   └── lib/
│       └── admin/
│           ├── commands.ts        # コマンド定義
│           └── executor.ts        # 実行ロジック
```

---

## 実装ステップ

### Phase 1: 基本機能 (MVP)

- [ ] 管理画面ページ作成 (`/admin`)
- [ ] 日付選択コンポーネント
- [ ] 単発実行ボタン（パドック、成績、統合、MD生成）
- [ ] API Route でコマンド実行
- [ ] ログ表示（リアルタイム）
- [ ] 実行状態表示

### Phase 2: 一括実行

- [ ] 前日準備ボタン
- [ ] レース後更新ボタン
- [ ] 進捗バー表示

### Phase 3: 拡張機能（将来）

- [ ] 実行履歴の保存・表示
- [ ] 特定競馬場のみ指定して取得
- [ ] 調教データ集計との連携

---

## 環境変数

```env
# .env.local
KEIBABOOK_PATH=C:/source/git-h.fukuda1207/_keiba/keiba-cicd-core/KeibaCICD.keibabook
PYTHON_PATH=python
```

---

## 注意事項

1. **ローカル専用**: このAPIはローカル環境でのみ動作する想定
2. **排他制御**: 同時に複数のコマンドは実行しない
3. **タイムアウト**: 長時間処理のため、タイムアウトは長めに設定（5分）

---

*作成日: 2026-01-18*
