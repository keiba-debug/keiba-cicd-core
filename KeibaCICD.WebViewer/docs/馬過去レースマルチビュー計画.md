# 馬過去レースマルチビュー機能 開発計画

## 概要

1頭の馬の過去レースを複数選択し、パドック・レース映像をマルチビューで並べて確認できる機能を開発する。

---

## 🎯 目指す機能イメージ

```
馬プロファイルページ（WebViewer）
  ↓
過去成績一覧（レース選択チェックボックス付き）
  □ 2026/01/12 中山 5R 3着
  □ 2025/12/22 中山 3R 1着  
  □ 2025/11/24 東京 2R 2着
  ↓
[選択したレースを比較] ボタン
  ↓
マルチビュー画面（選択したレースのパドック/レース映像を並べて表示）
```

---

## 📊 現状のデータ分析

### JRAビュアーURL生成に必要な情報

| 項目 | 説明 | 馬プロファイルMD | race_info.json | JRA必須 |
|------|------|:----------------:|:--------------:|:-------:|
| 年 | 2026 | ✅ | ✅ | ✅ |
| 月日 | 01/12 | ✅ | ✅ | ✅ |
| 競馬場 | 中山 | ✅ `4東京11` 形式 | ✅ | ✅ |
| レース番号 | 5R | ❌ **なし** | ✅ | ✅ |
| 回次 | 1回中山 | ⚠️ 解析可能 | ✅ `5回中山1日目` | ✅ |
| 日次 | 7日目 | ⚠️ 解析可能 | ✅ | ✅ |

### 馬プロファイルMDの成績フォーマット

```markdown
## 過去成績
| 日付 | 開催 | レース | 着順 | 騎手 | 斤量 | 距離 | 馬場 | タイム | 上がり | 通過順 | 着差 | 人気 | 単勝 | 馬場指数 |
|------|------|------|------|------|------|------|------|------|------|------|------|------|------|------|
| 2025/11/02 | 4東京11 | 天皇賞（秋）(G1) | 4 | モレイラ | 58.0 | 芝2000 | 良 | ... |
```

**問題点**: `レース番号`（何R）が含まれていない

### race_info.json の構造

```json
{
  "date": "20251206",
  "tracks": ["中山", "阪神"],
  "kaisai_data": {
    "中山": "5回中山1日目",
    "阪神": "2回阪神1日目"
  },
  "races": {
    "中山": [
      {"id": "202506010101", "race_number": 1, "name": "..."}
    ]
  }
}
```

---

## 🔧 解決策

### Phase 1: race_info.json 検索方式（短期）

```
日付 + 競馬場 + レース名 → 過去のrace_info.jsonを検索 → レース番号/回次/日次を取得
```

**メリット**:
- 既存データを活用
- 追加スクレイピング不要

**デメリット**:
- 過去のrace_info.jsonが保存されていない期間は対応不可
- レース名が微妙に異なる場合のマッチング問題

### Phase 2: 馬成績スクレイピング拡張（中期）

競馬ブックの馬成績ページからレース番号を追加取得

**対象URL**: `https://p.keibabook.co.jp/db/uma/{horse_id}/kanzen`

**拡張フィールド**:
- `race_number`: レース番号
- `kaisai`: 回次・日次（例: "1回中山7日"）
- `race_id`: JRA-VAN形式のレースID

### Phase 3: JRA-VAN連携（長期）

JRA-VANデータから馬ID → 過去成績（レース番号含む）を取得

---

## 📁 関連ソースファイル

### スクレイピング関連

| ファイル | 役割 |
|----------|------|
| `KeibaCICD.keibabook/src/parsers/seiseki_parser.py` | 成績ページパーサー |
| `KeibaCICD.keibabook/src/scrapers/horse_profile_manager.py` | 馬プロファイル管理 |
| `KeibaCICD.keibabook/src/horse_profile_cli.py` | 馬プロファイルCLI |

### 馬プロファイル生成

| ファイル | 役割 |
|----------|------|
| `KeibaCICD.keibabook/src/integrator/markdown_generator.py` | MD生成 |
| `KeibaCICD.keibabook/src/integrator/markdown_generator_enhanced.py` | 拡張MD生成 |

### WebViewer関連

| ファイル | 役割 |
|----------|------|
| `KeibaCICD.WebViewer/src/app/horses/[id]/page.tsx` | 馬詳細ページ |
| `KeibaCICD.WebViewer/src/app/multi-view/page.tsx` | マルチビューページ |
| `KeibaCICD.WebViewer/src/lib/jra-viewer-url.ts` | JRAビュアーURL生成 |

### 既存ドキュメント

| ファイル | 役割 |
|----------|------|
| `KeibaCICD.keibabook/docs/horse_scraping_system.md` | 馬スクレイピングシステム仕様 |
| `KeibaCICD.keibabook/docs/API仕様/データ仕様.md` | データ仕様 |

---

## 📋 実装計画

### Phase 1: 基盤整備（1-2日）

- [ ] **1.1** 馬プロファイルMDにレース番号フィールドを追加
  - `markdown_generator.py` を修正
  - 過去成績テーブルに `R` 列を追加
  
- [ ] **1.2** race_info.json 検索APIを実装
  - 日付 + 競馬場 + レース名 → race_info.json から検索
  - APIエンドポイント: `/api/race-lookup`

- [ ] **1.3** 馬プロファイルページにレース選択UIを追加
  - チェックボックス付き過去成績テーブル
  - 「選択したレースを比較」ボタン

### Phase 2: マルチビュー連携（1日）

- [ ] **2.1** 馬ページ → マルチビュー連携
  - 選択したレース情報をクエリパラメータで渡す
  - マルチビューページで自動設定

- [ ] **2.2** JRAビュアーURL生成の拡張
  - race_info.json からの回次・日次取得
  - 過去レース用URL生成

### Phase 3: スクレイピング拡張（2-3日）

- [ ] **3.1** 馬成績ページからレース番号を取得
  - `seiseki_parser.py` を拡張
  - 新フィールド: `race_number`, `kaisai`

- [ ] **3.2** 馬プロファイル再生成
  - 過去成績にレース番号を含める
  - `horse_profile_cli.py` で一括更新

### Phase 4: UI改善（1日）

- [ ] **4.1** 馬ページのレース選択UI改善
  - レース種別フィルター
  - 日付範囲フィルター

- [ ] **4.2** マルチビューの馬専用モード
  - 同一馬の過去レース比較モード
  - パドック/レース映像切替

---

## 🔍 競馬ブック馬成績ページの調査

### URL構造

```
https://p.keibabook.co.jp/db/uma/{horse_id}/kanzen
例: https://p.keibabook.co.jp/db/uma/0889022/kanzen
```

### 取得可能な情報（確認が必要）

- [ ] レース番号
- [ ] 回次・日次
- [ ] レースID（JRA-VAN形式）

---

## 📝 データ拡張案

### 馬プロファイルMD 拡張フォーマット

```markdown
## 過去成績

| 日付 | 開催 | R | レース | 着順 | 騎手 | 斤量 | 距離 | 馬場 | タイム | 上がり | ... |
|------|------|---|------|------|------|------|------|------|------|------|-----|
| 2025/11/02 | 4東京9 | 11 | 天皇賞（秋）(G1) | 4 | モレイラ | 58.0 | 芝2000 | 良 | ... |

<!-- レースID情報（非表示） -->
<!-- 2025/11/02_東京_11: 202504090911 -->
```

### integrated JSON 拡張

```json
{
  "horses": [
    {
      "number": 1,
      "name": "ジャスティンパレス",
      "history": [
        {
          "date": "2025/11/02",
          "track": "東京",
          "race_number": 11,
          "kaisai": "4回東京9日",
          "race_id": "202504090911",
          "race_name": "天皇賞（秋）(G1)",
          "result": 4
        }
      ]
    }
  ]
}
```

---

## 📊 race_info.json 保存状況

### 確認結果（2026-01-18）

| 期間 | 状況 |
|------|------|
| 2024年1月～2024年12月 | ✅ ほぼ全開催日に存在 |
| 2025年1月～2025年12月 | ✅ ほぼ全開催日に存在 |

**結論**: 2024年1月以降の開催については`race_info.json`検索方式で対応可能！

### ディレクトリ構造

```
Z:/KEIBA-CICD/data2/races/
├── 2024/
│   ├── 01/
│   │   ├── 06/
│   │   │   ├── race_info.json  ← 開催情報
│   │   │   └── temp/
│   │   │       └── *.json      ← レース詳細
│   │   └── ...
│   └── ...
└── 2025/
    └── ...
```

---

## 🚀 次のアクション

1. **Phase 1 の実装開始**
   - race_info.json 検索APIを実装
   - 馬プロファイルページにレース選択UIを追加

2. **競馬ブック馬成績ページの調査（並行）**
   - レース番号の取得可否を確認
   - 2024年以前のデータ対応のため

---

## 更新履歴

- 2026-01-18: 初版作成
